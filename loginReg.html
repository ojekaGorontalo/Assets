<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Login - JeGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <!-- FirebaseUI untuk WebView -->
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
  
  <style>
    /* KEEP YOUR EXISTING STYLES */
    :root {
      --primary: #1e6f5c;
      --secondary: #289672;
      --accent: #e6dd3b;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.4;
      font-size: 0.85rem;
    }

    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo {
      width: 40px;
      height: 40px;
      background-color: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary);
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* Container Styles */
    .container {
      max-width: 100%;
      padding: 15px;
    }

    .form-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 500px;
      margin: 0 auto;
    }

    .form-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
    }

    /* Customize FirebaseUI */
    .firebaseui-container {
      max-width: 100% !important;
      margin: 0 auto;
    }
    
    .firebaseui-card-content {
      padding: 0 !important;
    }
    
    .firebaseui-idp-button {
      max-width: 100% !important;
      border-radius: 8px !important;
      height: auto !important;
      min-height: 48px !important;
    }
    
    .firebaseui-idp-text {
      font-size: 1rem !important;
      font-weight: 600 !important;
    }

    /* Badge Lokal */
    .local-badge {
      display: inline-block;
      background-color: var(--accent);
      color: var(--dark);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-top: 10px;
      font-size: 0.8rem;
      text-align: center;
      width: 100%;
    }

    .app-info {
      text-align: center;
      margin: 15px 0;
      font-size: 0.85rem;
      color: var(--dark);
      opacity: 0.8;
    }

    /* FirebaseUI container */
    #firebaseui-auth-container {
      margin: 20px 0;
    }

    /* User Info */
    .user-info {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 10px;
      border: 3px solid var(--primary);
      object-fit: cover;
    }

    .user-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .user-email {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 15px;
    }

    .submit-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      width: 100%;
      margin-top: 10px;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    /* Status Messages */
    .status-message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }

    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 20px;
    }

    /* Fallback Options */
    .fallback-options {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      text-align: center;
    }

    .fallback-btn {
      display: inline-block;
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 10px 20px;
      margin: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: none;
    }

    .fallback-btn:hover {
      background: rgba(30, 111, 92, 0.05);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-title {
        font-size: 1rem;
      }
      
      body {
        font-size: 0.8rem;
      }
      
      .form-container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo-container">
      <div class="logo">JG</div>
      <div class="header-title">JeGo - Login User</div>
    </div>
  </div>

  <!-- Container -->
  <div class="container">
    <div class="form-container">
      <h1 class="form-title">Login/Daftar User</h1>
      <div class="local-badge">APLIKASI LOKAL BUATAN ANAK GORONTALO</div>
      <div class="app-info">
        JeGo - Jasa Ekspedisi Gorontalo<br>
        Solusi Transportasi Lokal Terpercaya
      </div>
      
      <!-- Status Message -->
      <div class="status-message" id="statusMessage"></div>
      
      <!-- FirebaseUI Auth Container -->
      <div id="firebaseui-auth-container"></div>
      
      <!-- Loading -->
      <div class="loading" id="loading" style="display: none;">
        <p>Memproses login...</p>
      </div>
      
      <!-- User Info (After Login) -->
      <div class="user-info" id="userInfo">
        <img class="user-avatar" id="userAvatar" src="" alt="User Avatar">
        <div class="user-name" id="userName"></div>
        <div class="user-email" id="userEmail"></div>
        <button type="button" class="submit-btn" id="continueBtn">Lanjutkan ke Aplikasi</button>
      </div>
      
      <!-- Fallback Options -->
      <div class="fallback-options" id="fallbackOptions" style="display: none;">
        <p style="margin-bottom: 10px; color: #666;">Login dengan Google tidak tersedia di browser ini.</p>
        <p><a href="https://jego-gorontalo.firebaseapp.com/login" class="fallback-btn" target="_blank">Buka di Browser Eksternal</a></p>
        <p style="margin-top: 15px; color: #999; font-size: 0.8rem;">Setelah login di browser, kembali ke aplikasi.</p>
      </div>
      
      <!-- Terms and Conditions -->
      <div style="text-align: center; margin-top: 20px; font-size: 0.8rem; color: #666;">
        Dengan melanjutkan, Anda menyetujui <a href="#" style="color: var(--primary);">Syarat & Ketentuan</a> dan <a href="#" style="color: var(--primary);">Kebijakan Privasi</a> JeGo.
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
      authDomain: "game-balap-simpel.firebaseapp.com",
      databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
      projectId: "game-balap-simpel",
      storageBucket: "game-balap-simpel.firebasestorage.app",
      messagingSenderId: "864576853495",
      appId: "1:864576853495:web:6f16eb757fd3d8affb0af2",
      measurementId: "G-YWJPK7Y3J4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Deteksi jika di WebView AppGeyser
    function isAppGeyserWebView() {
      const userAgent = navigator.userAgent.toLowerCase();
      return userAgent.includes('appgeyser') || 
             userAgent.includes('webview') || 
             userAgent.includes('wv') ||
             /android.*wv/.test(userAgent);
    }

    // Show status message
    function showStatus(message, type) {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = 'status-message';
      statusElement.classList.add(`status-${type}`);
      statusElement.style.display = 'block';
    }

    // Hide status message
    function hideStatus() {
      document.getElementById('statusMessage').style.display = 'none';
    }

    // Show loading
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('firebaseui-auth-container').style.display = 'none';
    }

    // Hide loading
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // Show user info after login
    function showUserInfo(user, isNewUser = false) {
      const userInfo = document.getElementById('userInfo');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');
      
      // Update user info
      if (user.photoURL) {
        userAvatar.src = user.photoURL;
      } else {
        // Default avatar with initials
        const initials = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U';
        userAvatar.src = `https://ui-avatars.com/api/?name=${initials}&background=${encodeURIComponent('#1e6f5c')}&color=fff&size=80`;
      }
      
      userName.textContent = user.displayName || 'User';
      userEmail.textContent = user.email;
      
      // Hide auth container, show user info
      document.getElementById('firebaseui-auth-container').style.display = 'none';
      userInfo.style.display = 'block';
      
      // Show welcome message
      if (isNewUser) {
        showStatus(`Selamat bergabung, ${user.displayName || 'User'}!`, 'success');
      } else {
        showStatus(`Selamat datang kembali, ${user.displayName || 'User'}!`, 'success');
      }
    }

    // Check if user exists in database
    function checkUserExists(userId) {
      return database.ref('users/' + userId).once('value')
        .then((snapshot) => {
          return snapshot.exists();
        })
        .catch((error) => {
          console.error('Error checking user existence:', error);
          return false;
        });
    }

    // Save user data to Firebase
    async function saveUserToFirebase(user, isNewRegistration = false) {
      const userData = {
        uid: user.uid,
        nama: user.displayName || '',
        email: user.email || '',
        foto: user.photoURL || '',
        provider: user.providerData && user.providerData[0] ? user.providerData[0].providerId : 'google',
        tanggalDaftar: new Date().toISOString(),
        lastLogin: new Date().toISOString(),
        status: 'active',
        isNewRegistration: isNewRegistration
      };
      
      try {
        await database.ref('users/' + user.uid).set(userData);
        console.log('User data saved to Firebase');
        return { userData, isNewRegistration };
      } catch (error) {
        console.error('Error saving user data:', error);
        throw error;
      }
    }

    // Save user data to localStorage
    function saveUserToLocalStorage(user, userData, isNewUser = false) {
      const userDataToStore = {
        ...userData,
        firebase_key: user.uid,
        last_login: new Date().toISOString(),
        is_new_user: isNewUser
      };
      
      // Simpan data user
      localStorage.setItem('jego_logged_in_user', JSON.stringify(userDataToStore));
      
      // Simpan untuk kompatibilitas
      let jegoUsers = JSON.parse(localStorage.getItem('jego_users')) || {};
      jegoUsers[user.uid] = userData;
      localStorage.setItem('jego_users', JSON.stringify(jegoUsers));
      
      // Backup
      localStorage.setItem('jego_user_data', JSON.stringify(userData));
      
      console.log('✅ Data user disimpan di localStorage:', userDataToStore);
    }

    // Fungsi untuk mengirim data ke Kodular
    function sendToKodular(data, action = 'login_success') {
      const kodularData = {
        action: action,
        timestamp: new Date().toISOString(),
        ...data
      };
      
      console.log('Data yang akan dikirim ke Kodular:', kodularData);
      
      if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
        try {
          window.AppInventor.setWebViewString(JSON.stringify(kodularData));
          console.log('✅ Data berhasil dikirim ke Kodular');
        } catch (error) {
          console.error('Error mengirim data via AppInventor:', error);
        }
      } else if (typeof window.android !== 'undefined' && window.android.receiveData) {
        try {
          window.android.receiveData(JSON.stringify(kodularData));
          console.log('✅ Data berhasil dikirim ke Kodular');
        } catch (error) {
          console.error('Error mengirim data via window.android:', error);
        }
      } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.observe) {
        try {
          window.webkit.messageHandlers.observe.postMessage(kodularData);
          console.log('✅ Data berhasil dikirim ke Kodular');
        } catch (error) {
          console.error('Error mengirim data via webkit.messageHandlers:', error);
        }
      } else {
        console.warn('❌ Tidak ada metode yang berhasil mengirim data ke Kodular');
      }
    }

    // Initialize FirebaseUI
    function initFirebaseUI() {
      // Cek jika di WebView AppGeyser
      if (isAppGeyserWebView()) {
        console.log('Detected AppGeyser WebView - Using FirebaseUI for WebView');
        showStatus('Menggunakan mode login khusus untuk AppGeyser...', 'info');
      }
      
      // Konfigurasi FirebaseUI
      const uiConfig = {
        callbacks: {
          signInSuccessWithAuthResult: function(authResult, redirectUrl) {
            showLoading();
            
            const user = authResult.user;
            const isNewUser = authResult.additionalUserInfo.isNewUser;
            
            // Process user login
            processUserLogin(user, isNewUser);
            
            // Return false untuk mencegah redirect default
            return false;
          },
          uiShown: function() {
            // Hide loading when UI is shown
            hideLoading();
            hideStatus();
          }
        },
        signInFlow: 'popup', // Gunakan popup untuk AppGeyser
        signInOptions: [
          {
            provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            clientId: '864576853495-xxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com',
            customParameters: {
              prompt: 'select_account'
            }
          }
        ],
        // Untuk WebView, gunakan credentialHelper: 'none'
        credentialHelper: isAppGeyserWebView() ? firebaseui.auth.CredentialHelper.NONE : firebaseui.auth.CredentialHelper.GOOGLE_YOLO,
        // Terms of service url
        tosUrl: '#',
        // Privacy policy url
        privacyPolicyUrl: '#'
      };
      
      // Initialize FirebaseUI
      const ui = new firebaseui.auth.AuthUI(firebase.auth());
      ui.start('#firebaseui-auth-container', uiConfig);
    }

    // Process user login
    async function processUserLogin(user, isNewUser) {
      try {
        // Check if user exists
        const userExists = await checkUserExists(user.uid);
        const isNewRegistration = isNewUser || !userExists;
        
        // Save user data
        const saveResult = await saveUserToFirebase(user, isNewRegistration);
        const { userData } = saveResult;
        
        // Save to localStorage
        saveUserToLocalStorage(user, userData, isNewRegistration);
        
        // Show user info
        showUserInfo(user, isNewRegistration);
        
        // Send to Kodular
        sendToKodular({
          login_status: 'success',
          user_data: userData,
          firebase_key: user.uid,
          provider: 'google',
          is_new_user: isNewRegistration
        }, isNewRegistration ? 'registration_success' : 'login_success');
        
        hideLoading();
        
      } catch (error) {
        console.error('Error processing login:', error);
        showStatus('Terjadi kesalahan saat memproses login. Silakan coba lagi.', 'error');
        hideLoading();
        
        // Show auth UI again
        document.getElementById('firebaseui-auth-container').style.display = 'block';
      }
    }

    // Handle Continue button
    document.getElementById('continueBtn').addEventListener('click', function() {
      showStatus('Mengalihkan ke halaman utama...', 'info');
      
      // Redirect to jenis_kenderaan.html after 1 second
      setTimeout(() => {
        window.location.href = 'jenis_kenderaan.html';
      }, 1000);
    });

    // Check if user is already logged in
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is signed in
        console.log('User already logged in:', user);
        
        // Check if this is a new or existing user
        checkUserExists(user.uid)
          .then((userExists) => {
            if (!userExists) {
              // This shouldn't normally happen, but just in case
              saveUserToFirebase(user, true)
                .then((result) => {
                  saveUserToLocalStorage(user, result.userData, true);
                  showUserInfo(user, true);
                });
            } else {
              showUserInfo(user, false);
            }
          });
      } else {
        // User is not signed in
        console.log('No user logged in - Initializing FirebaseUI');
        
        // Initialize FirebaseUI
        initFirebaseUI();
        
        // Check if we need to show fallback options
        if (isAppGeyserWebView()) {
          // Show fallback options after 3 seconds if FirebaseUI doesn't load
          setTimeout(() => {
            if (document.getElementById('firebaseui-auth-container').children.length === 0) {
              document.getElementById('fallbackOptions').style.display = 'block';
              showStatus('Login dengan Google tidak tersedia di browser ini. Silakan gunakan opsi di bawah.', 'error');
            }
          }, 3000);
        }
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Check if already logged in via localStorage
      const loggedInUser = localStorage.getItem('jego_logged_in_user');
      
      if (loggedInUser) {
        try {
          const user = JSON.parse(loggedInUser);
          showStatus('Anda sudah login. Mengalihkan...', 'info');
          
          // Redirect ke jenis_kenderaan.html setelah 1.5 detik
          setTimeout(() => {
            window.location.href = 'jenis_kenderaan.html';
          }, 1500);
        } catch (error) {
          console.error('Error parsing logged in user:', error);
        }
      }
    });
  </script>
</body>
</html>
