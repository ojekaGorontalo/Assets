<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lengkapi Data - OloRide</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* CSS tetap sama seperti sebelumnya */
  </style>
</head>
<body>
  <!-- HTML struktur tetap sama -->
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Variabel untuk menyimpan koordinat
      let userCoordinates = null;
      
      // Current location button handler
      currentLocationBtn.addEventListener('click', function() {
        // ... kode UI sebelumnya ...
        
        // Request lokasi tanpa alert
        requestLocationSilently();
      });

      // Fungsi untuk request lokasi tanpa alert
      function requestLocationSilently() {
        if (!navigator.permissions) {
          // Fallback untuk browser yang tidak support Permissions API
          getLocationWithOptions();
          return;
        }

        // Cek status permission pertama kali
        navigator.permissions.query({name: 'geolocation'})
          .then(permissionStatus => {
            if (permissionStatus.state === 'granted') {
              getLocationWithOptions();
            } else if (permissionStatus.state === 'prompt') {
              // Jika belum ada keputusan, gunakan timeout untuk menghindari prompt
              setTimeout(() => {
                getLocationWithOptions({timeout: 100});
              }, 10);
            } else {
              showManualEntry("Izin lokasi ditolak sebelumnya");
            }

            // Monitor perubahan permission
            permissionStatus.onchange = () => {
              if (permissionStatus.state === 'granted') {
                getLocationWithOptions();
              }
            };
          })
          .catch(() => {
            getLocationWithOptions();
          });
      }

      // Fungsi untuk mendapatkan lokasi dengan opsi khusus
      function getLocationWithOptions(options = {}) {
        const defaultOptions = {
          enableHighAccuracy: true,
          maximumAge: 30000,
          timeout: 10000
        };
        
        navigator.geolocation.getCurrentPosition(
          position => {
            userCoordinates = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            reverseGeocode(userCoordinates.lat, userCoordinates.lng);
          },
          error => {
            showManualEntry(getErrorMessage(error));
          },
          {...defaultOptions, ...options}
        );
      }

      // Fungsi untuk menampilkan pesan error
      function getErrorMessage(error) {
        switch(error.code) {
          case error.PERMISSION_DENIED:
            return "Izin lokasi tidak diberikan";
          case error.POSITION_UNAVAILABLE:
            return "Informasi lokasi tidak tersedia";
          case error.TIMEOUT:
            return "Waktu permintaan habis";
          default:
            return "Gagal mendapatkan lokasi";
        }
      }

      // Fungsi untuk beralih ke input manual
      function showManualEntry(message) {
        addressText.textContent = message;
        manualAddressBtn.click();
      }

      // Form submission handler
      document.getElementById('dataForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // ... validasi sebelumnya ...

        if (valid) {
          // Siapkan data lengkap dengan koordinat
          const userData = {
            phone: phone,
            address: address,
            method: currentLocationBtn.classList.contains('active') ? 'auto' : 'manual',
            coordinates: userCoordinates, // Sertakan koordinat jika ada
            accuracy: userCoordinates ? userCoordinates.accuracy : null,
            completed: true,
            timestamp: new Date().getTime()
          };

          // ... pengiriman data ke App Inventor ...
        }
      });

      // Default ke input manual
      manualAddressBtn.click();
    });
  </script>
</body>
</html>
