<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Data Users - Admin</title>
<style>
    body { font-family: Arial; padding: 20px; }
    input { padding: 8px; width: 320px; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; font-size: 14px; }
    th { background: #f2f2f2; }
    .loading { text-align: center; color: #666; padding: 20px; }
    .error { text-align: center; color: red; padding: 20px; }
    .pending { background-color: #fff3cd; }
    .success { background-color: #d1ecf1; }
    .blokir { background-color: #f8d7da; }
    .user-id { font-size: 12px; color: #666; }
    .btn-edit { background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px; }
    .btn-delete { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px; }
    .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: black; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], input[type="email"], select { width: 100%; padding: 8px; box-sizing: border-box; }
    .btn-save { background: #2196F3; color: white; border: none; padding: 10px 15px; border-radius: 3px; cursor: pointer; margin: 5px; }
    .btn-cancel { background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 3px; cursor: pointer; margin: 5px; }
    .stats { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .stat-card { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 120px; }
    .stat-value { font-size: 24px; font-weight: bold; }
    .stat-label { font-size: 12px; color: #666; }
</style>
</head>
<body>

<h3>Manajemen Data Users</h3>
<input id="searchInput" placeholder="Cari nama, email, telepon, atau alamat...">

<div class="stats">
    <div class="stat-card">
        <div class="stat-value" id="totalUsers">0</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="pendingUsers">0</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="successUsers">0</div>
        <div class="stat-label">Success</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="blokirUsers">0</div>
        <div class="stat-label">Diblokir</div>
    </div>
</div>

<table>
<thead>
<tr>
    <th>User ID</th>
    <th>Nama</th>
    <th>Email</th>
    <th>Telepon</th>
    <th>Alamat</th>
    <th>Jenis Kelamin</th>
    <th>Status</th>
    <th>Tanggal Daftar</th>
    <th>Aksi</th>
</tr>
</thead>
<tbody id="userTable">
    <tr><td colspan="9" class="loading">Memuat data users...</td></tr>
</tbody>
</table>

<!-- Modal Edit User -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Edit Data User</h3>
        <form id="editForm">
            <input type="hidden" id="editUserKey">
            
            <div class="form-group">
                <label>Nama:</label>
                <input type="text" id="editNama" required>
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="editEmail" required>
            </div>
            
            <div class="form-group">
                <label>Telepon:</label>
                <input type="text" id="editTelepon" required>
            </div>
            
            <div class="form-group">
                <label>Alamat:</label>
                <input type="text" id="editAlamat" required>
            </div>
            
            <div class="form-group">
                <label>Jenis Kelamin:</label>
                <select id="editJenisKelamin" required>
                    <option value="Laki-laki">Laki-laki</option>
                    <option value="Perempuan">Perempuan</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Status:</label>
                <select id="editStatus" required>
                    <option value="pending">Pending</option>
                    <option value="success">Success</option>
                    <option value="blokir">Blokir</option>
                </select>
            </div>
            
            <button type="submit" class="btn-save">Simpan Perubahan</button>
            <button type="button" class="btn-cancel" onclick="closeEditModal()">Batal</button>
        </form>
    </div>
</div>

<script>
// URL Firebase untuk users
const usersUrl = "https://ojeka-ba255-default-rtdb.firebaseio.com/users.json";

let allUsers = {};

// Function untuk memuat dan menampilkan data users
async function loadUsers() {
    try {
        const response = await fetch(usersUrl);
        const data = await response.json();
        
        const tbody = document.getElementById("userTable");
        
        if (!data) {
            tbody.innerHTML = '<tr><td colspan="9" class="loading">Tidak ada data users</td></tr>';
            updateStats(0, 0, 0, 0);
            return;
        }
        
        tbody.innerHTML = '';
        allUsers = data;
        
        // Convert object ke array dan tambahkan key sebagai user_id
        const usersArray = Object.entries(data).map(([userId, userData]) => {
            return {
                user_key: userId,
                user_id: userId,
                ...userData
            };
        });
        
        // Hitung statistik
        const stats = calculateStats(usersArray);
        updateStats(usersArray.length, stats.pending, stats.success, stats.blokir);
        
        if (usersArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="loading">Tidak ada data users</td></tr>';
            return;
        }
        
        // Urutkan berdasarkan tanggal daftar (terbaru pertama)
        usersArray.sort((a, b) => new Date(b.tanggalDaftar) - new Date(a.tanggalDaftar));
        
        usersArray.forEach(user => {
            const row = document.createElement("tr");
            
            // Format tanggal
            const registerDate = new Date(user.tanggalDaftar);
            const formattedDate = registerDate.toLocaleString('id-ID');
            
            // Tentukan class berdasarkan status
            row.className = user.status || 'pending';
            
            row.innerHTML = `
                <td><span class="user-id">${user.user_id || "-"}</span></td>
                <td><strong>${user.nama || "-"}</strong></td>
                <td>${user.email || "-"}</td>
                <td>${user.telepon || "-"}</td>
                <td>${user.alamat || "-"}</td>
                <td>${user.jenisKelamin || "-"}</td>
                <td><span class="status-${user.status}">${getStatusText(user.status)}</span></td>
                <td>${formattedDate}</td>
                <td>
                    <button class="btn-edit" onclick="editUser('${user.user_key}')">Edit</button>
                    <button class="btn-delete" onclick="deleteUser('${user.user_key}')">Hapus</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        setupSearch();
        console.log(`Data users loaded: ${usersArray.length} users`);
        
    } catch (error) {
        console.error("Error loading users data:", error);
        document.getElementById("userTable").innerHTML = 
            '<tr><td colspan="9" class="error">Gagal memuat data users: ' + error.message + '</td></tr>';
    }
}

// Fungsi untuk menghitung statistik
function calculateStats(usersArray) {
    const stats = {
        pending: 0,
        success: 0,
        blokir: 0
    };
    
    usersArray.forEach(user => {
        if (user.status === 'pending') stats.pending++;
        else if (user.status === 'success') stats.success++;
        else if (user.status === 'blokir') stats.blokir++;
        else stats.pending++; // Default jika status tidak ada
    });
    
    return stats;
}

// Fungsi untuk update statistik
function updateStats(total, pending, success, blokir) {
    document.getElementById("totalUsers").textContent = total;
    document.getElementById("pendingUsers").textContent = pending;
    document.getElementById("successUsers").textContent = success;
    document.getElementById("blokirUsers").textContent = blokir;
}

// Fungsi untuk mendapatkan teks status
function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'success': 'Success', 
        'blokir': 'Diblokir'
    };
    return statusMap[status] || 'Pending';
}

// Function untuk setup pencarian
function setupSearch() {
    const searchInput = document.getElementById("searchInput");
    const tbody = document.getElementById("userTable");
    
    searchInput.addEventListener("keyup", function() {
        const value = this.value.toLowerCase();
        const rows = tbody.getElementsByTagName("tr");
        
        for (let i = 0; i < rows.length; i++) {
            let rowText = rows[i].textContent || rows[i].innerText;
            rows[i].style.display = rowText.toLowerCase().includes(value) ? "" : "none";
        }
    });
}

// Modal functionality
const modal = document.getElementById("editModal");
const closeBtn = document.querySelector(".close");

closeBtn.onclick = () => modal.style.display = "none";

window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

function closeEditModal() {
    modal.style.display = "none";
}

// Fungsi edit user
function editUser(userKey) {
    const user = allUsers[userKey];
    
    if (!user) {
        alert('Data user tidak ditemukan!');
        return;
    }

    document.getElementById("editUserKey").value = userKey;
    document.getElementById("editNama").value = user.nama || '';
    document.getElementById("editEmail").value = user.email || '';
    document.getElementById("editTelepon").value = user.telepon || '';
    document.getElementById("editAlamat").value = user.alamat || '';
    document.getElementById("editJenisKelamin").value = user.jenisKelamin || 'Laki-laki';
    document.getElementById("editStatus").value = user.status || 'pending';
    
    modal.style.display = "block";
}

// Form submit untuk update user
document.getElementById("editForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    const userKey = document.getElementById("editUserKey").value;
    const updatedData = {
        nama: document.getElementById("editNama").value,
        email: document.getElementById("editEmail").value,
        telepon: document.getElementById("editTelepon").value,
        alamat: document.getElementById("editAlamat").value,
        jenisKelamin: document.getElementById("editJenisKelamin").value,
        status: document.getElementById("editStatus").value,
        updated_at: new Date().toISOString()
    };

    // Update data ke Firebase
    fetch(`https://ojeka-ba255-default-rtdb.firebaseio.com/users/${userKey}.json`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updatedData)
    })
    .then(response => response.json())
    .then(data => {
        alert('Data user berhasil diperbarui!');
        modal.style.display = "none";
        loadUsers(); // Reload data
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat memperbarui data.');
    });
});

// Fungsi hapus user
function deleteUser(userKey) {
    if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
        fetch(`https://ojeka-ba255-default-rtdb.firebaseio.com/users/${userKey}.json`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            alert('User berhasil dihapus!');
            loadUsers(); // Reload data
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat menghapus user.');
        });
    }
}

// Auto-refresh setiap 15 detik
function startAutoRefresh() {
    setInterval(loadUsers, 15000);
}

// Load data pertama kali
loadUsers();

// Mulai auto-refresh
startAutoRefresh();
</script>

</body>
</html>
