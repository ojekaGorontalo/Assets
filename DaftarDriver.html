<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Daftar Driver - JeGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    :root {
      --primary: #FF9800;    /* Orange */
      --secondary: #FF5722;   /* Red-Orange */
      --accent: #FFC107;     /* Amber/Yellow */
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #4CAF50;    /* Green */
      --danger: #f44336;     /* Red */
      --gray: #9E9E9E;       /* Gray */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.4;
      font-size: 0.85rem;
    }

    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo {
      width: 40px;
      height: 40px;
      background-color: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary);
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Container Styles */
    .container {
      max-width: 100%;
      padding: 15px;
    }

    .form-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
    }

    .form-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .vehicle-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .vehicle-option {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .vehicle-option:hover {
      border-color: var(--secondary);
    }

    .vehicle-option.selected {
      border-color: var(--primary);
      background-color: rgba(255, 152, 0, 0.05);
    }

    .vehicle-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .vehicle-name {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .vehicle-capacity {
      font-size: 0.75rem;
      color: #666;
      margin-top: 3px;
    }

    .terms-container {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
    }

    .terms-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .terms-content {
      font-size: 0.8rem;
      line-height: 1.5;
    }

    .terms-content p {
      margin-bottom: 10px;
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .checkbox-group input {
      margin-right: 10px;
      margin-top: 3px;
    }

    .checkbox-group label {
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .submit-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      width: 100%;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .submit-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Status Messages */
    .status-message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }

    .status-success {
      background-color: rgba(76, 175, 80, 0.1);
      color: #2e7d32;
      border: 1px solid #4CAF50;
    }

    .status-error {
      background-color: rgba(244, 67, 54, 0.1);
      color: #c62828;
      border: 1px solid #f44336;
    }

    .status-info {
      background-color: rgba(33, 150, 243, 0.1);
      color: #1565c0;
      border: 1px solid #2196F3;
    }

    .status-warning {
      background-color: rgba(255, 193, 7, 0.1);
      color: #ff8f00;
      border: 1px solid #FFC107;
    }

    /* File Upload Styles */
    .file-upload-container {
      background-color: rgba(255, 152, 0, 0.05);
      border: 2px dashed var(--primary);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .file-upload-container:hover {
      background-color: rgba(255, 152, 0, 0.1);
      border-color: var(--secondary);
    }

    .file-upload-container.dragover {
      background-color: rgba(255, 152, 0, 0.2);
      border-color: var(--accent);
    }

    .upload-icon {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .file-input {
      display: none;
    }

    .file-preview {
      margin-top: 15px;
      max-width: 200px;
      margin: 15px auto;
      display: none;
    }

    .file-preview img {
      width: 100%;
      border-radius: 6px;
      border: 2px solid var(--gray);
    }

    .upload-progress {
      margin-top: 10px;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      display: none;
    }

    .upload-progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--accent));
      width: 0%;
      transition: width 0.3s;
    }

    /* Success Section */
    .success-section {
      background-color: rgba(76, 175, 80, 0.1);
      border: 1px solid var(--success);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
      text-align: center;
    }

    .success-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--success);
    }

    .success-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .success-message {
      margin-bottom: 20px;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .whatsapp-btn {
      background: linear-gradient(to right, #25D366, #128C7E);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin-bottom: 10px;
    }

    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .whatsapp-icon {
      font-size: 1.2rem;
    }

    /* Loading spinner */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 152, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-title {
        font-size: 1rem;
      }
      
      body {
        font-size: 0.8rem;
      }
      
      .form-container {
        padding: 15px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .vehicle-options {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }
    }

    @media (max-width: 576px) {
      .container {
        padding: 10px;
      }
      
      .form-title {
        font-size: 1.3rem;
      }
      
      .vehicle-options {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo-container">
      <div class="logo">JG</div>
      <div class="header-title">JeGo - Daftar Driver</div>
    </div>
    <a href="list.html" class="back-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Kembali
    </a>
  </div>

  <!-- Container -->
  <div class="container">
    <div class="form-container">
      <h1 class="form-title">Form Pendaftaran Driver</h1>
      
      <div class="status-message" id="statusMessage"></div>
      
      <!-- Form Pendaftaran Awal -->
      <form id="driverForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="fullName">Nama Lengkap *</label>
            <input type="text" class="form-input" id="fullName" placeholder="Masukkan nama lengkap" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="phoneNumber">Nomor Telepon *</label>
            <input type="tel" class="form-input" id="phoneNumber" placeholder="Contoh: 08123456789" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input type="email" class="form-input" id="email" placeholder="Contoh: nama@email.com">
        </div>
        
        <div class="form-group">
          <label class="form-label" for="address">Alamat *</label>
          <input type="text" class="form-input" id="address" placeholder="Masukkan alamat lengkap" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Jenis Kendaraan *</label>
          <div class="vehicle-options">
            <div class="vehicle-option" data-type="motor">
              <div class="vehicle-icon">üèçÔ∏è</div>
              <div class="vehicle-name">Motor</div>
              <div class="vehicle-capacity">1 Penumpang</div>
            </div>
            <div class="vehicle-option" data-type="bentor">
              <div class="vehicle-icon">üõ∫</div>
              <div class="vehicle-name">Bentor</div>
              <div class="vehicle-capacity">3 Penumpang</div>
            </div>
            <div class="vehicle-option" data-type="mobil">
              <div class="vehicle-icon">üöó</div>
              <div class="vehicle-name">Mobil</div>
              <div class="vehicle-capacity">4 Penumpang</div>
            </div>
          </div>
          <input type="hidden" id="vehicleType" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="vehicleBrand">Merk Kendaraan *</label>
            <input type="text" class="form-input" id="vehicleBrand" placeholder="Contoh: Honda Beat" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="plateNumber">Plat Nomor *</label>
            <input type="text" class="form-input" id="plateNumber" placeholder="Contoh: B 1234 ABC" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="idCardNumber">Nomor KTP *</label>
          <input type="text" class="form-input" id="idCardNumber" placeholder="Masukkan nomor KTP" required>
        </div>
        
        <!-- Profile Photo Upload -->
        <div class="form-group">
          <label class="form-label">Foto Profil *</label>
          <p style="font-size: 0.8rem; color: var(--gray); margin-bottom: 10px;">
            Upload foto profil (wajah jelas, latar belakang netral). Maksimal 2MB.
          </p>
          
          <div class="file-upload-container" id="profileUploadContainer">
            <div class="upload-icon">üì∑</div>
            <p>Klik atau drag foto profil ke sini</p>
            <input type="file" class="file-input" id="profileFile" accept="image/*" required>
            <div class="upload-progress" id="profileProgress">
              <div class="upload-progress-bar" id="profileProgressBar"></div>
            </div>
          </div>
          <div class="file-preview" id="profilePreview"></div>
        </div>
        
        <!-- Document Upload Section -->
        <div class="form-group">
          <label class="form-label">Dokumen Pendukung *</label>
          <p style="font-size: 0.8rem; color: var(--gray); margin-bottom: 10px;">
            Upload foto KTP, SIM, dan STNK. Maksimal 2MB per file.
          </p>
          
          <!-- KTP Upload -->
          <div class="form-group">
            <label class="form-label">Foto KTP *</label>
            <div class="file-upload-container" id="ktpUploadContainer">
              <div class="upload-icon">üìÑ</div>
              <p>Klik atau drag file KTP ke sini</p>
              <input type="file" class="file-input" id="ktpFile" accept="image/*" required>
              <div class="upload-progress" id="ktpProgress">
                <div class="upload-progress-bar" id="ktpProgressBar"></div>
              </div>
            </div>
            <div class="file-preview" id="ktpPreview"></div>
          </div>
          
          <!-- SIM Upload -->
          <div class="form-group">
            <label class="form-label">Foto SIM *</label>
            <div class="file-upload-container" id="simUploadContainer">
              <div class="upload-icon">üìÑ</div>
              <p>Klik atau drag file SIM ke sini</p>
              <input type="file" class="file-input" id="simFile" accept="image/*" required>
              <div class="upload-progress" id="simProgress">
                <div class="upload-progress-bar" id="simProgressBar"></div>
              </div>
            </div>
            <div class="file-preview" id="simPreview"></div>
          </div>
          
          <!-- STNK Upload -->
          <div class="form-group">
            <label class="form-label">Foto STNK *</label>
            <div class="file-upload-container" id="stnkUploadContainer">
              <div class="upload-icon">üìÑ</div>
              <p>Klik atau drag file STNK ke sini</p>
              <input type="file" class="file-input" id="stnkFile" accept="image/*" required>
              <div class="upload-progress" id="stnkProgress">
                <div class="upload-progress-bar" id="stnkProgressBar"></div>
              </div>
            </div>
            <div class="file-preview" id="stnkPreview"></div>
          </div>
        </div>
        
        <div class="terms-container">
          <div class="terms-title">Syarat dan Ketentuan JeGo Driver</div>
          <div class="terms-content">
            <p>1. Driver harus memiliki SIM yang masih berlaku sesuai dengan jenis kendaraan yang digunakan.</p>
            <p>2. Kendaraan harus dalam kondisi baik, layak jalan, dan memiliki STNK yang masih berlaku.</p>
            <p>3. Driver harus berperilaku sopan dan menjaga etika selama melayani customer.</p>
            <p>4. Driver dilarang menolak order tanpa alasan yang jelas.</p>
            <p>5. Driver harus mematuhi peraturan lalu lintas yang berlaku.</p>
            <p>6. Driver bertanggung jawab atas keamanan dan keselamatan customer selama perjalanan.</p>
            <p>7. JeGo berhak menonaktifkan akun driver yang melanggar syarat dan ketentuan.</p>
            <p>8. Driver akan dikenakan sanksi jika melakukan penipuan atau tindakan yang merugikan customer.</p>
            <p>9. Semua transaksi harus dilakukan melalui aplikasi JeGo.</p>
            <p>10. Driver setuju untuk memberikan data pribadi yang diperlukan untuk keperluan verifikasi.</p>
          </div>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="agreeTerms" required>
          <label for="agreeTerms">Saya telah membaca dan menyetujui Syarat dan Ketentuan JeGo Driver</label>
        </div>
        
        <button type="submit" class="submit-btn" id="submitBtn">Daftar sebagai Driver</button>
      </form>
      
      <!-- Success Section -->
      <div class="success-section" id="successSection">
        <div class="success-icon">‚úÖ</div>
        <h2 class="success-title">Pendaftaran Berhasil!</h2>
        
        <div class="success-message">
          <p>Terima kasih telah mendaftar sebagai driver JeGo.</p>
          <p>Data Anda sedang diverifikasi oleh admin. Proses verifikasi membutuhkan waktu 1-2 hari kerja.</p>
          <p>Anda akan menerima notifikasi via WhatsApp setelah verifikasi selesai.</p>
        </div>
        
        <button class="whatsapp-btn" id="whatsappBtn">
          <span class="whatsapp-icon">üì±</span>
          Hubungi Admin JeGo
        </button>
        
        <p style="font-size: 0.8rem; color: #666; margin-top: 15px;">
          Nomor Admin: 083142889149<br>
          Jam Operasional: 08:00 - 17:00 WITA
        </p>
        
        <a href="list.html" class="submit-btn" style="background: var(--gray); margin-top: 10px;">
          Kembali ke Halaman Utama
        </a>
      </div>
    </div>
  </div>

  <script>
    // ================================================
    // KONFIGURASI FIREBASE (SAMA DENGAN registrasi_jego.html)
    // ================================================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
      authDomain: "game-balap-simpel.firebaseapp.com",
      databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
      projectId: "game-balap-simpel",
      storageBucket: "game-balap-simpel.firebasestorage.app",
      messagingSenderId: "864576853495",
      appId: "1:864576853495:web:6f16eb757fd3d8affb0af2",
      measurementId: "G-YWJPK7Y3J4"
    };

    // ================================================
    // INISIALISASI FIREBASE
    // ================================================
    firebase.initializeApp(FIREBASE_CONFIG);
    const database = firebase.database();
    const storage = firebase.storage();
    const auth = firebase.auth();

    // ================================================
    // FUNGSI UTILITAS
    // ================================================
    
    // Generate driver ID dengan format: jego + 8 digit angka + 3 huruf
    function generateDriverId() {
      const digits = '0123456789';
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let numPart = '';
      let letterPart = '';
      
      // Generate 8 digit angka
      for (let i = 0; i < 8; i++) {
        numPart += digits.charAt(Math.floor(Math.random() * digits.length));
      }
      
      // Generate 3 huruf kapital
      for (let i = 0; i < 3; i++) {
        letterPart += letters.charAt(Math.floor(Math.random() * letters.length));
      }
      
      return 'JEGO' + numPart + letterPart;
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = 'status-message';
      statusElement.classList.add(`status-${type}`);
      statusElement.style.display = 'block';
      
      // Auto hide success messages after 5 seconds
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    // Validate form data
    function validateForm(formData) {
      // Check required fields
      const requiredFields = [
        'fullName', 'phoneNumber', 'address', 'vehicleType', 
        'vehicleBrand', 'plateNumber', 'idCardNumber'
      ];
      
      for (const field of requiredFields) {
        if (!formData[field] || formData[field].trim() === '') {
          return `Field ${field} harus diisi`;
        }
      }
      
      // Validate phone number (minimal 10 digit)
      const phoneRegex = /^[0-9]{10,}$/;
      if (!phoneRegex.test(formData.phoneNumber.replace(/\D/g, ''))) {
        return 'Nomor telepon tidak valid';
      }
      
      // Validate email if provided
      if (formData.email && formData.email.trim() !== '') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
          return 'Format email tidak valid';
        }
      }
      
      // Validate ID card number (minimal 16 digit)
      const idCardRegex = /^[0-9]{16,}$/;
      if (!idCardRegex.test(formData.idCardNumber.replace(/\D/g, ''))) {
        return 'Nomor KTP harus terdiri dari 16 digit angka';
      }
      
      return null; // No errors
    }

    // Upload file to Firebase Storage
    async function uploadFile(file, path, progressBar) {
      return new Promise((resolve, reject) => {
        // Set metadata untuk gambar
        const metadata = {
          contentType: file.type,
          customMetadata: {
            uploadedBy: 'driver_registration',
            timestamp: Date.now().toString()
          }
        };
        
        const storageRef = storage.ref(path);
        const uploadTask = storageRef.put(file, metadata);
        
        uploadTask.on('state_changed',
          (snapshot) => {
            // Progress monitoring
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log(`Upload is ${progress}% done`);
            
            if (progressBar) {
              progressBar.style.width = progress + '%';
            }
          },
          (error) => {
            console.error('Upload error:', error);
            reject(error);
          },
          async () => {
            try {
              const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
              resolve(downloadURL);
            } catch (error) {
              reject(error);
            }
          }
        );
      });
    }

    // Setup file upload functionality
    function setupFileUpload(uploadContainerId, fileInputId, previewId, progressId, progressBarId) {
      const uploadContainer = document.getElementById(uploadContainerId);
      const fileInput = document.getElementById(fileInputId);
      const preview = document.getElementById(previewId);
      const progress = document.getElementById(progressId);
      const progressBar = document.getElementById(progressBarId);
      
      // Click container to trigger file input
      uploadContainer.addEventListener('click', () => {
        fileInput.click();
      });
      
      // Handle file input change
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          // Validate file size (max 2MB)
          if (file.size > 2 * 1024 * 1024) {
            showStatus('File terlalu besar. Maksimal 2MB', 'error');
            fileInput.value = '';
            return;
          }
          
          // Validate file type
          if (!file.type.startsWith('image/')) {
            showStatus('File harus berupa gambar', 'error');
            fileInput.value = '';
            return;
          }
          
          // Show preview
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Drag and drop functionality
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        uploadContainer.classList.add('dragover');
      }
      
      function unhighlight() {
        uploadContainer.classList.remove('dragover');
      }
      
      uploadContainer.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          const file = files[0];
          
          // Validate file
          if (file.size > 2 * 1024 * 1024) {
            showStatus('File terlalu besar. Maksimal 2MB', 'error');
            return;
          }
          
          if (!file.type.startsWith('image/')) {
            showStatus('File harus berupa gambar', 'error');
            return;
          }
          
          fileInput.files = files;
          fileInput.dispatchEvent(new Event('change'));
        }
      }
      
      return {
        uploadContainer,
        fileInput,
        preview,
        progress,
        progressBar
      };
    }

    // ================================================
    // INISIALISASI ELEMEN DAN EVENT HANDLERS
    // ================================================
    
    // Setup file uploads
    const profileUpload = setupFileUpload('profileUploadContainer', 'profileFile', 'profilePreview', 'profileProgress', 'profileProgressBar');
    const ktpUpload = setupFileUpload('ktpUploadContainer', 'ktpFile', 'ktpPreview', 'ktpProgress', 'ktpProgressBar');
    const simUpload = setupFileUpload('simUploadContainer', 'simFile', 'simPreview', 'simProgress', 'simProgressBar');
    const stnkUpload = setupFileUpload('stnkUploadContainer', 'stnkFile', 'stnkPreview', 'stnkProgress', 'stnkProgressBar');

    // Handle vehicle selection
    document.querySelectorAll('.vehicle-option').forEach(option => {
      option.addEventListener('click', function() {
        // Remove selected class from all options
        document.querySelectorAll('.vehicle-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Add selected class to clicked option
        this.classList.add('selected');
        
        // Set the hidden input value
        document.getElementById('vehicleType').value = this.getAttribute('data-type');
      });
    });

    // Handle form submission
    document.getElementById('driverForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Mendaftarkan...';
      
      try {
        // Validate required files
        const requiredFiles = [
          { name: 'Foto Profil', file: profileUpload.fileInput.files[0], upload: profileUpload },
          { name: 'KTP', file: ktpUpload.fileInput.files[0], upload: ktpUpload },
          { name: 'SIM', file: simUpload.fileInput.files[0], upload: simUpload },
          { name: 'STNK', file: stnkUpload.fileInput.files[0], upload: stnkUpload }
        ];
        
        for (const reqFile of requiredFiles) {
          if (!reqFile.file) {
            showStatus(`Harap upload ${reqFile.name}`, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Daftar sebagai Driver';
            return;
          }
        }
        
        // Collect form data
        const driverId = generateDriverId();
        const formData = {
          fullName: document.getElementById('fullName').value.trim(),
          phoneNumber: document.getElementById('phoneNumber').value.trim(),
          email: document.getElementById('email').value.trim(),
          address: document.getElementById('address').value.trim(),
          vehicleType: document.getElementById('vehicleType').value,
          vehicleBrand: document.getElementById('vehicleBrand').value.trim(),
          plateNumber: document.getElementById('plateNumber').value.trim(),
          idCardNumber: document.getElementById('idCardNumber').value.trim(),
          registrationDate: new Date().toISOString(),
          registrationTimestamp: Date.now(),
          status: 'pending', // pending, verified, rejected
          driverId: driverId,
          profilePhotoUrl: '',
          
          // Saldo dan potongan
          Balance: 25000, // Saldo awal Rp 25.000
          Potongan: 10,  // Potongan 10%
          
          // Statistik driver
          totalOrders: 0,
          completedOrders: 0,
          totalEarnings: 0,
          avgRating: 5.0,
          ratingCount: 1,
          completionRate: '0%',
          isOnline: false,
          onTrip: false,
          
          // Dokumen (akan diisi setelah upload)
          ktpPhotoUrl: '',
          simPhotoUrl: '',
          stnkPhotoUrl: ''
        };
        
        // Validate form data
        const validationError = validateForm(formData);
        if (validationError) {
          showStatus(validationError, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Daftar sebagai Driver';
          return;
        }
        
        // Show uploading status
        showStatus('Mengupload foto dan dokumen...', 'info');
        
        // Upload semua file sekaligus dengan Promise.all
        const uploadPromises = [];
        
        // Upload Foto Profil
        profileUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            profileUpload.fileInput.files[0], 
            `drivers/${driverId}/profile_${Date.now()}.jpg`,
            profileUpload.progressBar
          ).then(url => { formData.profilePhotoUrl = url; })
        );
        
        // Upload KTP
        ktpUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            ktpUpload.fileInput.files[0], 
            `drivers/${driverId}/ktp_${Date.now()}.jpg`,
            ktpUpload.progressBar
          ).then(url => { formData.ktpPhotoUrl = url; })
        );
        
        // Upload SIM
        simUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            simUpload.fileInput.files[0], 
            `drivers/${driverId}/sim_${Date.now()}.jpg`,
            simUpload.progressBar
          ).then(url => { formData.simPhotoUrl = url; })
        );
        
        // Upload STNK
        stnkUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            stnkUpload.fileInput.files[0], 
            `drivers/${driverId}/stnk_${Date.now()}.jpg`,
            stnkUpload.progressBar
          ).then(url => { formData.stnkPhotoUrl = url; })
        );
        
        // Tunggu semua upload selesai
        await Promise.all(uploadPromises);
        
        // Save to Firebase Realtime Database
        showStatus('Menyimpan data driver...', 'info');
        const driversRef = database.ref('drivers');
        await driversRef.child(driverId).set(formData);
        
        // Juga simpan di path lain untuk kemudahan akses
        await database.ref(`driver_by_phone/${formData.phoneNumber.replace(/\D/g, '')}`).set({
          driverId: driverId,
          name: formData.fullName,
          status: 'pending'
        });
        
        // Simpan ke localStorage
        localStorage.setItem('jego_driver_data', JSON.stringify(formData));
        
        // Tampilkan pesan sukses
        showStatus('Pendaftaran berhasil! Data Anda sedang diverifikasi.', 'success');
        
        // Kirim data ke Kodular
        sendToKodular({
          action: 'driver_registered',
          driver_id: driverId,
          full_name: formData.fullName,
          phone_number: formData.phoneNumber,
          vehicle_type: formData.vehicleType,
          initial_balance: formData.Balance,
          potongan_percentage: formData.Potongan,
          status: 'pending'
        });
        
        // Sembunyikan form dan tampilkan success section
        document.getElementById('driverForm').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';
        
      } catch (error) {
        console.error('Error saving driver data:', error);
        
        let errorMessage = 'Terjadi kesalahan saat menyimpan data. ';
        if (error.code === 'storage/unauthorized') {
          errorMessage = '‚ö†Ô∏è ERROR: Akses storage ditolak. Silakan hubungi administrator untuk mengatur Firebase Storage Rules.';
          showStatus(errorMessage, 'error');
          
          // Tampilkan instruksi untuk admin
          setTimeout(() => {
            showStatus(
              'Admin: Buka Firebase Console ‚Üí Storage ‚Üí Rules ‚Üí Ubah rules menjadi: allow read, write: if true; (untuk development)',
              'warning'
            );
          }, 3000);
        } else if (error.code === 'storage/canceled') {
          errorMessage += 'Upload dibatalkan.';
          showStatus(errorMessage, 'error');
        } else {
          errorMessage += 'Silakan coba lagi. ' + (error.message || '');
          showStatus(errorMessage, 'error');
        }
        
        submitBtn.disabled = false;
        submitBtn.textContent = 'Daftar sebagai Driver';
      }
    });

    // Handle WhatsApp button
    document.getElementById('whatsappBtn').addEventListener('click', function() {
      const driverData = JSON.parse(localStorage.getItem('jego_driver_data') || '{}');
      
      const message = `Halo Admin JeGo, saya ${driverData.fullName || 'calon driver'} ingin menanyakan status verifikasi pendaftaran driver saya.`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/6283142889149?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
    });

    // Fungsi untuk mengirim data ke Kodular
    function sendToKodular(data) {
      console.log('Mengirim data ke Kodular:', data);
      
      // METODE 1: Menggunakan window.AppInventor.setWebViewString
      if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
        try {
          window.AppInventor.setWebViewString(JSON.stringify(data));
          console.log('‚úÖ Data berhasil dikirim ke Kodular via AppInventor.setWebViewString');
        } catch (error) {
          console.error('Error mengirim data via AppInventor:', error);
        }
      }
      // METODE 2: Menggunakan window.android (Android WebView)
      else if (typeof window.android !== 'undefined' && window.android.receiveData) {
        try {
          window.android.receiveData(JSON.stringify(data));
          console.log('‚úÖ Data berhasil dikirim ke Kodular via window.android');
        } catch (error) {
          console.error('Error mengirim data via window.android:', error);
        }
      }
      // METODE 3: Menggunakan window.webkit.messageHandlers (iOS WebView)
      else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.observe) {
        try {
          window.webkit.messageHandlers.observe.postMessage(data);
          console.log('‚úÖ Data berhasil dikirim ke Kodular via webkit.messageHandlers');
        } catch (error) {
          console.error('Error mengirim data via webkit.messageHandlers:', error);
        }
      }
      else {
        console.warn('‚ùå Tidak ada metode yang berhasil mengirim data ke Kodular');
        console.log('Data yang gagal dikirim:', data);
      }
    }

    // Cek status driver saat halaman dimuat
    function checkDriverStatus() {
      const driverData = JSON.parse(localStorage.getItem('jego_driver_data') || '{}');
      
      if (driverData.driverId && driverData.status === 'pending') {
        // Jika sudah mendaftar dan status pending
        document.getElementById('driverForm').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';
        
        showStatus('Anda sudah mendaftar. Status: Menunggu verifikasi admin.', 'info');
      }
    }

    // Inisialisasi saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
      checkDriverStatus();
    });
  </script>
</body>
</html>
