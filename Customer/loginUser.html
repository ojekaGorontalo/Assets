<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Login - JeGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDK (Compat) hanya untuk Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    /* Gaya konsisten dengan JeGo (salin dari kode sebelumnya) */
    :root { --primary: #FF9800; --secondary: #FF5722; --accent: #FFC107; --dark: #343a40; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; font-size: 0.9rem; }
    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .logo { width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; color: var(--dark); }
    .header-title { font-size: 1.2rem; font-weight: 600; }
    .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }
    .form-container { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .form-title { font-size: 1.5rem; font-weight: 600; color: var(--primary); text-align: center; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--dark); }
    .form-input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
    .form-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(255,152,0,0.1); }
    .submit-btn { background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; padding: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; transition: 0.3s; }
    .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    .secondary-btn { background: transparent; color: var(--primary); border: 1px solid var(--primary); border-radius: 8px; padding: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
    .status-message { padding: 12px; border-radius: 6px; margin-bottom: 15px; display: none; }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .otp-section { display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
    .otp-single-input { width: 100%; padding: 15px; text-align: center; font-size: 2rem; letter-spacing: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace; margin-bottom: 15px; }
    .otp-single-input:focus { border-color: var(--primary); }
    .resend-otp { text-align: center; margin-top: 10px; }
    .resend-link { color: var(--primary); cursor: pointer; text-decoration: underline; }
    .resend-link.disabled { color: #999; cursor: not-allowed; text-decoration: none; }
    .progress-container { height: 4px; background: #e0e0e0; margin: 10px 0; display: none; }
    .progress-bar { height: 100%; background: linear-gradient(to right, var(--primary), var(--secondary)); width: 0%; }
    .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); display: none; max-width: 300px; z-index: 1000; }
    #recaptcha-container { margin: 20px 0; display: flex; justify-content: center; display: none; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">JG</div>
    <div class="header-title">JeGo - Login</div>
  </div>

  <div class="container">
    <div class="form-container">
      <h1 class="form-title">Masuk ke JeGo</h1>

      <!-- Status Message -->
      <div class="status-message" id="statusMessage"></div>

      <!-- Progress -->
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- Form Login -->
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="teleponInput">Nomor Telepon</label>
          <input type="tel" class="form-input" id="teleponInput" placeholder="08123456789" required inputmode="numeric">
        </div>
        <button type="submit" class="submit-btn" id="loginBtn">Kirim Kode OTP</button>
        <button type="button" class="secondary-btn" id="registerBtn" onclick="window.location.href='registrasi_jego.html'">Belum punya akun? Daftar</button>
      </form>

      <!-- OTP Verification -->
      <div class="otp-section" id="otpSection">
        <h2 style="font-size: 1.3rem; text-align: center;">Verifikasi OTP</h2>
        <input type="text" class="otp-single-input" id="otpInput" maxlength="6" inputmode="numeric" placeholder="000000">
        <button class="submit-btn" id="verifyOtpBtn">Verifikasi OTP</button>
        <div class="resend-otp">
          <span class="resend-link" id="resendOtpLink">Kirim ulang OTP</span>
          <span id="countdownText" style="display: none;"> (Tunggu <span id="countdown">60</span> detik)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifikasi Popup -->
  <div class="notification" id="notificationPopup">
    <div id="notificationTitle"></div>
    <div id="notificationMessage"></div>
  </div>

  <script>
    // ================= KONFIGURASI =================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
      authDomain: "game-balap-simpel.firebaseapp.com",
      databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
      projectId: "game-balap-simpel",
      storageBucket: "game-balap-simpel.firebasestorage.app",
      messagingSenderId: "864576853495",
      appId: "1:864576853495:web:6f16eb757fd3d8affb0af2"
    };

    // ========== KONFIGURASI GATEWAY SMS (DIRECT) ==========
    // ðŸ”´ PERHATIAN: Kredensial akan terlihat di source code! Gunakan hanya untuk development.
    const SMS_GATEWAY_CONFIG = {
      user: 'gsmreload',
      pass: 'Jd59dm$jr*dj^hy',  // pastikan password sudah di-encode jika perlu
      baseUrl: 'https://srv2.soufasms.com/sms_gateway/'
    };

    // ================= GLOBAL =================
    let firebaseDatabase;
    let currentPhone = ''; // menyimpan nomor untuk resend dan verifikasi

    // ================= UTILITAS =================
    function showNotif(title, msg, type = 'info') {
      const n = document.getElementById('notificationPopup');
      document.getElementById('notificationTitle').innerText = title;
      document.getElementById('notificationMessage').innerText = msg;
      n.className = `notification ${type}`;
      n.style.display = 'block';
      setTimeout(() => n.style.display = 'none', 4000);
    }

    function showStatus(msg, type) {
      const el = document.getElementById('statusMessage');
      el.innerText = msg;
      el.className = `status-message status-${type}`;
      el.style.display = 'block';
      if (type === 'success') setTimeout(() => el.style.display = 'none', 5000);
    }

    function showProgress(percent) {
      document.getElementById('progressContainer').style.display = 'block';
      document.getElementById('progressBar').style.width = percent + '%';
    }
    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
    }

    function formatPhoneNumber(phone) {
      let cleaned = phone.replace(/\D/g, '');
      if (cleaned.startsWith('0')) cleaned = '+62' + cleaned.substring(1);
      else if (cleaned.startsWith('62')) cleaned = '+' + cleaned;
      else if (!cleaned.startsWith('+')) cleaned = '+62' + cleaned;
      return cleaned;
    }

    function validatePhoneFormat(phone) {
      return /^\+62[0-9]{9,12}$/.test(phone);
    }

    function startResendCountdown(seconds) {
      const link = document.getElementById('resendOtpLink');
      const cdText = document.getElementById('countdownText');
      const cdSpan = document.getElementById('countdown');
      link.classList.add('disabled');
      cdText.style.display = 'inline';
      let count = seconds;
      cdSpan.innerText = count;
      const interval = setInterval(() => {
        count--;
        cdSpan.innerText = count;
        if (count <= 0) {
          clearInterval(interval);
          link.classList.remove('disabled');
          cdText.style.display = 'none';
        }
      }, 1000);
    }

    // Generate OTP 6 digit acak
    function generateOTP() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // ================= FIREBASE INIT =================
    async function initFirebase() {
      if (typeof firebase === 'undefined') throw new Error('Firebase SDK not loaded');
      firebase.initializeApp(FIREBASE_CONFIG);
      firebaseDatabase = firebase.database();
    }

    // ================= LOGIKA OTP =================

    // Cek apakah nomor masih diizinkan mengirim OTP (maks 3x dalam 10 menit)
    async function canSendOTP(phone) {
      const ref = firebaseDatabase.ref('otp_verification/' + phone.replace(/\+/g, '_'));
      const snap = await ref.child('requests').once('value');
      const requests = snap.val() || [];
      const now = Date.now();
      const tenMinutesAgo = now - 10 * 60 * 1000;
      const recentRequests = requests.filter(ts => ts > tenMinutesAgo);
      return recentRequests.length < 3;
    }

    // Simpan OTP ke database dan catat waktu permintaan
    async function saveOTP(phone, code) {
      const path = 'otp_verification/' + phone.replace(/\+/g, '_');
      const ref = firebaseDatabase.ref(path);
      const now = Date.now();
      const expiresAt = now + 5 * 60 * 1000; // 5 menit

      // Ambil data requests yang ada
      const snap = await ref.child('requests').once('value');
      let requests = snap.val() || [];
      requests = requests.filter(ts => ts > now - 10 * 60 * 1000); // hanya simpan 10 menit terakhir
      requests.push(now);

      await ref.set({
        code: code,
        created_at: now,
        expires_at: expiresAt,
        requests: requests
      });
    }

    // Kirim OTP langsung ke gateway SMS via GET (kredensial terekspos!)
    async function sendOTPviaDirectGateway(phone, code) {
      const message = `Kode OTP Anda adalah ${code}`;
      // Hapus karakter '+' dari nomor untuk gateway (biasanya tidak pakai +)
      const no = phone.replace('+', '');
      // Encode komponen URL
      const params = new URLSearchParams({
        user: SMS_GATEWAY_CONFIG.user,
        pass: SMS_GATEWAY_CONFIG.pass,
        no: no,
        msg: message,
        max: '1'
      });
      const url = `${SMS_GATEWAY_CONFIG.baseUrl}?${params.toString()}`;

      try {
        // Gunakan mode 'no-cors' untuk menghindari blokir CORS, tapi response tidak bisa dibaca.
        // Alternatif: jika gateway mendukung CORS, bisa gunakan mode 'cors'.
        const response = await fetch(url, { mode: 'no-cors' });
        // Karena mode 'no-cors', kita tidak bisa tahu apakah sukses atau gagal.
        // Kita asumsikan sukses.
        console.log('OTP dikirim (mode no-cors, tidak ada validasi)');
        return true;
      } catch (e) {
        console.error('Gagal mengirim OTP:', e);
        showStatus('Gagal mengirim OTP. Periksa koneksi internet.', 'error');
        return false;
      }
    }

    // Kirim OTP (alur utama)
    async function sendOTP(phone) {
      try {
        // Cek batas kirim
        const allowed = await canSendOTP(phone);
        if (!allowed) {
          showStatus('Terlalu banyak permintaan OTP. Coba lagi nanti.', 'error');
          return false;
        }

        const code = generateOTP();
        // Simpan ke database
        await saveOTP(phone, code);

        // Kirim via gateway langsung
        const sent = await sendOTPviaDirectGateway(phone, code);
        if (!sent) {
          // Jika gagal kirim, hapus data OTP yang baru disimpan
          await firebaseDatabase.ref('otp_verification/' + phone.replace(/\+/g, '_')).remove();
          return false;
        }

        showStatus('OTP terkirim!', 'success');
        return true;
      } catch (e) {
        showStatus('Gagal kirim OTP: ' + e.message, 'error');
        return false;
      }
    }

    // Verifikasi kode OTP
    async function verifyOTP(phone, code) {
      const path = 'otp_verification/' + phone.replace(/\+/g, '_');
      const ref = firebaseDatabase.ref(path);
      const snap = await ref.once('value');
      const data = snap.val();
      if (!data) {
        showStatus('Kode OTP tidak ditemukan. Silakan kirim ulang.', 'error');
        return null;
      }

      const now = Date.now();
      if (now > data.expires_at) {
        showStatus('Kode OTP sudah kadaluarsa. Silakan kirim ulang.', 'error');
        await ref.remove();
        return null;
      }

      if (data.code !== code) {
        showStatus('Kode OTP salah.', 'error');
        return null;
      }

      // OTP benar, hapus data OTP
      await ref.remove();

      // Ambil data user dari database berdasarkan nomor telepon
      const usersRef = firebaseDatabase.ref('users');
      const snapshot = await usersRef.orderByChild('phone').equalTo(phone).once('value');
      const users = snapshot.val();
      if (!users) {
        showStatus('Nomor tidak terdaftar. Silakan daftar.', 'error');
        return null;
      }
      const uid = Object.keys(users)[0];
      const dbUser = users[uid];
      return { uid, ...dbUser };
    }

    // ================= HANDLER LOGIN =================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const phoneInput = document.getElementById('teleponInput').value.trim();
      if (!phoneInput) return showStatus('Masukkan nomor telepon', 'error');

      const phone = formatPhoneNumber(phoneInput);
      if (!validatePhoneFormat(phone)) return showStatus('Format nomor tidak valid (contoh: 08123456789)', 'error');

      const btn = document.getElementById('loginBtn');
      btn.disabled = true; btn.innerText = 'Mengirim...';
      showProgress(30);

      try {
        const sent = await sendOTP(phone);
        if (sent) {
          currentPhone = phone;
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('otpSection').style.display = 'block';
          document.getElementById('otpInput').focus();
          startResendCountdown(60);
          showProgress(100);
        }
      } catch (err) {
        showStatus('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.innerText = 'Kirim Kode OTP';
        hideProgress();
      }
    });

    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
      const otp = document.getElementById('otpInput').value;
      if (otp.length !== 6) return showStatus('Masukkan 6 digit OTP', 'error');

      const btn = document.getElementById('verifyOtpBtn');
      btn.disabled = true; btn.innerText = 'Memverifikasi...';

      try {
        const userData = await verifyOTP(currentPhone, otp);
        if (!userData) {
          btn.disabled = false; btn.innerText = 'Verifikasi OTP';
          return;
        }

        // Buat session
        const session = {
          userId: userData.uid,
          uid: userData.uid,
          name: userData.name || '',
          phone: userData.phone || currentPhone,
          email: userData.email || '',
          status: userData.status || 'active',
          photoURL: userData.fotoProfilURL || '',
          rating: userData.rating || 5,
          perjalanan: userData.perjalanan || 0
        };

        localStorage.setItem('jego_logged_in_user', JSON.stringify(session));

        showStatus('Login berhasil! Mengalihkan...', 'success');
        setTimeout(() => window.location.href = 'jenis_kenderaan.html', 1500);
      } catch (err) {
        showStatus('Gagal verifikasi: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.innerText = 'Verifikasi OTP';
      }
    });

    document.getElementById('resendOtpLink').addEventListener('click', async function() {
      if (this.classList.contains('disabled') || !currentPhone) return;
      this.classList.add('disabled');
      await sendOTP(currentPhone);
      startResendCountdown(60);
    });

    // ================= INIT =================
    window.onload = async () => {
      // Bersihkan key lama
      ['user', 'currentUser', 'jegoUser'].forEach(k => localStorage.removeItem(k));

      try {
        await initFirebase();

        // Cek session aktif
        const session = localStorage.getItem('jego_logged_in_user');
        if (session) {
          const user = JSON.parse(session);
          showStatus(`Selamat datang kembali, ${user.name}`, 'info');
          setTimeout(() => window.location.href = 'jenis_kenderaan.html', 1500);
        }
      } catch (e) {
        showNotif('Error', 'Gagal inisialisasi Firebase', 'error');
      }
    };
  </script>
</body>
</html>