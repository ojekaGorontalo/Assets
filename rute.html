<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rute - JeGo</title>
    
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <style>
        /* CSS TIDAK DIUBAH - tetap sama */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #FF4A1C;
            --secondary: #FFD400;
            --accent: #e6dd3b;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --confirm-height: 56px;
            --confirm-gap: 8px;
            --confirm-bottom: 20px;
        }

        body {
            background-color: var(--secondary);
            color: #333;
            min-height: 100vh;
        }

        /* Map Container */
        #map-container {
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Panel Styles - Diposisikan di paling atas */
        .panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            z-index: 100;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            box-sizing: border-box;
        }

        .input-container {
            position: relative;
            margin-bottom: 12px;
        }

        input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            font-size: 14px;
            box-sizing: border-box;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 74, 28, 0.1);
        }

        .clear-btn {
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-mode-btn {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 600;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        .map-mode-btn:hover {
            background: #ff3a0c;
            transform: translateY(-2px);
        }

        /* Detail Rute Styles */
        .route-details {
            position: absolute;
            bottom: calc(var(--confirm-bottom) + var(--confirm-height) + var(--confirm-gap));
            left: 10px;
            right: 10px;
            background: #fff;
            border-radius: 12px;
            padding: 8px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 99;
            max-height: 30vh;
            overflow-y: auto;
            display: none;
            transition: all 0.25s ease;
            border-left: 4px solid var(--primary);
        }

        .route-info {
            margin-bottom: 8px;
        }

        .route-address {
            display: flex;
            align-items: flex-start;
            margin-bottom: 5px;
            font-size: 0.8rem;
            position: relative;
        }

        .route-address .label {
            min-width: 70px;
            color: var(--primary);
            font-weight: 600;
            margin-right: 8px;
        }

        .route-address .value {
            flex: 1;
            color: var(--dark);
            margin-right: 8px;
            line-height: 1.3;
        }

        .route-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }

        .route-stat {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
        }

        .price-highlight {
            font-weight: 700;
            color: var(--success);
            font-size: 1.1rem;
        }

        /* Tombol Konfirmasi */
        .confirm-btn {
            position: absolute;
            bottom: var(--confirm-bottom);
            left: 10px;
            right: 10px;
            background: linear-gradient(to right, var(--primary), #ff3a0c);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 101;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
            background: linear-gradient(to right, #ff3a0c, var(--primary));
        }

        .confirm-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Tombol Batalkan */
        .cancel-btn {
            position: absolute;
            bottom: 20px;
            left: 10px;
            right: 10px;
            background: linear-gradient(to right, var(--danger), #e74c3c);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            z-index: 101;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            display: none;
            font-family: 'Poppins', sans-serif;
        }

        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }

        .cancel-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Radar Loading */
        .radar {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            transform: translate(-50%, -50%);
            z-index: 999;
            transition: all 2s ease-in-out;
            display: none;
        }

        .radar.expanding {
            width: 300px;
            height: 300px;
        }

        .radar::before, .radar::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary);
            border-radius: 50%;
            animation: radarPulse 3s infinite ease-out;
        }

        .radar::after {
            animation-delay: 1.5s;
        }

        .radar span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary);
            font-weight: bold;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            font-size: 14px;
            white-space: nowrap;
        }

        @keyframes radarPulse {
            0% { transform: scale(0.4); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* Notifikasi Status */
        .search-status {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 600;
            text-align: center;
            max-width: 80%;
            border-left: 4px solid var(--primary);
        }

        /* POPUP STYLES */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .popup-overlay.active .popup {
            transform: scale(1);
        }

        .popup-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .popup-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-content {
            padding: 20px;
            text-align: center;
        }

        .popup-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .popup-message {
            font-size: 16px;
            line-height: 1.5;
            color: var(--dark);
            margin-bottom: 20px;
        }

        .popup-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .popup-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
            font-family: 'Poppins', sans-serif;
        }

        .popup-button-primary {
            background: linear-gradient(135deg, var(--primary), #ff3a0c);
            color: white;
        }

        .popup-button-secondary {
            background: #f8f9fa;
            color: var(--dark);
            border: 1px solid #ddd;
        }

        .popup-button-warning {
            background: linear-gradient(135deg, var(--warning), #ff9800);
            color: white;
        }

        .popup-button-danger {
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            color: white;
        }

        .popup-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Penawaran Driver */
        #driverOffers {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 420px;
            z-index: 99999;
            display: none;
        }

        #driverOffers > div {
            background: rgba(255,255,255,0.98);
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.12);
            overflow: hidden;
        }

        #driverOffers > div > div:first-child {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        #driverOffers > div > div:first-child strong {
            font-weight: 600;
        }

        #driverOffers > div > div:first-child button {
            background: none;
            border: none;
            font-weight: 600;
            cursor: pointer;
            color: white;
            font-size: 18px;
        }

        #driverOfferList {
            max-height: 60vh;
            overflow: auto;
            padding: 12px;
        }

        /* Driver Offer Card */
        .driver-offer-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            min-height: 70px;
            overflow: hidden;
        }

        .driver-offer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .driver-info {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .driver-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e9ecef;
            flex-shrink: 0;
        }

        .driver-details {
            flex: 1;
            min-width: 0;
            max-width: calc(100% - 90px);
            overflow: hidden;
        }

        .driver-name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            max-width: 100%;
            overflow: hidden;
        }

        .driver-name-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .driver-vehicle {
            font-size: 12px;
            color: #444;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .driver-rating-container {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #666;
            flex-wrap: wrap;
            max-width: 100%;
        }

        .accept-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 12px;
            min-width: 70px;
            transition: all 0.3s;
            flex-shrink: 0;
            white-space: nowrap;
            font-family: 'Poppins', sans-serif;
        }

        .accept-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --confirm-height: 64px;
                --confirm-bottom: 15px;
            }
            
            .panel {
                top: 5px;
                left: 5px;
                right: 5px;
                padding: 12px;
            }
            
            .route-details {
                left: 5px;
                right: 5px;
                max-height: 28vh;
                padding: 6px 10px;
            }
            
            .confirm-btn, .cancel-btn {
                left: 5px;
                right: 5px;
            }
            
            .radar.expanding {
                width: 200px;
                height: 200px;
            }
            
            .radar span {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .map-mode-btn {
                bottom: 80px;
                right: 10px;
            }
        }

        @media (max-width: 480px) {
            .driver-offer-card {
                padding: 8px;
            }
            
            .driver-info {
                gap: 8px;
            }
            
            .driver-photo {
                width: 45px;
                height: 45px;
            }
            
            .driver-details {
                max-width: calc(100% - 80px);
            }
            
            .accept-btn {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 60px;
            }
            
            .popup {
                width: 95%;
            }
            
            .popup-buttons {
                flex-direction: column;
            }
        }

        /* Menghilangkan watermark Google Maps */
        .gm-style-cc, [title="Report errors in the road map or imagery to Google"] {
            display: none !important;
        }

        a[href^="http://maps.google.com/maps"] {
            display: none !important;
        }

        .gm-style a[href^="https://maps.google.com/maps"] {
            display: none !important;
        }

        .gm-bundled-control {
            bottom: 10px !important;
        }

        /* Driver dot animation styles */
        .driver-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4285F4;
            box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7);
            animation: driverPulse 2s infinite;
            z-index: 10;
        }

        @keyframes driverPulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(66, 133, 244, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0);
            }
        }

        /* ========== TAMBAHAN BARU UNTUK KURIR ========== */
        
        /* Tombol kecil untuk melihat detail kurir */
        .kurir-toggle-btn {
            position: absolute;
            top: 120px; /* Di bawah panel */
            right: 20px;
            background: linear-gradient(135deg, var(--primary), #ff3a0c);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        .kurir-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }

        /* Popup detail kurir yang lebih baik */
        .kurir-detail-popup {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .kurir-detail-content {
            padding: 20px;
        }

        .kurir-detail-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .kurir-detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .kurir-detail-title {
            color: var(--primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kurir-detail-item {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .kurir-detail-label {
            font-weight: 600;
            color: #333;
            min-width: 140px;
            margin-right: 10px;
        }

        .kurir-detail-value {
            flex: 1;
            color: #555;
            word-break: break-word;
        }

        .kurir-detail-instructions {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }

        /* Khusus untuk tampilan mobile */
        @media (max-width: 768px) {
            .kurir-toggle-btn {
                top: 110px;
                right: 10px;
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .kurir-detail-popup {
                width: 95%;
                max-height: 70vh;
            }
            
            .kurir-detail-label {
                min-width: 120px;
                font-size: 13px;
            }
            
            .kurir-detail-value {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .kurir-toggle-btn {
                top: 105px;
                right: 8px;
                padding: 5px 10px;
                font-size: 10px;
            }
            
            .kurir-detail-label {
                min-width: 100px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <!-- Input Panel - Sekarang paling atas -->
        <div class="panel">
            <div class="input-container">
                <input id="fromInput" type="text" placeholder="Mo jemput dimana?" />
                <button class="clear-btn" onclick="clearInput('fromInput')">√ó</button>
                <button class="location-btn" onclick="detectLocation('fromInput')">‚åñ</button>
            </div>
            <div class="input-container">
                <input id="toInput" type="text" placeholder="Mo antar kamana?" />
                <button class="clear-btn" onclick="clearInput('toInput')">√ó</button>
                <button class="location-btn" onclick="detectLocation('toInput')">‚åñ</button>
            </div>
        </div>

        <!-- Tombol kecil untuk kurir (hanya muncul jika ada data kurir) -->
        <button id="kurirToggleBtn" class="kurir-toggle-btn" style="display: none;">
            <i class="fas fa-box"></i> Detail Pengiriman
        </button>

        <!-- Penawaran Driver -->
        <div id="driverOffers">
            <div>
                <div>
                    <strong>üèÜ Penawaran Driver</strong>
                    <button id="closeDriverOffers">‚úï</button>
                </div>
                <div id="driverOfferList"></div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Controls -->
        <button id="mapModeBtn" class="map-mode-btn" onclick="toggleMapMode()">Mode Malam</button>
        
        <!-- Route Details -->
        <div class="route-details" id="routeDetails">
            <div class="route-info">
                <div class="route-address">
                    <span class="label">A:</span>
                    <span class="value" id="routeFrom">-</span>
                </div>
                <div class="route-address">
                    <span class="label">B:</span>
                    <span class="value" id="routeTo">-</span>
                </div>
            </div>
            <div class="route-stats">
                <div class="route-stat">
                    <div class="stat-value" id="routeDuration">-</div>
                    <div class="stat-label">Durasi</div>
                </div>
                <div class="route-stat">
                    <div class="stat-value"><span class="price-highlight" id="routePrice">-</span></div>
                    <div class="stat-label">Biaya</div>
                </div>
            </div>
        </div>

        <!-- Confirm Button -->
        <button class="confirm-btn" id="confirmBtn" onclick="confirmRoute()" disabled>Konfirmasi Rute</button>

        <!-- Cancel Button -->
        <button class="cancel-btn" id="cancelBtn" onclick="cancelSearch()" disabled>BATALKAN</button>

        <!-- Radar Loading -->
        <div class="radar" id="radar">
            <span>Mencari driver...</span>
        </div>

        <!-- Popup Custom -->
        <div class="popup-overlay" id="popupOverlay">
            <div class="popup">
                <div class="popup-header">
                    <h3 class="popup-title" id="popupTitle">Pemberitahuan</h3>
                    <button class="popup-close" onclick="closePopup()">√ó</button>
                </div>
                <div class="popup-content">
                    <div class="popup-icon" id="popupIcon">‚ö†Ô∏è</div>
                    <div class="popup-message" id="popupMessage">Pesan akan ditampilkan di sini</div>
                    <div class="popup-buttons" id="popupButtons">
                        <button class="popup-button popup-button-primary" id="popupButton" onclick="closePopup()">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup Penawaran Harga -->
        <div class="popup-overlay" id="priceOfferPopup">
            <div class="popup">
                <div class="popup-header">
                    <h3 class="popup-title">üí° Naikkan Tarif</h3>
                    <button class="popup-close" onclick="closePriceOfferPopup()">√ó</button>
                </div>
                <div class="popup-content">
                    <div class="popup-icon">üí∞</div>
                    <div class="popup-message">
                        <p>Belum ada driver yang menerima dalam 30 detik. Coba naikkan tarif untuk menarik perhatian driver.</p>
                        <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: #666;">Tarif Saat Ini:</div>
                            <div style="font-size: 1.4rem; font-weight: 700; color: var(--success);" id="currentPriceDisplay">Rp 0</div>
                        </div>
                    </div>
                    <div class="popup-buttons" style="flex-direction: column; gap: 8px;">
                        <button class="popup-button popup-button-primary" id="price10Btn" onclick="increasePrice(0.1)">+ 10% (Rp <span id="price10">0</span>)</button>
                        <button class="popup-button popup-button-primary" id="price20Btn" onclick="increasePrice(0.2)">+ 20% (Rp <span id="price20">0</span>)</button>
                        <button class="popup-button popup-button-warning" id="price30Btn" onclick="increasePrice(0.3)">+ 30% (Rp <span id="price30">0</span>)</button>
                        <button class="popup-button popup-button-secondary" onclick="closePriceOfferPopup()">Tidak, Terus Tunggu</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup Detail Kurir -->
        <div class="popup-overlay" id="kurirDetailPopup">
            <div class="popup kurir-detail-popup">
                <div class="popup-header">
                    <h3 class="popup-title"><i class="fas fa-box-open"></i> Detail Pengiriman</h3>
                    <button class="popup-close" onclick="closeKurirDetailPopup()">√ó</button>
                </div>
                <div class="kurir-detail-content" id="kurirDetailContent">
                    <!-- Data kurir akan diisi oleh JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
    // ==================== KONFIGURASI FIREBASE ====================
const firebaseConfig = {
    apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
    authDomain: "game-balap-simpel.firebaseapp.com",
    databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
    projectId: "game-balap-simpel",
    storageBucket: "game-balap-simpel.firebasestorage.app",
    messagingSenderId: "864576853495",
    appId: "1:864576853495:web:6f16eb757fd3d8affb0af2",
    measurementId: "G-YWJPK7Y3J4"
};

// Initialize Firebase
try {
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase berhasil diinisialisasi");
} catch (error) {
    console.error("Error inisialisasi Firebase:", error);
}

const database = firebase.database();
const auth = firebase.auth();

// ==================== VARIABEL GLOBAL ====================
let map, directionsService, directionsRenderer;
let markerA, markerB, circleB;
let radarInterval;
let currentPosition = null;
let currentRouteData = null;
let currentOrderId = null;
let isSearching = false;

// Data user
let userData = null;

let currentDriverData = null;

// Variabel untuk Firebase listener
let driverRef = null;
let driverUpdateHandler = null;
let driverOffersRef = null;

// Array untuk menyimpan driver offers
let driverOffersList = [];

// Data kurir dari localStorage
let kurirDeliveryData = null;

// Variabel baru untuk sistem penawaran harga
let priceIncreaseTimer = null;
let currentBasePrice = 0;
let currentVehicleMinPrice = 0;

// Variabel untuk marker driver di peta
let driverMarkers = {};

// Variabel untuk animasi zoom yang halus
let smoothZoomAnimation = null;
let isSmoothZoomRunning = false;

// ==================== FUNGSI UTAMA ====================

// Ambil parameter vehicle
const urlParams = new URLSearchParams(window.location.search);
let vehicle = urlParams.get("vehicle");

// Jika tidak ada parameter vehicle, coba ambil dari localStorage
if (!vehicle) {
    const lastTransport = localStorage.getItem('jego_last_transport');
    if (lastTransport) {
        try {
            const transportData = JSON.parse(lastTransport);
            vehicle = transportData.type;
            
            // Cek apakah ada data pengiriman untuk kurir
            if (transportData.deliveryData) {
                kurirDeliveryData = transportData.deliveryData;
            }
        } catch (e) {
            console.error('Error parsing last transport:', e);
        }
    }
}

// Fallback ke motor jika masih tidak ada
if (!vehicle) {
    vehicle = "motor";
}

const fromParam = urlParams.get("from");
const toParam = urlParams.get("to");
const coordParam = urlParams.get("coord");

// Data kendaraan yang sudah dinormalisasi dari Firebase
let vehicleData = {};

// Fallback data jika Firebase tidak tersedia (untuk emergency)
const fallbackVehicleData = {
    motor: { 
        name: "Motor", 
        capacity: "1 Penumpang", 
        icon: 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
        minDistance: 4,
        minPrice: 10000,
        pricePerKm: 2200
    },
    bentor: { 
        name: "Bentor", 
        capacity: "2 Penumpang", 
        icon: 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png',
        minDistance: 4,
        minPrice: 11000,
        pricePerKm: 3000
    },
    mobil: { 
        name: "Mobil", 
        capacity: "4 Penumpang", 
        icon: 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
        minDistance: 4,
        minPrice: 15000,
        pricePerKm: 4000
    },
    kurir_motor: { 
        name: "Kurir Motor", 
        capacity: "Paket Kecil", 
        icon: 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png',
        minDistance: 4,
        minPrice: 10000,
        pricePerKm: 2100
    },
    kurir_bentor: { 
        name: "Kurir Bentor", 
        capacity: "Paket Sedang", 
        icon: 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png',
        minDistance: 4,
        minPrice: 10000,
        pricePerKm: 2100
    }
};

// ==================== FUNGSI NORMALISASI DATA TARIF DARI FIREBASE ====================

/**
 * Fungsi untuk normalisasi key kendaraan dari Firebase
 * "Kurir Motor" ‚Üí "kurir_motor"
 * "Bentor" ‚Üí "bentor"
 */
function normalizeVehicleKey(firebaseKey) {
    if (!firebaseKey) return '';
    
    return firebaseKey
        .toLowerCase()
        .replace(/\s+/g, '_')
        .trim();
}

/**
 * Fungsi untuk normalisasi data dari Firebase ke format standar
 */
function normalizeVehicleData(firebaseData) {
    if (!firebaseData) return null;
    
    return {
        name: firebaseData.Nama || firebaseData.name || 'Kendaraan',
        capacity: firebaseData.Capacity || firebaseData.capacity || '1 Penumpang',
        icon: firebaseData.Icon || firebaseData.icon || '',
        minDistance: firebaseData.MinimalDistance || firebaseData.minDistance || 4,
        minPrice: firebaseData.MinimalPrice || firebaseData.minPrice || 10000,
        pricePerKm: firebaseData.PricePerKm || firebaseData.pricePerKm || 2000,
        description: firebaseData.Deskripsi || firebaseData.description || ''
    };
}

/**
 * Fungsi untuk memuat dan normalisasi data tarif dari Firebase
 */
function loadVehicleData() {
    return new Promise((resolve, reject) => {
        console.log("üìä Memuat data tarif dari Firebase...");
        
        const tarifRef = database.ref('tarif');
        
        tarifRef.once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    console.log("‚úÖ Data tarif berhasil dimuat dari Firebase:", firebaseData);
                    
                    // Normalisasi data dari Firebase
                    vehicleData = {};
                    
                    Object.keys(firebaseData).forEach(firebaseKey => {
                        const normalizedKey = normalizeVehicleKey(firebaseKey);
                        const normalizedData = normalizeVehicleData(firebaseData[firebaseKey]);
                        
                        if (normalizedKey && normalizedData) {
                            vehicleData[normalizedKey] = normalizedData;
                            console.log(`   - ${firebaseKey} ‚Üí ${normalizedKey}:`, normalizedData);
                        }
                    });
                    
                    console.log("‚úÖ Data tarif dinormalisasi:", vehicleData);
                    resolve();
                } else {
                    console.log("‚ö†Ô∏è Data tarif tidak ditemukan di Firebase, menggunakan fallback data");
                    vehicleData = fallbackVehicleData;
                    resolve();
                }
            })
            .catch((error) => {
                console.error("‚ùå Error mengambil data tarif:", error);
                vehicleData = fallbackVehicleData;
                console.log("‚ö†Ô∏è Menggunakan fallback data karena error Firebase");
                resolve(); // Tetap resolve agar aplikasi tidak berhenti
            });
    });
}

// ==================== FUNGSI UNTUK MENDAPATKAN DATA KENDARAAN DENGAN FALLBACK ====================

/**
 * Fungsi untuk mendapatkan data kendaraan dengan fallback yang aman
 */
function getVehicleData(vehicleType) {
    try {
        // Coba ambil dari vehicleData yang sudah dinormalisasi
        if (vehicleData && vehicleData[vehicleType]) {
            return vehicleData[vehicleType];
        }
        
        // Fallback 1: Coba cari dengan key alternatif
        const alternativeKeys = [
            vehicleType,
            vehicleType.replace('_', ' '), // kurir_motor ‚Üí kurir motor
            vehicleType.replace('kurir_', 'kurir ') // kurir_motor ‚Üí kurir motor
        ];
        
        for (const key of alternativeKeys) {
            if (vehicleData && vehicleData[key]) {
                return vehicleData[key];
            }
        }
        
        // Fallback 2: Gunakan fallbackVehicleData
        if (fallbackVehicleData[vehicleType]) {
            console.log(`‚ö†Ô∏è Menggunakan fallback data untuk: ${vehicleType}`);
            return fallbackVehicleData[vehicleType];
        }
        
        // Fallback 3: Data default minimal
        console.warn(`‚ö†Ô∏è Data kendaraan tidak ditemukan untuk: ${vehicleType}, menggunakan default`);
        return {
            name: vehicleType.charAt(0).toUpperCase() + vehicleType.slice(1).replace('_', ' '),
            capacity: "1 Penumpang",
            icon: 'https://cdn-icons-png.flaticon.com/128/3097/3097139.png',
            minDistance: 4,
            minPrice: 10000,
            pricePerKm: 2000,
            description: ''
        };
        
    } catch (error) {
        console.error(`‚ùå Error mendapatkan data kendaraan untuk ${vehicleType}:`, error);
        // Return data default yang aman
        return {
            name: "Kendaraan",
            capacity: "1 Penumpang",
            icon: 'https://cdn-icons-png.flaticon.com/128/3097/3097139.png',
            minDistance: 4,
            minPrice: 10000,
            pricePerKm: 2000,
            description: ''
        };
    }
}

/**
 * Fungsi untuk mendapatkan icon marker dengan fallback yang aman
 */
function getVehicleIcon(vehicleType) {
    try {
        const data = getVehicleData(vehicleType);
        
        if (data && data.icon && data.icon.trim() !== '') {
            return data.icon;
        }
        
        // Fallback icon berdasarkan tipe kendaraan
        const iconMap = {
            'motor': 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
            'bentor': 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png',
            'mobil': 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
            'kurir_motor': 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png',
            'kurir_bentor': 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png'
        };
        
        return iconMap[vehicleType] || 'https://cdn-icons-png.flaticon.com/128/3097/3097139.png';
        
    } catch (error) {
        console.error(`‚ùå Error mendapatkan icon untuk ${vehicleType}:`, error);
        return 'https://cdn-icons-png.flaticon.com/128/3097/3097139.png';
    }
}

// ==================== FUNGSI PERHITUNGAN TARIF YANG AMAN ====================

/**
 * Fungsi untuk menghitung tarif dengan validasi dan fallback
 */
function calculatePrice(distanceKm) {
    try {
        // Validasi input
        if (!distanceKm || distanceKm <= 0) {
            console.warn('‚ö†Ô∏è Jarak tidak valid:', distanceKm);
            distanceKm = 1; // Jarak minimal
        }
        
        // Dapatkan data kendaraan
        const vehicleInfo = getVehicleData(vehicle);
        
        // Validasi data kendaraan
        if (!vehicleInfo) {
            console.error('‚ùå Data kendaraan tidak ditemukan untuk perhitungan tarif');
            throw new Error('Data kendaraan tidak ditemukan');
        }
        
        const { minDistance, minPrice, pricePerKm } = vehicleInfo;
        
        // Validasi nilai numerik
        const validMinDistance = minDistance && !isNaN(minDistance) ? Number(minDistance) : 4;
        const validMinPrice = minPrice && !isNaN(minPrice) ? Number(minPrice) : 10000;
        const validPricePerKm = pricePerKm && !isNaN(pricePerKm) ? Number(pricePerKm) : 2000;
        
        console.log(`üìä Perhitungan tarif: jarak=${distanceKm}km, minDistance=${validMinDistance}, minPrice=${validMinPrice}, pricePerKm=${validPricePerKm}`);
        
        if (distanceKm <= validMinDistance) {
            return validMinPrice;
        }
        
        const additionalDistance = distanceKm - validMinDistance;
        const additionalPrice = Math.ceil(additionalDistance * validPricePerKm / 100) * 100;
        const totalPrice = validMinPrice + additionalPrice;
        
        console.log(`üí∞ Hasil perhitungan: ${totalPrice} (minPrice: ${validMinPrice} + additional: ${additionalPrice})`);
        
        return totalPrice;
        
    } catch (error) {
        console.error('‚ùå Error dalam calculatePrice:', error);
        
        // Fallback perhitungan sederhana
        const fallbackPrice = 10000 + Math.max(0, Math.ceil((distanceKm - 4) * 2000));
        console.log(`‚ö†Ô∏è Menggunakan fallback price: ${fallbackPrice}`);
        
        return fallbackPrice;
    }
}

// ==================== BATAS WILAYAH GORONTALO ====================
const GORONTALO_BOUNDS = {
    north: 1.1,    // Batas utara
    south: 0.2,    // Batas selatan
    west: 121.9,   // Batas barat
    east: 123.3    // Batas timur
};

// PUSAT DEFAULT GORONTALO
const GORONTALO_CENTER = { lat: 0.55, lng: 123.05 };

// Daftar kabupaten/kota di Gorontalo
const GORONTALO_REGIONS = [
    'gorontalo', 'kota gorontalo', 'bone bolango', 'gorontalo utara', 
    'gorontalo selatan', 'gorontalo timur', 'boalemo', 'pohuwato',
    'tilongkabila', 'kabila', 'suwawa', 'bonepantai', 'botupingge',
    'bulango utara', 'bulango selatan', 'bulango timur', 'bulango'
];

// ==================== FUNGSI BARU: AMBIL DATA USER LANGSUNG DARI FIREBASE ====================
function getUserDataFromFirebase(uid) {
    return new Promise((resolve, reject) => {
        if (!uid || uid === 'unknown') {
            reject(new Error('UID tidak valid'));
            return;
        }
        
        console.log("üîÑ Mengambil data user langsung dari Firebase untuk UID:", uid);
        
        const userRef = database.ref('users/' + uid);
        userRef.once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    console.log("‚úÖ Data user dari Firebase:", userData);
                    
                    // Normalisasi data user dengan struktur yang diharapkan
                    const normalizedUser = {
                        uid: uid,
                        name: userData.name || userData.nama || 'Pelanggan',
                        phone: userData.phone || userData.telepon || '-',
                        photoURL: userData.photoURL || userData.foto || null,
                        rating: userData.rating || userData.rating_pengguna || 0,
                        perjalanan: userData.perjalanan || userData.total_perjalanan || 0,
                        role: userData.role || 'penumpang',
                        status: userData.status || 'active'
                    };
                    
                    // Validasi rating dan perjalanan
                    if (normalizedUser.rating === 0) {
                        console.warn("‚ö†Ô∏è Rating user adalah 0, menggunakan default 5");
                        normalizedUser.rating = 5;
                    }
                    
                    if (normalizedUser.perjalanan === 0) {
                        console.log("‚ÑπÔ∏è Perjalanan user adalah 0 (mungkin user baru)");
                    }
                    
                    console.log("‚úÖ Data user yang dinormalisasi:", {
                        uid: normalizedUser.uid,
                        name: normalizedUser.name,
                        rating: normalizedUser.rating,
                        perjalanan: normalizedUser.perjalanan,
                        role: normalizedUser.role,
                        status: normalizedUser.status
                    });
                    
                    resolve(normalizedUser);
                } else {
                    console.log("‚ùå Data user tidak ditemukan di Firebase untuk UID:", uid);
                    reject(new Error('User tidak ditemukan di database'));
                }
            })
            .catch((error) => {
                console.error("‚ùå Error mengambil data user dari Firebase:", error);
                reject(error);
            });
    });
}

// ==================== FUNGSI UNTUK MENDAPATKAN UID USER ====================
function getCurrentUserId() {
    return new Promise((resolve, reject) => {
        // Cek apakah user sudah login di Firebase Auth
        const currentUser = auth.currentUser;
        
        if (currentUser) {
            console.log("‚úÖ User login melalui Firebase Auth, UID:", currentUser.uid);
            resolve(currentUser.uid);
            return;
        }
        
        // Jika Firebase Auth tidak tersedia, cek parameter URL atau fallback ke localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const uidFromUrl = urlParams.get('uid');
        
        if (uidFromUrl) {
            console.log("‚úÖ UID dari URL parameter:", uidFromUrl);
            resolve(uidFromUrl);
            return;
        }
        
        // Fallback: coba ambil dari localStorage (hanya untuk backward compatibility)
        try {
            const currentUserStr = localStorage.getItem('currentUser');
            if (currentUserStr) {
                const userData = JSON.parse(currentUserStr);
                const uid = userData.uid || userData.firebase_key || userData.id;
                if (uid && uid !== 'unknown') {
                    console.log("‚ö†Ô∏è UID dari localStorage fallback:", uid);
                    resolve(uid);
                    return;
                }
            }
        } catch (e) {
            console.error("Error parsing localStorage:", e);
        }
        
        // Jika semua gagal, tolak dengan error
        reject(new Error('Tidak dapat mengidentifikasi user. Silakan login kembali.'));
    });
}

// ==================== FUNGSI PEMBULATAN HARGA ====================
function roundToNearestThousand(price) {
    try {
        if (!price || isNaN(price)) {
            console.warn('‚ö†Ô∏è Harga tidak valid untuk pembulatan:', price);
            return 10000;
        }
        
        let remainder = price % 1000;
        let rounded = price - remainder;
        if (remainder > 500) {
            rounded += 1000;
        }
        return rounded;
    } catch (error) {
        console.error('‚ùå Error dalam roundToNearestThousand:', error);
        return Math.round(price / 1000) * 1000;
    }
}

// ==================== PERBAIKAN VALIDASI WILAYAH ====================

// Fungsi untuk memeriksa apakah tempat berada di Provinsi Gorontalo
function isInGorontaloProvince(place) {
    if (!place.address_components) {
        console.log("Tidak ada address_components, gunakan validasi bounds");
        return null;
    }
    
    for (let component of place.address_components) {
        if (component.types.includes('administrative_area_level_1')) {
            const provinceName = component.long_name.toLowerCase();
            if (provinceName.includes('gorontalo')) {
                console.log("Ditemukan provinsi Gorontalo:", provinceName);
                return true;
            }
        }
        if (component.types.includes('administrative_area_level_2')) {
            const regencyName = component.long_name.toLowerCase();
            for (let region of GORONTALO_REGIONS) {
                if (regencyName.includes(region)) {
                    console.log("Ditemukan wilayah Gorontalo:", regencyName);
                    return true;
                }
            }
        }
        if (component.types.includes('administrative_area_level_3')) {
            const districtName = component.long_name.toLowerCase();
            for (let region of GORONTALO_REGIONS) {
                if (districtName.includes(region)) {
                    console.log("Ditemukan kecamatan Gorontalo:", districtName);
                    return true;
                }
            }
        }
        if (component.types.includes('locality')) {
            const localityName = component.long_name.toLowerCase();
            for (let region of GORONTALO_REGIONS) {
                if (localityName.includes(region)) {
                    console.log("Ditemukan locality Gorontalo:", localityName);
                    return true;
                }
            }
        }
    }
    
    console.log("Tidak ditemukan komponen Gorontalo dalam address_components");
    return false;
}

// Fungsi untuk memeriksa apakah koordinat berada dalam batas Gorontalo dengan toleransi
function isWithinGorontaloBounds(latLng) {
    try {
        if (!latLng || !latLng.lat || !latLng.lng) {
            console.warn('‚ö†Ô∏è Koordinat tidak valid:', latLng);
            return false;
        }
        
        const TOLERANCE = 0.1;
        const inBounds = (
            latLng.lat >= (GORONTALO_BOUNDS.south - TOLERANCE) &&
            latLng.lat <= (GORONTALO_BOUNDS.north + TOLERANCE) &&
            latLng.lng >= (GORONTALO_BOUNDS.west - TOLERANCE) &&
            latLng.lng <= (GORONTALO_BOUNDS.east + TOLERANCE)
        );
        
        console.log("Validasi bounds:", latLng, "hasil:", inBounds);
        return inBounds;
    } catch (error) {
        console.error('‚ùå Error dalam isWithinGorontaloBounds:', error);
        return false;
    }
}

// ==================== PERBAIKAN FUNGSI MARKER ====================

function updateMarker(inputId, position) {
    try {
        if (!map) {
            console.error("Map belum diinisialisasi!");
            return;
        }
        
        if (!position || !position.lat || !position.lng) {
            console.error("Posisi tidak valid untuk marker:", position);
            return;
        }
        
        const isFromInput = inputId === 'fromInput';
        
        // Dapatkan icon dengan fallback yang aman
        let vehicleIconUrl;
        try {
            vehicleIconUrl = getVehicleIcon(vehicle);
            console.log(`üìç Menggunakan icon untuk ${vehicle}: ${vehicleIconUrl}`);
        } catch (iconError) {
            console.error('‚ùå Error mendapatkan icon:', iconError);
            vehicleIconUrl = 'https://cdn-icons-png.flaticon.com/128/3097/3097139.png';
        }
        
        const marker = isFromInput ? markerA : markerB;
        const icon = isFromInput ? 
            { 
                url: vehicleIconUrl, 
                scaledSize: new google.maps.Size(40, 40),
                // Fallback jika icon error
                error: function() {
                    console.warn('‚ö†Ô∏è Icon kendaraan gagal dimuat, menggunakan default');
                    return {
                        url: 'https://cdn-icons-png.flaticon.com/128/3097/3097139.png',
                        scaledSize: new google.maps.Size(40, 40)
                    };
                }
            } :
            { 
                url: "https://cdn-icons-png.flaticon.com/512/684/684908.png", 
                scaledSize: new google.maps.Size(40, 40) 
            };
        
        if (marker) marker.setMap(null);
        
        const newMarker = new google.maps.Marker({
            position: position,
            map: map,
            icon: icon
        });
        
        if (isFromInput) {
            markerA = newMarker;
        } else {
            markerB = newMarker;
        }
        
        console.log(`‚úÖ Marker ${isFromInput ? 'A' : 'B'} berhasil dibuat di:`, position);
        
    } catch (error) {
        console.error(`‚ùå Error dalam updateMarker untuk ${inputId}:`, error);
    }
}

// FIX MAP: Fungsi utama inisialisasi peta - dipanggil oleh Google Maps API
function initMap() {
    console.log("üöÄ Memulai inisialisasi peta Google Maps");
    
    try {
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            console.error("Google Maps API belum dimuat!");
            showPopup("Gagal memuat peta. Silakan refresh halaman.", "Error", "error");
            return;
        }
        
        map = new google.maps.Map(document.getElementById("map"), {
            center: GORONTALO_CENTER,
            zoom: 11,
            mapTypeId: 'roadmap',
            disableDefaultUI: false,
            zoomControl: true,
            streetViewControl: false,
            fullscreenControl: true,
            mapTypeControl: false
        });
        
        console.log("‚úÖ Peta Google Maps berhasil dibuat dengan center Gorontalo");
        
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            preserveViewport: false
        });
        
        console.log("‚úÖ DirectionsService dan DirectionsRenderer siap");
        
        loadVehicleData()
            .then(() => {
                console.log('‚úÖ Data tarif berhasil dimuat dan dinormalisasi dari Firebase');
                console.log('üìã Data kendaraan yang tersedia:', Object.keys(vehicleData));
                
                // Debug: Tampilkan data kendaraan
                Object.keys(vehicleData).forEach(key => {
                    console.log(`   - ${key}:`, vehicleData[key]);
                });
                
                const lastTransport = localStorage.getItem('jego_last_transport');
                if (lastTransport) {
                    try {
                        const transportData = JSON.parse(lastTransport);
                        if (transportData.deliveryData) {
                            kurirDeliveryData = transportData.deliveryData;
                            console.log('üì¶ Data pengiriman kurir ditemukan:', kurirDeliveryData);
                            
                            // Update tombol kurir jika ada data kurir
                            updateKurirButton();
                        }
                    } catch (e) {
                        console.error('Error parsing delivery data:', e);
                    }
                }
                
                initAutocomplete();
                
                document.getElementById('closeDriverOffers').addEventListener('click', () => {
                    const container = document.getElementById('driverOffers');
                    container.style.display = 'none';
                });
                
                // Nonaktifkan tombol mode malam
                document.getElementById('mapModeBtn').style.display = 'none';
                
                setTimeout(() => {
                    checkActiveOrder();
                }, 2000);
                
                console.log("‚úÖ JeGo Rute berhasil dimuat");
                
            })
            .catch(error => {
                console.error('‚ùå Gagal memuat data tarif dari Firebase:', error);
                
                vehicleData = fallbackVehicleData;
                
                const lastTransport = localStorage.getItem('jego_last_transport');
                if (lastTransport) {
                    try {
                        const transportData = JSON.parse(lastTransport);
                        if (transportData.deliveryData) {
                            kurirDeliveryData = transportData.deliveryData;
                            console.log('üì¶ Data pengiriman kurir ditemukan:', kurirDeliveryData);
                            
                            // Update tombol kurir jika ada data kurir
                            updateKurirButton();
                        }
                    } catch (e) {
                        console.error('Error parsing delivery data:', e);
                    }
                }
                
                initAutocomplete();
                
                document.getElementById('closeDriverOffers').addEventListener('click', () => {
                    const container = document.getElementById('driverOffers');
                    container.style.display = 'none';
                });
                
                // Nonaktifkan tombol mode malam
                document.getElementById('mapModeBtn').style.display = 'none';
                
                setTimeout(() => {
                    checkActiveOrder();
                }, 2000);
                
                console.log("‚úÖ JeGo Rute berhasil dimuat dengan fallback data");
            });
        
    } catch (error) {
        console.error("‚ùå Gagal inisialisasi peta:", error);
        showPopup("Gagal memuat peta. Silakan refresh halaman.", "Error", "error");
    }
}

// FIX MAP: Load Google Maps API dengan callback=initMap
const script = document.createElement("script");
script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyCEsbn9W4ivUesB15wmDuMhOT4JR6Mq9Bs&libraries=places,geometry&callback=initMap";
script.async = true;
script.defer = true;

script.onerror = function() {
    document.getElementById('radar').style.display = 'flex';
    document.getElementById('radar').querySelector('span').textContent = 'Error: Gagal memuat peta';
    console.error("Gagal memuat Google Maps API");
    showPopup("Gagal memuat peta. Periksa koneksi internet Anda.", "Error", "error");
};

document.head.appendChild(script);

// Mencegah klik kanan
document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
});

// ==================== FUNGSI-FUNGSI YANG TETAP SAMA ====================

function clearInput(inputId) {
    document.getElementById(inputId).value = '';
    if (inputId === 'fromInput' && markerA) {
        markerA.setMap(null);
        markerA = null;
    }
    if (inputId === 'toInput' && markerB) {
        markerB.setMap(null);
        markerB = null;
    }
    
    if (directionsRenderer) {
        directionsRenderer.setMap(null);
    }
    if (circleB) {
        circleB.setMap(null);
        circleB = null;
    }
    
    hideRouteDetails();
    updateConfirmButton();
}

// ==================== FUNGSI REVERSE GEOCODING ====================

function getAddressFromOSM(latlng, callback) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(latlng.lat)}&lon=${encodeURIComponent(latlng.lng)}&addressdetails=1&zoom=18`;

    fetch(url, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'User-Agent': 'JeGo-Transport/1.0'
        }
    })
    .then(resp => {
        if (!resp.ok) throw new Error('Gagal mengambil data alamat: ' + resp.status);
        return resp.json();
    })
    .then(data => {
        console.log("üìç Data OSM lengkap:", data);
        
        let display = '';
        
        if (data.address) {
            const addr = data.address;
            
            const addressParts = [];
            
            if (addr.amenity || addr.shop || addr.building) {
                addressParts.push(addr.amenity || addr.shop || addr.building);
            }
            
            if (addr.road) {
                addressParts.push(`Jl. ${addr.road}`);
            }
            
            if (addr.village) {
                addressParts.push(addr.village);
            } else if (addr.hamlet) {
                addressParts.push(addr.hamlet);
            } else if (addr.suburb) {
                addressParts.push(addr.suburb);
            } else if (addr.neighbourhood) {
                addressParts.push(addr.neighbourhood);
            }
            
            if (addr.county) {
                addressParts.push(`Kec. ${addr.county}`);
            }
            
            if (addr.city_district) {
                addressParts.push(addr.city_district);
            } else if (addr.city) {
                addressParts.push(addr.city);
            }
            
            if (addr.state) {
                if (addr.state !== "Gorontalo") {
                    addressParts.push(addr.state);
                }
            }
            
            display = addressParts.join(', ');
            
            if (!display || display.length < 10) {
                display = data.display_name || '';
            }
            
            display = display.replace(/, Indonesia/gi, '');
            
            if (addr.state === "Gorontalo" && addr.county && addr.county.includes("Tilongkabila")) {
                display += ", Kabupaten Bone Bolango";
            }
            
        } else if (data.display_name) {
            display = data.display_name.replace(/, Indonesia/gi, '');
        }

        if (!display || display.trim() === '') {
            callback(`Lokasi (${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)})`);
        } else {
            callback(display);
        }
    })
    .catch(err => {
        console.error("‚ùå Error OSM:", err);
        callback(`Lokasi (${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)})`);
    });
}

// ==================== PERBAIKAN: FORMAT ALAMAT DARI GOOGLE PLACES ====================
function getAddressFromGooglePlaces(place, callback) {
    console.log("üîç Memproses alamat dari Google Places:", place);
    
    let addressParts = [];
    
    if (place.name && !place.name.includes('Unnamed Road') && !place.name.match(/^[A-Z0-9]+\+[A-Z0-9]+$/)) {
        addressParts.push(place.name);
    }
    
    if (place.formatted_address) {
        let formattedAddress = place.formatted_address;
        
        formattedAddress = formattedAddress.replace(/, Indonesia/gi, '');
        
        const parts = formattedAddress.split(',').map(part => part.trim());
        
        for (let part of parts) {
            if (!addressParts.some(existing => existing.includes(part) || part.includes(existing))) {
                if (!part.match(/^[A-Z0-9]+\+[A-Z0-9]+$/)) {
                    addressParts.push(part);
                }
            }
        }
    }
    
    if (addressParts.length === 0 && place.address_components) {
        const components = place.address_components;
        
        for (let component of components) {
            if (component.types.includes('route')) {
                addressParts.push(`Jl. ${component.long_name}`);
                break;
            }
        }
        
        for (let component of components) {
            if (component.types.includes('sublocality') || 
                component.types.includes('sublocality_level_1') ||
                component.types.includes('sublocality_level_2') ||
                component.types.includes('sublocality_level_3') ||
                component.types.includes('neighborhood')) {
                addressParts.push(component.long_name);
                break;
            }
        }
        
        for (let component of components) {
            if (component.types.includes('administrative_area_level_3')) {
                addressParts.push(`Kec. ${component.long_name}`);
                break;
            }
        }
        
        for (let component of components) {
            if (component.types.includes('administrative_area_level_2')) {
                addressParts.push(`Kabupaten ${component.long_name}`);
                break;
            }
        }
    }
    
    addressParts = addressParts.filter((part, index, self) => 
        part && part.trim() !== '' && self.indexOf(part) === index
    );
    
    if (addressParts.length > 0) {
        const finalAddress = addressParts.join(', ');
        console.log("‚úÖ Alamat final:", finalAddress);
        callback(finalAddress);
    } else {
        const location = {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
        };
        console.log("‚ö†Ô∏è Menggunakan fallback OSM");
        getAddressFromOSM(location, callback);
    }
}

function detectLocation(inputId) {
    if (navigator.geolocation) {
        showRadar('Mendeteksi lokasi...');
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                if (!isWithinGorontaloBounds(currentPosition)) {
                    hideRadar();
                    showPopup(
                        "Lokasi Anda di luar wilayah layanan JeGo (Provinsi Gorontalo). " +
                        "Silakan pilih lokasi dalam wilayah Gorontalo.",
                        "Lokasi Tidak Didukung", 
                        "error"
                    );
                    return;
                }
                
                getAddressFromOSM(currentPosition, (alamat) => {
                    document.getElementById(inputId).value = alamat;
                    hideRadar();
                    updateMarker(inputId, currentPosition);
                    if (map) {
                        map.panTo(currentPosition);
                        map.setZoom(14);
                    }
                    if (markerA && markerB) tryDirection();
                    updateConfirmButton();
                });
            },
            (error) => {
                let errorMsg = "Gagal mendapatkan lokasi";
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = "Izin lokasi ditolak";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = "Informasi lokasi tidak tersedia";
                        break;
                    case error.TIMEOUT:
                        errorMsg = "Timeout mendeteksi lokasi";
                        break;
                }
                
                document.getElementById('radar').querySelector('span').textContent = errorMsg;
                setTimeout(() => {
                    hideRadar();
                }, 2000);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        showPopup("Browser tidak mendukung geolokasi", "Error Browser", "error");
    }
}

// ==================== PERBAIKAN UTAMA: GOOGLE MAPS AUTOCOMPLETE ====================
function initAutocomplete() {
    console.log("üöÄ Memulai inisialisasi autocomplete");
    
    try {
        if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') {
            console.error("Google Maps Places API belum dimuat!");
            setTimeout(initAutocomplete, 500);
            return;
        }
        
        if (!map) {
            console.error("Map belum diinisialisasi!");
            setTimeout(initAutocomplete, 500);
            return;
        }
        
        const autocompleteOptions = {
            types: ['geocode', 'establishment'],
            componentRestrictions: { country: 'id' },
            bounds: {
                north: GORONTALO_BOUNDS.north,
                south: GORONTALO_BOUNDS.south,
                east: GORONTALO_BOUNDS.east,
                west: GORONTALO_BOUNDS.west
            },
            strictBounds: false,
            fields: ['geometry', 'formatted_address', 'name', 'address_components', 'place_id']
        };
        
        const fromAutocomplete = new google.maps.places.Autocomplete(
            document.getElementById('fromInput'),
            autocompleteOptions
        );
        
        const toAutocomplete = new google.maps.places.Autocomplete(
            document.getElementById('toInput'),
            autocompleteOptions
        );
        
        fromAutocomplete.addListener('place_changed', function() {
            handlePlaceSelection(fromAutocomplete, 'fromInput');
        });
        
        toAutocomplete.addListener('place_changed', function() {
            handlePlaceSelection(toAutocomplete, 'toInput');
        });
        
        console.log("‚úÖ Autocomplete berhasil diinisialisasi");
        
        if (fromParam) {
            document.getElementById('fromInput').value = fromParam;
        }
        if (toParam) {
            document.getElementById('toInput').value = toParam;
        }
        
        document.getElementById('fromInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocationManually('fromInput');
            }
        });
        
        document.getElementById('toInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocationManually('toInput');
            }
        });
        
    } catch (error) {
        console.error("‚ùå Gagal inisialisasi autocomplete:", error);
        showPopup("Gagal mengaktifkan pencarian lokasi. Silakan refresh halaman.", "Error", "error");
    }
}

// **PERBAIKAN**: Fungsi untuk menangani pemilihan tempat dengan validasi yang lebih baik
function handlePlaceSelection(autocomplete, inputId) {
    const place = autocomplete.getPlace();
    
    if (!place || !place.geometry) {
        console.log("Tempat tidak ditemukan");
        showPopup("Lokasi tidak ditemukan. Silakan coba alamat lain.", "Peringatan", "warning");
        return;
    }
    
    const location = {
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng()
    };
    
    console.log("üìç Lokasi dipilih:", place.name, location);
    console.log("üìã Address components:", place.address_components);
    
    // Ambil alamat langsung dari input textbox (tidak dari formatted_address Google)
    const inputElement = document.getElementById(inputId);
    const selectedAddress = inputElement.value;
    
    updateMarker(inputId, location);
    
    if (map) {
        map.panTo(location);
        map.setZoom(14);
    }
    
    if (markerA && markerB) tryDirection();
    updateConfirmButton();
}

function searchLocationManually(inputId) {
    const searchQuery = document.getElementById(inputId).value.trim();
    if (!searchQuery) return;
    
    showRadar('Mencari lokasi...');
    
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode(
        {
            address: searchQuery + ', Gorontalo, Indonesia',
            bounds: {
                north: GORONTALO_BOUNDS.north,
                south: GORONTALO_BOUNDS.south,
                east: GORONTALO_BOUNDS.east,
                west: GORONTALO_BOUNDS.west
            }
        },
        function(results, status) {
            hideRadar();
            
            if (status === 'OK' && results[0]) {
                const location = results[0].geometry.location;
                const place = {
                    geometry: { location: location },
                    address_components: results[0].address_components,
                    formatted_address: results[0].formatted_address,
                    name: searchQuery
                };
                
                const isInGorontaloByBounds = isWithinGorontaloBounds({lat: location.lat(), lng: location.lng()});
                
                if (!isInGorontaloByBounds) {
                    showPopup("Lokasi tidak ditemukan di Provinsi Gorontalo.", "Lokasi Tidak Didukung", "error");
                    return;
                }
                
                getAddressFromGooglePlaces(place, function(fullAddress) {
                    document.getElementById(inputId).value = fullAddress;
                    updateMarker(inputId, { lat: location.lat(), lng: location.lng() });
                    
                    if (map) {
                        map.panTo(location);
                        map.setZoom(14);
                    }
                    
                    if (markerA && markerB) tryDirection();
                    updateConfirmButton();
                });
                
            } else {
                showPopup("Lokasi tidak ditemukan. Coba gunakan nama jalan, desa, atau kecamatan di Gorontalo.", "Pencarian Gagal", "warning");
            }
        }
    );
}

// ==================== FUNGSI UNTUK KURIR ====================

// Fungsi untuk menampilkan/menyembunyikan tombol kurir
function updateKurirButton() {
    const kurirBtn = document.getElementById('kurirToggleBtn');
    if (kurirDeliveryData) {
        kurirBtn.style.display = 'flex';
        kurirBtn.addEventListener('click', openKurirDetailPopup);
    } else {
        kurirBtn.style.display = 'none';
    }
}

// Fungsi untuk membuka popup detail kurir
function openKurirDetailPopup() {
    if (!kurirDeliveryData) return;
    
    const content = document.getElementById('kurirDetailContent');
    
    // Format kategori barang (sama dengan di jenis_kenderaan.html)
    const categoryMap = {
        'dokumen': 'Dokumen',
        'makanan': 'Makanan',
        'paket': 'Paket/Kardus',
        'elektronik': 'Elektronik',
        'pakaian': 'Pakaian',
        'obat': 'Obat-obatan',
        'lainnya': 'Lainnya'
    };
    
    const category = categoryMap[kurirDeliveryData.itemCategory] || kurirDeliveryData.itemCategory;
    
    // Buat HTML untuk detail kurir (format mirip dengan form di jenis_kenderaan.html)
    content.innerHTML = `
        <div class="kurir-detail-section">
            <div class="kurir-detail-title">
                <i class="fas fa-box"></i> Informasi Barang
            </div>
            <div class="kurir-detail-item">
                <span class="kurir-detail-label">Jenis Barang:</span>
                <span class="kurir-detail-value">${category}</span>
            </div>
            <div class="kurir-detail-item">
                <span class="kurir-detail-label">Deskripsi Barang:</span>
                <span class="kurir-detail-value">${kurirDeliveryData.itemDescription || '-'}</span>
            </div>
            ${kurirDeliveryData.specialInstructions ? `
            <div class="kurir-detail-item">
                <span class="kurir-detail-label">Instruksi Khusus:</span>
                <span class="kurir-detail-value">${kurirDeliveryData.specialInstructions}</span>
            </div>
            ` : ''}
        </div>
        
        <div class="kurir-detail-section">
            <div class="kurir-detail-title">
                <i class="fas fa-user"></i> Informasi Pengirim
            </div>
            <div class="kurir-detail-item">
                <span class="kurir-detail-label">Nama Pengirim:</span>
                <span class="kurir-detail-value">${kurirDeliveryData.senderName || '-'}</span>
            </div>
            <div class="kurir-detail-item">
                <span class="kurir-detail-label">Nomor HP Pengirim:</span>
                <span class="kurir-detail-value">${kurirDeliveryData.senderPhone || '-'}</span>
            </div>
        </div>
        
        <div class="kurir-detail-section">
            <div class="kurir-detail-title">
                <i class="fas fa-user-check"></i> Informasi Penerima
            </div>
            <div class="kurir-detail-item">
                <span class="kurir-detail-label">Nama Penerima:</span>
                <span class="kurir-detail-value">${kurirDeliveryData.receiverName || '-'}</span>
            </div>
            <div class="kurir-detail-item">
                <span class="kurir-detail-label">Nomor HP Penerima:</span>
                <span class="kurir-detail-value">${kurirDeliveryData.receiverPhone || '-'}</span>
            </div>
        </div>
        
        <div class="kurir-detail-instructions">
            <i class="fas fa-info-circle"></i> Informasi ini akan diberikan kepada driver untuk proses pengiriman.
        </div>
    `;
    
    document.getElementById('kurirDetailPopup').classList.add('active');
}

// Fungsi untuk menutup popup detail kurir
function closeKurirDetailPopup() {
    document.getElementById('kurirDetailPopup').classList.remove('active');
}

// ==================== PERBAIKAN UTAMA: FUNGSI POPUP ====================
function showPopup(message, title = "Pemberitahuan", type = "info", buttons = "default") {
    const popupOverlay = document.getElementById('popupOverlay');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    const popupIcon = document.getElementById('popupIcon');
    const popupButtons = document.getElementById('popupButtons');
    
    popupTitle.textContent = title;
    popupMessage.textContent = message;
    
    let icon = "‚ö†Ô∏è";
    if (type === "success") icon = "‚úÖ";
    else if (type === "error") icon = "‚ùå";
    else if (type === "warning") icon = "‚ö†Ô∏è";
    else if (type === "info") icon = "‚ÑπÔ∏è";
    
    popupIcon.textContent = icon;
    
    // Reset tombol berdasarkan parameter
    if (buttons === "default") {
        popupButtons.innerHTML = `
            <button class="popup-button popup-button-primary" onclick="closePopup()">OK</button>
        `;
    } else if (buttons === "cancel") {
        popupButtons.innerHTML = `
            <button class="popup-button popup-button-secondary" onclick="closePopup()">Tidak</button>
            <button class="popup-button popup-button-danger" onclick="confirmDeleteOrder()">Ya, Batalkan</button>
        `;
    } else if (buttons === "custom") {
        // Biarkan tombol custom yang sudah diatur sebelumnya
    }
    
    popupOverlay.classList.add('active');
}

function closePopup() {
    const popupOverlay = document.getElementById('popupOverlay');
    popupOverlay.classList.remove('active');
    
    // Reset ke default setelah popup ditutup
    setTimeout(() => {
        const popupButtons = document.getElementById('popupButtons');
        popupButtons.innerHTML = `
            <button class="popup-button popup-button-primary" onclick="closePopup()">OK</button>
        `;
    }, 300);
}

function showRadar(message) {
    const radar = document.getElementById('radar');
    radar.querySelector('span').textContent = message || 'Memproses...';
    radar.style.display = 'block';
}

function hideRadar() {
    const radar = document.getElementById('radar');
    radar.style.display = 'none';
    radar.classList.remove('expanding');
}

// ==================== PERBAIKAN: FUNGSI UNTUK MENAMPILKAN RUTE ====================

// Fungsi untuk menghitung dan menampilkan rute
function tryDirection() {
    if (!map || !directionsService) {
        console.error("Map atau DirectionsService belum diinisialisasi!");
        return;
    }
    
    if (!markerA || !markerB) return;
    
    const request = {
        origin: markerA.getPosition(),
        destination: markerB.getPosition(),
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC
    };
    
    directionsService.route(request, function(result, status) {
        if (status == 'OK') {
            directionsRenderer.setDirections(result);
            
            const route = result.routes[0].legs[0];
            currentRouteData = {
                distance: route.distance.value / 1000,
                duration: route.duration.value / 60,
                startAddress: route.start_address,
                endAddress: route.end_address,
                startLocation: {
                    lat: route.start_location.lat(),
                    lng: route.start_location.lng()
                },
                endLocation: {
                    lat: route.end_location.lat(),
                    lng: route.end_location.lng()
                }
            };
            
            try {
                const price = roundToNearestThousand(calculatePrice(currentRouteData.distance));
                currentBasePrice = price;
                currentVehicleMinPrice = getVehicleData(vehicle).minPrice || 10000;
                
                console.log(`üí∞ Tarif dihitung: ${price} untuk jarak ${currentRouteData.distance}km`);
                
                showRouteDetails(
                    route.start_address,
                    route.end_address,
                    route.duration.text,
                    price
                );
                
            } catch (priceError) {
                console.error('‚ùå Error menghitung harga:', priceError);
                
                // Harga fallback
                const fallbackPrice = 10000;
                currentBasePrice = fallbackPrice;
                currentVehicleMinPrice = fallbackPrice;
                
                showRouteDetails(
                    route.start_address,
                    route.end_address,
                    route.duration.text,
                    fallbackPrice
                );
                
                showPopup("Gagal menghitung tarif. Menggunakan tarif standar.", "Peringatan", "warning");
            }
            
        } else {
            console.error('Error mendapatkan rute:', status);
            showPopup("Gagal mendapatkan rute. Coba lokasi lain.", "Error Rute", "error");
            document.getElementById('confirmBtn').disabled = true;
        }
    });
}

// Fungsi untuk menampilkan detail rute
function showRouteDetails(from, to, duration, price) {
    try {
        document.getElementById('routeFrom').textContent = from;
        document.getElementById('routeTo').textContent = to;
        document.getElementById('routeDuration').textContent = duration;
        document.getElementById('routePrice').textContent = `Rp ${price.toLocaleString('id-ID')}`;
        document.getElementById('routeDetails').style.display = 'block';
        updateConfirmButton();
    } catch (error) {
        console.error('‚ùå Error menampilkan detail rute:', error);
    }
}

function hideRouteDetails() {
    document.getElementById('routeDetails').style.display = 'none';
}

// Fungsi untuk update tombol konfirmasi
function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmBtn');
    try {
        if (markerA && markerB && currentRouteData) {
            confirmBtn.disabled = false;
        } else {
            confirmBtn.disabled = true;
        }
    } catch (error) {
        console.error('‚ùå Error update tombol konfirmasi:', error);
        confirmBtn.disabled = true;
    }
}

// ==================== PERBAIKAN UTAMA: FUNGSI KONFIRMASI RUTE ====================
async function confirmRoute() {
    if (!currentRouteData) {
        showPopup("Silakan pilih rute terlebih dahulu", "Perhatian", "warning");
        return;
    }
    
    showRadar('Mengambil data pengguna...');
    
    try {
        // 1. Dapatkan UID user
        const uid = await getCurrentUserId();
        console.log("‚úÖ UID user yang didapatkan:", uid);
        
        // 2. Ambil data user langsung dari Firebase
        const user = await getUserDataFromFirebase(uid);
        
        // 3. Validasi data user
        if (!user) {
            hideRadar();
            showPopup("Data pengguna tidak ditemukan di database.", "Error", "error");
            return;
        }
        
        if (user.status !== "active") {
            hideRadar();
            showPopup("Akun Anda tidak aktif. Silakan hubungi administrator.", "Akun Tidak Aktif", "error");
            return;
        }
        
        // 4. Pastikan rating dan perjalanan tidak 0
        if (user.rating === 0) {
            console.warn("‚ö†Ô∏è Rating user 0, menggunakan default 5");
            user.rating = 5;
        }
        
        if (user.perjalanan === 0) {
            console.log("‚ÑπÔ∏è Perjalanan user: 0 (mungkin user baru)");
        }
        
        console.log("‚úÖ Data user lengkap untuk order:", {
            userId: user.uid,
            userName: user.name,
            userRating: user.rating,
            userPerjalanan: user.perjalanan,
            userPhone: user.phone,
            userStatus: user.status
        });
        
        hideRadar();
        
        // Zoom in/out halus ke marker A dengan animasi lebih panjang
        if (map && markerA) {
            const currentZoom = map.getZoom();
            const targetZoomIn = Math.min(currentZoom + 2, 18);
            const targetZoomOut = Math.max(currentZoom - 1, 12);
            
            map.panTo(markerA.getPosition());
            map.setZoom(targetZoomIn);
            
            // Animasi zoom yang lebih smooth dan lama
            setTimeout(() => {
                map.setZoom(targetZoomOut);
                setTimeout(() => {
                    processOrderConfirmation(user);
                    
                    // Setelah konfirmasi, aktifkan animasi radar dan pencarian
                    setTimeout(() => {
                        activateRadarAndSearch();
                    }, 500);
                }, 300);
            }, 800);
        } else {
            processOrderConfirmation(user);
            
            // Setelah konfirmasi, aktifkan animasi radar dan pencarian
            setTimeout(() => {
                activateRadarAndSearch();
            }, 500);
        }
        
    } catch (error) {
        hideRadar();
        console.error("‚ùå Error dalam confirmRoute:", error);
        
        if (error.message.includes('Tidak dapat mengidentifikasi user')) {
            showPopup("Tidak dapat mengidentifikasi user. Silakan login kembali.", "Error Autentikasi", "error");
        } else if (error.message.includes('User tidak ditemukan')) {
            showPopup("Data pengguna tidak ditemukan di database. Silakan registrasi ulang.", "User Tidak Ditemukan", "error");
        } else {
            showPopup("Terjadi kesalahan saat mengambil data pengguna: " + error.message, "Error", "error");
        }
    }
}

// Fungsi untuk mengaktifkan radar dan memulai pencarian
function activateRadarAndSearch() {
    // Tampilkan radar dengan animasi ekspansi
    const radar = document.getElementById('radar');
    radar.style.display = 'block';
    setTimeout(() => {
        radar.classList.add('expanding');
    }, 100);
    
    // Update teks radar
    radar.querySelector('span').textContent = 'Mencari driver...';
    
    // Aktifkan animasi zoom kamera yang halus selama pencarian
    startSmoothCameraZoomAnimation();
    
    // Update UI: tombol berubah ke BATALKAN
    document.getElementById('cancelBtn').style.display = 'block';
    document.getElementById('cancelBtn').disabled = false;
    document.getElementById('confirmBtn').style.display = 'none';
}

// ==================== PERBAIKAN: ANIMASI ZOOM KAMERA YANG HALUS ====================
function startSmoothCameraZoomAnimation() {
    if (!map || !markerA || isSmoothZoomRunning) return;
    
    console.log("üé¨ Memulai animasi zoom kamera yang halus");
    
    const startLocation = markerA.getPosition();
    const startZoom = map.getZoom();
    const targetZoom1 = 15;  // Zoom in sedikit
    const targetZoom2 = 13;  // Zoom out lebih jauh
    
    let phase = 1;
    let startTime = null;
    const duration = 4000; // 4 detik per fase
    
    isSmoothZoomRunning = true;
    
    // Fungsi animasi menggunakan requestAnimationFrame
    function animate(currentTime) {
        if (!isSmoothZoomRunning || !isSearching) {
            isSmoothZoomRunning = false;
            return;
        }
        
        if (!startTime) startTime = currentTime;
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function untuk pergerakan halus
        const easeInOutCubic = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        const easedProgress = easeInOutCubic(progress);
        
        if (phase === 1) {
            // Fase 1: Zoom in ke targetZoom1
            const currentZoom = startZoom + (targetZoom1 - startZoom) * easedProgress;
            map.setZoom(currentZoom);
            
            // Gerakkan kamera sedikit ke arah acak
            const randomOffset = {
                lat: Math.sin(progress * Math.PI * 2) * 0.001,
                lng: Math.cos(progress * Math.PI * 2) * 0.001
            };
            
            const newCenter = {
                lat: startLocation.lat() + randomOffset.lat,
                lng: startLocation.lng() + randomOffset.lng
            };
            
            map.panTo(newCenter);
            
            if (progress >= 1) {
                phase = 2;
                startTime = currentTime;
            }
        } else if (phase === 2) {
            // Fase 2: Zoom out ke targetZoom2
            const currentZoom = targetZoom1 + (targetZoom2 - targetZoom1) * easedProgress;
            map.setZoom(currentZoom);
            
            // Gerakkan kamera ke arah lain yang acak
            const randomOffset = {
                lat: Math.cos(progress * Math.PI * 2) * 0.002,
                lng: Math.sin(progress * Math.PI * 2) * 0.002
            };
            
            const newCenter = {
                lat: startLocation.lat() + randomOffset.lat,
                lng: startLocation.lng() + randomOffset.lng
            };
            
            map.panTo(newCenter);
            
            if (progress >= 1) {
                phase = 1;
                startTime = currentTime;
            }
        }
        
        // Lanjutkan animasi
        smoothZoomAnimation = requestAnimationFrame(animate);
    }
    
    // Mulai animasi
    smoothZoomAnimation = requestAnimationFrame(animate);
}

// Fungsi untuk menghentikan animasi zoom yang halus
function stopSmoothCameraZoomAnimation() {
    if (smoothZoomAnimation) {
        cancelAnimationFrame(smoothZoomAnimation);
        smoothZoomAnimation = null;
    }
    isSmoothZoomRunning = false;
    
    // Kembalikan kamera ke posisi normal jika masih ada markerA
    if (map && markerA) {
        map.panTo(markerA.getPosition());
        map.setZoom(14);
    }
}

// Fungsi untuk memproses order (TANPA PROMO)
function processOrderConfirmation(user) {
    showRadar('Mengirim permintaan...');
    
    let finalPrice = roundToNearestThousand(currentBasePrice);
    
    const fromInput = document.getElementById('fromInput').value;
    const toInput = document.getElementById('toInput').value;
    
    console.log("üì§ Mengirim order dengan data user langsung dari Firebase:", {
        userId: user.uid,
        userName: user.name,
        userPhone: user.phone,
        userRating: user.rating,
        userPerjalanan: user.perjalanan
    });
    
    const orderData = {
        // Data user langsung dari Firebase - DENGAN RATING DAN PERJALANAN
        userId: user.uid,
        userName: user.name,
        userPhone: user.phone,
        userPhoto: user.photoURL,
        userRating: user.rating,
        userPerjalanan: user.perjalanan,
        userRole: user.role || 'penumpang',
        userStatus: user.status || 'active',
        
        // Data kendaraan dari data yang dinormalisasi
        vehicle: vehicle,
        vehicleName: getVehicleData(vehicle).name,
        vehicleCapacity: getVehicleData(vehicle).capacity,
        
        // Data rute (alamat dari textbox langsung)
        from: fromInput,
        to: toInput,
        fromLat: currentRouteData.startLocation.lat,
        fromLng: currentRouteData.startLocation.lng,
        toLat: currentRouteData.endLocation.lat,
        toLng: currentRouteData.endLocation.lng,
        distance: currentRouteData.distance,
        duration: currentRouteData.duration,
        price: finalPrice,
        originalPrice: finalPrice,
        status: 'searching',
        timestamp: Date.now(),
        deliveryData: kurirDeliveryData || null
    };
    
    sendOrderToFirebase(orderData);
}

// Fungsi untuk mengirim order ke Firebase (TANPA PROMO)
function sendOrderToFirebase(orderData) {
    const orderId = generateOrderId();
    currentOrderId = orderId;
    
    const orderRef = database.ref('orders/' + orderId);
    orderData.orderId = orderId;
    
    orderRef.set(orderData)
        .then(() => {
            console.log("‚úÖ Order berhasil dikirim ke Firebase dengan data LENGKAP dari Firebase:", {
                orderId: orderId,
                userRating: orderData.userRating,
                userPerjalanan: orderData.userPerjalanan,
                userStatus: orderData.userStatus
            });
            
            saveActiveOrderToLocalStorage(orderId, orderData);
            
            // Mulai mendengarkan perubahan status order
            startOrderStatusListener(orderId);
            
            // Mulai pencarian driver
            startDriverSearch(orderId);
            
            // Update status pencarian
            isSearching = true;
            
        })
        .catch((error) => {
            console.error("‚ùå Gagal mengirim order:", error);
            hideRadar();
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('confirmBtn').style.display = 'block';
            showPopup("Gagal mengirim permintaan. Coba lagi.", "Error", "error");
        });
}

// ==================== PERBAIKAN: LISTENER STATUS ORDER ====================
let orderStatusListenerRef = null;

function startOrderStatusListener(orderId) {
    const orderRef = database.ref('orders/' + orderId);
    
    // Hentikan listener sebelumnya jika ada
    if (orderStatusListenerRef) {
        orderStatusListenerRef.off();
    }
    
    orderStatusListenerRef = orderRef;
    
    orderRef.on('value', (snapshot) => {
        const order = snapshot.val();
        
        if (!order) {
            // Order sudah dihapus (dibatalkan)
            console.log("Order sudah dihapus dari Firebase");
            cleanupSearch();
            return;
        }
        
        console.log("üìä Status order diperbarui:", order.status);
        
        // Jika status berubah menjadi 'accepted'
        if (order.status === 'accepted') {
            console.log("‚úÖ Driver menerima order!");
            
            // Hentikan semua proses pencarian
            cleanupSearch();
            
            // Tampilkan notifikasi sukses
            showPopup(`Driver ${order.driverName || ''} menerima pesanan Anda!`, "Berhasil", "success");
            
            // Redirect ke halaman order diterima setelah 2 detik
            setTimeout(() => {
                window.location.href = `orderAcceptedForCS.html?orderId=${orderId}`;
            }, 2000);
        }
    });
}

// Fungsi untuk membersihkan semua proses pencarian
function cleanupSearch() {
    isSearching = false;
    
    // Hentikan radar
    const radar = document.getElementById('radar');
    radar.style.display = 'none';
    radar.classList.remove('expanding');
    
    // Hentikan animasi zoom kamera yang halus
    stopSmoothCameraZoomAnimation();
    
    // Hentikan timer harga
    if (priceIncreaseTimer) {
        clearTimeout(priceIncreaseTimer);
        priceIncreaseTimer = null;
    }
    
    // Hentikan listener driver offers
    if (driverOffersRef) {
        driverOffersRef.off();
    }
    
    // Hentikan listener order status
    if (orderStatusListenerRef) {
        orderStatusListenerRef.off();
        orderStatusListenerRef = null;
    }
    
    // Hapus driver markers
    clearDriverMarkers();
    
    // Reset UI tombol
    document.getElementById('cancelBtn').style.display = 'none';
    document.getElementById('confirmBtn').style.display = 'block';
    
    // Kosongkan daftar driver offers
    driverOffersList = [];
    document.getElementById('driverOfferList').innerHTML = '';
    document.getElementById('driverOffers').style.display = 'none';
    
    // Hapus order ID
    currentOrderId = null;
}

// ==================== PERBAIKAN UTAMA: FUNGSI BATALKAN ORDER ====================
function cancelSearch() {
    if (!isSearching || !currentOrderId) {
        showPopup("Tidak ada order yang aktif untuk dibatalkan", "Perhatian", "warning");
        return;
    }
    
    // Tampilkan konfirmasi popup
    showConfirmCancelPopup();
}

// Fungsi untuk menampilkan popup konfirmasi pembatalan
function showConfirmCancelPopup() {
    showPopup(
        "Apakah Anda yakin ingin membatalkan pencarian driver?", 
        "Batalkan Pencarian?", 
        "warning", 
        "cancel"
    );
}

// ==================== FUNGSI BARU: HAPUS ORDER DARI FIREBASE ====================
function confirmDeleteOrder() {
    closePopup();
    
    showRadar('Menghapus order...');
    
    const orderRef = database.ref('orders/' + currentOrderId);
    
    // HAPUS order dari Firebase (bukan update status)
    orderRef.remove()
    .then(() => {
        console.log("‚úÖ Order berhasil DIHAPUS dari Firebase:", currentOrderId);
        
        // Hapus juga dari driver_offers jika ada
        const offersRef = database.ref('driver_offers/' + currentOrderId);
        offersRef.remove();
        
        // Hapus dari localStorage
        removeActiveOrderFromLocalStorage();
        
        // Hentikan semua proses pencarian
        cleanupSearch();
        
        hideRadar();
        
        // Tampilkan notifikasi sukses dengan tombol default (hanya OK)
        setTimeout(() => {
            showPopup(
                "Pencarian driver berhasil dibatalkan", 
                "Dibatalkan", 
                "success", 
                "default"
            );
        }, 500);
    })
    .catch((error) => {
        console.error("‚ùå Gagal menghapus order:", error);
        hideRadar();
        showPopup("Gagal membatalkan order. Coba lagi.", "Error", "error", "default");
    });
}

// Fungsi untuk memulai pencarian driver
function startDriverSearch(orderId) {
    isSearching = true;
    
    startPriceIncreaseTimer();
    listenDriverOffers(orderId);
    loadOnlineDriversOnMap();
}

// Fungsi untuk timer penawaran harga
function startPriceIncreaseTimer() {
    if (priceIncreaseTimer) {
        clearTimeout(priceIncreaseTimer);
    }
    
    priceIncreaseTimer = setTimeout(() => {
        if (isSearching) {
            showPriceOfferPopup();
        }
    }, 30000);
}

// Fungsi untuk menampilkan popup penawaran harga
function showPriceOfferPopup() {
    document.getElementById('currentPriceDisplay').textContent = `Rp ${currentBasePrice.toLocaleString('id-ID')}`;
    
    // Hitung harga dengan kenaikan dan pembulatan
    const price10 = roundToNearestThousand(Math.round(currentBasePrice * 1.1));
    const price20 = roundToNearestThousand(Math.round(currentBasePrice * 1.2));
    const price30 = roundToNearestThousand(Math.round(currentBasePrice * 1.3));
    
    document.getElementById('price10').textContent = price10.toLocaleString('id-ID');
    document.getElementById('price20').textContent = price20.toLocaleString('id-ID');
    document.getElementById('price30').textContent = price30.toLocaleString('id-ID');
    
    document.getElementById('priceOfferPopup').classList.add('active');
}

function closePriceOfferPopup() {
    document.getElementById('priceOfferPopup').classList.remove('active');
}

// Fungsi untuk menaikkan harga dengan pembulatan
function increasePrice(percentage) {
    let newPrice = Math.round(currentBasePrice * (1 + percentage));
    newPrice = roundToNearestThousand(newPrice);
    
    currentBasePrice = newPrice;
    
    if (currentOrderId) {
        const orderRef = database.ref('orders/' + currentOrderId);
        orderRef.update({
            price: newPrice,
            originalPrice: newPrice
        });
    }
    
    closePriceOfferPopup();
    showPopup(`Harga dinaikkan menjadi Rp ${newPrice.toLocaleString('id-ID')}`, "Berhasil", "success");
}

// Fungsi untuk mendengarkan penawaran driver
function listenDriverOffers(orderId) {
    const offersRef = database.ref('driver_offers/' + orderId);
    
    offersRef.on('child_added', (snapshot) => {
        const offer = snapshot.val();
        if (offer && offer.status === 'pending') {
            addDriverOffer(offer);
        }
    });
    
    driverOffersRef = offersRef;
}

// Fungsi untuk menambahkan penawaran driver ke daftar
function addDriverOffer(offer) {
    driverOffersList.push(offer);
    
    document.getElementById('driverOffers').style.display = 'block';
    
    renderDriverOffer(offer);
}

// Fungsi untuk merender penawaran driver
function renderDriverOffer(offer) {
    const list = document.getElementById('driverOfferList');
    
    const card = document.createElement('div');
    card.className = 'driver-offer-card';
    card.dataset.driverId = offer.driverId;
    
    card.innerHTML = `
        <div class="driver-info">
            <img src="${offer.driverPhoto || 'https://cdn-icons-png.flaticon.com/128/3135/3135715.png'}" 
                 class="driver-photo" alt="Driver">
            <div class="driver-details">
                <div class="driver-name">
                    <span class="driver-name-text">${offer.driverName || 'Driver'}</span>
                    <span style="color: gold;">‚òÖ</span>
                    <span>${offer.driverRating || '5.0'}</span>
                </div>
                <div class="driver-vehicle">${offer.vehicleType || 'Motor'}</div>
                <div class="driver-rating-container">
                    <span>${offer.completedTrips || 0} trip</span>
                    <span>‚Ä¢</span>
                    <span>${offer.eta || 5} menit</span>
                </div>
            </div>
        </div>
        <button class="accept-btn" onclick="selectDriver('${offer.driverId}')">
            Pilih
        </button>
    `;
    
    list.appendChild(card);
}

// Fungsi untuk memilih driver
function selectDriver(driverId) {
    const selectedDriver = driverOffersList.find(d => d.driverId === driverId);
    if (!selectedDriver) return;
    
    if (currentOrderId) {
        showRadar('Memproses pilihan driver...');
        
        const orderRef = database.ref('orders/' + currentOrderId);
        orderRef.update({
            driverId: driverId,
            driverName: selectedDriver.driverName,
            driverPhoto: selectedDriver.driverPhoto,
            driverVehicle: selectedDriver.vehicleType,
            status: 'accepted',
            acceptedAt: Date.now()
        })
        .then(() => {
            const offersRef = database.ref('driver_offers/' + currentOrderId);
            offersRef.remove();
            
            document.getElementById('driverOffers').style.display = 'none';
            
            hideRadar();
            
            // Redirect ke halaman order diterima setelah 1.5 detik
            setTimeout(() => {
                window.location.href = `orderAcceptedForCS.html?orderId=${currentOrderId}`;
            }, 1500);
        })
        .catch((error) => {
            console.error("‚ùå Gagal memilih driver:", error);
            hideRadar();
            showPopup("Gagal memilih driver. Coba lagi.", "Error", "error");
        });
    }
}

// Fungsi untuk memuat driver online ke peta
function loadOnlineDriversOnMap() {
    const driversRef = database.ref('drivers_online');
    
    driversRef.on('value', (snapshot) => {
        clearDriverMarkers();
        
        const drivers = snapshot.val();
        if (!drivers) return;
        
        Object.keys(drivers).forEach(driverId => {
            const driver = drivers[driverId];
            if (driver.status === 'available' && driver.location) {
                addDriverMarker(driverId, driver);
            }
        });
    });
}

// Fungsi untuk menambahkan marker driver ke peta
function addDriverMarker(driverId, driver) {
    if (!map) return;
    
    const driverLocation = {
        lat: driver.location.lat,
        lng: driver.location.lng
    };
    
    const marker = new google.maps.Marker({
        position: driverLocation,
        map: map,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#4285F4',
            fillOpacity: 1,
            strokeColor: '#FFFFFF',
            strokeWeight: 2
        },
        title: driver.name || 'Driver'
    });
    
    driverMarkers[driverId] = marker;
}

// Fungsi untuk menghapus semua marker driver
function clearDriverMarkers() {
    Object.values(driverMarkers).forEach(marker => {
        if (marker) marker.setMap(null);
    });
    driverMarkers = {};
}

// Fungsi untuk mengecek order aktif
function checkActiveOrder() {
    const activeOrder = getActiveOrderFromLocalStorage();
    if (activeOrder) {
        console.log("üì± Order aktif ditemukan:", activeOrder.orderId);
        
        // Setel variabel global
        currentOrderId = activeOrder.orderId;
        currentRouteData = activeOrder.data;
        
        // Mulai mendengarkan status order
        startOrderStatusListener(currentOrderId);
        
        // Aktifkan mode pencarian
        isSearching = true;
        
        // Tampilkan radar dan tombol batalkan
        activateRadarAndSearch();
        
        // Mulai pencarian driver
        startDriverSearch(currentOrderId);
    }
}

// Fungsi untuk menghasilkan ID order
function generateOrderId() {
    return 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Fungsi untuk menyimpan order aktif ke localStorage
function saveActiveOrderToLocalStorage(orderId, orderData) {
    localStorage.setItem('jego_active_order', JSON.stringify({
        orderId: orderId,
        data: orderData,
        timestamp: Date.now()
    }));
}

// Fungsi untuk mengambil order aktif dari localStorage
function getActiveOrderFromLocalStorage() {
    try {
        const saved = localStorage.getItem('jego_active_order');
        return saved ? JSON.parse(saved) : null;
    } catch (e) {
        return null;
    }
}

// Fungsi untuk menghapus order aktif dari localStorage
function removeActiveOrderFromLocalStorage() {
    localStorage.removeItem('jego_active_order');
}

// Fungsi toggle map mode (jika diperlukan)
function toggleMapMode() {
    if (map) {
        const currentMapType = map.getMapTypeId();
        const newMapType = currentMapType === 'roadmap' ? 'hybrid' : 'roadmap';
        map.setMapTypeId(newMapType);
        
        const btn = document.getElementById('mapModeBtn');
        btn.textContent = newMapType === 'roadmap' ? 'Mode Malam' : 'Mode Siang';
    }
}

// Inisialisasi tambahan setelah halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    console.log("üì± DOM JeGo Rute siap");
    
    // Cek apakah ada order aktif saat halaman dimuat
    checkActiveOrder();
});

</script>
</body>
</html>
