<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Driver Details - JeGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary: #FF9800;    /* Orange */
      --secondary: #FF5722;   /* Red-Orange */
      --accent: #FFC107;     /* Amber/Yellow */
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #4CAF50;    /* Green */
      --danger: #f44336;     /* Red */
      --warning: #FFC107;    /* Yellow */
      --info: #2196F3;       /* Blue */
      --gray: #9E9E9E;       /* Gray */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--dark);
      height: 100vh;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    .container {
      width: 100%;
      max-width: 100%;
      background: white;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      margin-top: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      text-align: center;
      position: relative;
      flex-shrink: 0;
      z-index: 100;
    }

    .header h1 {
      display: none;
    }

    /* ==================== STYLE PETA ==================== */
    .map-section {
      width: 100%;
      height: 50vh;
      min-height: 300px;
      flex-shrink: 0;
      position: relative;
      z-index: 1;
      display: none;
    }

    #orderMap {
      width: 100%;
      height: 100%;
      border: none;
    }

    .leaflet-control-zoom {
      border: 1px solid #ddd !important;
      border-radius: 4px !important;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
    }

    /* PERBAIKAN SCROLL: Konten utama bisa discroll */
    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      padding-bottom: 120px; /* Space untuk tombol aksi */
      -webkit-overflow-scrolling: touch; /* Smooth scroll di iOS */
      max-height: calc(100vh - 50vh - 60px); /* Batasi tinggi maksimum */
    }

    .status-section {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      text-align: center;
    }

    .status-badge {
      background: var(--accent);
      color: var(--dark);
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .driver-section {
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    .driver-profile {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 15px;
    }

    .driver-photo-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .driver-photo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--secondary);
    }

    .driver-plate {
      background: var(--accent);
      color: var(--dark);
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.7rem;
      margin-top: 5px;
      text-align: center;
    }

    .driver-info {
      flex: 1;
    }

    .driver-name {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .driver-rating {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 5px;
      font-size: 0.85rem;
    }

    .stars {
      color: var(--accent);
    }

    .rating-value {
      font-weight: 600;
      color: var(--dark);
    }

    .driver-vehicle {
      font-size: 0.8rem;
      color: #666;
    }

    .driver-arrival {
      background: rgba(40, 150, 114, 0.1);
      padding: 12px;
      border-radius: 10px;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .arrival-icon {
      width: 35px;
      height: 35px;
      background: var(--success);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      flex-shrink: 0;
    }

    .arrival-text {
      flex: 1;
    }

    .arrival-title {
      font-weight: 600;
      color: var(--success);
      margin-bottom: 2px;
      font-size: 0.85rem;
    }

    .arrival-subtitle {
      font-size: 0.75rem;
      color: #666;
    }

    .route-section {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }

    .section-title {
      font-size: 0.9rem;
      color: var(--primary);
      margin-bottom: 10px;
      font-weight: 600;
    }

    .route-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .route-point {
      display: flex;
      gap: 10px;
    }

    .route-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 10px;
    }

    .pickup-icon {
      background: var(--success);
      color: white;
    }

    .destination-icon {
      background: var(--primary);
      color: white;
    }

    .route-text {
      flex: 1;
    }

    .route-label {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 2px;
    }

    .route-address {
      font-weight: 500;
      color: var(--dark);
      font-size: 0.8rem;
    }

    .info-section {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }

    .info-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      flex: 1;
      text-align: center;
      padding: 0 5px;
    }

    .info-label {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 3px;
    }

    .info-value {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.8rem;
    }

    .price-highlight {
      color: var(--success);
      font-weight: 700;
      font-size: 0.9rem;
    }

    .discount-badge {
      background: var(--warning);
      color: var(--dark);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 5px;
    }

    .original-price {
      text-decoration: line-through;
      color: #999;
      font-size: 0.75rem;
      margin-right: 5px;
    }

    /* ==================== SECTION PROMO ==================== */
    .promo-section {
      padding: 12px 20px;
      border-bottom: 1px solid #eee;
      display: none;
      background: white;
    }

    .promo-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: linear-gradient(135deg, #ffd700, #ff9800);
      color: #333;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .promo-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .promo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .promo-label {
      color: #666;
      font-weight: 500;
    }

    .promo-value {
      font-weight: 600;
      color: var(--dark);
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .final-price {
      color: var(--success);
      font-weight: 700;
      font-size: 0.85rem;
    }

    /* Actions Section - Fixed at Bottom */
    .actions-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: white;
      border-top: 1px solid #eee;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .action-btn {
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .chat-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 15px rgba(40, 150, 114, 0.3);
    }

    .cancel-btn {
      background: linear-gradient(to right, var(--danger), #e74c3c);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .completed-badge {
      background: var(--success);
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .completed-badge:hover {
      background: #218838;
      transform: scale(1.05);
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px;
      text-align: center;
      flex: 1;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(40, 150, 114, 0.2);
      border-radius: 50%;
      border-top-color: var(--secondary);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .error-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px;
      text-align: center;
      color: var(--danger);
      flex: 1;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .retry-btn {
      margin-top: 20px;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ==================== STYLE CHAT FULL SCREEN ==================== */
    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .chat-container {
      width: 100%;
      height: 100%;
      background: white;
      border-radius: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid white;
    }

    .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-name {
      font-weight: 600;
      font-size: 16px;
    }

    .chat-status {
      font-size: 12px;
      opacity: 0.8;
    }

    .close-chat {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #ECE5DD;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message-bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      position: relative;
    }

    .message-left {
      align-self: flex-start;
      background: white;
      border-bottom-left-radius: 5px;
    }

    .message-right {
      align-self: flex-end;
      background: #DCF8C6;
      border-bottom-right-radius: 5px;
    }

    .message-time {
      font-size: 11px;
      color: #888;
      margin-top: 5px;
      text-align: right;
    }

    .chat-input-area {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #ddd;
      flex-shrink: 0;
    }

    .chat-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
    }

    .chat-send-btn {
      margin-left: 10px;
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
    }

    .chat-notification {
      position: fixed;
      top: 70px;
      right: 10px;
      left: 10px;
      background: #25D366;
      color: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 2001;
      cursor: pointer;
      display: none;
    }

    .chat-notification strong {
      display: block;
      margin-bottom: 5px;
    }

    .chat-notification p {
      margin: 0;
      font-size: 14px;
    }

    .chat-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    /* Modal Rating Styles */
    .rating-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .rating-modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 350px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      animation: modalAppear 0.3s ease-out;
    }

    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 15px 0;
      font-size: 2rem;
    }

    .rating-star {
      cursor: pointer;
      transition: all 0.2s;
      color: #ddd;
      user-select: none;
    }

    .rating-star:hover {
      transform: scale(1.2);
    }

    .rating-star.active {
      color: #FFD700;
    }

    .rating-comment {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin: 12px 0;
      font-family: inherit;
      resize: vertical;
      min-height: 70px;
      font-size: 0.85rem;
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    .modal-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }

    .modal-cancel {
      background: #e9ecef;
      color: #495057;
    }

    .modal-cancel:hover {
      background: #dee2e6;
    }

    .modal-submit {
      background: var(--primary);
      color: white;
    }

    .modal-submit:hover {
      background: var(--secondary);
    }

    .modal-submit:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    /* Modal Konfirmasi dan Informasi */
    .confirmation-modal, .info-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .confirmation-modal-content, .info-modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 350px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      animation: modalAppear 0.3s ease-out;
    }

    .confirmation-title, .info-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--dark);
    }

    .confirmation-message, .info-message {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .confirmation-buttons, .info-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .confirmation-btn, .info-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
      min-width: 80px;
    }

    .btn-cancel {
      background: #e9ecef;
      color: #495057;
    }

    .btn-cancel:hover {
      background: #dee2e6;
    }

    .btn-confirm {
      background: var(--danger);
      color: white;
    }

    .btn-confirm:hover {
      background: #c82333;
    }

    .btn-ok {
      background: var(--primary);
      color: white;
    }

    .btn-ok:hover {
      background: var(--secondary);
    }

    /* Custom scrollbar untuk konten */
    .content-wrapper::-webkit-scrollbar {
      width: 6px;
    }

    .content-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .content-wrapper::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    .content-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      body {
        padding: 0;
      }
      
      .container {
        border-radius: 0;
        height: 100vh;
      }
      
      .status-section, .driver-section, .route-section, .info-section, .promo-section {
        padding: 15px;
      }
      
      .driver-profile {
        gap: 12px;
      }
      
      .driver-photo {
        width: 60px;
        height: 60px;
      }
      
      .info-row {
        flex-wrap: wrap;
      }
      
      .info-item {
        min-width: 50%;
        margin-bottom: 8px;
      }
      
      .rating-modal-content, .confirmation-modal-content, .info-modal-content {
        padding: 18px;
      }
      
      .rating-stars {
        font-size: 1.8rem;
      }

      .chat-container {
        width: 100%;
        height: 100%;
      }

      .chat-notification {
        right: 10px;
        left: 10px;
      }
      
      /* PERBAIKAN RESPONSIVE: Tinggi peta disesuaikan */
      .map-section {
        height: 40vh;
        min-height: 250px;
      }
      
      .content-wrapper {
        max-height: calc(100vh - 40vh - 60px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Detail Driver</h1>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Memuat data driver...</p>
    </div>

    <div id="error" class="error-message" style="display: none;">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Data Tidak Tersedia</h3>
      <p>Data driver tidak ditemukan. Silakan coba lagi atau pesan driver baru.</p>
      <button class="retry-btn" onclick="safeGoBack()">Kembali</button>
    </div>

    <div id="content" style="display: none;">
      <!-- Map Section - Full Width 100%, Height 50% -->
      <div class="map-section" id="mapSection" style="display: none;">
        <div id="orderMap"></div>
      </div>

      <div class="content-wrapper">
        <div class="status-section">
          <div class="status-badge" id="statusBadge" style="display: none;">Menuju Lokasi</div>
        </div>

        <div class="driver-section">
          <div class="driver-profile">
            <div class="driver-photo-container">
              <img id="driverPhoto" src="" alt="Driver Photo" class="driver-photo">
              <div class="driver-plate" id="driverPlate">-</div>
            </div>
            <div class="driver-info">
              <div class="driver-name" id="driverName">-</div>
              <div class="driver-rating">
                <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                <div class="rating-value" id="driverRating">4.9</div>
              </div>
              <div class="driver-vehicle">
                <span id="driverVehicleBrand">-</span> ‚Ä¢ <span id="driverVehicleType">-</span>
              </div>
            </div>
          </div>

          <div class="driver-arrival">
            <div class="arrival-icon">üöó</div>
            <div class="arrival-text">
              <div class="arrival-title" id="arrivalTitle">Order Diterima</div>
              <div class="arrival-subtitle" id="arrivalSubtitle">Driver sedang menuju lokasi penjemputan.</div>
            </div>
          </div>
        </div>

        <div class="route-section">
          <div class="section-title">Detail Perjalanan</div>
          <div class="route-details">
            <div class="route-point">
              <div class="route-icon pickup-icon">A</div>
              <div class="route-text">
                <div class="route-label">Penjemputan</div>
                <div class="route-address" id="pickupAddress">-</div>
              </div>
            </div>
            <div class="route-point">
              <div class="route-icon destination-icon">B</div>
              <div class="route-text">
                <div class="route-label">Tujuan</div>
                <div class="route-address" id="destinationAddress">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <div class="section-title">Informasi Perjalanan</div>
          <div class="info-grid">
            <!-- Baris 1: Jenis Layanan | Kapasitas | Durasi -->
            <div class="info-row">
              <div class="info-item">
                <div class="info-label">Jenis Layanan</div>
                <div class="info-value" id="serviceType">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Kapasitas</div>
                <div class="info-value" id="serviceCapacity">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Durasi</div>
                <div class="info-value" id="tripDuration">-</div>
              </div>
            </div>
            
            <!-- Baris 2: Jarak | Waktu Order -->
            <div class="info-row">
              <div class="info-item">
                <div class="info-label">Jarak</div>
                <div class="info-value" id="tripDistance">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Waktu Order</div>
                <div class="info-value" id="orderTime">-</div>
              </div>
            </div>
            
            <!-- Baris 3: Biaya saja -->
            <div class="info-row">
              <div class="info-item">
                <div class="info-label">Biaya</div>
                <div class="info-value">
                  <div id="priceContainer">
                    <span class="price-highlight" id="tripPrice">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== SECTION PROMO ==================== -->
        <div class="promo-section" id="promoSection">
          <div class="section-title">Promo</div>
          <div class="promo-details">
            <div class="promo-item">
              <span class="promo-label">Kode Promo:</span>
              <span class="promo-value" id="promoCode">  </span>
            </div>
            <div class="promo-item">
              <span class="promo-label">Harga Asli:</span>
              <span class="promo-value">
                <span class="original-price" id="originalPrice">  </span>
              </span>
            </div>
            <div class="promo-item">
              <span class="promo-label">Diskon:</span>
              <span class="promo-value">
                <span class="discount-badge" id="discountPercentage">  </span>
              </span>
            </div>
            <div class="promo-item">
              <span class="promo-label">Harga Final:</span>
              <span class="promo-value final-price" id="finalPrice">  </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions Section - Fixed at Bottom -->
    <div class="actions-section" id="actionsSection" style="display: none;">
      <button class="action-btn chat-btn" onclick="openChat()" id="contactBtn" style="position: relative;">
        <span>üí¨</span> Chat Driver
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
      </button>
      <button class="action-btn cancel-btn" onclick="cancelTrip()">
        <span>‚úñ</span> Batalkan Perjalanan
      </button>
    </div>
  </div>

  <!-- Overlay Chat -->
  <div class="chat-overlay" id="chatOverlay">
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-header-info">
          <div class="chat-avatar" id="chatAvatar">
            <!-- Avatar driver akan diisi JavaScript -->
          </div>
          <div>
            <div class="chat-name" id="chatName">Driver</div>
            <div class="chat-status" id="chatStatus">Online</div>
          </div>
        </div>
        <button class="close-chat" onclick="closeChat()">‚úï</button>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <!-- Pesan akan dimuat di sini -->
      </div>
      
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." />
        <button class="chat-send-btn" id="chatSendBtn">Kirim</button>
      </div>
    </div>
  </div>

  <!-- Notifikasi Chat -->
  <div class="chat-notification" id="chatNotification">
    <strong>üí¨ Pesan Baru</strong>
    <p id="notificationMessage"></p>
    <small>Klik untuk membalas</small>
  </div>

  <!-- Modal Rating -->
  <div id="ratingModal" class="rating-modal">
    <div class="rating-modal-content">
      <h2>Beri Rating Driver</h2>
      <p>Bagaimana pengalaman perjalanan Anda?</p>
      
      <div class="rating-stars" id="ratingStars">
        <span class="rating-star" data-rating="1">‚òÜ</span>
        <span class="rating-star" data-rating="2">‚òÜ</span>
        <span class="rating-star" data-rating="3">‚òÜ</span>
        <span class="rating-star" data-rating="4">‚òÜ</span>
        <span class="rating-star" data-rating="5">‚òÜ</span>
      </div>
      
      <textarea 
        class="rating-comment" 
        id="ratingComment" 
        placeholder="Tambahkan komentar (opsional)..."
      ></textarea>
      
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" onclick="closeRatingModal()">Batal</button>
        <button class="modal-btn modal-submit" onclick="submitRating()" id="submitRatingBtn">Kirim Rating</button>
      </div>
    </div>
  </div>

  <!-- Modal Konfirmasi -->
  <div id="confirmationModal" class="confirmation-modal">
    <div class="confirmation-modal-content">
      <div class="confirmation-title" id="confirmationTitle">Konfirmasi</div>
      <div class="confirmation-message" id="confirmationMessage"></div>
      <div class="confirmation-buttons">
        <button class="confirmation-btn btn-cancel" onclick="closeConfirmationModal()">Batal</button>
        <button class="confirmation-btn btn-confirm" onclick="confirmAction()">Ya</button>
      </div>
    </div>
  </div>

  <!-- Modal Informasi -->
  <div id="infoModal" class="info-modal">
    <div class="info-modal-content">
      <div class="info-title" id="infoTitle">Informasi</div>
      <div class="info-message" id="infoMessage"></div>
      <div class="info-buttons">
        <button class="info-btn btn-ok" onclick="closeInfoModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ==================== KONFIGURASI FIREBASE YANG DIPERBARUI ====================
    // Diambil dari registrasi_jego.html
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
      authDomain: "game-balap-simpel.firebaseapp.com",
      databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
      projectId: "game-balap-simpel",
      storageBucket: "game-balap-simpel.firebasestorage.app",
      messagingSenderId: "864576853495",
      appId: "1:864576853495:web:6f16eb757fd3d8affb0af2",
      measurementId: "G-YWJPK7Y3J4"
    };

    // Initialize Firebase dengan konfigurasi baru
    firebase.initializeApp(FIREBASE_CONFIG);
    const database = firebase.database();

    // Data yang diterima dari halaman rute
    let driverData = null;
    let routeData = null;
    let userData = null;
    let orderId = null;
    
    // Variabel untuk Firebase listener
    let orderRef = null;
    let orderUpdateHandler = null;
    
    // Timeout untuk cek data kosong
    let dataTimeout = null;

    // Variabel untuk rating
    let selectedRating = 0;
    let isRatingSubmitted = false;

    // Variabel untuk modal konfirmasi
    let confirmCallback = null;
    let currentAction = '';

    // ==================== VARIABEL SISTEM CHAT ====================
    let chatRef = null;
    let chatListener = null;
    let unreadMessages = 0;
    let chatOpen = false;

    // ==================== VARIABEL UNTUK MENCEGAH BACK ====================
    let currentOrderStatus = '';
    let isBackBlocked = false;

    // ==================== VARIABEL PETA DAN LOKASI ====================
    let orderMap = null;
    let driverMarker = null;
    let pickupMarker = null;
    let destinationMarker = null;
    let routePolyline = null;
    let driverLocationListener = null;

    // ==================== VARIABEL UNTUK TRIP INCREMENT ====================
    let tripAlreadyIncremented = false;

    // ==================== MAPPING ICON KENDARAAN ====================
    const vehicleIconMap = {
      'motor': 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
      'bentor': 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png',
      'mobil': 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
      'kurir_motor': 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png',
      'kurir_bentor': 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png'
    };

    // OpenRouteService API Key
    const ORS_API_KEY = '5b3ce3597851110001cf6248ddd85ecde3854d768e0a852f64697af0';

    // ==================== FUNGSI BARU: UPDATE PROMO DI LOCALSTORAGE ====================

    // FUNGSI BARU: Update status promo di localStorage
    function updatePromoStatusInLocalStorage(promoCode) {
        try {
            console.log('üíæ Memperbarui status promo di localStorage...');
            
            // 1. Update di jego_logged_in_user
            const loggedInUser = localStorage.getItem('jego_logged_in_user');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                if (user.promo_code === promoCode) {
                    user.promo_status = 'used';
                    user.promo_used_at = new Date().toISOString();
                    user.promo_used_order = orderId;
                    user.promo_used_count = (user.promo_used_count || 0) + 1;
                    
                    localStorage.setItem('jego_logged_in_user', JSON.stringify(user));
                    console.log('‚úÖ Status promo diupdate di jego_logged_in_user');
                }
            }
            
            // 2. Update di jego_user_promo
            const userPromo = localStorage.getItem('jego_user_promo');
            if (userPromo) {
                const promo = JSON.parse(userPromo);
                if (promo.code === promoCode) {
                    promo.status = 'used';
                    promo.used_at = new Date().toISOString();
                    promo.used_order = orderId;
                    promo.used_count = (promo.used_count || 0) + 1;
                    
                    localStorage.setItem('jego_user_promo', JSON.stringify(promo));
                    console.log('‚úÖ Status promo diupdate di jego_user_promo');
                }
            }
            
            // 3. Update di jego_users (data registrasi)
            const jegoUsers = localStorage.getItem('jego_users');
            if (jegoUsers) {
                const users = JSON.parse(jegoUsers);
                let updated = false;
                
                Object.keys(users).forEach(key => {
                    const user = users[key];
                    if (user.promo_code === promoCode) {
                        user.promo_status = 'used';
                        user.promo_used_at = new Date().toISOString();
                        user.promo_used_order = orderId;
                        user.promo_used_count = (user.promo_used_count || 0) + 1;
                        updated = true;
                        console.log('‚úÖ Status promo diupdate di jego_users untuk user:', key);
                    }
                });
                
                if (updated) {
                    localStorage.setItem('jego_users', JSON.stringify(users));
                }
            }
            
            // 4. Update di jego_active_order
            const activeOrder = localStorage.getItem('jego_active_order');
            if (activeOrder) {
                const order = JSON.parse(activeOrder);
                if (order.promo_code_used === promoCode || order.kode_promo === promoCode) {
                    order.promo_status = 'used';
                    order.promo_used_at = new Date().toISOString();
                    localStorage.setItem('jego_active_order', JSON.stringify(order));
                    console.log('‚úÖ Status promo diupdate di jego_active_order');
                }
            }
            
            console.log('üíæ Update promo di localStorage selesai');
            
        } catch (error) {
            console.error('‚ùå Gagal update status promo di localStorage:', error);
        }
    }

    // FUNGSI BARU: Validasi masa berlaku promo
    function validatePromoExpiry(promoData) {
        if (!promoData || !promoData.promo_expiry) {
            console.warn('‚ö†Ô∏è Data promo tidak lengkap untuk validasi expiry');
            return false;
        }
        
        try {
            const expiryDate = new Date(promoData.promo_expiry);
            const currentDate = new Date();
            
            const isValid = currentDate <= expiryDate;
            console.log('üìÖ Validasi masa berlaku promo:', {
                expiry: expiryDate.toLocaleDateString('id-ID'),
                current: currentDate.toLocaleDateString('id-ID'),
                isValid: isValid
            });
            
            return isValid;
            
        } catch (error) {
            console.error('‚ùå Error validasi expiry promo:', error);
            return false;
        }
    }

    // FUNGSI BARU: Cleanup promo yang sudah kadaluarsa di localStorage
    function cleanupExpiredPromos() {
        try {
            console.log('üßπ Membersihkan promo yang sudah kadaluarsa...');
            
            // Cleanup jego_user_promo
            const userPromo = localStorage.getItem('jego_user_promo');
            if (userPromo) {
                const promo = JSON.parse(userPromo);
                if (promo.expiry && !validatePromoExpiry(promo)) {
                    localStorage.removeItem('jego_user_promo');
                    console.log('‚úÖ Promo kadaluarsa dihapus dari jego_user_promo');
                }
            }
            
            // Cleanup jego_logged_in_user
            const loggedInUser = localStorage.getItem('jego_logged_in_user');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                if (user.promo_expiry && !validatePromoExpiry(user)) {
                    user.promo_status = 'expired';
                    localStorage.setItem('jego_logged_in_user', JSON.stringify(user));
                    console.log('‚úÖ Status promo diupdate menjadi expired di jego_logged_in_user');
                }
            }
            
        } catch (error) {
            console.error('‚ùå Error cleanup promo kadaluarsa:', error);
        }
    }

    // ==================== FUNGSI UPDATE STATUS DISKON YANG DIPERBAIKI ====================

    // Fungsi untuk mengupdate status diskon ketika order diterima
    function updateDiscountStatus() {
        console.log('üîÑ Memulai updateDiscountStatus...');
        
        if (!userData) {
            console.error('‚ùå userData tidak tersedia:', userData);
            return;
        }

        if (!orderId) {
            console.error('‚ùå orderId tidak tersedia:', orderId);
            return;
        }

        console.log('üìã Data yang tersedia:', {
            userData: userData,
            orderId: orderId,
            routeData: routeData
        });

        // PERBAIKAN: Ambil kode promo dari berbagai kemungkinan field
        const hasDiscount = routeData && routeData.diskon_persen && routeData.diskon_persen > 0;
        
        // CARI KODE PROMO DARI BERBAGAI FIELD YANG MUNGKIN
        let promoCode = null;
        if (routeData) {
            promoCode = routeData.promo_code_used || 
                       routeData.kode_promo || 
                       (routeData.promo_data && routeData.promo_data.code) ||
                       userData.promo_code;
        }
        
        console.log('üí∞ Status diskon:', {
            hasDiscount: hasDiscount,
            promoCode: promoCode,
            diskon_persen: routeData?.diskon_persen,
            kode_promo: routeData?.kode_promo,
            promo_data: routeData?.promo_data
        });
        
        if (hasDiscount && promoCode) {
            console.log('üéØ Diskonditemukan, memulai update...');
            console.log('üì¶ Data diskon:', {
                promo_code: promoCode,
                diskon_persen: routeData.diskon_persen,
                harga_asal: routeData.harga_asal,
                harga_total: routeData.harga_total
            });
            
            // ‚≠ê‚≠ê VALIDASI MASA BERLAKU PROMO SEBELUM UPDATE ‚≠ê‚≠ê
            const promoData = userData.promo_data || userData;
            const isPromoValid = validatePromoExpiry(promoData);
            
            if (!isPromoValid) {
                console.warn('‚ö†Ô∏è Promo sudah kadaluarsa, tidak melakukan update status');
                showInfoModal('Promo Kadaluarsa', 'Kode promo yang digunakan sudah melewati masa berlaku (30 hari).');
                return;
            }
            
            // Update status diskon di Firebase
            updateDiscountInFirebase(promoCode);
        } else {
            console.log('‚ÑπÔ∏è Order tidak menggunakan diskon atau data tidak lengkap');
        }
    }

    // FUNGSI YANG DIPERBAIKI: Update status diskon di Firebase
    function updateDiscountInFirebase(promoCode) {
        console.log('üîÑ Memulai update diskon di Firebase dengan promo code:', promoCode);
        
        if (!userData) {
            console.error('‚ùå userData tidak tersedia');
            return;
        }

        // PERBAIKAN: Gunakan user_key langsung dari data order
        const userKey = userData.firebase_key || userData.user_key;
        
        if (!userKey) {
            console.error('‚ùå User key tidak ditemukan di userData:', userData);
            
            // Fallback: cari berdasarkan telepon
            const userPhone = userData.telepon || userData.phone;
            if (!userPhone) {
                console.error('‚ùå Nomor telepon user juga tidak ditemukan');
                return;
            }
            
            console.log('üîç Mencari user dengan nomor telepon:', userPhone);
            searchUserByPhoneAndUpdateDiscount(userPhone, promoCode);
            return;
        }

        console.log('üîë Menggunakan user key langsung:', userKey);
        updateDiscountWithUserKey(promoCode, userKey);
    }

    // FUNGSI BARU: Update dengan user key langsung
    function updateDiscountWithUserKey(promoCode, userKey) {
        console.log('üîÑ Update diskon dengan user key:', userKey);
        
        const userRef = database.ref('users/' + userKey);
        
        userRef.once('value').then((snapshot) => {
            const userDataFromFirebase = snapshot.val();
            
            if (userDataFromFirebase) {
                console.log('‚úÖ User ditemukan di Firebase dengan key:', userKey);
                console.log('üìä Data user dari Firebase:', userDataFromFirebase);
                
                // PERBAIKAN: Pastikan promo code match sebelum update
                const userPromoCode = userDataFromFirebase.promo_code;
                if (userPromoCode !== promoCode) {
                    console.warn('‚ö†Ô∏è Kode promo tidak match:', {
                        user_promo: userPromoCode,
                        order_promo: promoCode
                    });
                    // Tetap lanjutkan update, mungkin user punya multiple promo
                }
                
                // Update status promo
                const updates = {
                    promo_status: 'used',
                    promo_used_at: new Date().toISOString(),
                    promo_used_order: orderId,
                    promo_used_count: (userDataFromFirebase.promo_used_count || 0) + 1,
                    updated_at: new Date().toISOString()
                };
                
                console.log('üîÑ Data yang akan diupdate:', updates);
                
                return userRef.update(updates)
                    .then(() => {
                        console.log('‚úÖ Status diskon diupdate di Firebase: used');
                        
                        // Update userData lokal dengan data terbaru
                        userData = { ...userData, ...updates };
                        
                        // Verifikasi update berhasil
                        return userRef.once('value').then((updatedSnapshot) => {
                            const updatedData = updatedSnapshot.val();
                            console.log('‚úÖ Data setelah update:', {
                                promo_status: updatedData.promo_status,
                                promo_used_at: updatedData.promo_used_at,
                                promo_used_order: updatedData.promo_used_order,
                                promo_used_count: updatedData.promo_used_count
                            });
                            
                            // Update localStorage setelah berhasil update Firebase
                            updateDiscountInLocalStorage(promoCode);
                            
                            // Kirim notifikasi ke Kodular
                            sendDiscountUsedNotification(promoCode);
                            
                            return true;
                        });
                    });
            } else {
                throw new Error('Data user tidak ditemukan di Firebase dengan key: ' + userKey);
            }
        })
        .then((success) => {
            if (success) {
                console.log('‚úÖ Update diskon berhasil di Firebase');
            }
        })
        .catch((error) => {
            console.error('‚ùå Gagal update status diskon di Firebase:', error);
            
            // Fallback ke pencarian berdasarkan telepon
            const userPhone = userData.telepon || userData.phone;
            if (userPhone) {
                console.log('üîÑ Mencoba fallback dengan nomor telepon:', userPhone);
                searchUserByPhoneAndUpdateDiscount(userPhone, promoCode);
            }
        });
    }

    // FUNGSI BARU: Cari user berdasarkan telepon dan update discount
    function searchUserByPhoneAndUpdateDiscount(userPhone, promoCode) {
        console.log('üîç Mencari user dengan nomor telepon:', userPhone);
        
        const usersRef = database.ref('users');
        
        usersRef.orderByChild('telepon').equalTo(userPhone).once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const userKeys = Object.keys(snapshot.val());
                    if (userKeys.length > 0) {
                        const userKey = userKeys[0];
                        console.log('‚úÖ User ditemukan dengan key:', userKey);
                        updateDiscountWithUserKey(promoCode, userKey);
                    } else {
                        throw new Error('User tidak ditemukan dengan nomor telepon tersebut');
                    }
                } else {
                    throw new Error('User tidak ditemukan di database');
                }
            })
            .catch((error) => {
                console.error('‚ùå Gagal mencari user berdasarkan telepon:', error);
            });
    }

    // Fungsi untuk mengupdate status diskon di localStorage
    function updateDiscountInLocalStorage(promoCode) {
        try {
            console.log('üíæ Memperbarui status diskon di localStorage...');
            
            // Update di logged_in_user
            const loggedInUser = localStorage.getItem('jego_logged_in_user');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                // PERBAIKAN: Update jika promo code match atau tidak ada kondisi
                if (!user.promo_code || user.promo_code === promoCode) {
                    user.promo_status = 'used';
                    user.promo_used_at = new Date().toISOString();
                    user.promo_used_order = orderId;
                    user.promo_used_count = (user.promo_used_count || 0) + 1;
                    
                    localStorage.setItem('jego_logged_in_user', JSON.stringify(user));
                    console.log('‚úÖ Status diskon diupdate di localStorage user data');
                }
            }
            
            // Update di user_promo
            const userPromo = localStorage.getItem('jego_user_promo');
            if (userPromo) {
                const promo = JSON.parse(userPromo);
                if (promo.code === promoCode) {
                    promo.status = 'used';
                    promo.used_at = new Date().toISOString();
                    promo.used_order = orderId;
                    
                    localStorage.setItem('jego_user_promo', JSON.stringify(promo));
                    console.log('‚úÖ Status diskon diupdate di localStorage promo data');
                }
            }
            
            // Update di active_order
            const activeOrder = localStorage.getItem('jego_active_order');
            if (activeOrder) {
                const order = JSON.parse(activeOrder);
                // PERBAIKAN: Update berbagai field promo yang mungkin
                if (order.promo_code_used === promoCode || 
                    order.kode_promo === promoCode || 
                    (order.promo_data && order.promo_data.code === promoCode)) {
                    
                    order.promo_status = 'used';
                    order.promo_used_at = new Date().toISOString();
                    localStorage.setItem('jego_active_order', JSON.stringify(order));
                    console.log('‚úÖ Status diskon diupdate di active order');
                }
            }
            
            // ‚≠ê‚≠ê PERBAIKAN UTAMA: UPDATE DATA PROMO DI LOCALSTORAGE REGISTRASI ‚≠ê‚≠ê
            updatePromoStatusInLocalStorage(promoCode);
            
            console.log('üíæ Update localStorage selesai');
            
        } catch (error) {
            console.error('‚ùå Gagal update status diskon di localStorage:', error);
        }
    }

    // Fungsi untuk mengirim notifikasi penggunaan diskon ke Kodular
    function sendDiscountUsedNotification(promoCode) {
        const discountData = {
            action: 'discount_used',
            order_id: orderId,
            promo_code: promoCode,
            discount_percentage: routeData.diskon_persen,
            original_price: routeData.harga_asal,
            discounted_price: routeData.harga_total,
            message: `Diskon ${routeData.diskon_persen}% dengan kode ${promoCode} telah digunakan`,
            timestamp: new Date().toISOString()
        };
        
        sendToKodular(discountData);
        console.log('üì® Notifikasi penggunaan diskon dikirim ke Kodular');
    }

    // ==================== FUNGSI DISKON YANG DIPERBAIKI ====================

    // Fungsi untuk menampilkan harga dengan diskon
    function displayPriceWithDiscount() {
      const priceContainer = document.getElementById('priceContainer');
      const tripPrice = document.getElementById('tripPrice');
      const promoSection = document.getElementById('promoSection');
      const promoCode = document.getElementById('promoCode');
      const originalPrice = document.getElementById('originalPrice');
      const discountPercentage = document.getElementById('discountPercentage');
      const finalPrice = document.getElementById('finalPrice');
      
      if (!routeData) return;
      
      // Cek apakah ada data diskon
      const hasDiscount = routeData.diskon_persen && routeData.diskon_persen > 0;
      const hasOriginalPrice = routeData.harga_asal && routeData.harga_asal > 0;
      
      if (hasDiscount && hasOriginalPrice) {
        // Hitung harga setelah diskon
        const discountAmount = (routeData.harga_asal * routeData.diskon_persen) / 100;
        const discountedPrice = routeData.harga_total || (routeData.harga_asal - discountAmount);
        
        // Tampilkan section promo
        promoSection.style.display = 'block';
        
        // Isi data promo
        promoCode.textContent = routeData.kode_promo || routeData.promo_code_used || 'PROMO';
        originalPrice.textContent = `Rp ${parseInt(routeData.harga_asal).toLocaleString('id-ID')}`;
        discountPercentage.textContent = `${routeData.diskon_persen}%`;
        finalPrice.textContent = `Rp ${parseInt(discountedPrice).toLocaleString('id-ID')}`;
        
        // Tampilkan harga asli yang dicoret dan harga setelah diskon di info-grid
        priceContainer.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center;">
            <div>
              <span class="original-price">Rp ${routeData.harga_asal.toLocaleString('id-ID')}</span>
              <span class="price-highlight">Rp ${Math.round(discountedPrice).toLocaleString('id-ID')}</span>
              <span class="discount-badge">-${routeData.diskon_persen}%</span>
            </div>
            <div style="font-size: 0.7rem; color: #666; margin-top: 3px;">
              Hemat: Rp ${Math.round(discountAmount).toLocaleString('id-ID')}
            </div>
          </div>
        `;
        
        // Update routeData dengan harga diskon untuk perhitungan selanjutnya
        routeData.harga_total = Math.round(discountedPrice);
        
        console.log('üí∞ Harga dengan diskon ditampilkan:', {
          harga_asal: routeData.harga_asal,
          diskon_persen: routeData.diskon_persen,
          diskon_amount: Math.round(discountAmount),
          harga_setelah_diskon: Math.round(discountedPrice)
        });
        
      } else {
        // Sembunyikan section promo
        promoSection.style.display = 'none';
        
        // Tampilkan harga normal tanpa diskon
        if (routeData.harga_total) {
          const harga = typeof routeData.harga_total === 'number' ? routeData.harga_total : parseInt(routeData.harga_total);
          tripPrice.textContent = `Rp ${harga.toLocaleString('id-ID')}`;
        } else {
          tripPrice.textContent = '-';
        }
        console.log('üí∞ Harga normal ditampilkan:', routeData.harga_total);
      }
    }

    // ==================== FUNGSI PETA YANG DIPERBAIKI ====================

    // Fungsi untuk mendapatkan icon berdasarkan URL
    function getVehicleIconByUrl(iconUrl) {
      return L.icon({
        iconUrl: iconUrl,
        iconSize: [40, 40],
        iconAnchor: [20, 40], // Anchor di tengah bawah icon
        popupAnchor: [0, -40], // Popup muncul di atas icon
        className: 'driver-marker'
      });
    }

    // Fungsi untuk mendapatkan icon berdasarkan tipe kendaraan
    function getVehicleIconByType(vehicleType) {
      // Normalisasi nama vehicle type
      const normalizedType = vehicleType?.toLowerCase().replace(/ /g, '_') || 'motor';
      
      // Ambil URL icon dari mapping
      const iconUrl = vehicleIconMap[normalizedType] || vehicleIconMap['motor'];
      
      return L.icon({
        iconUrl: iconUrl,
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
        className: 'driver-marker'
      });
    }

    // ==================== FUNGSI PETA DIPERBAIKI ====================

    function initMap(centerLat, centerLng) {
      if (!orderMap) {
        orderMap = L.map('orderMap').setView([centerLat, centerLng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(orderMap);
        
        // Tambahkan kontrol zoom yang lebih baik untuk mobile
        L.control.zoom({
          position: 'bottomright'
        }).addTo(orderMap);
        
        console.log('‚úÖ Peta diinisialisasi dengan view:', centerLat, centerLng);
      } else {
        orderMap.setView([centerLat, centerLng], 13);
      }
    }

    function addPickupMarker(lat, lng, address) {
      if (pickupMarker) {
        pickupMarker.setLatLng([lat, lng]);
      } else {
        pickupMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            html: '<div style="background-color: #28a745; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">A</div>',
            iconSize: [40, 40],
            className: 'pickup-marker'
          })
        }).addTo(orderMap).bindPopup(`<b>üìç Penjemputan</b><br>${address}`);
      }
    }

    function addDestinationMarker(lat, lng, address) {
      if (destinationMarker) {
        destinationMarker.setLatLng([lat, lng]);
      } else {
        destinationMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            html: '<div style="background-color: #dc3545; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">B</div>',
            iconSize: [40, 40],
            className: 'destination-marker'
          })
        }).addTo(orderMap).bindPopup(`<b>üéØ Tujuan</b><br>${address}`);
      }
    }

    // ==================== FUNGSI MARKER DRIVER DENGAN ICON URL ====================

    function updateDriverMarker(lat, lng, vehicleType, iconUrl = null) {
      let vehicleIcon;
      
      // Prioritaskan iconUrl jika diberikan
      if (iconUrl) {
        vehicleIcon = getVehicleIconByUrl(iconUrl);
      } else {
        // Gunakan icon berdasarkan tipe kendaraan
        vehicleIcon = getVehicleIconByType(vehicleType);
      }
      
      if (!driverMarker) {
        // Buat marker baru dengan icon
        driverMarker = L.marker([lat, lng], {
          icon: vehicleIcon,
          zIndexOffset: 1000 // Pastikan marker driver di atas yang lain
        }).addTo(orderMap).bindPopup(`
          <div style="text-align: center;">
            <b>üöó Posisi Driver</b><br>
            ${vehicleType || 'Kendaraan'}<br>
            <small>${new Date().toLocaleTimeString('id-ID')}</small>
          </div>
        `);
        
        console.log('‚úÖ Marker driver dibuat dengan icon:', iconUrl || vehicleType);
      } else {
        // Update posisi dan icon marker yang sudah ada
        driverMarker.setLatLng([lat, lng]);
        driverMarker.setIcon(vehicleIcon);
        
        // Update popup dengan info terbaru
        driverMarker.setPopupContent(`
          <div style="text-align: center;">
            <b>üöó Posisi Driver</b><br>
            ${vehicleType || 'Kendaraan'}<br>
            <small>${new Date().toLocaleTimeString('id-ID')}</small>
          </div>
        `);
      }
    }

    // ==================== FUNGSI RUTE POLYLINE DIPERBAIKI ====================

    async function drawRouteOnMap(startLat, startLng, endLat, endLng) {
      try {
        const startCoords = `${startLng},${startLat}`;
        const endCoords = `${endLng},${endLat}`;
        
        // Menggunakan OSRM (Open Source Routing Machine) yang lebih cepat dan reliable
        const url = `https://router.project-osrm.org/route/v1/driving/${startCoords};${endCoords}?overview=full&geometries=geojson`;
        
        console.log('üîÑ Mengambil rute dari OSRM...');
        console.log('Start:', startCoords, 'End:', endCoords);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const coordinates = route.geometry.coordinates;
          const latLngCoordinates = coordinates.map(coord => [coord[1], coord[0]]);
          
          // Hitung jarak dan durasi
          const distanceKm = (route.distance / 1000).toFixed(1);
          const durationMin = Math.round(route.duration / 60);
          
          // Hapus polyline lama jika ada
          if (routePolyline) {
            orderMap.removeLayer(routePolyline);
          }
          
          // Buat polyline baru dengan style yang lebih jelas
          routePolyline = L.polyline(latLngCoordinates, {
            color: '#289672',
            weight: 5,
            opacity: 0.8,
            lineJoin: 'round',
            lineCap: 'round',
            dashArray: null
          }).addTo(orderMap);
          
          // Fit peta ke rute dengan padding yang lebih baik
          orderMap.fitBounds(routePolyline.getBounds(), {
            padding: [50, 50]
          });
          
          console.log(`‚úÖ Rute berhasil ditampilkan di peta: ${distanceKm} km, ${durationMin} menit`);
          
          // Update informasi jarak dan durasi di UI
          updateTripInfo(distanceKm, durationMin);
          
          return true;
        } else {
          console.warn('‚ö†Ô∏è Tidak ada rute yang ditemukan, menggunakan garis lurus');
          drawStraightLineRoute(startLat, startLng, endLat, endLng);
          return false;
        }
      } catch (error) {
        console.error('‚ùå Error mengambil rute dari OSRM:', error);
        // Fallback ke OpenRouteService jika OSRM gagal
        return await drawRouteWithOpenRouteService(startLat, startLng, endLat, endLng);
      }
    }

    async function drawRouteWithOpenRouteService(startLat, startLng, endLat, endLng) {
      try {
        const startCoords = `${startLng},${startLat}`;
        const endCoords = `${endLng},${endLat}`;
        
        const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${startCoords}&end=${endCoords}`;
        
        console.log('üîÑ Mengambil rute dari OpenRouteService...');
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`OpenRouteService error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          const coordinates = data.features[0].geometry.coordinates;
          const latLngCoordinates = coordinates.map(coord => [coord[1], coord[0]]);
          
          if (routePolyline) {
            orderMap.removeLayer(routePolyline);
          }
          
          routePolyline = L.polyline(latLngCoordinates, {
            color: '#289672',
            weight: 5,
            opacity: 0.8,
            lineJoin: 'round',
            lineCap: 'round'
          }).addTo(orderMap);
          
          orderMap.fitBounds(routePolyline.getBounds(), {
            padding: [50, 50]
          });
          
          console.log('‚úÖ Rute OpenRouteService berhasil ditampilkan');
          return true;
        } else {
          throw new Error('Tidak ada rute dari OpenRouteService');
        }
      } catch (error) {
        console.error('‚ùå Error OpenRouteService:', error);
        drawStraightLineRoute(startLat, startLng, endLat, endLng);
        return false;
      }
    }

    function drawStraightLineRoute(startLat, startLng, endLat, endLng) {
      if (routePolyline) {
        orderMap.removeLayer(routePolyline);
      }
      
      routePolyline = L.polyline([[startLat, startLng], [endLat, endLng]], {
        color: '#289672',
        weight: 4,
        opacity: 0.7,
        lineJoin: 'round',
        dashArray: '10, 10'
      }).addTo(orderMap);
      
      console.log('‚úÖ Garis lurus ditampilkan sebagai fallback');
    }

    function updateTripInfo(distanceKm, durationMin) {
      // Update UI dengan informasi rute yang lebih akurat
      const distanceElement = document.getElementById('tripDistance');
      const durationElement = document.getElementById('tripDuration');
      
      if (distanceElement) {
        distanceElement.textContent = `${distanceKm} km`;
      }
      
      if (durationElement) {
        durationElement.textContent = `${durationMin} menit`;
      }
    }

    // ==================== FUNGSI MENDENGARKAN LOKASI DRIVER DARI FIREBASE ====================

    function listenToDriverLocation(orderId) {
      if (driverLocationListener) {
        database.ref('driver_offers/' + orderId).off('value', driverLocationListener);
      }
      
      driverLocationListener = (snapshot) => {
        const data = snapshot.val();
        if (data && data.driver_lat && data.driver_lng) {
          const vehicleType = data.vehicle_type || driverData?.vehicle_type || 'motor';
          const vehicleIcon = data.vehicle_icon || vehicleIconMap[vehicleType?.toLowerCase().replace(/ /g, '_')] || vehicleIconMap['motor'];
          
          updateDriverMarker(data.driver_lat, data.driver_lng, vehicleType, vehicleIcon);
          
          console.log('üìç Posisi driver diperbarui:', {
            lat: data.driver_lat,
            lng: data.driver_lng,
            vehicleType: vehicleType
          });
        }
      };
      
      database.ref('driver_offers/' + orderId).on('value', driverLocationListener);
    }

    // ==================== SISTEM CHAT INTEGRASI ====================

    function initializeChatSystem(orderId) {
      if (chatRef && chatListener) {
        chatRef.off('child_added', chatListener);
      }
      
      chatRef = database.ref('chat/' + orderId);
      chatListener = chatRef.on('child_added', (snapshot) => {
        const message = snapshot.val();
        console.log('üí¨ Pesan baru diterima:', message);
        
        // Jika chat terbuka, tampilkan pesan langsung
        if (chatOpen) {
          displayMessage(message);
          markMessageAsRead(snapshot.key);
        } else {
          // Jika chat tertutup, tampilkan notifikasi dan update badge
          handleNewMessageNotification(message);
        }
      });
      
      // Muat pesan yang sudah ada
      loadExistingMessages();
    }

    function loadExistingMessages() {
      if (!chatRef) return;
      
      chatRef.once('value').then((snapshot) => {
        const messages = snapshot.val();
        
        // Kosongkan chat messages terlebih dahulu
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        
        if (!messages) {
          console.log('üí¨ Tidak ada pesan sebelumnya');
          return;
        }
        
        console.log('üí¨ Memuat pesan yang sudah ada:', Object.keys(messages).length + ' pesan');
        
        // Tampilkan semua pesan
        Object.keys(messages).forEach(key => {
          displayMessage(messages[key]);
        });
        
        // Scroll ke bawah
        scrollChatToBottom();
      }).catch((error) => {
        console.error('‚ùå Gagal memuat pesan:', error);
      });
    }

    function displayMessage(message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');
      
      const isCustomerMessage = message.sender === 'customer';
      const messageTime = formatTime(message.timestamp);
      
      messageElement.className = `message-bubble ${isCustomerMessage ? 'message-right' : 'message-left'}`;
      messageElement.innerHTML = `
        ${message.message}
        <div class="message-time">${messageTime}</div>
      `;
      
      chatMessages.appendChild(messageElement);
      scrollChatToBottom();
    }

    function handleNewMessageNotification(message) {
      // Hanya tampilkan notifikasi untuk pesan dari driver
      if (message.sender === 'driver') {
        unreadMessages++;
        updateChatBadge();
        
        // Tampilkan notifikasi
        showChatNotification(message);
        
        // Kirim notifikasi ke Kodular
        sendToKodular({
          action: 'new_chat_message',
          order_id: orderId,
          sender: message.sender,
          sender_id: message.sender_id,
          message: message.message,
          timestamp: message.timestamp,
          unread_count: unreadMessages
        });
      }
    }

    function showChatNotification(message) {
      const notification = document.getElementById('chatNotification');
      const notificationMessage = document.getElementById('notificationMessage');
      
      notificationMessage.textContent = message.message;
      notification.style.display = 'block';
      
      // Auto hide setelah 5 detik
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
      
      // Klik untuk buka chat
      notification.onclick = function() {
        notification.style.display = 'none';
        openChat();
      };
    }

    function updateChatBadge() {
      const chatBadge = document.getElementById('chatBadge');
      if (unreadMessages > 0) {
        chatBadge.textContent = unreadMessages > 99 ? '99+' : unreadMessages.toString();
        chatBadge.style.display = 'flex';
      } else {
        chatBadge.style.display = 'none';
      }
    }

    function markMessageAsRead(messageKey) {
      // Reset unread count ketika chat dibuka
      if (chatOpen) {
        unreadMessages = 0;
        updateChatBadge();
      }
    }

    function scrollChatToBottom() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.getHours().toString().padStart(2, '0') + ':' + 
             date.getMinutes().toString().padStart(2, '0');
    }

    function openChat() {
      chatOpen = true;
      unreadMessages = 0;
      updateChatBadge();
      
      // Setup UI chat
      setupChatUI();
      
      // Muat ulang pesan setiap kali chat dibuka
      loadExistingMessages();
      
      // Tampilkan overlay chat
      document.getElementById('chatOverlay').style.display = 'flex';
      
      // Focus ke input
      setTimeout(() => {
        document.getElementById('chatInput').focus();
      }, 300);
      
      // Tutup notifikasi jika terbuka
      document.getElementById('chatNotification').style.display = 'none';
      
      console.log('üí¨ Chat dibuka, memuat pesan...');
    }

    function closeChat() {
      chatOpen = false;
      document.getElementById('chatOverlay').style.display = 'none';
      console.log('üí¨ Chat ditutup');
    }

    function setupChatUI() {
      if (!driverData) return;
      
      const chatName = document.getElementById('chatName');
      const chatAvatar = document.getElementById('chatAvatar');
      
      chatName.textContent = driverData.name || 'Driver';
      
      // Setup avatar driver
      if (driverData.profile_photo_url) {
        chatAvatar.innerHTML = `<img src="${driverData.profile_photo_url}" alt="${driverData.name}">`;
      } else {
        chatAvatar.innerHTML = '';
        chatAvatar.style.backgroundImage = "url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"%23006699\"><path d=\"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\"/></svg>')";
        chatAvatar.style.backgroundColor = '#cce7ff';
        chatAvatar.style.backgroundRepeat = 'no-repeat';
        chatAvatar.style.backgroundPosition = 'center';
        chatAvatar.style.backgroundSize = '60%';
      }
      
      // Setup event listeners untuk input chat
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      
      chatSendBtn.onclick = sendChatMessage;
      chatInput.onkeypress = function(e) {
        if (e.key === 'Enter') sendChatMessage();
      };
    }

    function sendChatMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      
      if (!message || !userData) return;
      
      const messageData = {
        sender: 'customer',
        sender_id: userData.id || 'unknown',
        message: message,
        timestamp: Date.now()
      };
      
      chatRef.push(messageData)
        .then(() => {
          chatInput.value = '';
          console.log('‚úÖ Pesan terkirim');
        })
        .catch((error) => {
          console.error('‚ùå Gagal mengirim pesan:', error);
        });
    }

    // ==================== FUNGSI MODAL BARU ====================

    // Fungsi untuk menampilkan modal konfirmasi
    function showConfirmationModal(title, message, callback, action = '') {
      document.getElementById('confirmationTitle').textContent = title;
      document.getElementById('confirmationMessage').textContent = message;
      confirmCallback = callback;
      currentAction = action;
      
      const modal = document.getElementById('confirmationModal');
      modal.style.display = 'flex';
    }

    // Fungsi untuk menutup modal konfirmasi
    function closeConfirmationModal() {
      const modal = document.getElementById('confirmationModal');
      modal.style.display = 'none';
      confirmCallback = null;
      currentAction = '';
    }

    // Fungsi untuk menampilkan modal informasi
    function showInfoModal(title, message) {
      document.getElementById('infoTitle').textContent = title;
      document.getElementById('infoMessage').textContent = message;
      
      const modal = document.getElementById('infoModal');
      modal.style.display = 'flex';
    }

    // Fungsi untuk menutup modal informasi
    function closeInfoModal() {
      const modal = document.getElementById('infoModal');
      modal.style.display = 'none';
    }

    // Fungsi ketika tombol konfirmasi ditekan
    function confirmAction() {
      if (confirmCallback) {
        confirmCallback();
      }
      closeConfirmationModal();
    }

    // ==================== FUNGSI LOCALSTORAGE ====================

    // Fungsi untuk mengambil data order aktif dari localStorage
    function getActiveOrderFromLocalStorage() {
        try {
            const activeOrder = localStorage.getItem('jego_active_order');
            return activeOrder ? JSON.parse(activeOrder) : null;
        } catch (error) {
            console.error('‚ùå Gagal mengambil order aktif dari localStorage:', error);
            return null;
        }
    }

    // Fungsi untuk memuat data dari localStorage
    function loadFromLocalStorage() {
        const activeOrder = getActiveOrderFromLocalStorage();
        
        if (activeOrder && activeOrder.is_active) {
            console.log('‚úÖ Data order aktif ditemukan di localStorage:', activeOrder);
            
            // Extract data dari localStorage
            orderId = activeOrder.order_id;
            driverData = activeOrder.selected_driver || activeOrder.driver || activeOrder.driver_data;
            routeData = activeOrder.currentRouteData || activeOrder;
            userData = activeOrder.user_data;
            
            // Tampilkan data di halaman
            displayDriverData();
            
            // Mulai listen ke Firebase untuk update real-time
            if (orderId) {
                listenToOrderUpdates(orderId);
            }
            
            return true;
        }
        
        return false;
    }

    // ==================== FUNGSI RATING YANG DIPERBAIKI ====================

    // Fungsi untuk menampilkan modal rating
    function showRatingModal() {
      if (!driverData) {
        showInfoModal('Peringatan', 'Data driver tidak tersedia');
        return;
      }

      // Reset rating
      selectedRating = 0;
      
      // Reset tampilan bintang
      const stars = document.querySelectorAll('.rating-star');
      stars.forEach(star => {
        star.textContent = '‚òÜ';
        star.classList.remove('active');
        star.style.color = '#ddd';
        star.style.cursor = 'pointer';
      });

      // Reset komentar
      document.getElementById('ratingComment').value = '';

      // Reset tombol submit
      const submitBtn = document.getElementById('submitRatingBtn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Kirim Rating';

      // Tampilkan modal
      const modal = document.getElementById('ratingModal');
      modal.style.display = 'flex';
      
      // Setup event listeners dengan cara yang lebih reliable
      setupRatingStars();
      
      console.log('‚úÖ Modal rating ditampilkan');
    }

    // FUNGSI YANG DIPERBAIKI: Setup rating stars dengan event delegation
    function setupRatingStars() {
      const starsContainer = document.getElementById('ratingStars');
      
      // Hapus semua event listeners lama dengan cloning element
      const newStarsContainer = starsContainer.cloneNode(true);
      starsContainer.parentNode.replaceChild(newStarsContainer, starsContainer);
      
      // Dapatkan container yang baru
      const updatedStarsContainer = document.getElementById('ratingStars');
      const stars = updatedStarsContainer.querySelectorAll('.rating-star');
      
      // Gunakan event delegation pada container
      updatedStarsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('rating-star')) {
          const rating = parseInt(e.target.getAttribute('data-rating'));
          selectedRating = rating;
          
          console.log('‚≠ê Rating dipilih:', rating);
          
          // Update tampilan semua bintang
          stars.forEach((star, index) => {
            if (index < rating) {
              star.textContent = '‚òÖ';
              star.classList.add('active');
              star.style.color = '#FFD700';
            } else {
              star.textContent = '‚òÜ';
              star.classList.remove('active');
              star.style.color = '#ddd';
            }
          });
        }
      });
      
      // Tambahkan efek hover
      updatedStarsContainer.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('rating-star')) {
          const hoverRating = parseInt(e.target.getAttribute('data-rating'));
          
          stars.forEach((star, index) => {
            if (index < hoverRating && !star.classList.contains('active')) {
              star.style.color = '#FFD700';
            }
          });
        }
      });
      
      updatedStarsContainer.addEventListener('mouseout', function(e) {
        stars.forEach((star, index) => {
          if (index >= selectedRating) {
            star.style.color = '#ddd';
          }
        });
      });
      
      console.log('‚úÖ Event listeners rating stars dipasang');
    }

    // FUNGSI UTAMA RATING YANG DIPERBAIKI - PASTI BEKERJA
    function submitRating() {
      console.log('üîÑ Tombol kirim rating diklik');
      console.log('Selected rating:', selectedRating);
      
      if (selectedRating === 0) {
        showInfoModal('Peringatan', 'Silakan pilih rating terlebih dahulu');
        return;
      }

      if (!driverData) {
        showInfoModal('Peringatan', 'Data driver tidak tersedia');
        return;
      }

      // PERBAIKAN: Ambil driver_id dengan berbagai kemungkinan struktur data
      const driverId = driverData.driver_id || driverData.id || driverData.uid;
      
      if (!driverId) {
        console.error('‚ùå Driver ID tidak ditemukan. Data driver:', driverData);
        showInfoModal('Error', 'ID Driver tidak ditemukan. Silakan refresh halaman dan coba lagi.');
        return;
      }

      console.log(`‚≠ê Mengirim rating ${selectedRating} untuk driver ${driverId}, order: ${orderId}`);

      const comment = document.getElementById('ratingComment').value.trim();

      // Tampilkan loading state di tombol
      const submitBtn = document.getElementById('submitRatingBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Mengirim...';
      submitBtn.disabled = true;

      const ratingData = {
        rating: selectedRating,
        order_id: orderId,
        driver_id: driverId,
        customer_id: userData?.id || 'unknown',
        customer_name: userData?.nama || 'Customer',
        comment: comment,
        rated_at: new Date().toISOString(),
        timestamp: Date.now()
      };

      console.log('üì¶ Data rating yang akan dikirim:', ratingData);

      // PERBAIKAN: Simpan rating di database dengan path yang benar
      const ratingRef = database.ref(`drivers/${driverId}/ratings`).push();
      
      console.log(`üìç Menyimpan rating ke path: drivers/${driverId}/ratings/${ratingRef.key}`);

      ratingRef.set(ratingData)
        .then(() => {
          console.log('‚úÖ Rating berhasil disimpan di database dengan key:', ratingRef.key);
          
          // PERBAIKAN: Update statistik rating driver
          updateDriverRating(driverId, selectedRating);
          
        })
        .catch((error) => {
          console.error('‚ùå Gagal menyimpan rating:', error);
          
          // Reset tombol jika error
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
          
          showInfoModal('Error', 'Gagal memberikan rating. Silakan cek koneksi internet dan coba lagi.\nError: ' + error.message);
        });
    }

    // FUNGSI UPDATE DRIVER RATING YANG DIPERBAIKI
    function updateDriverRating(driverId, newRating) {
      console.log('üîÑ Memperbarui rating driver:', driverId, newRating);
      
      const driverRef = database.ref('drivers/' + driverId);
      
      driverRef.once('value')
        .then((snapshot) => {
          const driverData = snapshot.val();
          
          if (!driverData) {
            console.error('‚ùå Data driver tidak ditemukan di database');
            throw new Error('Driver tidak ditemukan');
          }

          // Data statistik saat ini - PERBAIKAN: Handle berbagai struktur data
          const currentStats = {
            avgRating: driverData.avgRating || driverData.rating || 0,
            ratingCount: driverData.ratingCount || 0,
            totalRating: driverData.totalRating || 0
          };

          console.log('üìä Statistik rating saat ini:', currentStats);

          // Hitung rating baru
          const updatedStats = {
            ratingCount: currentStats.ratingCount + 1,
            totalRating: currentStats.totalRating + newRating,
            avgRating: (currentStats.totalRating + newRating) / (currentStats.ratingCount + 1)
          };

          // Format avgRating ke 1 desimal
          updatedStats.avgRating = parseFloat(updatedStats.avgRating.toFixed(1));

          console.log('‚≠ê Statistik rating baru:', updatedStats);

          // Update ke Firebase
          return driverRef.update({
            avgRating: updatedStats.avgRating,
            ratingCount: updatedStats.ratingCount,
            totalRating: updatedStats.totalRating,
            last_rating_update: new Date().toISOString()
          });
        })
        .then(() => {
          console.log('‚úÖ Rating driver berhasil diupdate di database');
          
          // Tandai bahwa rating sudah dikirim
          isRatingSubmitted = true;
          
          // Tutup modal
          closeRatingModal();
          
          // Kirim notifikasi sederhana ke Kodular
          sendToKodular({
            action: 'driver_rated',
            order_id: orderId,
            driver_id: driverId,
            rating: newRating,
            message: `Rating ${newRating} bintang diberikan untuk driver`,
            timestamp: new Date().toISOString()
          });
          
          console.log('üì® Notifikasi rating terkirim ke Kodular');
          
          // Beri feedback ke user
          showInfoModal('Terima Kasih', `Terima kasih! Anda memberikan rating ${selectedRating} bintang untuk driver.`);
          
          // Kembali ke halaman utama setelah rating (boleh back karena sudah completed)
          setTimeout(() => {
            safeGoBack();
          }, 2000);
          
        })
        .catch((error) => {
          console.error('‚ùå Gagal update rating driver:', error);
          
          // Tetap tutup modal meski ada error (data rating sudah tersimpan)
          closeRatingModal();
          
          showInfoModal('Informasi', 'Rating berhasil dikirim, tetapi ada masalah update statistik. Silakan refresh aplikasi.');
          
          // Kirim notifikasi error ke Kodular
          sendToKodular({
            action: 'rating_error',
            order_id: orderId,
            driver_id: driverId,
            message: 'Gagal update statistik rating',
            timestamp: new Date().toISOString()
          });
        });
    }

    // Fungsi untuk menutup modal rating
    function closeRatingModal() {
      const modal = document.getElementById('ratingModal');
      modal.style.display = 'none';
      
      // Reset state tombol
      const submitBtn = document.getElementById('submitRatingBtn');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Kirim Rating';
      }
      
      console.log('‚úÖ Modal rating ditutup');
    }

    // ==================== FUNGSI MENAMBAH PERJALANAN USER ====================

    // Fungsi untuk menambah jumlah perjalanan user di Firebase dan localStorage
    function incrementTripCount() {
        console.log('üîÑ Memulai incrementTripCount untuk user...');
        
        if (!userData) {
            console.error('‚ùå userData tidak tersedia:', userData);
            
            // Coba ambil dari localStorage
            const loggedInUser = localStorage.getItem('jego_logged_in_user');
            if (loggedInUser) {
                userData = JSON.parse(loggedInUser);
                console.log('‚úÖ userData diambil dari localStorage:', userData);
            } else {
                console.error('‚ùå Tidak dapat menemukan data user');
                return;
            }
        }

        // Dapatkan user ID dari berbagai kemungkinan field
        const userId = userData.firebase_key || 
                       userData.user_key || 
                       userData.id || 
                       (userData.userId ? userData.userId.toString() : null);
        
        if (!userId) {
            console.error('‚ùå User ID tidak ditemukan di userData:', userData);
            
            // Fallback: cari user berdasarkan nomor telepon
            const userPhone = userData.telepon || userData.phone;
            if (userPhone) {
                console.log('üîç Mencari user berdasarkan telepon:', userPhone);
                searchUserByPhoneAndIncrementTrip(userPhone);
            }
            return;
        }

        console.log('üë§ User ID untuk increment trip:', userId);
        
        // Reference ke user di Firebase
        const userRef = database.ref('users/' + userId);
        
        userRef.once('value')
            .then((snapshot) => {
                const user = snapshot.val();
                
                if (!user) {
                    throw new Error('Data user tidak ditemukan di Firebase');
                }
                
                // Ambil jumlah perjalanan saat ini (default 0 jika tidak ada)
                let currentTrips = user.Perjalanan || user.perjalanan || 0;
                
                // PERBAIKAN: Pastikan currentTrips adalah number
                if (typeof currentTrips === 'string') {
                    currentTrips = parseInt(currentTrips) || 0;
                }
                
                console.log(`üìä Perjalanan saat ini: ${currentTrips}`);
                
                // Tambah 1 perjalanan
                const newTripCount = currentTrips + 1;
                
                console.log(`‚ûï Menambah perjalanan: ${currentTrips} ‚Üí ${newTripCount}`);
                
                // Update di Firebase
                return userRef.update({ 
                    Perjalanan: newTripCount,
                    perjalanan: newTripCount,
                    last_trip_update: new Date().toISOString(),
                    last_trip_order: orderId,
                    updated_at: new Date().toISOString()
                });
            })
            .then(() => {
                console.log('‚úÖ Jumlah perjalanan berhasil ditambahkan di Firebase');
                
                // Update di localStorage
                updateTripCountInLocalStorage();
                
                // Set flag untuk mencegah duplikasi
                tripAlreadyIncremented = true;
                const incrementKey = `trip_incremented_${orderId}`;
                localStorage.setItem(incrementKey, 'true');
                
                // Kirim notifikasi ke Kodular
                sendToKodular({
                    action: 'trip_incremented',
                    order_id: orderId,
                    user_id: userId,
                    trip_count: 'incremented',
                    message: `Perjalanan ditambahkan untuk user ${userId}`,
                    timestamp: new Date().toISOString()
                });
                
                return true;
            })
            .catch((error) => {
                console.error('‚ùå Gagal menambah jumlah perjalanan di Firebase:', error);
                
                // Fallback: update localStorage saja
                console.log('üîÑ Mencoba fallback ke localStorage...');
                updateTripCountInLocalStorage();
                
                return false;
            });
    }

    // Fungsi untuk mencari user berdasarkan telepon dan menambah perjalanan
    function searchUserByPhoneAndIncrementTrip(userPhone) {
        console.log('üîç Mencari user dengan nomor telepon:', userPhone);
        
        const usersRef = database.ref('users');
        const formattedPhone = formatPhoneNumber(userPhone);
        
        usersRef.orderByChild('telepon').equalTo(formattedPhone).once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const userKeys = Object.keys(snapshot.val());
                    if (userKeys.length > 0) {
                        const userId = userKeys[0];
                        console.log('‚úÖ User ditemukan dengan key:', userId);
                        
                        // Update userData dengan ID yang ditemukan
                        userData = { ...userData, firebase_key: userId };
                        
                        // Panggil kembali incrementTripCount
                        incrementTripCount();
                    } else {
                        console.error('‚ùå User tidak ditemukan dengan nomor telepon tersebut');
                    }
                } else {
                    console.error('‚ùå User tidak ditemukan di database');
                }
            })
            .catch((error) => {
                console.error('‚ùå Gagal mencari user berdasarkan telepon:', error);
            });
    }

    // Fungsi untuk memperbarui jumlah perjalanan di localStorage
    function updateTripCountInLocalStorage() {
        try {
            console.log('üíæ Memperbarui jumlah perjalanan di localStorage...');
            
            // 1. Update di jego_logged_in_user
            const loggedInUser = localStorage.getItem('jego_logged_in_user');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                const currentTrips = user.Perjalanan || user.perjalanan || 0;
                const newTripCount = currentTrips + 1;
                
                user.Perjalanan = newTripCount;
                user.perjalanan = newTripCount;
                user.last_trip_update = new Date().toISOString();
                user.last_trip_order = orderId;
                
                localStorage.setItem('jego_logged_in_user', JSON.stringify(user));
                console.log(`‚úÖ Perjalanan diupdate di jego_logged_in_user: ${currentTrips} ‚Üí ${newTripCount}`);
            }
            
            // 2. Update di jego_users (data registrasi)
            const jegoUsers = localStorage.getItem('jego_users');
            if (jegoUsers) {
                const users = JSON.parse(jegoUsers);
                const userId = userData?.firebase_key || userData?.user_key;
                
                if (userId && users[userId]) {
                    const currentTrips = users[userId].Perjalanan || users[userId].perjalanan || 0;
                    const newTripCount = currentTrips + 1;
                    
                    users[userId].Perjalanan = newTripCount;
                    users[userId].perjalanan = newTripCount;
                    users[userId].last_trip_update = new Date().toISOString();
                    users[userId].last_trip_order = orderId;
                    
                    localStorage.setItem('jego_users', JSON.stringify(users));
                    console.log(`‚úÖ Perjalanan diupdate di jego_users: ${currentTrips} ‚Üí ${newTripCount}`);
                }
            }
            
            // 3. Update di jego_active_order
            const activeOrder = localStorage.getItem('jego_active_order');
            if (activeOrder) {
                const order = JSON.parse(activeOrder);
                order.trip_count_updated = true;
                order.trip_update_time = new Date().toISOString();
                localStorage.setItem('jego_active_order', JSON.stringify(order));
                console.log('‚úÖ Flag trip_count_updated ditambahkan di jego_active_order');
            }
            
            console.log('‚úÖ LocalStorage berhasil diperbarui');
            
        } catch (error) {
            console.error('‚ùå Gagal update jumlah perjalanan di localStorage:', error);
        }
    }

    // Fungsi untuk mencegah duplikasi penambahan perjalanan
    function checkIfTripAlreadyIncremented() {
        const incrementKey = `trip_incremented_${orderId}`;
        return localStorage.getItem(incrementKey) === 'true' || tripAlreadyIncremented;
    }

    // Fungsi untuk memformat nomor telepon ke format +62
    function formatPhoneNumber(phone) {
        if (!phone) return '';
        
        let cleaned = phone.replace(/\D/g, '');
        
        if (cleaned.startsWith('0')) {
            cleaned = '+62' + cleaned.substring(1);
        } else if (cleaned.startsWith('62')) {
            cleaned = '+' + cleaned;
        } else if (!cleaned.startsWith('+')) {
            cleaned = '+62' + cleaned;
        }
        
        return cleaned;
    }

    // ==================== FUNGSI UTAMA YANG DIMODIFIKASI ====================

    // Fungsi untuk mendapatkan pesan status - FUNGSI BARU
    function getStatusMessage(status) {
      const statusMessages = {
        'accepted': 'Driver telah menerima pesanan Anda',
        'on_the_way': 'Driver sedang menuju lokasi penjemputan',
        'arrived': 'Driver telah tiba di lokasi penjemputan',
        'on_trip': 'Perjalanan sedang berlangsung',
        'completed': 'Perjalanan telah selesai',
        'cancelled': 'Perjalanan telah dibatalkan',
        'waiting': 'Menunggu konfirmasi driver'
      };
      
      return statusMessages[status] || 'Status diperbarui';
    }

    // Fungsi untuk listen update order dari Firebase - DIMODIFIKASI
    function listenToOrderUpdates(orderId) {
      if (orderRef && orderUpdateHandler) {
        orderRef.off('value', orderUpdateHandler);
      }
      
      orderRef = database.ref('orders/' + orderId);
      orderUpdateHandler = (snapshot) => {
        const orderData = snapshot.val();
        
        if (orderData) {
          console.log('Update order diterima:', orderData);
          
          // PERBAIKAN: Hanya kirim data sederhana ke Kodular
          sendToKodular({
            action: 'order_updated',
            order_id: orderId,
            new_status: orderData.status || 'unknown',
            message: getStatusMessage(orderData.status),
            timestamp: new Date().toISOString()
          });
          
          // Handle berbagai struktur data driver
          let driverDataFromFirebase = null;
          
          // Cek berbagai kemungkinan struktur data driver
          if (orderData.selected_driver) {
            driverDataFromFirebase = orderData.selected_driver;
          } else if (orderData.driver) {
            driverDataFromFirebase = orderData.driver;
          } else if (orderData.driver_offers) {
            const offerKeys = Object.keys(orderData.driver_offers);
            if (offerKeys.length > 0) {
              driverDataFromFirebase = orderData.driver_offers[offerKeys[0]];
            }
          }
          
          // Update status driver - fungsi ini sekarang sudah mengirim ke Kodular
          updateDriverStatus(orderData.status, driverDataFromFirebase);
          
          // Update estimasi waktu jika ada - DIMODIFIKASI
          if (orderData.estimated_arrival) {
            // Kirim update estimasi ke Kodular dengan format sederhana
            sendToKodular({
              action: 'arrival_updated',
              order_id: orderId,
              estimated_arrival: orderData.estimated_arrival,
              message: `Estimasi tiba: ${orderData.estimated_arrival}`,
              timestamp: new Date().toISOString()
            });
          }
          
          // Update data driver jika ada perubahan
          if (driverDataFromFirebase) {
            updateDriverData(driverDataFromFirebase);
            driverData = driverDataFromFirebase;
          }
          
          // Update data rute jika ada perubahan
          if (orderData.alamat_a || orderData.alamat_b) {
            updateRouteData(orderData);
            routeData = orderData;
          }
        } else {
          console.error('Data order tidak ditemukan di Firebase');
          // Coba gunakan data dari localStorage sebagai fallback
          if (!loadFromLocalStorage()) {
            showError('Data perjalanan tidak ditemukan');
          }
        }
      };
      
      orderRef.on('value', orderUpdateHandler);
      
      // Inisialisasi sistem chat
      initializeChatSystem(orderId);
      
      // Mulai mendengarkan lokasi driver
      listenToDriverLocation(orderId);
    }

    // Fungsi untuk update status driver - DIMODIFIKASI DENGAN PERJALANAN
    function updateDriverStatus(status, driverData = null) {
      const statusBadge = document.getElementById('statusBadge');
      const arrivalTitle = document.getElementById('arrivalTitle');
      const arrivalSubtitle = document.getElementById('arrivalSubtitle');
      const actionsSection = document.getElementById('actionsSection');
      
      statusBadge.style.display = 'block';
      
      // ========== PERBAIKAN UTAMA: UPDATE STATUS ORDER GLOBAL ==========
      currentOrderStatus = status;
      
      // ========== KIRIM STATUS SEDERHANA KE KODULAR ==========
      sendToKodular({
        action: 'status_changed',
        order_id: orderId,
        new_status: status,
        message: getStatusMessage(status),
        timestamp: new Date().toISOString()
      });
      
      switch(status) {
        case 'accepted':
          statusBadge.textContent = 'Order Diterima';
          statusBadge.style.background = '#e6dd3b';
          statusBadge.style.color = '#343a40';
          statusBadge.className = 'status-badge';
          arrivalTitle.textContent = 'Order Diterima';
          arrivalSubtitle.innerHTML = 'Driver sedang bersiap untuk menjemput Anda.<br>Harap tunggu konfirmasi berikutnya..';
          actionsSection.style.display = 'flex';
          
          // ========== PERBAIKAN UTAMA: UPDATE STATUS DISKON KETIKA ORDER DITERIMA ==========
          updateDiscountStatus();
          break;
          
        case 'on_the_way':
          statusBadge.textContent = 'Menuju Lokasi';
          statusBadge.style.background = '#289672';
          statusBadge.style.color = 'white';
          statusBadge.className = 'status-badge';
          arrivalTitle.textContent = 'Menuju Lokasi Anda';
          arrivalSubtitle.innerHTML = 'Driver dalam perjalanan menuju titik jemput.<br>Harap bersiap.';
          actionsSection.style.display = 'flex';
          break;
          
        case 'arrived':
          statusBadge.textContent = 'Driver Tiba';
          statusBadge.style.background = '#28a745';
          statusBadge.style.color = 'white';
          statusBadge.className = 'status-badge';
          arrivalTitle.textContent = 'Driver Telah Tiba';
          arrivalSubtitle.innerHTML = 'Driver sudah berada di lokasi penjemputan.<br>Silakan menuju kendaraan.';
          actionsSection.style.display = 'flex';
          break;
          
        case 'on_trip':
          statusBadge.textContent = 'Dalam Perjalanan';
          statusBadge.style.background = '#1e6f5c';
          statusBadge.style.color = 'white';
          statusBadge.className = 'status-badge';
          arrivalTitle.textContent = 'Perjalanan Berlangsung';
          arrivalSubtitle.innerHTML = 'Anda sedang dalam perjalanan menuju lokasi tujuan.';
          actionsSection.style.display = 'flex';
          break;
          
        case 'completed':
          statusBadge.textContent = 'Selesai';
          statusBadge.style.background = '#28a745';
          statusBadge.style.color = 'white';
          statusBadge.className = 'status-badge completed-badge';
          // PERBAIKAN: Ganti ke safeGoBack
          statusBadge.onclick = safeGoBack;
          arrivalTitle.textContent = 'Perjalanan Selesai';
          arrivalSubtitle.innerHTML = 'Terima kasih telah menggunakan JeGo.<br>Sampai jumpa pada perjalanan berikutnya!';
          actionsSection.style.display = 'none';
          
          // Kirim status completed ke Kodular - DIMODIFIKASI
          sendToKodular({
            action: 'trip_completed',
            order_id: orderId,
            new_status: 'completed',
            message: 'Perjalanan telah selesai',
            timestamp: new Date().toISOString()
          });
          
          // ========== PERBAIKAN UTAMA: TAMBAH JUMLAH PERJALANAN USER ==========
          // Cek dulu apakah perjalanan sudah pernah ditambahkan untuk order ini
          if (!checkIfTripAlreadyIncremented()) {
              console.log('üöó Menambahkan 1 perjalanan untuk user...');
              incrementTripCount();
          } else {
              console.log('‚ÑπÔ∏è Perjalanan sudah pernah ditambahkan untuk order ini');
          }
          
          // Tampilkan modal rating jika belum dikirim
          if (!isRatingSubmitted) {
            setTimeout(() => {
              showRatingModal();
            }, 1000);
          }
          break;
          
        case 'cancelled':
          statusBadge.textContent = 'Dibatalkan';
          statusBadge.style.background = '#dc3545';
          statusBadge.style.color = 'white';
          statusBadge.className = 'status-badge';
          arrivalTitle.textContent = 'Perjalanan Dibatalkan';
          arrivalSubtitle.innerHTML = 'Perjalanan telah dibatalkan.<br>Silakan pesan ulang jika diperlukan.';
          actionsSection.style.display = 'none';
          
          // ========== PERBAIKAN: HAPUS FLAG TRIP INCREMENT ==========
          const incrementKey = `trip_incremented_${orderId}`;
          localStorage.removeItem(incrementKey);
          
          // Kirim status cancelled ke Kodular - DIMODIFIKASI
          sendToKodular({
            action: 'trip_cancelled',
            order_id: orderId,
            new_status: 'cancelled',
            message: 'Perjalanan telah dibatalkan',
            timestamp: new Date().toISOString()
          });
          break;
          
        default:
          statusBadge.textContent = 'Menunggu Konfirmasi';
          statusBadge.style.background = '#e6dd3b';
          statusBadge.style.color = '#343a40';
          statusBadge.className = 'status-badge';
          arrivalTitle.textContent = 'Menunggu Konfirmasi';
          arrivalSubtitle.innerHTML = 'Sedang mencari driver terdekat...';
          actionsSection.style.display = 'flex';
          
          // Kirim status default ke Kodular - DIMODIFIKASI
          sendToKodular({
            action: 'status_changed',
            order_id: orderId,
            new_status: 'waiting',
            message: 'Menunggu konfirmasi driver',
            timestamp: new Date().toISOString()
          });
      }
      
      console.log(`üîÑ Status diperbarui: ${status}`);
    }

    // Fungsi untuk update data driver
    function updateDriverData(driver) {
      if (driver && driver.name) {
        document.getElementById('driverName').textContent = driver.name;
      }
      
      if (driver && (driver.rating || driver.avg_rating)) {
        document.getElementById('driverRating').textContent = driver.rating || driver.avg_rating || '4.9';
      } else {
        document.getElementById('driverRating').textContent = '4.9';
      }
      
      if (driver && driver.vehicle_brand) {
        document.getElementById('driverVehicleBrand').textContent = driver.vehicle_brand;
      }
      
      if (driver && driver.vehicle_type) {
        document.getElementById('driverVehicleType').textContent = driver.vehicle_type;
      }
      
      if (driver && driver.plate_number) {
        document.getElementById('driverPlate').textContent = driver.plate_number;
      }
      
      if (driver && driver.profile_photo_url) {
        document.getElementById('driverPhoto').src = driver.profile_photo_url;
      } else {
        document.getElementById('driverPhoto').src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
      }
    }

    // Fungsi untuk update data rute - DIPERBAIKI UNTUK DISKON
    function updateRouteData(route) {
      if (route.alamat_a) {
        document.getElementById('pickupAddress').textContent = route.alamat_a;
      }
      
      if (route.alamat_b) {
        document.getElementById('destinationAddress').textContent = route.alamat_b;
      }
      
      if (route.vehicle_name) {
        document.getElementById('serviceType').textContent = route.vehicle_name;
      }
      
      if (route.vehicle_capacity) {
        document.getElementById('serviceCapacity').textContent = route.vehicle_capacity;
      }
      
      if (route.durasi) {
        document.getElementById('tripDuration').textContent = route.durasi;
      }
      
      if (route.jarak) {
        document.getElementById('tripDistance').textContent = route.jarak;
      }
      
      if (route.created_at) {
        const orderTime = new Date(route.created_at);
        document.getElementById('orderTime').textContent = orderTime.toLocaleTimeString('id-ID', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      } else {
        document.getElementById('orderTime').textContent = '-';
      }
      
      // PERBAIKAN: Tampilkan harga dengan diskon jika ada
      displayPriceWithDiscount();
    }

    // Fungsi untuk menampilkan data driver - DIPERBAIKI
    function displayDriverData() {
      // Sembunyikan loading, tampilkan konten
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      document.getElementById('actionsSection').style.display = 'flex';
      
      console.log("Displaying driver data:", driverData);
      console.log("Displaying route data:", routeData);
      
      // PERBAIKAN: Handle berbagai struktur data driver
      let actualDriverData = driverData;
      
      // Jika driverData adalah objek yang kompleks (seperti dari Firebase), extract data yang diperlukan
      if (driverData && typeof driverData === 'object') {
        // Cek jika ada nested driver object (seperti dalam data yang Anda berikan)
        if (driverData.driver) {
          actualDriverData = driverData.driver;
        }
        
        // PERBAIKAN: Handle selected_driver structure
        if (driverData.selected_driver) {
          actualDriverData = driverData.selected_driver;
        }
        
        // Isi data driver
        document.getElementById('driverName').textContent = actualDriverData.name || '-';
        document.getElementById('driverRating').textContent = actualDriverData.rating || actualDriverData.avg_rating || '4.9';
        document.getElementById('driverVehicleBrand').textContent = actualDriverData.vehicle_brand || '-';
        document.getElementById('driverVehicleType').textContent = actualDriverData.vehicle_type || '-';
        document.getElementById('driverPlate').textContent = actualDriverData.plate_number || '-';
        
        // Foto driver (gunakan placeholder jika tidak ada)
        const driverPhoto = document.getElementById('driverPhoto');
        driverPhoto.src = actualDriverData.profile_photo_url || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
        driverPhoto.alt = actualDriverData.name || 'Driver Photo';
      }
      
      // Isi data rute - PERBAIKAN: Handle berbagai struktur data
      let actualRouteData = routeData;
      
      // Jika routeData adalah order data langsung dari Firebase atau localStorage
      if (routeData && typeof routeData === 'object') {
        // Gunakan data langsung dari routeData (order data)
        document.getElementById('pickupAddress').textContent = routeData.alamat_a || '-';
        document.getElementById('destinationAddress').textContent = routeData.alamat_b || '-';
        document.getElementById('serviceType').textContent = routeData.vehicle_name || routeData.vehicle || '-';
        document.getElementById('serviceCapacity').textContent = routeData.vehicle_capacity || '-';
        
        // Tambahkan durasi dan jarak dari data contoh
        if (routeData.durasi) {
          document.getElementById('tripDuration').textContent = routeData.durasi;
        }
        
        if (routeData.jarak) {
          document.getElementById('tripDistance').textContent = routeData.jarak;
        }
        
        // PERBAIKAN: Tampilkan harga dengan diskon jika ada
        displayPriceWithDiscount();
        
        // ==================== TAMPILKAN PETA JIKA ADA KOORDINAT ====================
        if (routeData.from_lat && routeData.from_lng && routeData.to_lat && routeData.to_lng) {
          document.getElementById('mapSection').style.display = 'block';
          
          const centerLat = (parseFloat(routeData.from_lat) + parseFloat(routeData.to_lat)) / 2;
          const centerLng = (parseFloat(routeData.from_lng) + parseFloat(routeData.to_lng)) / 2;
          
          initMap(centerLat, centerLng);
          
          addPickupMarker(routeData.from_lat, routeData.from_lng, routeData.alamat_a);
          addDestinationMarker(routeData.to_lat, routeData.to_lng, routeData.alamat_b);
          
          // Gambar rute
          setTimeout(() => {
            drawRouteOnMap(routeData.from_lat, routeData.from_lng, routeData.to_lat, routeData.to_lng);
          }, 1000);
        } else {
          document.getElementById('mapSection').style.display = 'none';
        }
      }
      
      // Update status berdasarkan data aktual
      if (routeData && routeData.status) {
        updateDriverStatus(routeData.status, actualDriverData);
      } else {
        updateArrivalStatus();
      }
      
      // PERBAIKAN: Pastikan konten bisa discroll
      setTimeout(() => {
        const contentWrapper = document.querySelector('.content-wrapper');
        if (contentWrapper) {
          contentWrapper.style.overflowY = 'auto';
        }
      }, 100);
    }

    // Fungsi untuk memperbarui status kedatangan driver
    function updateArrivalStatus() {
      const statusBadge = document.getElementById('statusBadge');
      statusBadge.style.display = 'block';
      
      // Simulasi estimasi waktu kedatangan (5-10 menit)
      const arrivalMinutes = Math.floor(Math.random() * 6) + 5;
      
      // Update status badge berdasarkan waktu
      if (arrivalMinutes <= 5) {
        statusBadge.textContent = 'Akan Tiba';
        statusBadge.style.background = '#28a745';
        statusBadge.style.color = 'white';
      } else {
        statusBadge.textContent = 'Menuju Lokasi';
        statusBadge.style.background = '#e6dd3b';
        statusBadge.style.color = '#343a40';
      }
    }

    // Fungsi untuk menampilkan error
    function showError(message) {
      console.error('Error:', message);
      
      // Sembunyikan loading dan content, tampilkan error
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'none';
      document.getElementById('actionsSection').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
      
      // Kirim error ke Kodular
      sendToKodular({
        action: 'error',
        message: message,
        order_id: orderId,
        timestamp: new Date().toISOString()
      });
    }

    // ==================== FUNGSI UNTUK MENCEGAH BACK PADA STATUS TERTENTU ====================

    // Fungsi untuk memeriksa apakah status order memungkinkan untuk back
    function canGoBack() {
        const blockedStatuses = ['accepted', 'on_the_way', 'arrived', 'on_trip'];
        const canBack = !blockedStatuses.includes(currentOrderStatus);
        
        console.log(`üîô Status saat ini: ${currentOrderStatus}, Boleh back: ${canBack}`);
        return canBack;
    }

    // Fungsi untuk tombol back yang aman (memeriksa status dulu)
    function safeGoBack() {
        if (canGoBack()) {
            // Panggil fungsi goBack asli
            performGoBack();
        } else {
            // Tampilkan pesan bahwa tidak bisa back saat perjalanan masih berlangsung
            showInfoModal(
                'Perjalanan Berlangsung', 
                'Anda tidak dapat kembali saat perjalanan masih berlangsung. Harap tunggu sampai perjalanan selesai.'
            );
        }
    }

    // Fungsi asli untuk kembali ke halaman sebelumnya
    function performGoBack() {
        // Hentikan listener Firebase sebelum kembali
        if (orderRef && orderUpdateHandler) {
            orderRef.off('value', orderUpdateHandler);
        }
        
        // Hentikan chat listener
        if (chatRef && chatListener) {
            chatRef.off('child_added', chatListener);
        }
        
        // Hentikan driver location listener
        if (driverLocationListener) {
            database.ref('driver_offers/' + orderId).off('value', driverLocationListener);
        }
        
        // Hentikan timeout jika masih berjalan
        if (dataTimeout) {
            clearTimeout(dataTimeout);
            dataTimeout = null;
        }
        
        // Hapus peta
        if (orderMap) {
            orderMap.remove();
            orderMap = null;
        }
        
        // ========== PERBAIKAN: HAPUS FLAG TRIP INCREMENT ==========
        // Simpan bahwa user sudah kembali dari halaman ini
        const backData = {
            action: 'go_back',
            order_id: orderId,
            trip_updated: checkIfTripAlreadyIncremented() // Informasi apakah perjalanan sudah ditambah
        };
        
        sendToKodular(backData);
        
        // Hapus active order dari localStorage
        localStorage.removeItem('jego_active_order');
        
        console.log('üîô Kembali ke halaman sebelumnya');
    }

    // Fungsi untuk menangani tombol back fisik (hardware back button)
    function setupBackButtonHandler() {
        // Tangani hardware back button untuk Android/WebView
        if (window.history && window.history.pushState) {
            // Tambah state ke history untuk mencegah back langsung
            history.pushState(null, null, document.URL);
            
            window.addEventListener('popstate', function(event) {
                if (!canGoBack()) {
                    // Tampilkan pesan bahwa tidak bisa back
                    showInfoModal(
                        'Perjalanan Berlangsung', 
                        'Anda tidak dapat kembali saat perjalanan masih berlangsung. Harap tunggu sampai perjalanan selesai atau batalkan terlebih dahulu.'
                    );
                    
                    // Tambah lagi state untuk mencegah back
                    history.pushState(null, null, document.URL);
                } else {
                    // Jika boleh back, lanjutkan dengan back normal
                    performGoBack();
                }
            });
        }
        
        console.log('‚úÖ Handler tombol back dipasang');
    }

    // Fungsi untuk tombol aksi
    function chatDriver() {
      openChat();
    }

    function cancelTrip() {
      showConfirmationModal(
        'Konfirmasi Pembatalan', 
        'Apakah Anda yakin ingin membatalkan perjalanan?', 
        confirmCancelTrip,
        'cancel_trip'
      );
    }

    function confirmCancelTrip() {
      const cancelData = {
        action: 'cancel_trip',
        order_id: orderId,
        message: 'Perjalanan dibatalkan oleh pengguna'
      };
      
      sendToKodular(cancelData);
      
      // Update status di Firebase
      if (orderId) {
        const orderRef = database.ref('orders/' + orderId);
        orderRef.update({
          status: 'cancelled',
          updated_at: new Date().toISOString(),
          cancelled_by: 'customer'
        })
        .then(() => {
          console.log('Status order diupdate menjadi cancelled');
        })
        .catch((error) => {
          console.error('Gagal update status order:', error);
        });
      }
      
      // ========== PERBAIKAN: HAPUS FLAG TRIP INCREMENT ==========
      const incrementKey = `trip_incremented_${orderId}`;
      localStorage.removeItem(incrementKey);
      
      showInfoModal('Informasi', 'Perjalanan dibatalkan');
      
      // Kembali ke halaman sebelumnya setelah beberapa detik
      setTimeout(() => {
        safeGoBack();
      }, 1500);
    }

    // Fungsi untuk menerima data dari Kodular
    function receiveDataFromKodular(dataString) {
      try {
        // Clear timeout karena data sudah diterima
        if (dataTimeout) {
          clearTimeout(dataTimeout);
          dataTimeout = null;
        }
        
        const data = JSON.parse(dataString);
        console.log("Data diterima dari Kodular:", data);
        
        if (data.action === 'open_driver_details') {
          // Simpan data
          driverData = data.driver;
          routeData = data.route_data;
          userData = data.user_data;
          orderId = data.order_id;
          
          // Tampilkan data di halaman
          displayDriverData();
          
          // Mulai listen ke Firebase untuk update real-time
          if (orderId) {
            listenToOrderUpdates(orderId);
          }
        }
      } catch (error) {
        console.error("Error parsing data dari Kodular:", error);
        showError("Format data tidak valid");
      }
    }

    // Fungsi untuk mengirim data ke Kodular - DIMODIFIKASI UNTUK LOGGING
    function sendToKodular(data) {
      const kodularData = {
        ...data,
        timestamp: new Date().toISOString()
      };
      
      console.log('üì§ Mengirim data SEDERHANA ke Kodular:', kodularData);
      
      // Menggunakan window.AppInventor.setWebViewString
      if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
        try {
          window.AppInventor.setWebViewString(JSON.stringify(kodularData));
          console.log('‚úÖ Data sederhana berhasil dikirim ke Kodular');
        } catch (error) {
          console.error('Error mengirim data via AppInventor:', error);
        }
      } else {
        console.warn('‚ùå window.AppInventor.setWebViewString tidak tersedia');
        // Fallback untuk testing di browser
        showInfoModal('Aksi', 'Aksi: ' + data.action + '\nData: ' + JSON.stringify(data, null, 2));
      }
    }

    // ==================== INISIALISASI YANG DIPERBAIKI ====================

    window.onload = function() {
      // Setup event listener untuk modal rating (klik di luar modal untuk menutup)
      document.getElementById('ratingModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeRatingModal();
        }
      });
      
      // Setup event listener untuk modal konfirmasi dan info
      document.getElementById('confirmationModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeConfirmationModal();
        }
      });
      
      document.getElementById('infoModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeInfoModal();
        }
      });
      
      // Setup event listener untuk modal chat
      document.getElementById('chatOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
          closeChat();
        }
      });
      
      // ‚≠ê‚≠ê PERBAIKAN: CLEANUP PROMO KADALUARSA SAAT INISIALISASI ‚≠ê‚≠ê
      cleanupExpiredPromos();
      
      // ‚≠ê‚≠ê PERBAIKAN: SETUP HANDLER UNTUK TOMBOL BACK ‚≠ê‚≠ê
      setupBackButtonHandler();
      
      // ‚≠ê‚≠ê PERBAIKAN: CEK TRIP INCREMENT FLAG DARI LOCALSTORAGE ‚≠ê‚≠ê
      if (orderId) {
        const incrementKey = `trip_incremented_${orderId}`;
        tripAlreadyIncremented = localStorage.getItem(incrementKey) === 'true';
      }
      
      // Cek URL parameters untuk order_id langsung
      const urlParams = new URLSearchParams(window.location.search);
      const directOrderId = urlParams.get('order_id');
      
      if (directOrderId) {
        // Jika ada order_id di URL, langsung ambil dari Firebase
        console.log('Mengambil data langsung dari Firebase untuk order:', directOrderId);
        orderId = directOrderId;
        listenToOrderUpdates(directOrderId);
        
        // Set timeout untuk cek jika data tidak ada di Firebase
        dataTimeout = setTimeout(() => {
          if (!driverData) {
            // Coba ambil dari localStorage sebagai fallback
            if (!loadFromLocalStorage()) {
              showError('Data driver tidak ditemukan di database');
            }
          }
        }, 5000);
        
      } else {
        // Jika tidak ada order_id di URL, coba ambil dari localStorage terlebih dahulu
        console.log('Mencoba mengambil data dari localStorage...');
        
        if (loadFromLocalStorage()) {
          console.log('‚úÖ Data berhasil dimuat dari localStorage');
        } else {
          // Jika tidak ada data di localStorage, tunggu data dari Kodular
          console.log('Tidak ada data di localStorage, menunggu data dari Kodular...');
          
          // Set timeout untuk cek jika tidak ada data dari Kodular
          dataTimeout = setTimeout(() => {
            if (!driverData) {
              showError('Tidak ada data driver yang diterima dari aplikasi');
            }
          }, 5000);
        }
      }
    };

    // Ekspos fungsi receiveDataFromKodular ke global scope agar bisa dipanggil dari Kodular
    window.receiveDataFromKodular = receiveDataFromKodular;
  </script>
</body>
</html>
