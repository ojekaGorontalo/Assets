<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Daftar Driver - JeGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #1e6f5c;
      --secondary: #289672;
      --accent: #e6dd3b;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --danger: #dc3545;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.4;
      font-size: 0.85rem;
    }

    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo {
      width: 40px;
      height: 40px;
      background-color: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary);
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Container Styles */
    .container {
      max-width: 100%;
      padding: 15px;
    }

    .form-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
    }

    .form-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 111, 92, 0.1);
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .vehicle-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .vehicle-option {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .vehicle-option:hover {
      border-color: var(--secondary);
    }

    .vehicle-option.selected {
      border-color: var(--primary);
      background-color: rgba(30, 111, 92, 0.05);
    }

    .vehicle-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .vehicle-name {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .vehicle-capacity {
      font-size: 0.75rem;
      color: #666;
      margin-top: 3px;
    }

    .terms-container {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
    }

    .terms-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .terms-content {
      font-size: 0.8rem;
      line-height: 1.5;
    }

    .terms-content p {
      margin-bottom: 10px;
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .checkbox-group input {
      margin-right: 10px;
      margin-top: 3px;
    }

    .checkbox-group label {
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .submit-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      width: 100%;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .submit-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Status Messages */
    .status-message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }

    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Verification Section */
    .verification-section {
      background-color: #f0f9ff;
      border: 1px solid #b3e0ff;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .verification-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
    }

    .verification-steps {
      margin-bottom: 20px;
    }

    .verification-step {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .step-number {
      background-color: var(--primary);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .step-text {
      flex: 1;
      font-size: 0.9rem;
    }

    .whatsapp-btn {
      background: linear-gradient(to right, #25D366, #128C7E);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .whatsapp-icon {
      font-size: 1.2rem;
    }

    /* Profile Photo Section */
    .profile-photo-section {
      background-color: #f0fff0;
      border: 1px solid #b3e6b3;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .profile-photo-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
    }

    .profile-photo-info {
      margin-bottom: 20px;
      font-size: 0.9rem;
      text-align: center;
    }

    .profile-photo-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .profile-photo-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .profile-photo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    /* Loading spinner */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-title {
        font-size: 1rem;
      }
      
      body {
        font-size: 0.8rem;
      }
      
      .form-container {
        padding: 15px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .vehicle-options {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }
    }

    @media (max-width: 576px) {
      .container {
        padding: 10px;
      }
      
      .form-title {
        fontSize: 1.3rem;
      }
      
      .vehicle-options {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo-container">
      <div class="logo">JG</div>
      <div class="header-title">JeGo - Daftar Driver</div>
    </div>
    <a href="list.html" class="back-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Kembali
    </a>
  </div>

  <!-- Container -->
  <div class="container">
    <div class="form-container">
      <h1 class="form-title">Form Pendaftaran Driver</h1>
      
      <div class="status-message" id="statusMessage"></div>
      
      <!-- Form Pendaftaran Awal -->
      <form id="driverForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="fullName">Nama Lengkap *</label>
            <input type="text" class="form-input" id="fullName" placeholder="Masukkan nama lengkap" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="phoneNumber">Nomor Telepon *</label>
            <input type="tel" class="form-input" id="phoneNumber" placeholder="Contoh: 08123456789" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input type="email" class="form-input" id="email" placeholder="Contoh: nama@email.com">
        </div>
        
        <div class="form-group">
          <label class="form-label" for="address">Alamat *</label>
          <input type="text" class="form-input" id="address" placeholder="Masukkan alamat lengkap" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Jenis Kendaraan *</label>
          <div class="vehicle-options">
            <div class="vehicle-option" data-type="motor">
              <div class="vehicle-icon">üèçÔ∏è</div>
              <div class="vehicle-name">Motor</div>
              <div class="vehicle-capacity">1 Penumpang</div>
            </div>
            <div class="vehicle-option" data-type="bentor">
              <div class="vehicle-icon">üõ∫</div>
              <div class="vehicle-name">Bentor</div>
              <div class="vehicle-capacity">3 Penumpang</div>
            </div>
            <div class="vehicle-option" data-type="mobil">
              <div class="vehicle-icon">üöó</div>
              <div class="vehicle-name">Mobil</div>
              <div class="vehicle-capacity">4 Penumpang</div>
            </div>
          </div>
          <input type="hidden" id="vehicleType" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="vehicleBrand">Merk Kendaraan *</label>
            <input type="text" class="form-input" id="vehicleBrand" placeholder="Contoh: Honda Beat" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="plateNumber">Plat Nomor *</label>
            <input type="text" class="form-input" id="plateNumber" placeholder="Contoh: B 1234 ABC" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="idCardNumber">Nomor KTP *</label>
          <input type="text" class="form-input" id="idCardNumber" placeholder="Masukkan nomor KTP" required>
        </div>
        
        <div class="terms-container">
          <div class="terms-title">Syarat dan Ketentuan JeGo Driver</div>
          <div class="terms-content">
            <p>1. Driver harus memiliki SIM yang masih berlaku sesuai dengan jenis kendaraan yang digunakan.</p>
            <p>2. Kendaraan harus dalam kondisi baik, layak jalan, dan memiliki STNK yang masih berlaku.</p>
            <p>3. Driver harus berperilaku sopan dan menjaga etika selama melayani customer.</p>
            <p>4. Driver dilarang menolak order tanpa alasan yang jelas.</p>
            <p>5. Driver harus mematuhi peraturan lalu lintas yang berlaku.</p>
            <p>6. Driver bertanggung jawab atas keamanan dan keselamatan customer selama perjalanan.</p>
            <p>7. JeGo berhak menonaktifkan akun driver yang melanggar syarat dan ketentuan.</p>
            <p>8. Driver akan dikenakan sanksi jika melakukan penipuan atau tindakan yang merugikan customer.</p>
            <p>9. Semua transaksi harus dilakukan melalui aplikasi JeGo.</p>
            <p>10. Driver setuju untuk memberikan data pribadi yang diperlukan untuk keperluan verifikasi.</p>
          </div>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="agreeTerms" required>
          <label for="agreeTerms">Saya telah membaca dan menyetujui Syarat dan Ketentuan JeGo Driver</label>
        </div>
        
        <button type="submit" class="submit-btn" id="submitBtn">Daftar sebagai Driver</button>
      </form>
      
      <!-- Verification Section (akan muncul setelah pendaftaran berhasil) -->
      <div class="verification-section" id="verificationSection">
        <h2 class="verification-title">Verifikasi Data Driver</h2>
        
        <div class="verification-steps">
          <div class="verification-step">
            <div class="step-number">1</div>
            <div class="step-text">Siapkan dokumen berikut untuk verifikasi:</div>
          </div>
          <div class="verification-step">
            <div class="step-number"></div>
            <div class="step-text">‚Ä¢ Foto KTP (Kartu Tanda Penduduk)</div>
          </div>
          <div class="verification-step">
            <div class="step-number"></div>
            <div class="step-text">‚Ä¢ Foto SIM (Surat Izin Mengemudi)</div>
          </div>
          <div class="verification-step">
            <div class="step-number"></div>
            <div class="step-text">‚Ä¢ Foto STNK (Surat Tanda Nomor Kendaraan)</div>
          </div>
          <div class="verification-step">
            <div class="step-number"></div>
            <div class="step-text">‚Ä¢ Foto kendaraan (tampak depan, samping, dan belakang)</div>
          </div>
          
          <div class="verification-step">
            <div class="step-number">2</div>
            <div class="step-text">Klik tombol di bawah untuk menghubungi Admin JeGo via WhatsApp</div>
          </div>
          
          <div class="verification-step">
            <div class="step-number">3</div>
            <div class="step-text">Kirimkan foto dokumen yang telah disiapkan ke Admin</div>
          </div>
        </div>
        
        <button class="whatsapp-btn" id="whatsappBtn">
          <span class="whatsapp-icon">üì±</span>
          Hubungi Admin via WhatsApp
        </button>
        
        <div style="text-align: center; margin-top: 15px; font-size: 0.8rem; color: #666;">
          Nomor Admin: 083142889149
        </div>
      </div>
      
      <!-- Profile Photo Section (akan muncul jika status accepted) -->
      <div class="profile-photo-section" id="profilePhotoSection">
        <h2 class="profile-photo-title">Upload Foto Profil</h2>
        
        <div class="profile-photo-info">
          <p>Selamat! Status Anda telah <strong>diterima</strong> sebagai driver JeGo.</p>
          <p>Silakan masukkan URL foto profil yang diberikan oleh Admin untuk ditampilkan ke customer.</p>
        </div>
        
        <div class="profile-photo-form">
          <div class="form-group">
            <label class="form-label" for="profilePhotoUrl">URL Foto Profil *</label>
            <input type="url" class="form-input" id="profilePhotoUrl" placeholder="Contoh: https://example.com/foto-driver.jpg" required>
          </div>
          
          <button class="profile-photo-btn" id="saveProfilePhotoBtn">Simpan Foto Profil</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCEsbn9W4ivUesB15wmDuMhOT4JR6Mq9Bs",
      authDomain: "ojeka-ba255.firebaseapp.com",
      databaseURL: "https://ojeka-ba255-default-rtdb.firebaseio.com",
      projectId: "ojeka-ba255",
      storageBucket: "ojeka-ba255.firebasestorage.app",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Generate unique driver ID
    function generateDriverId() {
      return 'DRIVER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Show status message
    function showStatus(message, type) {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = 'status-message';
      statusElement.classList.add(`status-${type}`);
      statusElement.style.display = 'block';
      
      // Auto hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    // Validate form data
    function validateForm(formData) {
      // Check required fields
      const requiredFields = [
        'fullName', 'phoneNumber', 'address', 'vehicleType', 
        'vehicleBrand', 'plateNumber', 'idCardNumber'
      ];
      
      for (const field of requiredFields) {
        if (!formData[field] || formData[field].trim() === '') {
          return `Field ${field} harus diisi`;
        }
      }
      
      // Validate phone number (minimal 10 digit)
      const phoneRegex = /^[0-9]{10,}$/;
      if (!phoneRegex.test(formData.phoneNumber.replace(/\D/g, ''))) {
        return 'Nomor telepon tidak valid';
      }
      
      // Validate email if provided
      if (formData.email && formData.email.trim() !== '') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
          return 'Format email tidak valid';
        }
      }
      
      // Validate ID card number (minimal 16 digit)
      const idCardRegex = /^[0-9]{16,}$/;
      if (!idCardRegex.test(formData.idCardNumber.replace(/\D/g, ''))) {
        return 'Nomor KTP harus terdiri dari 16 digit angka';
      }
      
      return null; // No errors
    }

    // Handle vehicle selection
    document.querySelectorAll('.vehicle-option').forEach(option => {
      option.addEventListener('click', function() {
        // Remove selected class from all options
        document.querySelectorAll('.vehicle-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Add selected class to clicked option
        this.classList.add('selected');
        
        // Set the hidden input value
        document.getElementById('vehicleType').value = this.getAttribute('data-type');
      });
    });

    // Handle form submission - DIPERBARUI DENGAN SALDO AWAL DAN POTONGAN
    document.getElementById('driverForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Mendaftarkan...';
      
      // Collect form data - DITAMBAHKAN SALDO AWAL DAN POTONGAN
      const formData = {
        fullName: document.getElementById('fullName').value.trim(),
        phoneNumber: document.getElementById('phoneNumber').value.trim(),
        email: document.getElementById('email').value.trim(),
        address: document.getElementById('address').value.trim(),
        vehicleType: document.getElementById('vehicleType').value,
        vehicleBrand: document.getElementById('vehicleBrand').value.trim(),
        plateNumber: document.getElementById('plateNumber').value.trim(),
        idCardNumber: document.getElementById('idCardNumber').value.trim(),
        registrationDate: new Date().toISOString(),
        status: 'pending', // pending, accepted, rejected
        driverId: generateDriverId(),
        profilePhotoUrl: '', // Awalnya kosong
        
        // === FIELD BARU: SALDO AWAL DAN POTONGAN ===
        Balance: 0, // Saldo awal Rp 25.000
        Potongan: 10,  // Potongan 10%
        
        // FIELD BARU YANG DITAMBAHKAN untuk statistik driver
        totalOrders: 0,
        completedOrders: 0,
        totalEarnings: 0,
        avgRating: 5.0,     // ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê default rating awal
        ratingCount: 0,     // supaya nilai 5.0 valid
        completionRate: '0%',
        isOnline: false,
        location: null,
        onTrip: false
      };
      
      // Validate form data
      const validationError = validateForm(formData);
      if (validationError) {
        showStatus(validationError, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Daftar sebagai Driver';
        return;
      }
      
      // Save to Firebase
      const driversRef = database.ref('drivers');
      driversRef.child(formData.driverId).set(formData)
        .then(() => {
          // Simpan ke localStorage
          localStorage.setItem('jego_driver_data', JSON.stringify(formData));
          
          showStatus('Pendaftaran berhasil! Silakan verifikasi data Anda dengan Admin.', 'success');
          
          // Sembunyikan form dan tampilkan section verifikasi
          document.getElementById('driverForm').style.display = 'none';
          document.getElementById('verificationSection').style.display = 'block';
          
          // Kirim data ke Kodular - DIPERBARUI DENGAN DATA LENGKAP
          sendToKodular({
            action: 'driver_registered',
            driver_id: formData.driverId,
            full_name: formData.fullName,
            phone_number: formData.phoneNumber,
            vehicle_type: formData.vehicleType,
            total_orders: formData.totalOrders,
            avg_rating: formData.avgRating,
            completion_rate: formData.completionRate,
            initial_balance: formData.Balance, // Tambahkan info saldo awal
            potongan_percentage: formData.Potongan // Tambahkan info potongan
          });
        })
        .catch((error) => {
          console.error('Error saving driver data:', error);
          showStatus('Terjadi kesalahan saat menyimpan data. Silakan coba lagi.', 'error');
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Daftar sebagai Driver';
        });
    });

    // Handle WhatsApp button click
    document.getElementById('whatsappBtn').addEventListener('click', function() {
      const driverData = JSON.parse(localStorage.getItem('jego_driver_data') || '{}');
      
      // Kirim data ke Kodular untuk diarahkan ke WhatsApp - DIPERBARUI
      sendToKodular({
        action: 'whatsapp_verification',
        driver_id: driverData.driverId,
        admin_number: '083142889149',
        driver_name: driverData.fullName,
        vehicle_type: driverData.vehicleType,
        initial_balance: driverData.Balance,
        potongan_percentage: driverData.Potongan
      });
      
      showStatus('Permintaan verifikasi telah dikirim. Tunggu konfirmasi dari Admin.', 'success');
    });

    // Handle save profile photo - DIPERBARUI
    document.getElementById('saveProfilePhotoBtn').addEventListener('click', function() {
      const profilePhotoUrl = document.getElementById('profilePhotoUrl').value.trim();
      
      if (!profilePhotoUrl) {
        showStatus('Harap masukkan URL foto profil', 'error');
        return;
      }
      
      // Validasi URL
      try {
        new URL(profilePhotoUrl);
      } catch (e) {
        showStatus('URL tidak valid. Harap masukkan URL yang benar.', 'error');
        return;
      }
      
      const driverData = JSON.parse(localStorage.getItem('jego_driver_data') || '{}');
      
      // Update data di localStorage
      driverData.profilePhotoUrl = profilePhotoUrl;
      localStorage.setItem('jego_driver_data', JSON.stringify(driverData));
      
      // Update data di Firebase
      const driversRef = database.ref('drivers/' + driverData.driverId);
      driversRef.update({
        profilePhotoUrl: profilePhotoUrl,
        profileUpdatedAt: new Date().toISOString()
      })
      .then(() => {
        showStatus('Foto profil berhasil disimpan!', 'success');
        
        // Kirim data ke Kodular - DIPERBARUI
        sendToKodular({
          action: 'profile_photo_updated',
          driver_id: driverData.driverId,
          profile_photo_url: profilePhotoUrl,
          full_name: driverData.fullName,
          status: 'completed_registration',
          balance: driverData.Balance,
          potongan: driverData.Potongan
        });
      })
      .catch((error) => {
        console.error('Error updating profile photo:', error);
        showStatus('Terjadi kesalahan saat menyimpan foto profil.', 'error');
      });
    });

    // Fungsi untuk mengirim data ke Kodular
    function sendToKodular(data) {
      console.log('Mengirim data ke Kodular:', data);
      
      // METODE 1: Menggunakan window.AppInventor.setWebViewString
      if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
        try {
          window.AppInventor.setWebViewString(JSON.stringify(data));
          console.log('‚úÖ Data berhasil dikirim ke Kodular via AppInventor.setWebViewString');
        } catch (error) {
          console.error('Error mengirim data via AppInventor:', error);
        }
      }
      // METODE 2: Menggunakan window.android (Android WebView)
      else if (typeof window.android !== 'undefined' && window.android.receiveData) {
        try {
          window.android.receiveData(JSON.stringify(data));
          console.log('‚úÖ Data berhasil dikirim ke Kodular via window.android');
        } catch (error) {
          console.error('Error mengirim data via window.android:', error);
        }
      }
      // METODE 3: Menggunakan window.webkit.messageHandlers (iOS WebView)
      else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.observe) {
        try {
          window.webkit.messageHandlers.observe.postMessage(data);
          console.log('‚úÖ Data berhasil dikirim ke Kodular via webkit.messageHandlers');
        } catch (error) {
          console.error('Error mengirim data via webkit.messageHandlers:', error);
        }
      }
      else {
        console.warn('‚ùå Tidak ada metode yang berhasil mengirim data ke Kodular');
        console.log('Data yang gagal dikirim:', data);
      }
    }

    // Cek status driver saat halaman dimuat
    function checkDriverStatus() {
      const driverData = JSON.parse(localStorage.getItem('jego_driver_data') || '{}');
      
      if (driverData.driverId) {
        // Driver sudah terdaftar, cek status di Firebase
        const driversRef = database.ref('drivers/' + driverData.driverId);
        driversRef.once('value')
          .then((snapshot) => {
            const currentData = snapshot.val();
            
            if (currentData) {
              // Update data di localStorage dengan data terbaru dari Firebase
              const updatedData = { ...driverData, ...currentData };
              localStorage.setItem('jego_driver_data', JSON.stringify(updatedData));
              
              // Tampilkan section sesuai status
              if (currentData.status === 'accepted') {
                // Jika status accepted, tampilkan form foto profil
                document.getElementById('driverForm').style.display = 'none';
                document.getElementById('verificationSection').style.display = 'none';
                document.getElementById('profilePhotoSection').style.display = 'block';
                
                // Jika sudah ada foto profil, isi field
                if (currentData.profilePhotoUrl) {
                  document.getElementById('profilePhotoUrl').value = currentData.profilePhotoUrl;
                }
              } else if (currentData.status === 'pending') {
                // Jika status masih pending, tampilkan section verifikasi
                document.getElementById('driverForm').style.display = 'none';
                document.getElementById('verificationSection').style.display = 'block';
                document.getElementById('profilePhotoSection').style.display = 'none';
              }
            }
          })
          .catch((error) => {
            console.error('Error checking driver status:', error);
          });
      }
    }

    // Inisialisasi saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
      checkDriverStatus();
    });
  </script>
</body>
</html>
