<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Detail Order - Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* [CSS STYLES TETAP SAMA SEPERTI SEBELUMNYA] */
    /* Karena panjang, saya tetapkan CSS yang sama */
    /* Anda bisa copy dari file sebelumnya */
    :root {
      --primary: #FF9800;
      --secondary: #FF5722;
      --accent: #FFC107;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #4CAF50;
      --danger: #f44336;
      --warning: #FFC107;
      --info: #2196F3;
      --gray: #9E9E9E;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--dark);
      height: 100vh;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    .container {
      width: 100%;
      max-width: 100%;
      background: white;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      margin-top: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    /* ... [CSS LAINNYA TETAP SAMA] ... */
    /* Karena sangat panjang, saya asumsikan Anda sudah memiliki CSS lengkap */
  </style>
</head>
<body>
  <!-- [STRUKTUR HTML TETAP SAMA] -->
  <!-- Karena panjang, struktur HTML tetap sama seperti sebelumnya -->
  <!-- Anda bisa copy dari file sebelumnya -->

  <script>
    // ==================== KONFIGURASI FIREBASE ====================
    const firebaseConfig = {
      apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
      authDomain: "game-balap-simpel.firebaseapp.com",
      databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
      projectId: "game-balap-simpel",
      storageBucket: "game-balap-simpel.firebasestorage.app",
      messagingSenderId: "864576853495",
      appId: "1:864576853495:web:6f16eb757fd3d8affb0af2",
      measurementId: "G-YWJPK7Y3J4"
    };

    // ==================== INISIALISASI VARIABEL GLOBAL ====================
    let firebaseApp, database;
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      database = firebaseApp.database();
      console.log("‚úÖ Firebase berhasil diinisialisasi");
    } catch (error) {
      console.error("‚ùå Gagal menginisialisasi Firebase:", error);
      showError("Gagal menghubungkan ke server. Periksa koneksi internet Anda.");
    }

    let currentOrderId = null;
    let orderRef = null;
    let orderListener = null;
    let currentOrderData = null;

    // ==================== VARIABEL SISTEM SALDO ====================
    let currentDriverData = null;
    let currentDriverBalance = 0;
    let potonganPercentage = 10;
    let balanceListener = null;

    // ==================== VARIABEL SISTEM CHAT ====================
    let chatRef = null;
    let chatListener = null;
    let unreadMessages = 0;
    let chatOpen = false;

    // ==================== VARIABEL PETA DAN LOKASI ====================
    let orderMap = null;
    let driverMarker = null;
    let pickupMarker = null;
    let destinationMarker = null;
    let routePolyline = null;
    let driverLocationInterval = null;
    let currentDriverLocation = null;

    // ==================== VARIABEL RATING SYSTEM ====================
    let selectedRating = 0;
    let ratingComment = '';
    let userToRate = null;
    let orderCompletedData = null;

    // ==================== VARIABEL FOTO PROFIL ====================
    let customerPhotoUrl = null;
    let customerPhotoData = null;

    // ==================== MAPPING ICON KENDARAAN ====================
    const vehicleIconMap = {
      'motor': 'https://cdn-icons-png.flaticon.com/128/5811/5811823.png',
      'bentor': 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png',
      'mobil': 'https://cdn-icons-png.flaticon.com/128/12689/12689302.png',
      'kurir_motor': 'https://cdn-icons-png.flaticon.com/128/9561/9561688.png',
      'kurir_bentor': 'https://cdn-icons-png.flaticon.com/128/7890/7890227.png'
    };

    // ==================== PERBAIKAN: FUNGSI UTILITAS ====================
    function getOrderAmount(order) {
      // Hanya ambil harga_total sebagai satu-satunya sumber harga
      const amount = order.harga_total;
      return typeof amount === 'number' ? amount : parseFloat(amount) || 0;
    }

    // ==================== PERBAIKAN: FUNGSI KOMUNIKASI KODULAR ====================
    function sendToKodular(data) {
      const kodularData = {
        ...data,
        timestamp: new Date().toISOString(),
        page: 'order_details_driver'
      };
      
      console.log('üì§ Mengirim data ke Kodular:', kodularData);
      
      // METODE 1: AppInventor (untuk WebView Kodular)
      if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
        try {
          window.AppInventor.setWebViewString(JSON.stringify(kodularData));
          console.log('‚úÖ Data terkirim via AppInventor');
          return true;
        } catch (error) {
          console.error('‚ùå Error mengirim data via AppInventor:', error);
        }
      }
      
      // METODE 2: postMessage (untuk WebView standar)
      if (window.parent && window.parent.postMessage) {
        try {
          window.parent.postMessage(JSON.stringify(kodularData), '*');
          console.log('‚úÖ Data terkirim via postMessage');
          return true;
        } catch (error) {
          console.error('‚ùå Error mengirim data via postMessage:', error);
        }
      }
      
      // METODE 3: localStorage (fallback)
      try {
        localStorage.setItem('kodular_webview_data', JSON.stringify(kodularData));
        console.log('‚úÖ Data disimpan di localStorage sebagai fallback');
        return true;
      } catch (error) {
        console.error('‚ùå Error menyimpan data ke localStorage:', error);
      }
      
      console.warn('‚ö†Ô∏è Semua metode pengiriman gagal, tampilkan di console saja');
      return false;
    }

    // ==================== PERBAIKAN: FUNGSI LOKASI DRIVER ====================
    // HAPUS SISTEM driver_offers yang menyebabkan permission_denied
    // Simpan lokasi driver langsung di node order
    
    function startSendingDriverLocation(orderId) {
      if (driverLocationInterval) {
        clearInterval(driverLocationInterval);
      }
      
      // Kirim lokasi pertama kali
      sendDriverLocationToFirebase(orderId);
      
      // Set interval untuk update lokasi
      driverLocationInterval = setInterval(() => {
        sendDriverLocationToFirebase(orderId);
      }, 5000); // Kirim setiap 5 detik
      
      console.log('üöó Memulai pengiriman lokasi driver otomatis');
    }

    function sendDriverLocationToFirebase(orderId) {
      if (!navigator.geolocation) {
        console.error('Geolocation not supported');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          currentDriverLocation = { lat: latitude, lng: longitude };
          
          const vehicleType = currentOrderData?.vehicle_name || 
                             currentOrderData?.vehicle || 
                             currentDriverData?.vehicleType || 
                             'motor';
          
          const vehicleIcon = currentOrderData?.transport_icon || 
                             currentDriverData?.vehicleIcon ||
                             vehicleIconMap[vehicleType?.toLowerCase().replace(/ /g, '_')] ||
                             vehicleIconMap['motor'];
          
          // Update marker di peta
          updateDriverMarker(latitude, longitude, vehicleType, vehicleIcon);
          
          // **PERBAIKAN: Simpan di node order, bukan driver_offers**
          const orderLocationRef = database.ref('orders/' + orderId + '/driver_location');
          
          const locationData = {
            lat: latitude,
            lng: longitude,
            driver_id: currentDriverData?.driverId || currentDriverData?.uid || 'unknown',
            driver_name: currentDriverData?.fullName || currentDriverData?.name || 'Driver',
            vehicle_type: vehicleType,
            vehicle_icon: vehicleIcon,
            timestamp: new Date().toISOString(),
            accuracy: position.coords.accuracy || 0
          };
          
          orderLocationRef.set(locationData)
            .then(() => {
              console.log('üìç Lokasi driver disimpan di order:', locationData);
              
              // Kirim ke Kodular
              sendToKodular({
                action: 'driver_location_updated',
                order_id: orderId,
                lat: latitude,
                lng: longitude,
                vehicle_type: vehicleType,
                vehicle_icon: vehicleIcon,
                timestamp: new Date().toISOString()
              });
            })
            .catch((error) => {
              console.error('‚ùå Gagal menyimpan lokasi driver:', error);
              
              // Jika gagal, coba metode alternatif
              if (error.code === 'PERMISSION_DENIED') {
                console.log('‚ö†Ô∏è Tidak punya izin, coba metode alternatif...');
                saveDriverLocationAlternative(orderId, locationData);
              }
            });
        },
        (error) => {
          console.error('Error getting location:', error);
          // Coba lagi dalam 10 detik
          setTimeout(() => sendDriverLocationToFirebase(orderId), 10000);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // Metode alternatif untuk menyimpan lokasi jika permission denied
    function saveDriverLocationAlternative(orderId, locationData) {
      // Coba simpan di localStorage sebagai fallback
      try {
        const key = `driver_location_${orderId}`;
        localStorage.setItem(key, JSON.stringify({
          ...locationData,
          local_timestamp: Date.now()
        }));
        console.log('üìç Lokasi driver disimpan di localStorage sebagai fallback');
      } catch (error) {
        console.error('‚ùå Gagal menyimpan lokasi di localStorage:', error);
      }
    }

    function stopSendingDriverLocation() {
      if (driverLocationInterval) {
        clearInterval(driverLocationInterval);
        driverLocationInterval = null;
        console.log('üìç Berhenti mengirim lokasi driver');
      }
    }

    // ==================== FUNGSI PETA ====================
    function initMap(centerLat, centerLng) {
      if (!orderMap) {
        orderMap = L.map('orderMap').setView([centerLat, centerLng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(orderMap);
        
        L.control.zoom({
          position: 'bottomright'
        }).addTo(orderMap);
        
        console.log('‚úÖ Peta diinisialisasi dengan view:', centerLat, centerLng);
      } else {
        orderMap.setView([centerLat, centerLng], 13);
      }
    }

    function updateDriverMarker(lat, lng, vehicleType, iconUrl = null) {
      let vehicleIcon;
      
      if (iconUrl) {
        vehicleIcon = L.icon({
          iconUrl: iconUrl,
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40],
          className: 'driver-marker'
        });
      } else {
        const normalizedType = vehicleType?.toLowerCase().replace(/ /g, '_') || 'motor';
        const defaultIconUrl = vehicleIconMap[normalizedType] || vehicleIconMap['motor'];
        
        vehicleIcon = L.icon({
          iconUrl: defaultIconUrl,
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40],
          className: 'driver-marker'
        });
      }
      
      if (!driverMarker) {
        driverMarker = L.marker([lat, lng], {
          icon: vehicleIcon,
          zIndexOffset: 1000
        }).addTo(orderMap).bindPopup(`
          <div style="text-align: center;">
            <b>üöó Posisi Driver</b><br>
            ${vehicleType || 'Kendaraan'}<br>
            <small>${new Date().toLocaleTimeString('id-ID')}</small>
          </div>
        `);
        
        console.log('‚úÖ Marker driver dibuat dengan icon:', iconUrl || vehicleType);
      } else {
        driverMarker.setLatLng([lat, lng]);
        driverMarker.setIcon(vehicleIcon);
        
        driverMarker.setPopupContent(`
          <div style="text-align: center;">
            <b>üöó Posisi Driver</b><br>
            ${vehicleType || 'Kendaraan'}<br>
            <small>${new Date().toLocaleTimeString('id-ID')}</small>
          </div>
        `);
      }
    }

    // ==================== SISTEM SALDO DRIVER ====================
    function initializeBalanceSystem() {
      const driverDataStr = localStorage.getItem('jego_driver_data');
      if (!driverDataStr) {
        console.log('‚ùå Tidak ada data driver di localStorage');
        showToast('Data driver tidak ditemukan. Silakan login ulang.', 'error');
        return;
      }

      try {
        currentDriverData = JSON.parse(driverDataStr);
        console.log('‚úÖ Data driver ditemukan:', currentDriverData);

        const driverId = currentDriverData.driverId || currentDriverData.uid;
        if (!driverId) {
          console.log('‚ùå Driver ID tidak ditemukan');
          return;
        }

        console.log('üöó Driver ID untuk saldo:', driverId);

        // Listener untuk saldo
        const balanceRef = database.ref('drivers/' + driverId + '/Balance');
        
        balanceListener = balanceRef.on('value', (snapshot) => {
          const newBalance = snapshot.val();
          console.log('üí∞ Data saldo dari Firebase:', newBalance);
          
          if (newBalance !== null && newBalance !== undefined) {
            currentDriverBalance = parseFloat(newBalance) || 0;
            console.log(`üí∞ Saldo diperbarui: Rp ${currentDriverBalance.toLocaleString('id-ID')}`);
            
            if (currentDriverData) {
              currentDriverData.Balance = currentDriverBalance;
              localStorage.setItem('jego_driver_data', JSON.stringify(currentDriverData));
            }
            
            updateDebugInfoUI();
          } else {
            console.warn('‚ö†Ô∏è Saldo driver null/undefined di Firebase, set ke 0');
            currentDriverBalance = 0;
          }
        }, (error) => {
          console.error('‚ùå Error listening to balance:', error);
        });

        // Ambil data potongan
        const potonganRef = database.ref('drivers/' + driverId + '/Potongan');
        
        potonganRef.once('value').then((snapshot) => {
          const potonganValue = snapshot.val();
          console.log('üìä Data potongan dari Firebase:', potonganValue);
          
          if (potonganValue !== null && potonganValue !== undefined) {
            potonganPercentage = parseFloat(potonganValue);
            console.log(`‚úÖ Potongan dari Firebase: ${potonganPercentage}%`);
            
            if (currentDriverData) {
              currentDriverData.Potongan = potonganPercentage;
              localStorage.setItem('jego_driver_data', JSON.stringify(currentDriverData));
            }
            
            updateDebugInfoUI();
          } else {
            console.warn(`‚ö†Ô∏è Potongan tidak ditemukan di Firebase, gunakan default: ${potonganPercentage}%`);
          }
        }).catch((error) => {
          console.error('‚ùå Error mengambil data potongan:', error);
        });

      } catch (error) {
        console.error('‚ùå Error parsing driver data:', error);
        showToast('Data driver tidak valid. Silakan login ulang.', 'error');
      }
    }

    function updateDebugInfoUI() {
      const debugInfo = document.getElementById('debugInfo');
      if (debugInfo) {
        debugInfo.innerHTML = `üí∞ Rp ${currentDriverBalance.toLocaleString('id-ID')} (${potonganPercentage}%)`;
        debugInfo.title = `Saldo: Rp ${currentDriverBalance.toLocaleString('id-ID')}\nPotongan: ${potonganPercentage}%`;
      }
    }

    // ==================== FUNGSI PERHITUNGAN POTONGAN ====================
    function calculateFee(orderAmount) {
      const amount = typeof orderAmount === 'number' ? orderAmount : parseFloat(orderAmount) || 0;
      const fee = Math.round(amount * (potonganPercentage / 100));
      
      console.log(`üßÆ PERHITUNGAN POTONGAN:`);
      console.log(`  - Harga order: Rp ${amount.toLocaleString('id-ID')}`);
      console.log(`  - Persentase: ${potonganPercentage}%`);
      console.log(`  - Hasil: Rp ${fee.toLocaleString('id-ID')}`);
      
      return fee;
    }

    function checkBalanceForOrder(orderAmount) {
      const requiredFee = calculateFee(orderAmount);
      const hasSufficientBalance = currentDriverBalance >= requiredFee;
      
      console.log(`üí≥ CEK SALDO:`);
      console.log(`  - Saldo driver: Rp ${currentDriverBalance.toLocaleString('id-ID')}`);
      console.log(`  - Potongan dibutuhkan: Rp ${requiredFee.toLocaleString('id-ID')}`);
      console.log(`  - Cukup? ${hasSufficientBalance ? '‚úÖ YA' : '‚ùå TIDAK'}`);
      console.log(`  - Sisa saldo: Rp ${(currentDriverBalance - requiredFee).toLocaleString('id-ID')}`);
      
      return {
        hasSufficientBalance: hasSufficientBalance,
        requiredFee: requiredFee,
        currentBalance: currentDriverBalance,
        remainingBalance: currentDriverBalance - requiredFee
      };
    }

    // ==================== PERBAIKAN: FUNGSI START TRIP ====================
    async function startTrip() {
      if (!currentOrderData) {
        showToast('‚ùå Data order tidak tersedia', 'error');
        return;
      }
      
      console.log('üöó === MEMULAI PROSES PERJALANAN ===');
      
      // HANYA AMBIL DARI harga_total - TIDAK ADA PROMO LAGI
      let orderAmount = getOrderAmount(currentOrderData);
      
      console.log(`üí∞ Harga order: Rp ${orderAmount.toLocaleString('id-ID')}`);
      console.log(`üìä Potongan saat ini: ${potonganPercentage}%`);
      console.log(`üí≥ Saldo driver: Rp ${currentDriverBalance.toLocaleString('id-ID')}`);
      
      const balanceCheck = checkBalanceForOrder(orderAmount);
      
      if (!balanceCheck.hasSufficientBalance) {
        // TAMPILKAN MODAL SALDO TIDAK CUKUP
        showBalanceModal(orderAmount, balanceCheck.requiredFee, balanceCheck.currentBalance);
        
        sendToKodular({
          action: 'balance_check_failed',
          order_id: currentOrderId,
          current_balance: currentDriverBalance,
          required_fee: balanceCheck.requiredFee,
          order_amount: orderAmount,
          fee_percentage: potonganPercentage,
          message: 'Saldo tidak cukup untuk memulai perjalanan'
        });
        
        return;
      }
      
      // Konfirmasi dengan modal HTML
      const confirmationMessage = `
‚úÖ KONFIRMASI MULAI PERJALANAN

üì¶ Order #${currentOrderId}
üí∞ Harga order: Rp ${orderAmount.toLocaleString('id-ID')}
üí∏ Potongan biaya (${potonganPercentage}%): Rp ${balanceCheck.requiredFee.toLocaleString('id-ID')}

üí≥ Saldo Anda:
  ‚Ä¢ Sebelum: Rp ${balanceCheck.currentBalance.toLocaleString('id-ID')}
  ‚Ä¢ Potongan: - Rp ${balanceCheck.requiredFee.toLocaleString('id-ID')}
  ‚Ä¢ Sesudah: Rp ${balanceCheck.remainingBalance.toLocaleString('id-ID')}

Apakah Anda yakin ingin memulai perjalanan?
Biaya akan langsung dipotong dari saldo Anda.
      `;
      
      const confirmation = confirm(confirmationMessage);
      
      if (!confirmation) {
        console.log('‚ùå Perjalanan dibatalkan oleh driver');
        showToast('Perjalanan dibatalkan', 'info');
        return;
      }
      
      console.log('üîÑ Update status order ke on_trip...');
      
      const orderRef = database.ref('orders/' + currentOrderId);
      try {
        await orderRef.update({
          status: 'on_trip',
          trip_started_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        });
        
        console.log('‚úÖ Status order updated to on_trip');
        
        // Proses pemotongan saldo
        if (currentDriverData && (currentDriverData.driverId || currentDriverData.uid)) {
          const driverId = currentDriverData.driverId || currentDriverData.uid;
          await deductOrderFee(currentOrderId, orderAmount, driverId);
        } else {
          console.error('‚ùå Driver ID tidak tersedia untuk pemotongan saldo');
          showToast('‚ùå Driver ID tidak ditemukan', 'error');
        }
        
        showToast(`Perjalanan dimulai! Potongan Rp ${balanceCheck.requiredFee.toLocaleString('id-ID')}`, 'success');
        
        sendToKodular({
          action: 'start_trip_success',
          order_id: currentOrderId,
          order_data: currentOrderData,
          order_amount: orderAmount,
          fee_percentage: potonganPercentage,
          fee_amount: balanceCheck.requiredFee,
          previous_balance: balanceCheck.currentBalance,
          new_balance: balanceCheck.remainingBalance,
          message: 'Perjalanan dimulai dan saldo berhasil dipotong'
        });
        
        setTimeout(() => {
          updateOrderStatus('on_trip');
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå Gagal update status order:', error);
        showToast('‚ùå Gagal memulai perjalanan. Silakan coba lagi.', 'error');
      }
    }

    // ==================== FUNGSI PEMOTONGAN SALDO ====================
    async function deductOrderFee(orderId, orderAmount, driverId) {
      const feeAmount = calculateFee(orderAmount);
      
      console.log(`üí∏ PROSES PEMOTONGAN SALDO:`);
      console.log(`  - Order ID: ${orderId}`);
      console.log(`  - Driver ID: ${driverId}`);
      console.log(`  - Jumlah potongan: Rp ${feeAmount.toLocaleString('id-ID')}`);
      
      const driverRef = database.ref('drivers/' + driverId);
      
      try {
        const snapshot = await driverRef.once('value');
        const currentData = snapshot.val();
        
        if (!currentData) {
          throw new Error('Data driver tidak ditemukan di Firebase');
        }
        
        const currentBalance = parseFloat(currentData.Balance) || 0;
        
        if (currentBalance < feeAmount) {
          throw new Error(`Saldo tidak cukup: ${currentBalance} < ${feeAmount}`);
        }
        
        const newBalance = currentBalance - feeAmount;
        
        // Update saldo
        await driverRef.update({
          Balance: newBalance,
          last_updated: new Date().toISOString()
        });
        
        // Update saldo lokal
        currentDriverBalance = newBalance;
        
        if (currentDriverData) {
          currentDriverData.Balance = currentDriverBalance;
          localStorage.setItem('jego_driver_data', JSON.stringify(currentDriverData));
        }
        
        updateDebugInfoUI();
        
        console.log(`‚úÖ Berhasil memotong saldo: Rp ${feeAmount.toLocaleString('id-ID')}`);
        console.log(`üí∞ Saldo baru: Rp ${currentDriverBalance.toLocaleString('id-ID')}`);
        
        sendToKodular({
          action: 'balance_deducted_success',
          order_id: orderId,
          fee_amount: feeAmount,
          order_amount: orderAmount,
          fee_percentage: potonganPercentage,
          new_balance: currentDriverBalance,
          message: `Potongan biaya layanan ${potonganPercentage}% berhasil`
        });
        
        showToast(`‚úÖ Potongan Rp ${feeAmount.toLocaleString('id-ID')} berhasil`, 'success');
        
      } catch (error) {
        console.error('‚ùå Error pemotongan saldo:', error);
        showToast('‚ùå Gagal memotong saldo: ' + error.message, 'error');
        
        sendToKodular({
          action: 'balance_deduction_failed',
          order_id: orderId,
          fee_amount: feeAmount,
          reason: error.message,
          message: 'Gagal memotong saldo'
        });
      }
    }

    // ==================== FUNGSI MODAL SALDO ====================
    function showBalanceModal(orderAmount, requiredFee, currentBalance) {
      const modal = document.getElementById('balanceModalOverlay');
      if (!modal) return;
      
      // Hitung kekurangan
      const kekurangan = requiredFee - currentBalance;
      const saldoSetelah = currentBalance - requiredFee;
      
      // Update konten modal
      document.getElementById('balanceOrderAmount').textContent = `Rp ${orderAmount.toLocaleString('id-ID')}`;
      document.getElementById('balancePotonganPercentage').textContent = `${potonganPercentage}%`;
      document.getElementById('balancePotonganAmount').textContent = `Rp ${requiredFee.toLocaleString('id-ID')}`;
      document.getElementById('balanceCurrentBalance').textContent = `Rp ${currentBalance.toLocaleString('id-ID')}`;
      document.getElementById('balanceKekurangan').textContent = `Rp ${kekurangan.toLocaleString('id-ID')}`;
      document.getElementById('balanceAfterDeduction').textContent = `Rp ${saldoSetelah.toLocaleString('id-ID')}`;
      
      // Tampilkan modal
      modal.style.display = 'flex';
    }

    function closeBalanceModal() {
      const modal = document.getElementById('balanceModalOverlay');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function topupBalance() {
      closeBalanceModal();
      showToast('Membuka halaman topup...', 'info');
      
      // Kirim ke Kodular untuk membuka halaman topup
      sendToKodular({
        action: 'open_topup',
        message: 'Driver perlu topup saldo'
      });
    }

    // ==================== FUNGSI UTAMA LAINNYA ====================
    // [Fungsi-fungsi lain seperti displayOrderData, updateOrderStatus, dll]
    // Tetap sama seperti sebelumnya, hanya diperbaiki bagian yang error
    
    // Contoh: Fungsi untuk menampilkan data order
    function displayOrderData(order) {
      // ... implementasi sama seperti sebelumnya ...
      // Pastikan untuk memanggil updateDebugInfoUI() untuk menampilkan saldo
      updateDebugInfoUI();
    }

    // ==================== INISIALISASI ====================
    window.onload = function() {
      console.log('üîÑ Halaman detail order driver dimuat...');
      
      initializeBalanceSystem();
      
      const driverData = JSON.parse(localStorage.getItem('jego_driver_data') || '{}');
      if (driverData && !currentDriverData) {
        currentDriverData = driverData;
      }
      
      // Cek apakah ada order ID dari URL atau localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const urlOrderId = urlParams.get('order_id');
      
      if (urlOrderId) {
        console.log('‚úÖ Order ID dari URL:', urlOrderId);
        currentOrderId = urlOrderId;
        startOrderListener(urlOrderId);
        
        sendToKodular({
          action: 'order_details_driver_ready',
          order_id: currentOrderId,
          message: 'Halaman detail order driver dibuka via URL'
        });
      } else {
        const acceptedOrder = getAcceptedOrderFromLocalStorage();
        if (acceptedOrder && acceptedOrder.order_id) {
          console.log('‚úÖ Order ID dari localStorage:', acceptedOrder.order_id);
          currentOrderId = acceptedOrder.order_id;
          startOrderListener(currentOrderId);
        } else {
          console.log('‚è≥ Menunggu data dari Kodular...');
          showError('Tidak ada data order yang diterima. Silakan buka order dari aplikasi utama.');
        }
      }
    };

    // Fungsi untuk menerima data dari Kodular
    window.receiveDataFromKodular = function(dataString) {
      try {
        const data = JSON.parse(dataString);
        console.log("Data diterima dari Kodular:", data);
        
        if (data.action === 'open_order_details_driver') {
          currentOrderId = data.order_id;
          
          sendToKodular({
            action: 'order_details_driver_ready',
            order_id: currentOrderId,
            message: 'Halaman detail order driver siap'
          });
          
          startOrderListener(currentOrderId);
        }
      } catch (error) {
        console.error("Error parsing data dari Kodular:", error);
        showError("Format data tidak valid");
      }
    };

    // Fungsi untuk memulai listener order
    function startOrderListener(orderId) {
      if (orderRef && orderListener) {
        orderRef.off('value', orderListener);
      }
      
      orderRef = database.ref('orders/' + orderId);
      
      orderListener = orderRef.on('value', (snapshot) => {
        const orderData = snapshot.val();
        
        if (orderData) {
          console.log('Data order diterima:', orderData);
          currentOrderData = orderData;
          
          displayOrderData(orderData);
          
          // Mulai kirim lokasi driver
          if (currentDriverData && (currentDriverData.driverId || currentDriverData.uid)) {
            setTimeout(() => {
              console.log('üìç Mulai mengirim lokasi driver otomatis...');
              startSendingDriverLocation(orderId);
            }, 2000);
          }
        } else {
          showError('Order tidak ditemukan di database');
        }
      }, (error) => {
        console.error('Error listening to order:', error);
        showError('Gagal memuat data order');
      });
    }

    // Fungsi helper
    function getAcceptedOrderFromLocalStorage() {
      try {
        const acceptedOrder = localStorage.getItem('jego_driver_accepted_order');
        return acceptedOrder ? JSON.parse(acceptedOrder) : null;
      } catch (error) {
        console.error('‚ùå Gagal mengambil order yang diterima dari localStorage:', error);
        return null;
      }
    }

    function showToast(message, type = 'info') {
      // Implementasi toast notification
      console.log(`Toast (${type}): ${message}`);
      alert(`${type.toUpperCase()}: ${message}`); // Fallback sederhana
    }

    function showError(message) {
      console.error('Error:', message);
      // Implementasi tampilan error
      alert(`ERROR: ${message}`);
    }

    // Debug function
    window.debugOrderData = function() {
      console.log('üìä DEBUG INFO:');
      console.log('Current Order ID:', currentOrderId);
      console.log('Current Order Data:', currentOrderData);
      console.log('Current Driver Data:', currentDriverData);
      console.log('Driver Balance:', currentDriverBalance);
      console.log('Potongan Percentage:', potonganPercentage);
    };
  </script>
</body>
</html>
