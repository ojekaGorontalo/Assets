<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pilih Kendaraan - JeGo</title>

<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
header{background:#ff9800;color:#fff;padding:15px;text-align:center}
.container{padding:20px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;cursor:pointer;border:2px solid #eee}
.card:hover{border-color:#ff9800}
.btn{display:block;text-align:center;background:#ff9800;color:#fff;padding:12px;border-radius:8px;text-decoration:none}
.hidden{display:none}

/* LOADING */
.loading{
  position:fixed;
  inset:0;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  z-index:999;
}
.loading.hidden{
  display:none;
}
</style>
</head>

<body>

<div class="loading hidden" id="loading">Memproses...</div>

<header>
  <h2>Pilih Kendaraan</h2>
</header>

<div class="container hidden" id="loginRequired">
  <p>Silakan login terlebih dahulu</p>
  <a href="userLogin.html" class="btn">Login</a>
</div>

<div class="container hidden" id="mainContent">
  <div id="vehicleList"></div>
</div>

<script>
/* ===== ERUDA ===== */
(function(){
  var s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/eruda';
  document.body.appendChild(s);
  s.onload=function(){eruda.init();};
})();

/* ===== SESSION ===== */
const LS_USER_KEY = 'jego_user_session';
const LS_VEHICLE_DATA_KEY = 'jego_vehicle_data';
const loading = document.getElementById('loading');
const mainContent = document.getElementById('mainContent');
const loginRequired = document.getElementById('loginRequired');
const vehicleList = document.getElementById('vehicleList');

let userSession=null;
try{
  userSession = JSON.parse(localStorage.getItem(LS_USER_KEY));
}catch(e){}

if(!userSession || !userSession.uid){
  loginRequired.classList.remove('hidden');
}else{
  mainContent.classList.remove('hidden');
  loadVehicleData();
}

/* ===== FUNGSI UNTUK MENGAMBIL DATA KENDARAAN ===== */
async function loadVehicleData() {
  loading.classList.remove('hidden');
  
  try {
    // Cek apakah data kendaraan sudah ada di localStorage
    const cachedData = localStorage.getItem(LS_VEHICLE_DATA_KEY);
    
    if (cachedData) {
      // Gunakan data dari cache
      displayVehicles(JSON.parse(cachedData));
      loading.classList.add('hidden');
    }
    
    // Selalu ambil data terbaru dari Firebase
    const response = await fetch('https://game-balap-simpel-default-rtdb.firebaseio.com/tarif.json');
    
    if (!response.ok) {
      throw new Error('Gagal mengambil data kendaraan');
    }
    
    const vehicleData = await response.json();
    
    // Simpan data ke localStorage
    localStorage.setItem(LS_VEHICLE_DATA_KEY, JSON.stringify(vehicleData));
    
    // Tampilkan data kendaraan
    displayVehicles(vehicleData);
    
  } catch (error) {
    console.error('Error loading vehicle data:', error);
    
    // Jika ada error, coba gunakan data cache jika tersedia
    const cachedData = localStorage.getItem(LS_VEHICLE_DATA_KEY);
    if (cachedData) {
      displayVehicles(JSON.parse(cachedData));
    } else {
      vehicleList.innerHTML = '<p>Gagal memuat data kendaraan. Silakan coba lagi.</p>';
    }
  } finally {
    loading.classList.add('hidden');
  }
}

/* ===== FUNGSI UNTUK MENAMPILKAN KENDARAAN ===== */
function displayVehicles(vehicleData) {
  vehicleList.innerHTML = '';
  
  // Konversi object ke array untuk di-loop
  const vehicles = Object.keys(vehicleData).map(key => {
    return {
      id: key.toLowerCase().replace(/\s+/g, '_'),
      ...vehicleData[key]
    };
  });
  
  // Urutkan kendaraan sesuai urutan yang diinginkan
  const orderedVehicles = [];
  const order = ['motor', 'bentor', 'mobil', 'kurir_motor', 'kurir_bentor'];
  
  order.forEach(vehicleId => {
    const vehicle = vehicles.find(v => v.id === vehicleId);
    if (vehicle) {
      orderedVehicles.push(vehicle);
    }
  });
  
  // Tambahkan kendaraan lain yang mungkin tidak ada di list order
  vehicles.forEach(vehicle => {
    if (!order.includes(vehicle.id)) {
      orderedVehicles.push(vehicle);
    }
  });
  
  // Buat elemen card untuk setiap kendaraan
  orderedVehicles.forEach(vehicle => {
    const card = document.createElement('div');
    card.className = 'card';
    card.onclick = () => selectVehicle(vehicle);
    
    // Tentukan emoji berdasarkan jenis kendaraan
    let emoji = 'ðŸš—';
    if (vehicle.id.includes('motor')) emoji = 'ðŸ';
    if (vehicle.id.includes('bentor')) emoji = 'ðŸ›º';
    if (vehicle.id.includes('kurir')) emoji = 'ðŸ“¦';
    
    card.innerHTML = `${emoji} ${vehicle.Nama}`;
    vehicleList.appendChild(card);
  });
}

/* ===== FUNGSI UNTUK MEMILIH KENDARAAN ===== */
function selectVehicle(vehicle) {
  loading.classList.remove('hidden');
  
  const selected = {
    id: vehicle.id,
    name: vehicle.Nama,
    type: vehicle.id,
    capacity: vehicle.Capacity,
    description: vehicle.Deskripsi,
    icon: vehicle.Icon,
    minimalDistance: vehicle.MinimalDistance,
    minimalPrice: vehicle.MinimalPrice,
    pricePerKm: vehicle.PricePerKm,
    userId: userSession.uid,
    time: new Date().toISOString()
  };
  
  // Simpan data kendaraan yang dipilih ke localStorage
  localStorage.setItem('jego_last_transport', JSON.stringify(selected));
  
  // Kirim data ke App Inventor jika ada
  if (window.AppInventor) {
    window.AppInventor.setWebViewString(JSON.stringify({
      action: 'vehicle_selected',
      data: selected
    }));
  }
  
  // Redirect ke halaman rute
  setTimeout(() => {
    location.href = 'rute.html';
  }, 500);
}
</script>

</body>
</html>
