<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Detail Order - Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary: #FF9800;    /* Orange */
      --secondary: #FF5722;   /* Red-Orange */
      --accent: #FFC107;     /* Amber/Yellow */
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #4CAF50;    /* Green */
      --danger: #f44336;     /* Red */
      --warning: #FFC107;    /* Yellow */
      --info: #2196F3;       /* Blue */
      --gray: #9E9E9E;       /* Gray */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--dark);
      height: 100vh;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    .container {
      width: 100%;
      max-width: 100%;
      background: white;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      margin-top: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      text-align: center;
      position: relative;
      flex-shrink: 0;
      z-index: 100;
    }

    .header h1 {
      display: none;
    }

    /* PERBAIKAN SCROLL: Konten utama bisa discroll */
    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      padding-bottom: 120px; /* Space untuk tombol aksi */
      -webkit-overflow-scrolling: touch; /* Smooth scroll di iOS */
      max-height: calc(100vh - 50vh - 60px); /* Batasi tinggi maksimum */
    }

    /* Map Section Styles - Full Width 100% */
    .map-section {
      width: 100%;
      height: 50vh;
      min-height: 300px; /* Minimum height untuk peta */
      flex-shrink: 0;
      position: relative;
      z-index: 1;
    }

    #orderMap {
      width: 100%;
      height: 100%;
      border: none;
    }

    .leaflet-control-zoom {
      border: 1px solid #ddd !important;
      border-radius: 4px !important;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
    }

    .status-section {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      text-align: center;
      background: white;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
    }

    .status-accepted {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-on_the_way {
      background: #cce7ff;
      color: #004085;
    }

    .status-arrived {
      background: #fff3cd;
      color: #856404;
    }

    .status-on_trip {
      background: #d4edda;
      color: #155724;
    }

    .status-completed {
      background: #e2e3e5;
      color: #383d41;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    .customer-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
    }

    .customer-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .customer-avatar:hover {
      transform: scale(1.05);
    }

    .customer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .customer-avatar.default-male {
      background-color: #cce7ff;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23006699"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
    }

    .customer-avatar.default-female {
      background-color: #f8d7da;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23943c57"><path d="M12 6c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0-2c-3.04 0-5.5 2.46-5.5 5.5S8.96 15 12 15s5.5-2.46-5.5-5.5S15.04 4 12 4zm0 16c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
    }

    .customer-avatar.default-unknown {
      background-color: #e2e3e5;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23555"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
    }

    .customer-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
      min-width: 0; /* PERBAIKAN: Agar text tidak overflow */
    }

    .customer-name {
      font-weight: 600;
      color: var(--primary);
      font-size: 1rem;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .customer-rating {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
      color: #666;
    }

    .stars {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .trip-count {
      font-size: 0.7rem;
      color: #888;
    }

    .route-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      background: white;
    }

    .section-title {
      font-size: 0.9rem;
      color: var(--primary);
      margin-bottom: 10px;
      font-weight: 600;
      text-align: center;
    }

    .route-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .route-point {
      display: flex;
      gap: 10px;
    }

    .route-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 10px;
      font-weight: bold;
      color: white;
    }

    .pickup-icon {
      background: var(--success);
    }

    .destination-icon {
      background: var(--primary);
    }

    .route-text {
      flex: 1;
      min-width: 0; /* PERBAIKAN: Agar text tidak overflow */
      cursor: pointer;
      position: relative;
    }

    .route-text:hover .copy-indicator {
      opacity: 1;
    }

    .route-label {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .copy-indicator {
      font-size: 0.65rem;
      color: var(--primary);
      opacity: 0.7;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .copy-indicator i {
      font-size: 0.7rem;
    }

    .route-address {
      font-weight: 500;
      color: var(--dark);
      font-size: 0.8rem;
      line-height: 1.3;
      word-break: break-word; /* PERBAIKAN: Teks alamat bisa turun baris */
      overflow-wrap: break-word;
      white-space: normal;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid #ddd;
      transition: all 0.3s;
    }

    .route-address:hover {
      background: #e9ecef;
      border-left-color: var(--primary);
    }

    .info-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      background: white;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      text-align: center;
    }

    .info-label {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 3px;
    }

    .info-value {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.75rem;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .price-highlight {
      color: var(--success);
      font-weight: 700;
      font-size: 0.8rem;
    }

    /* ==================== PROMO SECTION STYLES ==================== */
    .promo-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: none;
      background: white;
    }

    .promo-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: linear-gradient(135deg, #ffd700, #ff9800);
      color: #333;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .promo-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .promo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }

    .promo-label {
      color: #666;
      font-weight: 500;
    }

    .promo-value {
      font-weight: 600;
      color: var(--dark);
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .original-price {
      text-decoration: line-through;
      color: #999;
      font-size: 0.75rem;
    }

    .discount-badge {
      background: var(--success);
      color: white;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-left: 6px;
    }

    .final-price {
      color: var(--success);
      font-weight: 700;
      font-size: 0.85rem;
    }

    /* ==================== END PROMO SECTION ==================== */

    .delivery-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: none;
      background: white;
    }

    .delivery-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .delivery-item {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    .delivery-label {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 3px;
    }

    .delivery-value {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.75rem;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }

    .delivery-item-full {
      grid-column: 1 / span 2;
    }

    /* Actions Section - Fixed at Bottom */
    .actions-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: white;
      border-top: 1px solid #eee;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .action-btn {
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .on_the_way-btn {
      background: linear-gradient(to right, var(--success), #20c997);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .arrived-btn {
      background: linear-gradient(to right, #ffc107, #fd7e14);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

    .antar-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 15px rgba(40, 150, 114, 0.3);
    }

    .complete-btn {
      background: linear-gradient(to right, #28a745, #20c997);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .contact-btn {
      background: linear-gradient(to right, #25D366, #128C7E);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }

    .cancel-btn {
      background: linear-gradient(to right, var(--danger), #e74c3c);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .action-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px;
      text-align: center;
      flex: 1;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(40, 150, 114, 0.2);
      border-radius: 50%;
      border-top-color: var(--secondary);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .error-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px;
      text-align: center;
      color: var(--danger);
      flex: 1;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .retry-btn {
      margin-top: 20px;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    /* ==================== STYLE POPUP MODAL ==================== */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 4000;
      padding: 20px;
    }

    .popup-container {
      background: white;
      border-radius: 15px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
    }

    .popup-header {
      padding: 15px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .popup-title {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .close-popup {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }

    .popup-body {
      padding: 20px;
      text-align: center;
    }

    .popup-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .popup-message {
      font-size: 1rem;
      color: #333;
      line-height: 1.5;
      margin-bottom: 20px;
      word-break: break-word;
    }

    .popup-balance-details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: left;
    }

    .balance-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .balance-label {
      color: #666;
      font-weight: 500;
    }

    .balance-value {
      color: var(--dark);
      font-weight: 600;
    }

    .balance-insufficient {
      color: var(--danger);
    }

    .balance-sufficient {
      color: var(--success);
    }

    .popup-footer {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .popup-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .popup-btn-primary {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }

    .popup-btn-secondary {
      background: #f8f9fa;
      color: #666;
      border: 1px solid #ddd;
    }

    .popup-btn-danger {
      background: linear-gradient(to right, var(--danger), #e74c3c);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .popup-btn-success {
      background: linear-gradient(to right, var(--success), #20c997);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .popup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .popup-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Animation for popup */
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .popup-shake {
      animation: shake 0.5s ease-in-out;
    }

    /* ... (CSS lainnya tetap sama) ... */
  </style>
</head>
<body>
  <!-- ... (HTML sebelumnya tetap sama) ... -->

  <!-- ==================== POPUP MODAL ==================== -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup-container" id="popupContainer">
      <div class="popup-header">
        <div class="popup-title" id="popupTitle">Peringatan</div>
        <button class="close-popup" onclick="closePopup()">‚úï</button>
      </div>
      <div class="popup-body">
        <div class="popup-icon" id="popupIcon">‚ö†Ô∏è</div>
        <div class="popup-message" id="popupMessage"></div>
        <div class="popup-balance-details" id="popupBalanceDetails" style="display: none;">
          <div class="balance-item">
            <span class="balance-label">Saldo saat ini:</span>
            <span class="balance-value" id="currentBalance">Rp 0</span>
          </div>
          <div class="balance-item">
            <span class="balance-label">Biaya yang dibutuhkan:</span>
            <span class="balance-value balance-insufficient" id="requiredFee">Rp 0</span>
          </div>
          <div class="balance-item">
            <span class="balance-label">Saldo setelah transaksi:</span>
            <span class="balance-value" id="remainingBalance">Rp 0</span>
          </div>
        </div>
        <div class="popup-footer" id="popupFooter">
          <!-- Tombol akan diisi oleh JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- ... (HTML lainnya tetap sama) ... -->

  <script>
    // ... (kode Firebase dan variabel sebelumnya tetap sama) ...

    // ==================== VARIABEL SISTEM POPUP ====================
    let popupResolve = null;
    let popupReject = null;

    // ==================== FUNGSI POPUP DIPERBAIKI ====================
    function showPopup(options) {
      return new Promise((resolve, reject) => {
        // Simpan resolve dan reject untuk digunakan nanti
        popupResolve = resolve;
        popupReject = reject;
        
        // Set judul popup
        document.getElementById('popupTitle').textContent = options.title || 'Peringatan';
        
        // Set icon berdasarkan tipe
        const icon = document.getElementById('popupIcon');
        switch(options.type) {
          case 'success':
            icon.textContent = '‚úÖ';
            icon.style.color = '#28a745';
            break;
          case 'warning':
            icon.textContent = '‚ö†Ô∏è';
            icon.style.color = '#ffc107';
            break;
          case 'error':
            icon.textContent = '‚ùå';
            icon.style.color = '#dc3545';
            break;
          case 'info':
            icon.textContent = '‚ÑπÔ∏è';
            icon.style.color = '#17a2b8';
            break;
          default:
            icon.textContent = options.icon || '‚ö†Ô∏è';
        }
        
        // Set pesan
        document.getElementById('popupMessage').textContent = options.message || '';
        
        // Tampilkan atau sembunyikan detail saldo
        const balanceDetails = document.getElementById('popupBalanceDetails');
        if (options.showBalanceDetails && options.balanceData) {
          balanceDetails.style.display = 'block';
          const balanceData = options.balanceData;
          
          document.getElementById('currentBalance').textContent = 
            `Rp ${balanceData.currentBalance.toLocaleString('id-ID')}`;
          document.getElementById('requiredFee').textContent = 
            `Rp ${balanceData.requiredFee.toLocaleString('id-ID')}`;
          document.getElementById('remainingBalance').textContent = 
            `Rp ${balanceData.remainingBalance.toLocaleString('id-ID')}`;
          
          // Warna saldo setelah transaksi
          const remainingBalanceEl = document.getElementById('remainingBalance');
          if (balanceData.remainingBalance >= 0) {
            remainingBalanceEl.className = 'balance-value balance-sufficient';
          } else {
            remainingBalanceEl.className = 'balance-value balance-insufficient';
          }
        } else {
          balanceDetails.style.display = 'none';
        }
        
        // Setup tombol
        const popupFooter = document.getElementById('popupFooter');
        popupFooter.innerHTML = '';
        
        if (options.buttons && options.buttons.length > 0) {
          options.buttons.forEach((btn, index) => {
            const button = document.createElement('button');
            button.className = `popup-btn ${btn.class || 'popup-btn-primary'}`;
            button.textContent = btn.text;
            button.onclick = () => {
              closePopup();
              if (btn.onClick) btn.onClick();
              resolve(btn.value || btn.text);
            };
            popupFooter.appendChild(button);
          });
        } else {
          // Tombol default OK
          const okButton = document.createElement('button');
          okButton.className = 'popup-btn popup-btn-primary';
          okButton.textContent = 'OK';
          okButton.onclick = () => {
            closePopup();
            resolve('OK');
          };
          popupFooter.appendChild(okButton);
        }
        
        // Tampilkan popup dengan efek
        const popup = document.getElementById('popupOverlay');
        const container = document.getElementById('popupContainer');
        
        popup.style.display = 'flex';
        
        // Efek shake untuk popup error
        if (options.type === 'error') {
          container.classList.add('popup-shake');
          setTimeout(() => {
            container.classList.remove('popup-shake');
          }, 500);
        }
        
        // Close popup ketika klik di luar
        popup.onclick = function(event) {
          if (event.target === popup && !options.preventClose) {
            closePopup();
            resolve('CLOSE');
          }
        };
        
        // Close popup dengan ESC key
        const closeOnEsc = function(event) {
          if (event.key === 'Escape' && !options.preventClose) {
            closePopup();
            resolve('ESC');
            document.removeEventListener('keydown', closeOnEsc);
          }
        };
        document.addEventListener('keydown', closeOnEsc);
      });
    }

    function closePopup() {
      document.getElementById('popupOverlay').style.display = 'none';
      
      if (popupReject) {
        popupReject('Popup ditutup');
      }
      
      // Reset
      popupResolve = null;
      popupReject = null;
    }

    // ==================== FUNGSI PERHITUNGAN POTONGAN DIPERBAIKI ====================
    function calculateFee(orderAmount) {
      // Pastikan orderAmount adalah number
      const amount = typeof orderAmount === 'number' ? orderAmount : parseInt(orderAmount) || 0;
      console.log(`üí∞ Perhitungan potongan: ${amount} x ${potonganPercentage}%`);
      return Math.round(amount * (potonganPercentage / 100));
    }

    function checkBalanceForOrder(orderAmount) {
      const requiredFee = calculateFee(orderAmount);
      const hasSufficientBalance = currentDriverBalance >= requiredFee;
      
      console.log(`üí∞ Cek saldo: ${currentDriverBalance} >= ${requiredFee} = ${hasSufficientBalance}`);
      console.log(`üí∞ Saldo driver: ${currentDriverBalance}, Potongan: ${requiredFee}`);
      
      return {
        hasSufficientBalance: hasSufficientBalance,
        requiredFee: requiredFee,
        currentBalance: currentDriverBalance,
        remainingBalance: currentDriverBalance - requiredFee
      };
    }

    // ==================== FUNGSI TOMBOL AKSI DIPERBAIKI ====================
    async function startTrip() {
      if (!currentOrderData) return;
      
      console.log('üîÑ Memulai perjalanan dan memotong saldo...');
      
      // Ambil harga order yang benar (gunakan harga_final jika ada promo)
      let orderAmount = currentOrderData.harga_total;
      
      // Jika ada data promo, gunakan harga_final
      if (currentOrderData.promo_data || currentOrderData.harga_asal) {
        orderAmount = currentOrderData.harga_total; // Ini sudah harga setelah diskon
        console.log(`üí∞ Menggunakan harga setelah diskon: ${orderAmount}`);
      }
      
      // CEK SALDO SEBELUM MEMULAI PERJALANAN
      const balanceCheck = checkBalanceForOrder(orderAmount);
      
      if (!balanceCheck.hasSufficientBalance) {
        // Tampilkan popup detail saldo
        await showPopup({
          title: "Saldo Tidak Cukup",
          type: "error",
          message: "Saldo Anda tidak cukup untuk memulai perjalanan ini.",
          showBalanceDetails: true,
          balanceData: balanceCheck,
          buttons: [
            {
              text: "Tutup",
              class: "popup-btn-secondary",
              value: "close"
            },
            {
              text: "Lihat Saldo",
              class: "popup-btn-primary",
              value: "view_balance",
              onClick: () => {
                showPopup({
                  title: "Detail Saldo",
                  type: "info",
                  message: `Saldo Anda saat ini: Rp ${currentDriverBalance.toLocaleString('id-ID')}\nPotongan biaya layanan: ${potonganPercentage}%`,
                  buttons: [
                    { text: "OK", class: "popup-btn-primary" }
                  ]
                });
              }
            }
          ]
        });
        return;
      }
      
      // Konfirmasi sebelum mulai perjalanan
      const confirmation = await showPopup({
        title: "Mulai Perjalanan",
        type: "warning",
        message: `Apakah Anda yakin ingin memulai perjalanan?\n\nBiaya layanan ${potonganPercentage}% akan dipotong dari saldo Anda.`,
        showBalanceDetails: true,
        balanceData: balanceCheck,
        buttons: [
          {
            text: "Batal",
            class: "popup-btn-secondary",
            value: "cancel"
          },
          {
            text: "Ya, Mulai",
            class: "popup-btn-success",
            value: "confirm"
          }
        ]
      });
      
      if (confirmation !== 'confirm') {
        console.log('Perjalanan dibatalkan oleh driver');
        return;
      }
      
      // Update status order
      const orderRef = database.ref('orders/' + currentOrderId);
      try {
        await orderRef.update({
          status: 'on_trip',
          trip_started_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        });
        
        console.log('‚úÖ Status updated to on_trip');
        
        // POTONG SALDO SETELAH PERJALANAN DIMULAI
        if (currentDriverData && currentDriverData.driverId) {
          deductOrderFee(currentOrderId, orderAmount, currentDriverData.driverId);
        }
        
        // Tampilkan notifikasi sukses
        showPopup({
          title: "Perjalanan Dimulai",
          type: "success",
          message: "Perjalanan berhasil dimulai. Biaya layanan telah dipotong dari saldo Anda.",
          buttons: [
            { text: "OK", class: "popup-btn-success" }
          ]
        });
        
        sendToKodular({
          action: 'start_trip',
          order_id: currentOrderId,
          order_data: currentOrderData,
          order_amount: orderAmount,
          fee_percentage: potonganPercentage,
          fee_amount: balanceCheck.requiredFee,
          message: 'Perjalanan dimulai dan saldo dipotong'
        });
        
      } catch (error) {
        console.error('‚ùå Gagal update status:', error);
        showPopup({
          title: "Gagal Memulai",
          type: "error",
          message: "Gagal memulai perjalanan. Silakan coba lagi.",
          buttons: [
            { text: "OK", class: "popup-btn-primary" }
          ]
        });
      }
    }

    // ==================== FUNGSI SUBMIT RATING DIPERBAIKI ====================
    async function submitRating() {
      if (!selectedRating) {
        await showPopup({
          title: "Rating Belum Dipilih",
          type: "warning",
          message: "Silakan pilih rating terlebih dahulu sebelum mengirim.",
          buttons: [
            { text: "OK", class: "popup-btn-primary" }
          ]
        });
        return;
      }
      
      console.log('‚≠ê Mengirim rating untuk user:', userToRate.userId, 'Rating:', selectedRating);
      
      // Disable tombol saat proses
      const submitBtn = document.getElementById('submitRatingBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>‚è≥</span> Mengirim...';
      
      try {
        // 1. Update data user di Firebase (Perjalanan dan Ratings)
        await updateUserRatingInFirebase();
        
        // 2. Update order dengan rating di Firebase
        await updateOrderWithRating();
        
        // 3. Tutup modal rating
        document.getElementById('ratingOverlay').style.display = 'none';
        
        // 4. Tampilkan popup konfirmasi
        await showPopup({
          title: "Rating Terkirim",
          type: "success",
          message: `Terima kasih! Anda telah memberikan rating ${selectedRating} bintang kepada customer.`,
          buttons: [
            { 
              text: "Lanjutkan", 
              class: "popup-btn-success",
              onClick: () => {
                // 5. UPDATE STATISTIK DRIVER
                updateDriverStatistics(currentOrderData);
                
                // 6. Kirim ke Kodular DENGAN RATING
                sendRatingToKodular();
                
                // 7. Hapus localStorage
                localStorage.removeItem('jego_driver_accepted_order');
                
                // 8. Navigasi ke list orders
                sendToKodular({
                  action: 'navigate_to',
                  screen: 'list_orders',
                  order_id: currentOrderId,
                  message: 'Order selesai dengan rating'
                });
              }
            }
          ]
        });
        
      } catch (error) {
        console.error('‚ùå Error dalam submit rating:', error);
        await showPopup({
          title: "Gagal Mengirim Rating",
          type: "error",
          message: "Gagal mengirim rating. Silakan coba lagi.",
          buttons: [
            { text: "OK", class: "popup-btn-primary" }
          ]
        });
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    // ==================== FUNGSI CANCEL ORDER DIPERBAIKI ====================
    async function cancelOrder() {
      if (currentOrderData && (currentOrderData.status === 'completed' || currentOrderData.status === 'cancelled')) {
        return;
      }
      
      // Konfirmasi pembatalan
      const confirmation = await showPopup({
        title: "Batalkan Order",
        type: "warning",
        message: "Apakah Anda yakin ingin membatalkan order ini?",
        buttons: [
          {
            text: "Tidak",
            class: "popup-btn-secondary",
            value: "no"
          },
          {
            text: "Ya, Batalkan",
            class: "popup-btn-danger",
            value: "yes"
          }
        ]
      });
      
      if (confirmation !== 'yes') {
        return;
      }
      
      // Hentikan pengiriman lokasi
      stopSendingDriverLocation();
      
      const orderRef = database.ref('orders/' + currentOrderId);
      try {
        await orderRef.update({
          status: 'cancelled',
          cancelled_at: new Date().toISOString(),
          updated_at: new Date().toISOString(),
          cancelled_by: 'driver'
        });
        
        console.log('‚úÖ Order cancelled by driver');
        
        // Tampilkan notifikasi sukses
        await showPopup({
          title: "Order Dibatalkan",
          type: "info",
          message: "Order berhasil dibatalkan.",
          buttons: [
            {
              text: "OK",
              class: "popup-btn-primary",
              onClick: () => {
                localStorage.removeItem('jego_driver_accepted_order');
                
                sendToKodular({
                  action: 'cancel_order',
                  order_id: currentOrderId,
                  order_data: currentOrderData
                });
                
                // Kirim sinyal untuk navigasi ke Kodular
                sendToKodular({
                  action: 'navigate_to',
                  screen: 'list_orders',
                  order_id: currentOrderId,
                  message: 'Order dibatalkan, kembali ke list order'
                });
              }
            }
          ]
        });
        
      } catch (error) {
        console.error('‚ùå Gagal membatalkan order:', error);
        await showPopup({
          title: "Gagal Membatalkan",
          type: "error",
          message: "Gagal membatalkan order. Silakan coba lagi.",
          buttons: [
            { text: "OK", class: "popup-btn-primary" }
          ]
        });
      }
    }

    // ==================== FUNGSI DEDUCT ORDER FEE DIPERBAIKI ====================
    function deductOrderFee(orderId, orderAmount, driverId) {
      const feeAmount = calculateFee(orderAmount);
      
      console.log(`üí∞ Memotong saldo: Rp ${feeAmount.toLocaleString('id-ID')} dari order ${orderId}`);
      
      const driverRef = database.ref('drivers/' + driverId);
      
      // Gunakan transaction untuk menghindari race condition
      driverRef.transaction((currentData) => {
        if (currentData) {
          console.log(`üí∞ Saldo sebelum: ${currentData.Balance}, Potongan: ${feeAmount}`);
          
          if (currentData.Balance < feeAmount) {
            console.error('‚ùå Saldo tidak cukup untuk potongan');
            // Kirim notifikasi ke Kodular
            sendToKodular({
              action: 'balance_insufficient',
              order_id: orderId,
              current_balance: currentData.Balance,
              required_fee: feeAmount,
              message: 'Saldo tidak cukup untuk potongan biaya layanan'
            });
            return; // Batalkan transaction
          }
          
          currentData.Balance -= feeAmount;
          console.log(`üí∞ Saldo setelah: ${currentData.Balance}`);
          
          // Catat di riwayat transaksi jika ada field history
          const transactionId = 'tx_' + Date.now();
          if (!currentData.balance_history) {
            currentData.balance_history = {};
          }
          currentData.balance_history[transactionId] = {
            type: 'order_fee',
            order_id: orderId,
            amount: -feeAmount,
            order_amount: orderAmount,
            fee_percentage: potonganPercentage,
            description: `Biaya layanan order #${orderId}`,
            timestamp: new Date().toISOString()
          };
        }
        return currentData;
      }).then((result) => {
        if (result.committed) {
          console.log(`‚úÖ Berhasil memotong saldo: Rp ${feeAmount.toLocaleString('id-ID')}`);
          
          // Update currentDriverBalance
          currentDriverBalance = result.snapshot.val().Balance;
          
          sendToKodular({
            action: 'balance_deducted',
            order_id: orderId,
            fee_amount: feeAmount,
            order_amount: orderAmount,
            fee_percentage: potonganPercentage,
            new_balance: currentDriverBalance,
            message: `Potongan biaya layanan ${potonganPercentage}% untuk order #${orderId}`
          });
          
          // Tampilkan toast
          showToast(`Biaya layanan Rp ${feeAmount.toLocaleString('id-ID')} dipotong`, 'success');
          
        } else {
          console.error('‚ùå Transaksi pemotongan saldo dibatalkan');
          showPopup({
            title: "Gagal Memotong Saldo",
            type: "error",
            message: "Gagal memotong biaya layanan. Silakan coba lagi.",
            buttons: [
              { text: "OK", class: "popup-btn-primary" }
            ]
          });
        }
      }).catch((error) => {
        console.error('‚ùå Gagal memotong saldo:', error);
        showPopup({
          title: "Error Sistem",
          type: "error",
          message: "Terjadi kesalahan saat memotong saldo.",
          buttons: [
            { text: "OK", class: "popup-btn-primary" }
          ]
        });
      });
    }

    // ==================== FUNGSI INITIALIZE BALANCE SYSTEM DIPERBAIKI ====================
    function initializeBalanceSystem() {
      // Ambil data driver dari localStorage
      const driverDataStr = localStorage.getItem('jego_driver_data');
      if (!driverDataStr) {
        console.log('‚ùå Tidak ada data driver di localStorage');
        showPopup({
          title: "Data Driver Tidak Ditemukan",
          type: "error",
          message: "Data driver tidak ditemukan. Silakan login ulang.",
          buttons: [
            { 
              text: "OK", 
              class: "popup-btn-primary",
              onClick: () => {
                sendToKodular({
                  action: 'navigate_to',
                  screen: 'login',
                  message: 'Kembali ke login'
                });
              }
            }
          ]
        });
        return;
      }

      try {
        currentDriverData = JSON.parse(driverDataStr);
        console.log('‚úÖ Data driver ditemukan:', currentDriverData);

        if (!currentDriverData.driverId) {
          console.log('‚ùå Driver ID tidak ditemukan');
          return;
        }

        const driverId = currentDriverData.driverId;
        const balanceRef = database.ref('drivers/' + driverId + '/Balance');

        // Setup real-time listener untuk saldo
        balanceListener = balanceRef.on('value', (snapshot) => {
          const newBalance = snapshot.val() || 0;
          currentDriverBalance = newBalance;
          
          console.log(`üí∞ Saldo diperbarui: Rp ${newBalance.toLocaleString('id-ID')}`);
          
          // Update di localStorage
          if (currentDriverData) {
            currentDriverData.balance = newBalance;
            localStorage.setItem('jego_driver_data', JSON.stringify(currentDriverData));
          }
        }, (error) => {
          console.error('‚ùå Error listening to balance:', error);
        });

        // Ambil nilai potongan dari Firebase
        const potonganRef = database.ref('drivers/' + driverId + '/Potongan');
        potonganRef.once('value').then((snapshot) => {
          const potonganValue = snapshot.val();
          if (potonganValue !== null && potonganValue !== undefined) {
            potonganPercentage = potonganValue;
            console.log(`üí∞ Potongan dari Firebase: ${potonganPercentage}%`);
          } else {
            console.log(`üí∞ Potongan default: ${potonganPercentage}%`);
          }
        }).catch((error) => {
          console.error('‚ùå Error mengambil data potongan:', error);
        });

      } catch (error) {
        console.error('‚ùå Error parsing driver data:', error);
        showPopup({
          title: "Data Tidak Valid",
          type: "error",
          message: "Data driver tidak valid. Silakan login ulang.",
          buttons: [
            { text: "OK", class: "popup-btn-primary" }
          ]
        });
      }
    }

    // ... (kode JavaScript lainnya tetap sama) ...
  </script>
</body>
</html>
