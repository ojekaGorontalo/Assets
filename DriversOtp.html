<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Driver OTP</title>
<style>
    body { font-family: Arial; padding: 20px; }
    input { padding: 8px; width: 320px; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; font-size: 14px; }
    th { background: #f2f2f2; }
    .loading { text-align: center; color: #666; padding: 20px; }
    .error { text-align: center; color: red; padding: 20px; }
    .expired { background-color: #ffebee; }
    .active { background-color: #e8f5e8; }
</style>
</head>
<body>

<h3>Data OTP Driver</h3>
<input id="searchInput" placeholder="Cari Driver ID atau OTP...">

<table>
<thead>
<tr>
    <th>Driver ID</th>
    <th>OTP</th>
    <th>Dibuat Pada</th>
    <th>Kadaluarsa</th>
    <th>Status</th>
    <th>Sisa Waktu</th>
</tr>
</thead>
<tbody id="otpTable">
    <tr><td colspan="6" class="loading">Memuat data OTP...</td></tr>
</tbody>
</table>

<script>
// URL Firebase untuk OTP
const otpUrl = "https://ojeka-ba255-default-rtdb.firebaseio.com/driverOTP.json";

// Function untuk memuat dan menampilkan data OTP
async function loadOTP() {
    try {
        const response = await fetch(otpUrl);
        const data = await response.json();
        
        const tbody = document.getElementById("otpTable");
        
        if (!data) {
            tbody.innerHTML = '<tr><td colspan="6" class="loading">Tidak ada data OTP</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        
        // Convert object ke array dan tambahkan key sebagai driver_id
        const otpArray = Object.entries(data).map(([driverId, otpData]) => {
            return {
                driver_id: driverId,
                ...otpData
            };
        });
        
        if (otpArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="loading">Tidak ada data OTP</td></tr>';
            return;
        }
        
        // Urutkan berdasarkan createdAt (terbaru pertama)
        otpArray.sort((a, b) => b.createdAt - a.createdAt);
        
        otpArray.forEach(otp => {
            const row = document.createElement("tr");
            
            // Format tanggal
            const createdDate = new Date(otp.createdAt);
            const expiryDate = new Date(otp.otpExpiry);
            const now = new Date();
            
            const formattedCreated = createdDate.toLocaleString('id-ID');
            const formattedExpiry = expiryDate.toLocaleString('id-ID');
            
            // Hitung sisa waktu
            const timeLeft = expiryDate - now;
            const minutesLeft = Math.max(0, Math.floor(timeLeft / (1000 * 60)));
            
            // Tentukan status
            let status = "Aktif";
            let statusClass = "active";
            if (timeLeft <= 0) {
                status = "Kadaluarsa";
                statusClass = "expired";
            } else if (minutesLeft < 5) {
                status = "Hampir Kadaluarsa";
                statusClass = "expired";
            }
            
            row.className = statusClass;
            row.innerHTML = `
                <td>${otp.driver_id || "-"}</td>
                <td><strong>${otp.otp || "-"}</strong></td>
                <td>${formattedCreated}</td>
                <td>${formattedExpiry}</td>
                <td>${status}</td>
                <td>${minutesLeft} menit</td>
            `;
            tbody.appendChild(row);
        });
        
        setupSearch();
        console.log(`Data OTP loaded: ${otpArray.length} records`);
        
    } catch (error) {
        console.error("Error loading OTP data:", error);
        document.getElementById("otpTable").innerHTML = 
            '<tr><td colspan="6" class="error">Gagal memuat data OTP: ' + error.message + '</td></tr>';
    }
}

// Function untuk setup pencarian
function setupSearch() {
    const searchInput = document.getElementById("searchInput");
    const tbody = document.getElementById("otpTable");
    
    searchInput.addEventListener("keyup", function() {
        const value = this.value.toLowerCase();
        const rows = tbody.getElementsByTagName("tr");
        
        for (let i = 0; i < rows.length; i++) {
            let rowText = rows[i].textContent || rows[i].innerText;
            rows[i].style.display = rowText.toLowerCase().includes(value) ? "" : "none";
        }
    });
}

// Auto-refresh setiap 10 detik
function startAutoRefresh() {
    setInterval(loadOTP, 10000);
}

// Load data pertama kali
loadOTP();

// Mulai auto-refresh
startAutoRefresh();
</script>

</body>
</html>
