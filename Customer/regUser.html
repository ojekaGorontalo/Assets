<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JeGo - Registrasi</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0}
.container{max-width:500px;margin:40px auto;background:#fff;padding:20px;border-radius:8px}
h2{text-align:center}
input,select,textarea,button{width:100%;padding:10px;margin-top:10px}
button{background:#ff9800;border:none;color:#fff;font-weight:bold;cursor:pointer}
button.secondary{background:#607d8b}
button:disabled{background:#ccc;cursor:not-allowed}
.hidden{display:none}
.loading{opacity:.7}
.note{color:#d32f2f;font-size:14px;margin-top:10px}
</style>
</head>

<body>

<div class="container" id="step1">
<h2>Daftar Akun JeGo</h2>

<input id="nama" placeholder="Nama Lengkap">
<input id="email" placeholder="Email">
<input id="telepon" placeholder="+628xxxxxxxxxx">
<textarea id="alamat" placeholder="Alamat"></textarea>

<select id="gender">
<option value="">Pilih Gender</option>
<option>Laki-laki</option>
<option>Perempuan</option>
</select>

<div id="recaptcha-container"></div>

<button id="btnNext">Kirim OTP</button>
<button class="secondary" onclick="goLogin()">Sudah punya akun? Login</button>

<p id="infoText" class="note hidden"></p>
</div>

<div class="container hidden" id="step2">
<h2>Verifikasi OTP</h2>
<p id="phoneView"></p>
<input id="otpInput" maxlength="6" inputmode="numeric" placeholder="Masukkan 6 digit OTP">
<button id="btnVerify">Verifikasi</button>
</div>

<div class="container hidden" id="step3">
<h2>ðŸŽ‰ Registrasi Berhasil</h2>
<p>Mengalihkan ke halaman utamaâ€¦</p>
</div>

<script>
/* ===== CONFIG ===== */
const LS_USER_KEY = 'jego_user_session';

firebase.initializeApp({
 apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
 authDomain: "game-balap-simpel.firebaseapp.com",
 databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
 projectId: "game-balap-simpel"
});

const auth = firebase.auth();
const db = firebase.database();

/* ===== DOM ===== */
const namaInput = document.getElementById('nama');
const emailInput = document.getElementById('email');
const teleponInput = document.getElementById('telepon');
const alamatInput = document.getElementById('alamat');
const genderInput = document.getElementById('gender');
const otpInput = document.getElementById('otpInput');

const btnNext = document.getElementById('btnNext');
const btnVerify = document.getElementById('btnVerify');
const phoneView = document.getElementById('phoneView');
const infoText = document.getElementById('infoText');

/* ===== STATE ===== */
let regData = null;
let confirmationResult = null;

/* ===== UTILS ===== */
function formatPhone(p){
 p=p.replace(/\D/g,'');
 if(p.startsWith('0')) return '+62'+p.slice(1);
 if(p.startsWith('62')) return '+'+p;
 return '+62'+p;
}

function setLoading(btn, status, text){
 btn.disabled = status;
 btn.textContent = status ? text : btn.dataset.text;
}

function saveSession(user){
 localStorage.setItem(LS_USER_KEY, JSON.stringify(user));
}

function goLogin(){
 window.location.href = 'userLogin.html';
}

/* ===== AUTO LOGIN CHECK ===== */
if(localStorage.getItem(LS_USER_KEY)){
 location.href = 'transportasi.html';
}

/* ===== RECAPTCHA ===== */
const recaptcha = new firebase.auth.RecaptchaVerifier(
 'recaptcha-container',
 { size:'normal' }
);
recaptcha.render();

/* ===== CHECK PHONE EXIST ===== */
async function isPhoneRegistered(phone){
 const snap = await db.ref('users')
  .orderByChild('phone')
  .equalTo(phone)
  .once('value');
 return snap.exists();
}

/* ===== STEP 1 : SEND OTP ===== */
btnNext.dataset.text = btnNext.textContent;
btnNext.onclick = async ()=>{
 infoText.classList.add('hidden');

 const nama = namaInput.value.trim();
 const email = emailInput.value.trim();
 const phone = formatPhone(teleponInput.value.trim());
 const alamat = alamatInput.value.trim();
 const gender = genderInput.value;

 if(!nama || !phone || !alamat || !gender){
  alert('Lengkapi data');
  return;
 }

 regData = { nama, email, phone, alamat, gender };

 try{
  setLoading(btnNext,true,'Cek nomor...');
  
  const exists = await isPhoneRegistered(phone);
  if(exists){
   infoText.textContent = 'Nomor sudah terdaftar. Silakan login.';
   infoText.classList.remove('hidden');
   setLoading(btnNext,false);
   return;
  }

  setLoading(btnNext,true,'Mengirim OTP...');
  confirmationResult = await auth.signInWithPhoneNumber(phone, recaptcha);
  phoneView.textContent = phone;

  step1.classList.add('hidden');
  step2.classList.remove('hidden');

 }catch(e){
  alert(e.message);
 }finally{
  setLoading(btnNext,false);
 }
};

/* ===== STEP 2 : VERIFY OTP ===== */
btnVerify.dataset.text = btnVerify.textContent;
btnVerify.onclick = async ()=>{
 const code = otpInput.value.trim();
 if(code.length !== 6){
  alert('OTP harus 6 digit');
  return;
 }

 try{
  setLoading(btnVerify,true,'Memverifikasi...');
  const cred = await confirmationResult.confirm(code);
  const uid = cred.user.uid;

  const user = {
   uid,
   name: regData.nama,
   email: regData.email || "",
   phone: regData.phone,
   alamat: regData.alamat,
   gender: regData.gender,

   profilUrl: "",
   perjalanan: 0,
   rating: 5,
   status: "active",

   role: "penumpang",
   createdAt: new Date().toISOString()
  };

  await db.ref('users/' + uid).set(user);
  saveSession(user);

  step2.classList.add('hidden');
  step3.classList.remove('hidden');

  setTimeout(()=>{
   location.href = 'jenis_kenderaan.html';
  },3000);

 }catch(err){
  alert('OTP gagal: ' + err.message);
 }finally{
  setLoading(btnVerify,false);
 }
};
</script>

</body>
</html>