<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Detail Order - Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    /* CSS yang sama seperti sebelumnya */
    :root {
      --primary: #1e6f5c;
      --secondary: #289672;
      --accent: #e6dd3b;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--dark);
      height: 100vh;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      margin-top: 0;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 20px);
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      text-align: center;
      position: relative;
      flex-shrink: 0;
    }

    .header h1 {
      display: none;
    }

    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .status-section {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
    }

    .status-accepted {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-on_the_way {
      background: #cce7ff;
      color: #004085;
    }

    .status-arrived {
      background: #fff3cd;
      color: #856404;
    }

    .status-on_trip {
      background: #d4edda;
      color: #155724;
    }

    .status-completed {
      background: #e2e3e5;
      color: #383d41;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    .customer-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .customer-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      flex-shrink: 0;
    }

    .customer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .customer-avatar.default-male {
      background-color: #cce7ff;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23006699"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
    }

    .customer-avatar.default-female {
      background-color: #f8d7da;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23943c57"><path d="M12 6c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0-2c-3.04 0-5.5 2.46-5.5 5.5S8.96 15 12 15s5.5-2.46-5.5-5.5S15.04 4 12 4zm0 16c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
    }

    .customer-avatar.default-unknown {
      background-color: #e2e3e5;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23555"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
    }

    .customer-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
      flex: 1;
    }

    .customer-name {
      font-weight: 600;
      color: var(--primary);
      font-size: 1rem;
    }

    .customer-rating {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
      color: #666;
    }

    .stars {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .trip-count {
      font-size: 0.7rem;
      color: #888;
    }

    .route-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .section-title {
      font-size: 0.9rem;
      color: var(--primary);
      margin-bottom: 10px;
      font-weight: 600;
      text-align: center;
    }

    .route-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .route-point {
      display: flex;
      gap: 10px;
    }

    .route-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 10px;
      font-weight: bold;
      color: white;
    }

    .pickup-icon {
      background: var(--success);
    }

    .destination-icon {
      background: var(--primary);
    }

    .route-text {
      flex: 1;
    }

    .route-label {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 3px;
    }

    .route-address {
      font-weight: 500;
      color: var(--dark);
      font-size: 0.8rem;
      line-height: 1.3;
    }

    .info-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      text-align: center;
    }

    .info-label {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 3px;
    }

    .info-value {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.75rem;
    }

    .price-highlight {
      color: var(--success);
      font-weight: 700;
      font-size: 0.8rem;
    }

    .delivery-section {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: none;
    }

    .delivery-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .delivery-item {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    .delivery-label {
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 3px;
    }

    .delivery-value {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.75rem;
      word-break: break-word;
    }

    .delivery-item-full {
      grid-column: 1 / span 2;
    }

    .actions-section {
      padding: 12px 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }

    .action-btn {
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .on_the_way-btn {
      background: linear-gradient(to right, var(--success), #20c997);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .arrived-btn {
      background: linear-gradient(to right, #ffc107, #fd7e14);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

    .antar-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 15px rgba(40, 150, 114, 0.3);
    }

    .complete-btn {
      background: linear-gradient(to right, #28a745, #20c997);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .contact-btn {
      background: linear-gradient(to right, #25D366, #128C7E);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }

    .cancel-btn {
      background: linear-gradient(to right, var(--danger), #e74c3c);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .action-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px;
      text-align: center;
      flex: 1;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(40, 150, 114, 0.2);
      border-radius: 50%;
      border-top-color: var(--secondary);
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .error-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px;
      text-align: center;
      color: var(--danger);
      flex: 1;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .retry-btn {
      margin-top: 20px;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ==================== STYLE CHAT INTEGRASI ==================== */
    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .chat-container {
      width: 90%;
      max-width: 500px;
      height: 80%;
      background: white;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid white;
    }

    .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-name {
      font-weight: 600;
      font-size: 16px;
    }

    .chat-status {
      font-size: 12px;
      opacity: 0.8;
    }

    .close-chat {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #ECE5DD;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message-bubble {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      position: relative;
    }

    .message-left {
      align-self: flex-start;
      background: white;
      border-bottom-left-radius: 5px;
    }

    .message-right {
      align-self: flex-end;
      background: #DCF8C6;
      border-bottom-right-radius: 5px;
    }

    .message-time {
      font-size: 11px;
      color: #888;
      margin-top: 5px;
      text-align: right;
    }

    .chat-input-area {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #ddd;
    }

    .chat-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
    }

    .chat-send-btn {
      margin-left: 10px;
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
    }

    .chat-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #25D366;
      color: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1001;
      max-width: 300px;
      cursor: pointer;
      display: none;
    }

    .chat-notification strong {
      display: block;
      margin-bottom: 5px;
    }

    .chat-notification p {
      margin: 0;
      font-size: 14px;
    }

    .chat-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      
      .container {
        border-radius: 15px;
        height: calc(100vh - 10px);
      }
      
      .status-section, .customer-section, .route-section, .info-section, .delivery-section, .actions-section {
        padding: 10px 12px;
      }
      
      .info-grid {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
      }
      
      .delivery-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      
      .header {
        padding: 12px;
      }
      
      .customer-avatar {
        width: 45px;
        height: 45px;
      }
      
      .info-label, .delivery-label {
        font-size: 0.65rem;
      }
      
      .info-value, .delivery-value {
        font-size: 0.7rem;
      }
      
      .route-address {
        font-size: 0.75rem;
      }

      .chat-container {
        width: 95%;
        height: 85%;
      }

      .chat-notification {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Detail Order</h1>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Memuat data order...</p>
    </div>

    <div id="error" class="error-message" style="display: none;">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Data Tidak Tersedia</h3>
      <p id="errorMessage">Data order tidak ditemukan. Silakan coba lagi.</p>
      <button class="retry-btn" onclick="goBack()">Kembali</button>
    </div>

    <div id="content" style="display: none;">
      <div class="content-wrapper">
        <div class="status-section">
          <div class="status-badge" id="statusBadge">-</div>
        </div>

        <div class="customer-section">
          <div class="customer-avatar" id="customerAvatar">
            <!-- Avatar akan diisi oleh JavaScript -->
          </div>
          <div class="customer-info">
            <div class="customer-name" id="customerName">-</div>
            <div class="customer-rating">
              <div class="stars">üåü 4.8</div>
              <div class="trip-count" id="tripCount">(8)</div>
            </div>
          </div>
        </div>

        <div class="route-section">
          <div class="section-title">Rute Perjalanan</div>
          <div class="route-details">
            <div class="route-point">
              <div class="route-icon pickup-icon">A</div>
              <div class="route-text">
                <div class="route-label">Penjemputan</div>
                <div class="route-address" id="pickupAddress">-</div>
              </div>
            </div>
            <div class="route-point">
              <div class="route-icon destination-icon">B</div>
              <div class="route-text">
                <div class="route-label">Tujuan</div>
                <div class="route-address" id="destinationAddress">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <div class="section-title">Detail Order</div>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Layanan</div>
              <div class="info-value" id="serviceType">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Kapasitas</div>
              <div class="info-value" id="serviceCapacity">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Durasi</div>
              <div class="info-value" id="tripDuration">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Jarak</div>
              <div class="info-value" id="tripDistance">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Biaya</div>
              <div class="info-value"><span class="price-highlight" id="tripPrice">-</span></div>
            </div>
            <div class="info-item">
              <div class="info-label">Waktu</div>
              <div class="info-value" id="orderTime">-</div>
            </div>
          </div>
        </div>

        <div class="delivery-section" id="deliverySection">
          <div class="section-title">Informasi Pengiriman</div>
          <div class="delivery-grid">
            <div class="delivery-item">
              <div class="delivery-label">Telp Pengirim</div>
              <div class="delivery-value" id="senderPhone">-</div>
            </div>
            <div class="delivery-item">
              <div class="delivery-label">Telp Penerima</div>
              <div class="delivery-value" id="receiverPhone">-</div>
            </div>
            <div class="delivery-item">
              <div class="delivery-label">Jenis Barang</div>
              <div class="delivery-value" id="itemCategory">-</div>
            </div>
            <div class="delivery-item delivery-item-full">
              <div class="delivery-label">Deskripsi</div>
              <div class="delivery-value" id="itemDescription">-</div>
            </div>
          </div>
        </div>
      </div>

      <div class="actions-section">
        <!-- Tombol Menuju Lokasi - muncul saat status accepted -->
        <button class="action-btn on_the_way-btn" onclick="startToPickup()" id="onTheWayBtn" style="display: none;">
          <span>üöó</span> Menuju Lokasi
        </button>

        <!-- Tombol Saya Sudah Tiba - muncul saat status on_the_way -->
        <button class="action-btn arrived-btn" onclick="arrivedAtPickup()" id="arrivedBtn" style="display: none;">
          <span>üìç</span> Saya Sudah Tiba
        </button>

        <!-- Tombol Mulai Perjalanan - muncul saat status arrived -->
        <button class="action-btn antar-btn" onclick="startTrip()" id="startTripBtn" style="display: none;">
          <span>üì¶</span> Mulai Perjalanan
        </button>

        <!-- Tombol Selesaikan Perjalanan - muncul saat status on_trip -->
        <button class="action-btn complete-btn" onclick="completeOrder()" id="completeBtn" style="display: none;">
          <span>‚úÖ</span> Selesaikan Perjalanan
        </button>

        <!-- Tombol Chat Customer - selalu muncul kecuali order selesai/dibatalkan -->
        <button class="action-btn contact-btn" onclick="openChat()" id="contactBtn" style="display: none; position: relative;">
          <span>üí¨</span> Chat Customer
          <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
        </button>

        <!-- Tombol Batalkan Order - muncul kecuali order selesai/dibatalkan -->
        <button class="action-btn cancel-btn" onclick="cancelOrder()" id="cancelBtn" style="display: none;">
          <span>‚úñ</span> Batalkan Order
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay Chat -->
  <div class="chat-overlay" id="chatOverlay">
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-header-info">
          <div class="chat-avatar" id="chatAvatar">
            <!-- Avatar customer akan diisi JavaScript -->
          </div>
          <div>
            <div class="chat-name" id="chatName">Customer</div>
            <div class="chat-status" id="chatStatus">Online</div>
          </div>
        </div>
        <button class="close-chat" onclick="closeChat()">‚úï</button>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <!-- Pesan akan dimuat di sini -->
      </div>
      
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." />
        <button class="chat-send-btn" id="chatSendBtn">Kirim</button>
      </div>
    </div>
  </div>

  <!-- Notifikasi Chat -->
  <div class="chat-notification" id="chatNotification">
    <strong>üí¨ Pesan Baru</strong>
    <p id="notificationMessage"></p>
    <small>Klik untuk membalas</small>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCEsbn9W4ivUesB15wmDuMhOT4JR6Mq9Bs",
      authDomain: "ojeka-ba255.firebaseapp.com",
      databaseURL: "https://ojeka-ba255-default-rtdb.firebaseio.com",
      projectId: "ojeka-ba255",
      storageBucket: "ojeka-ba255.firebasestorage.app",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentOrderId = null;
    let orderRef = null;
    let orderListener = null;
    let currentOrderData = null;

    // ==================== VARIABEL SISTEM SALDO ====================
    let currentDriverData = null;
    let currentDriverBalance = 0;
    let potonganPercentage = 5.1; // Default potongan
    let balanceListener = null;

    // ==================== VARIABEL SISTEM CHAT ====================
    let chatRef = null;
    let chatListener = null;
    let unreadMessages = 0;
    let chatOpen = false;

    // ==================== SISTEM SALDO DRIVER ====================

    function initializeBalanceSystem() {
      // Ambil data driver dari localStorage
      const driverDataStr = localStorage.getItem('jego_driver_data');
      if (!driverDataStr) {
        console.log('‚ùå Tidak ada data driver di localStorage');
        return;
      }

      try {
        currentDriverData = JSON.parse(driverDataStr);
        console.log('‚úÖ Data driver ditemukan:', currentDriverData);

        if (!currentDriverData.driverId) {
          console.log('‚ùå Driver ID tidak ditemukan');
          return;
        }

        const driverId = currentDriverData.driverId;
        const balanceRef = database.ref('drivers/' + driverId + '/Balance');

        // Setup real-time listener untuk saldo
        balanceListener = balanceRef.on('value', (snapshot) => {
          const newBalance = snapshot.val() || 0;
          currentDriverBalance = newBalance;
          
          console.log(`üí∞ Saldo diperbarui: Rp ${newBalance.toLocaleString('id-ID')}`);
          
          // Update di localStorage
          if (currentDriverData) {
            currentDriverData.balance = newBalance;
            localStorage.setItem('jego_driver_data', JSON.stringify(currentDriverData));
          }
        }, (error) => {
          console.error('‚ùå Error listening to balance:', error);
        });

        // Ambil nilai potongan dari Firebase
        const potonganRef = database.ref('drivers/' + driverId + '/Potongan');
        potonganRef.once('value').then((snapshot) => {
          const potonganValue = snapshot.val();
          if (potonganValue !== null && potonganValue !== undefined) {
            potonganPercentage = potonganValue;
            console.log(`üí∞ Potongan dari Firebase: ${potonganPercentage}%`);
          } else {
            console.log(`üí∞ Potongan default: ${potonganPercentage}%`);
          }
        }).catch((error) => {
          console.error('‚ùå Error mengambil data potongan:', error);
        });

      } catch (error) {
        console.error('‚ùå Error parsing driver data:', error);
      }
    }

    // ==================== SISTEM CHAT INTEGRASI ====================

    function initializeChatSystem(orderId) {
      if (chatRef && chatListener) {
        chatRef.off('child_added', chatListener);
      }
      
      chatRef = database.ref('chat/' + orderId);
      chatListener = chatRef.on('child_added', (snapshot) => {
        const message = snapshot.val();
        console.log('üí¨ Pesan baru diterima:', message);
        
        // Jika chat terbuka, tampilkan pesan langsung
        if (chatOpen) {
          displayMessage(message);
          markMessageAsRead(snapshot.key);
        } else {
          // Jika chat tertutup, tampilkan notifikasi dan update badge
          handleNewMessageNotification(message);
        }
      });
      
      // Muat pesan yang sudah ada
      loadExistingMessages();
    }

    function loadExistingMessages() {
      if (!chatRef) return;
      
      chatRef.once('value').then((snapshot) => {
        const messages = snapshot.val();
        if (!messages) return;
        
        // Reset unread count saat memuat ulang
        unreadMessages = 0;
        updateChatBadge();
        
        // Kosongkan chat messages
        document.getElementById('chatMessages').innerHTML = '';
        
        // Tampilkan semua pesan
        Object.keys(messages).forEach(key => {
          displayMessage(messages[key]);
        });
        
        // Scroll ke bawah
        scrollChatToBottom();
      });
    }

    function displayMessage(message) {
      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');
      
      const isDriverMessage = message.sender === 'driver';
      const messageTime = formatTime(message.timestamp);
      
      messageElement.className = `message-bubble ${isDriverMessage ? 'message-right' : 'message-left'}`;
      messageElement.innerHTML = `
        ${message.message}
        <div class="message-time">${messageTime}</div>
      `;
      
      chatMessages.appendChild(messageElement);
      scrollChatToBottom();
    }

    function handleNewMessageNotification(message) {
      // Hanya tampilkan notifikasi untuk pesan dari customer
      if (message.sender !== 'driver') {
        unreadMessages++;
        updateChatBadge();
        
        // Tampilkan notifikasi
        showChatNotification(message);
        
        // Kirim notifikasi ke Kodular
        sendToKodular({
          action: 'new_chat_message',
          order_id: currentOrderId,
          sender: message.sender,
          sender_id: message.sender_id,
          message: message.message,
          timestamp: message.timestamp,
          unread_count: unreadMessages
        });
      }
    }

    function showChatNotification(message) {
      const notification = document.getElementById('chatNotification');
      const notificationMessage = document.getElementById('notificationMessage');
      
      notificationMessage.textContent = message.message;
      notification.style.display = 'block';
      
      // Auto hide setelah 5 detik
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
      
      // Klik untuk buka chat
      notification.onclick = function() {
        notification.style.display = 'none';
        openChat();
      };
    }

    function updateChatBadge() {
      const chatBadge = document.getElementById('chatBadge');
      if (unreadMessages > 0) {
        chatBadge.textContent = unreadMessages > 99 ? '99+' : unreadMessages.toString();
        chatBadge.style.display = 'flex';
      } else {
        chatBadge.style.display = 'none';
      }
    }

    function markMessageAsRead(messageKey) {
      // Dalam implementasi nyata, Anda bisa update status di Firebase
      // Untuk saat ini, kita reset unread count ketika chat dibuka
      if (chatOpen) {
        unreadMessages = 0;
        updateChatBadge();
      }
    }

    function scrollChatToBottom() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.getHours().toString().padStart(2, '0') + ':' + 
             date.getMinutes().toString().padStart(2, '0');
    }

    function openChat() {
      chatOpen = true;
      unreadMessages = 0;
      updateChatBadge();
      
      // Setup UI chat
      setupChatUI();
      
      // Tampilkan overlay chat
      document.getElementById('chatOverlay').style.display = 'flex';
      
      // Focus ke input
      setTimeout(() => {
        document.getElementById('chatInput').focus();
      }, 300);
    }

    function closeChat() {
      chatOpen = false;
      document.getElementById('chatOverlay').style.display = 'none';
    }

    function setupChatUI() {
      if (!currentOrderData || !currentOrderData.user_data) return;
      
      const customer = currentOrderData.user_data;
      const chatName = document.getElementById('chatName');
      const chatAvatar = document.getElementById('chatAvatar');
      
      chatName.textContent = customer.nama || 'Customer';
      
      // Setup avatar
      if (customer.foto) {
        chatAvatar.innerHTML = `<img src="${customer.foto}" alt="${customer.nama}">`;
      } else {
        chatAvatar.innerHTML = '';
        chatAvatar.style.backgroundImage = "url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"%23006699\"><path d=\"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\"/></svg>')";
        chatAvatar.style.backgroundColor = '#cce7ff';
        chatAvatar.style.backgroundRepeat = 'no-repeat';
        chatAvatar.style.backgroundPosition = 'center';
        chatAvatar.style.backgroundSize = '60%';
      }
      
      // Setup event listeners untuk input chat
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      
      chatSendBtn.onclick = sendChatMessage;
      chatInput.onkeypress = function(e) {
        if (e.key === 'Enter') sendChatMessage();
      };
    }

    function sendChatMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      
      if (!message || !currentDriverData) return;
      
      const messageData = {
        sender: 'driver',
        sender_id: currentDriverData.driverId,
        message: message,
        timestamp: Date.now()
      };
      
      chatRef.push(messageData)
        .then(() => {
          chatInput.value = '';
          console.log('‚úÖ Pesan terkirim');
        })
        .catch((error) => {
          console.error('‚ùå Gagal mengirim pesan:', error);
        });
    }

    // ==================== FUNGSI PERHITUNGAN POTONGAN ====================

    function calculateFee(orderAmount) {
      return Math.round(orderAmount * (potonganPercentage / 100));
    }

    function checkBalanceForOrder(orderAmount) {
      const requiredFee = calculateFee(orderAmount);
      const hasSufficientBalance = currentDriverBalance >= requiredFee;
      
      console.log(`üí∞ Cek saldo: ${currentDriverBalance} >= ${requiredFee} = ${hasSufficientBalance}`);
      
      return {
        hasSufficientBalance: hasSufficientBalance,
        requiredFee: requiredFee,
        currentBalance: currentDriverBalance,
        remainingBalance: currentDriverBalance - requiredFee
      };
    }

    function deductOrderFee(orderId, orderAmount, driverId) {
      const feeAmount = calculateFee(orderAmount);
      
      const driverRef = database.ref('drivers/' + driverId);
      
      // Gunakan transaction untuk menghindari race condition
      driverRef.transaction((currentData) => {
        if (currentData) {
          if (currentData.Balance < feeAmount) {
            console.error('‚ùå Saldo tidak cukup untuk potongan');
            return; // Batalkan transaction
          }
          
          currentData.Balance -= feeAmount;
          
          // Catat di riwayat transaksi jika ada field history
          const transactionId = 'tx_' + Date.now();
          if (!currentData.balance_history) {
            currentData.balance_history = {};
          }
          currentData.balance_history[transactionId] = {
            type: 'order_fee',
            order_id: orderId,
            amount: -feeAmount,
            order_amount: orderAmount,
            fee_percentage: potonganPercentage,
            description: `Biaya layanan order #${orderId}`,
            timestamp: new Date().toISOString()
          };
        }
        return currentData;
      }).then((result) => {
        if (result.committed) {
          console.log(`‚úÖ Berhasil memotong saldo: Rp ${feeAmount.toLocaleString('id-ID')}`);
          
          sendToKodular({
            action: 'balance_deducted',
            order_id: orderId,
            fee_amount: feeAmount,
            order_amount: orderAmount,
            new_balance: result.snapshot.val().Balance,
            message: `Potongan biaya layanan ${potonganPercentage}% untuk order #${orderId}`
          });
        } else {
          console.error('‚ùå Transaksi pemotongan saldo dibatalkan');
        }
      }).catch((error) => {
        console.error('‚ùå Gagal memotong saldo:', error);
      });
    }

    // ==================== FUNGSI LOCALSTORAGE ====================

    function getAcceptedOrderFromLocalStorage() {
        try {
            const acceptedOrder = localStorage.getItem('jego_driver_accepted_order');
            return acceptedOrder ? JSON.parse(acceptedOrder) : null;
        } catch (error) {
            console.error('‚ùå Gagal mengambil order yang diterima dari localStorage:', error);
            return null;
        }
    }

    // ==================== FUNGSI UPDATE STATISTIK DRIVER ====================

    function getDriverDataFromStorage() {
        try {
            return JSON.parse(localStorage.getItem('jego_driver_data') || '{}');
        } catch (error) {
            console.error('‚ùå Error parsing driver data from storage:', error);
            return {};
        }
    }

    function updateDriverStatistics(orderData) {
        console.log('üîÑ Memulai update statistik driver...');
        
        const driverData = getDriverDataFromStorage();
        const driverId = driverData.driverId;
        
        if (!driverId) {
            console.error('‚ùå Driver ID tidak ditemukan di localStorage');
            return;
        }

        console.log('üìä Update statistik untuk driver:', driverId);

        const driverRef = database.ref('drivers/' + driverId);
        
        driverRef.once('value').then((snapshot) => {
            const currentDriverData = snapshot.val();
            
            if (!currentDriverData) {
                console.error('‚ùå Data driver tidak ditemukan di Firebase');
                return;
            }

            const currentStats = {
                totalOrders: currentDriverData.totalOrders || 0,
                completedOrders: currentDriverData.completedOrders || 0,
                totalEarnings: currentDriverData.totalEarnings || 0,
                avgRating: currentDriverData.avgRating || 0,
                ratingCount: currentDriverData.ratingCount || 0,
                completionRate: currentDriverData.completionRate || '0%'
            };

            console.log('üìà Statistik saat ini:', currentStats);

            const orderPrice = orderData.harga_total ? parseInt(orderData.harga_total) : 0;
            
            const newStats = {
                totalOrders: currentStats.totalOrders + 1,
                completedOrders: currentStats.completedOrders + 1,
                totalEarnings: currentStats.totalEarnings + orderPrice,
                avgRating: currentStats.avgRating,
                ratingCount: currentStats.ratingCount,
                updated_at: new Date().toISOString()
            };

            const completionRateValue = (newStats.completedOrders / newStats.totalOrders) * 100;
            newStats.completionRate = completionRateValue.toFixed(1) + '%';

            console.log('üìä Statistik baru:', newStats);

            return driverRef.update({
                totalOrders: newStats.totalOrders,
                completedOrders: newStats.completedOrders,
                totalEarnings: newStats.totalEarnings,
                avgRating: newStats.avgRating,
                ratingCount: newStats.ratingCount,
                completionRate: newStats.completionRate,
                last_updated: new Date().toISOString()
            });

        }).then(() => {
            console.log('‚úÖ Statistik driver berhasil diupdate di Firebase');
            
            updateDriverStatsInLocalStorage();
            
        }).catch((error) => {
            console.error('‚ùå Gagal update statistik driver:', error);
        });
    }

    function updateDriverStatsInLocalStorage() {
        try {
            const driverData = getDriverDataFromStorage();
            const driverId = driverData.driverId;
            
            if (!driverId) return;

            const driverRef = database.ref('drivers/' + driverId);
            
            driverRef.once('value').then((snapshot) => {
                const updatedDriverData = snapshot.val();
                
                if (updatedDriverData) {
                    const currentLocalData = getDriverDataFromStorage();
                    const mergedData = {
                        ...currentLocalData,
                        ...updatedDriverData
                    };
                    
                    localStorage.setItem('jego_driver_data', JSON.stringify(mergedData));
                    console.log('‚úÖ Statistik driver diupdate di localStorage');
                }
            });

        } catch (error) {
            console.error('‚ùå Error updating driver stats in localStorage:', error);
        }
    }

    // ==================== FUNGSI UTAMA ====================

    function receiveDataFromKodular(dataString) {
      try {
        const data = JSON.parse(dataString);
        console.log("Data diterima dari Kodular:", data);
        
        if (data.action === 'open_order_details_driver') {
          currentOrderId = data.order_id;
          
          sendToKodular({
            action: 'order_details_driver_ready',
            order_id: currentOrderId,
            message: 'Halaman detail order driver siap'
          });
          
          startOrderListener(currentOrderId);
        }
      } catch (error) {
        console.error("Error parsing data dari Kodular:", error);
        showError("Format data tidak valid");
      }
    }

    function startOrderListener(orderId) {
      if (orderRef && orderListener) {
        orderRef.off('value', orderListener);
      }
      
      orderRef = database.ref('orders/' + orderId);
      orderListener = orderRef.on('value', (snapshot) => {
        const orderData = snapshot.val();
        
        if (orderData) {
          console.log('Data order diterima:', orderData);
          currentOrderData = orderData;
          displayOrderData(orderData);
          
          // Inisialisasi sistem chat
          initializeChatSystem(orderId);
        } else {
          showError('Order tidak ditemukan di database');
        }
      }, (error) => {
        console.error('Error listening to order:', error);
        showError('Gagal memuat data order');
      });
    }

    function displayOrderData(order) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      
      document.getElementById('pickupAddress').textContent = order.alamat_a || '-';
      document.getElementById('destinationAddress').textContent = order.alamat_b || '-';
      document.getElementById('serviceType').textContent = order.vehicle_name || '-';
      document.getElementById('serviceCapacity').textContent = order.vehicle_capacity || '-';
      document.getElementById('tripDuration').textContent = order.durasi || '-';
      document.getElementById('tripDistance').textContent = order.jarak || '-';
      
      if (order.harga_total) {
        const harga = typeof order.harga_total === 'number' ? order.harga_total : parseInt(order.harga_total);
        document.getElementById('tripPrice').textContent = `Rp ${harga.toLocaleString('id-ID')}`;
      } else {
        document.getElementById('tripPrice').textContent = '-';
      }
      
      if (order.created_at) {
        const orderTime = new Date(order.created_at);
        document.getElementById('orderTime').textContent = orderTime.toLocaleTimeString('id-ID', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      } else {
        document.getElementById('orderTime').textContent = '-';
      }
      
      updateCustomerInfo(order);
      updateOrderStatus(order.status);
      updateDeliveryInfo(order);
    }

    function updateCustomerInfo(order) {
      const customerAvatar = document.getElementById('customerAvatar');
      const customerName = document.getElementById('customerName');
      
      if (order.user_data) {
        const user = order.user_data;
        customerName.textContent = user.nama || '-';
        
        let gender = null;
        if (user.jenisKelamin) {
          gender = user.jenisKelamin.toLowerCase();
        }
        
        if (user.foto) {
          customerAvatar.innerHTML = `<img src="${user.foto}" alt="${user.nama}">`;
        } else {
          customerAvatar.innerHTML = '';
          customerAvatar.className = 'customer-avatar';
          if (gender === 'laki-laki' || gender === 'pria' || gender === 'male') {
            customerAvatar.classList.add('default-male');
          } else if (gender === 'perempuan' || gender === 'wanita' || gender === 'female') {
            customerAvatar.classList.add('default-female');
          } else {
            customerAvatar.classList.add('default-unknown');
          }
        }
        
        const tripCount = Math.floor(Math.random() * 15) + 1;
        document.getElementById('tripCount').textContent = `(${tripCount})`;
      } else {
        customerName.textContent = 'Tidak diketahui';
        customerAvatar.className = 'customer-avatar default-unknown';
        customerAvatar.innerHTML = '';
        document.getElementById('tripCount').textContent = '(0)';
      }
    }

    function updateDeliveryInfo(order) {
      const deliverySection = document.getElementById('deliverySection');
      
      const isKurirOrder = order.vehicle && order.vehicle.includes('kurir');
      const hasDeliveryData = order.delivery_data && 
        (order.delivery_data.senderPhone || 
         order.delivery_data.receiverPhone || 
         order.delivery_data.itemCategory || 
         order.delivery_data.description);
      
      if (isKurirOrder && hasDeliveryData) {
        deliverySection.style.display = 'block';
        
        const deliveryData = order.delivery_data;
        
        document.getElementById('senderPhone').textContent = deliveryData.senderPhone || '-';
        document.getElementById('receiverPhone').textContent = deliveryData.receiverPhone || '-';
        document.getElementById('itemCategory').textContent = deliveryData.itemCategory || '-';
        document.getElementById('itemDescription').textContent = deliveryData.description || '-';
      } else {
        deliverySection.style.display = 'none';
      }
    }

    function updateOrderStatus(status) {
      const statusBadge = document.getElementById('statusBadge');
      const onTheWayBtn = document.getElementById('onTheWayBtn');
      const arrivedBtn = document.getElementById('arrivedBtn');
      const startTripBtn = document.getElementById('startTripBtn');
      const completeBtn = document.getElementById('completeBtn');
      const contactBtn = document.getElementById('contactBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      
      onTheWayBtn.style.display = 'none';
      arrivedBtn.style.display = 'none';
      startTripBtn.style.display = 'none';
      completeBtn.style.display = 'none';
      contactBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      
      statusBadge.className = 'status-badge';
      
      switch(status) {
        case 'accepted':
          statusBadge.textContent = 'Diterima';
          statusBadge.classList.add('status-accepted');
          onTheWayBtn.style.display = 'flex';
          contactBtn.style.display = 'flex';
          cancelBtn.style.display = 'flex';
          break;
          
        case 'on_the_way':
          statusBadge.textContent = 'Menuju';
          statusBadge.classList.add('status-on_the_way');
          arrivedBtn.style.display = 'flex';
          contactBtn.style.display = 'flex';
          cancelBtn.style.display = 'flex';
          break;
          
        case 'arrived':
          statusBadge.textContent = 'Tiba';
          statusBadge.classList.add('status-arrived');
          startTripBtn.style.display = 'flex';
          contactBtn.style.display = 'flex';
          cancelBtn.style.display = 'flex';
          break;
          
        case 'on_trip':
          statusBadge.textContent = 'Perjalanan';
          statusBadge.classList.add('status-on_trip');
          completeBtn.style.display = 'flex';
          contactBtn.style.display = 'flex';
          cancelBtn.style.display = 'flex';
          break;
          
        case 'completed':
          statusBadge.textContent = 'Selesai';
          statusBadge.classList.add('status-completed');
          break;
          
        case 'cancelled':
          statusBadge.textContent = 'Batal';
          statusBadge.classList.add('status-cancelled');
          break;
          
        default:
          statusBadge.textContent = 'Tidak Diketahui';
          statusBadge.classList.add('status-accepted');
      }
      
      sendToKodular({
        action: 'order_status',
        order_id: currentOrderId,
        status: status
      });
    }

    function showError(message) {
      console.error('Error:', message);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
      document.getElementById('errorMessage').textContent = message;
      
      sendToKodular({
        action: 'error',
        message: message,
        order_id: currentOrderId,
        timestamp: new Date().toISOString()
      });
    }

    // ==================== FUNGSI TOMBOL AKSI ====================

    function startToPickup() {
      if (!currentOrderData) return;
      
      const orderRef = database.ref('orders/' + currentOrderId);
      orderRef.update({
        status: 'on_the_way',
        trip_started_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }).then(() => {
        console.log('Status updated to on_the_way');
        
        sendToKodular({
          action: 'start_to_pickup',
          order_id: currentOrderId,
          order_data: currentOrderData
        });
      }).catch((error) => {
        console.error('Gagal update status:', error);
      });
    }

    function arrivedAtPickup() {
      if (!currentOrderData) return;
      
      const orderRef = database.ref('orders/' + currentOrderId);
      orderRef.update({
        status: 'arrived',
        arrived_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }).then(() => {
        console.log('Status updated to arrived');
        
        sendToKodular({
          action: 'arrived_at_pickup',
          order_id: currentOrderId,
          order_data: currentOrderData
        });
      }).catch((error) => {
        console.error('Gagal update status:', error);
      });
    }

    function startTrip() {
      if (!currentOrderData) return;
      
      console.log('üîÑ Memulai perjalanan dan memotong saldo...');
      
      // CEK SALDO SEBELUM MEMULAI PERJALANAN
      const balanceCheck = checkBalanceForOrder(currentOrderData.harga_total);
      if (!balanceCheck.hasSufficientBalance) {
        alert(`Saldo tidak cukup untuk memulai perjalanan. Dibutuhkan: Rp ${balanceCheck.requiredFee.toLocaleString('id-ID')}`);
        return;
      }
      
      const orderRef = database.ref('orders/' + currentOrderId);
      orderRef.update({
        status: 'on_trip',
        trip_started_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }).then(() => {
        console.log('Status updated to on_trip');
        
        // ‚≠ê‚≠ê POTONG SALDO SETELAH PERJALANAN DIMULAI ‚≠ê‚≠ê
        if (currentDriverData && currentDriverData.driverId) {
          deductOrderFee(currentOrderId, currentOrderData.harga_total, currentDriverData.driverId);
        }
        
        sendToKodular({
          action: 'start_trip',
          order_id: currentOrderId,
          order_data: currentOrderData,
          message: 'Perjalanan dimulai dan saldo dipotong'
        });
      }).catch((error) => {
        console.error('Gagal update status:', error);
      });
    }

    function completeOrder() {
      if (!currentOrderData) return;
      
      console.log('üîÑ Menyelesaikan order dan update statistik...');
      
      const orderRef = database.ref('orders/' + currentOrderId);
      orderRef.update({
        status: 'completed',
        completed_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }).then(() => {
        console.log('‚úÖ Order completed di Firebase');
        
        localStorage.removeItem('jego_driver_accepted_order');
        
        // UPDATE STATISTIK DRIVER
        updateDriverStatistics(currentOrderData);
        
        sendToKodular({
          action: 'complete_order',
          order_id: currentOrderId,
          order_data: currentOrderData,
          message: 'Order selesai dan statistik driver akan diupdate'
        });

        sendToKodular({
          action: 'order_completed_popup',
          order_id: currentOrderId,
          message: 'Order berhasil diselesaikan'
        });
        
        setTimeout(() => {
          window.location.href = "list.html";
        }, 200);

      }).catch((error) => {
        console.error('‚ùå Gagal menyelesaikan order:', error);
        sendToKodular({
          action: 'order_complete_failed',
          order_id: currentOrderId,
          error: error.message,
          message: 'Gagal menyelesaikan order'
        });
      });
    }

    function cancelOrder() {
      if (currentOrderData && (currentOrderData.status === 'completed' || currentOrderData.status === 'cancelled')) {
        return;
      }
      
      const orderRef = database.ref('orders/' + currentOrderId);
      orderRef.update({
        status: 'cancelled',
        cancelled_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        cancelled_by: 'driver'
      }).then(() => {
        console.log('Order cancelled by driver');
        
        localStorage.removeItem('jego_driver_accepted_order');
        
        sendToKodular({
          action: 'cancel_order',
          order_id: currentOrderId,
          order_data: currentOrderData
        });
        
        setTimeout(() => {
          goBack();
        }, 1500);
      }).catch((error) => {
        console.error('Gagal membatalkan order:', error);
      });
    }

    function goBack() {
      if (orderRef && orderListener) {
        orderRef.off('value', orderListener);
      }
      
      if (chatRef && chatListener) {
        chatRef.off('child_added', chatListener);
      }
      
      if (balanceListener) {
        const driverId = currentDriverData?.driverId;
        if (driverId) {
          database.ref('drivers/' + driverId + '/Balance').off('value', balanceListener);
        }
      }
      
      sendToKodular({
        action: 'go_back_from_order_details_driver'
      });
      window.location.href = 'list.html';
    }

    function sendToKodular(data) {
      const kodularData = {
        ...data,
        timestamp: new Date().toISOString(),
        page: 'order_details_driver'
      };
      
      console.log('Mengirim data ke Kodular:', kodularData);
      
      if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
        try {
          window.AppInventor.setWebViewString(JSON.stringify(kodularData));
        } catch (error) {
          console.error('Error mengirim data via AppInventor:', error);
        }
      } else if (typeof window.android !== 'undefined' && window.android.receiveData) {
        try {
          window.android.receiveData(JSON.stringify(kodularData));
        } catch (error) {
          console.error('Error mengirim data via window.android:', error);
        }
      } else {
        console.warn('Metode pengiriman data ke Kodular tidak tersedia');
      }
    }

    // ==================== INISIALISASI ====================

    window.onload = function() {
      // Inisialisasi sistem saldo
      initializeBalanceSystem();
      
      // Cek URL parameters untuk order_id
      const urlParams = new URLSearchParams(window.location.search);
      const urlOrderId = urlParams.get('order_id');
      
      if (urlOrderId) {
        currentOrderId = urlOrderId;
        startOrderListener(urlOrderId);
        
        sendToKodular({
          action: 'order_details_driver_ready',
          order_id: currentOrderId,
          message: 'Halaman detail order driver dibuka via URL'
        });
      } else {
        const acceptedOrder = getAcceptedOrderFromLocalStorage();
        if (acceptedOrder && acceptedOrder.order_id) {
          currentOrderId = acceptedOrder.order_id;
          startOrderListener(currentOrderId);
          
          sendToKodular({
            action: 'order_details_driver_ready',
            order_id: currentOrderId,
            message: 'Halaman detail order driver dibuka via localStorage'
          });
        } else {
          console.log('Menunggu data dari Kodular...');
          
          setTimeout(() => {
            if (!currentOrderId) {
              showError('Tidak ada data order yang diterima');
            }
          }, 5000);
        }
      }
    };

    // Ekspos fungsi receiveDataFromKodular ke global scope
    window.receiveDataFromKodular = receiveDataFromKodular;
  </script>
</body>
</html>
