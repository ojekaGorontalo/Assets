<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat JeGo</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: Arial; background: #ECE5DD; height: 100vh; display: flex; flex-direction: column; }

        #header { display: flex; align-items: center; padding: 12px; background: #075E54; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.25); }
        #header img { width: 42px; height: 42px; border-radius: 50%; margin-right: 12px; }
        .name { font-size: 18px; font-weight: bold; }

        #chatBox { flex: 1; overflow-y: auto; padding: 15px; }

        .bubble { max-width: 75%; padding: 10px 14px; margin-bottom: 12px; border-radius: 10px; font-size: 15px; position: relative; }
        .left { background: #fff; align-self: flex-start; border-radius: 10px 10px 10px 0; }
        .right { background: #DCF8C6; align-self: flex-end; border-radius: 10px 10px 0 10px; }
        .time { font-size: 11px; opacity: 0.6; margin-top: 4px; text-align: right; }

        #inputArea { display: flex; padding: 10px; background: white; border-top: 1px solid #ccc; }
        #messageInput { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ccc; }
        #sendBtn { margin-left: 10px; padding: 12px 20px; background: #25D366; color: white; border-radius: 50px; border: none; cursor: pointer; }

        #orderClosed { display:none; text-align:center; padding:15px; color:#444; background:#ffe1e1; border-top:1px solid #dd0000; }
    </style>
</head>
<body>

    <div id="header">
        <img id="profilePic" src="">
        <div class="name" id="chatName">Loading...</div>
    </div>

    <div id="chatBox"></div>

    <!-- Pesan jika chat ditutup -->
    <div id="orderClosed">Order telah ditutup. Chat tidak dapat digunakan.</div>

    <div id="inputArea">
        <input type="text" id="messageInput" placeholder="Tulis pesan...">
        <button id="sendBtn">Kirim</button>
    </div>

<script>
/* Firebase */
const firebaseConfig = {
    apiKey: "AIzaSyDYju4Mi2uJYO0W3oR9ZcX91vgklqFszyY",
    authDomain: "ojeka-ba255.firebaseapp.com",
    databaseURL: "https://ojeka-ba255-default-rtdb.firebaseio.com",
    projectId: "ojeka-ba255",
    storageBucket: "ojeka-ba255.appspot.com",
    messagingSenderId: "443112627363",
    appId: "1:443112627363:web:62c39856d2c3f12ac44665"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function getQuery(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

const orderId = getQuery("order_id");
const role    = getQuery("role");
const senderId = getQuery("sender_id");

const chatRef  = db.ref("chat/" + orderId);
const orderRef = db.ref("orders/" + orderId);

const inputArea = document.getElementById("inputArea");
const closedBox = document.getElementById("orderClosed");

/* HEADER */
orderRef.once("value", snap => {
    const order = snap.val();
    if (!order) return;

    if (role === "driver") {
        chatName.textContent = order.user_data.nama;
        profilePic.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
    } else {
        chatName.textContent = order.selected_driver.name;
        profilePic.src = order.selected_driver.profile_photo_url;
    }
});

/* LISTEN STATUS ORDER â€” Fitur Baru */
orderRef.child("status").on("value", snap => {
    const status = snap.val();

    console.log("STATUS:", status);

    if (status === "cancelled" || status === "completed") {

        // Tutup input
        inputArea.style.display = "none";
        closedBox.style.display = "block";

        // Kirim info ke Kodular
        try {
            AppInventor.setWebViewString(JSON.stringify({
                chat_action: "closed",
                order_id: orderId,
                reason: status
            }));
        } catch(e){}

        // OPSIONAL: Hapus chat dari Firebase
        // chatRef.remove();
    }
});

/* Listen Chat */
chatRef.on("child_added", snap => showMessage(snap.val()));

/* Format Jam */
function formatTime(ts){
    const d = new Date(ts);
    return d.getHours().toString().padStart(2,"0") + ":" + 
           d.getMinutes().toString().padStart(2,"0");
}

/* Show Bubble */
function showMessage(data){
    const bubble = document.createElement("div");
    const isMine = (data.sender === role);

    bubble.className = "bubble " + (isMine ? "right" : "left");
    bubble.innerHTML = `
        ${data.message}
        <div class="time">${formatTime(data.timestamp)}</div>
    `;

    chatBox.appendChild(bubble);
    chatBox.scrollTop = chatBox.scrollHeight;
}

/* Send Message */
sendBtn.onclick = sendMessage;
messageInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
});

function sendMessage(){
    const msg = messageInput.value.trim();
    if (!msg) return;

    chatRef.push().set({
        sender: role,
        sender_id: senderId,
        message: msg,
        timestamp: Date.now()
    });

    messageInput.value = "";
}
</script>

</body>
</html>
