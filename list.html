<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>List Permintaan - JeGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEsbn9W4ivUesB15wmDuMhOT4JR6Mq9Bs&libraries=places"></script>
  <style>
    :root {
      --primary: #1e6f5c;
      --secondary: #289672;
      --accent: #e6dd3b;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --danger: #dc3545;
      --promo: #ff6b6b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.4;
      font-size: 0.85rem;
      padding-bottom: 70px;
    }

    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .driver-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent);
    }

    .gps-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .gps-active { background-color: #4ade80; }
    .gps-inactive { background-color: #f87171; }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .location-toggle-btn, .autobid-btn, .refresh-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
    }

    .location-toggle-btn:hover, .autobid-btn:hover, .refresh-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    .location-toggle-btn.active, .autobid-btn.active {
      background: var(--accent);
      color: var(--dark);
    }

    /* Container */
    .container {
      max-width: 100%;
      padding: 15px;
    }

    .orders-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .order-item {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .order-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .customer-name {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .kurir-badge {
      background-color: var(--accent);
      color: var(--dark);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .promo-badge {
      background: linear-gradient(135deg, var(--promo), #ff8e8e);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-searching {
      background-color: #fff3cd;
      color: #856404;
    }

    .route-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.8rem;
    }

    .route-point {
      display: flex;
      align-items: flex-start;
    }

    .point-marker {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      flex-shrink: 0;
      font-size: 0.7rem;
      color: white;
      font-weight: bold;
    }

    .point-marker-a { background-color: var(--primary); }
    .point-marker-b { background-color: var(--secondary); }

    .point-address { flex: 1; word-break: break-word; }
    .point-address-a { font-weight: 700; }

    .delivery-info {
      margin-top: 8px;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid var(--accent);
      font-size: 0.75rem;
    }

    .delivery-item {
      display: flex;
      margin-bottom: 4px;
    }

    .delivery-label {
      font-weight: 600;
      color: var(--primary);
      min-width: 80px;
      margin-right: 8px;
    }

    .order-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
      border-top: 1px solid #eee;
      padding-top: 8px;
      font-size: 0.8rem;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .detail-value {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.75rem;
    }

    .detail-label {
      font-size: 0.65rem;
      color: #666;
      margin-top: 2px;
    }

    .price-highlight { color: var(--success); font-weight: 700; }

    .price-promo {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .original-price {
      text-decoration: line-through;
      color: #999;
      font-size: 0.7rem;
      margin-bottom: 2px;
    }

    .promo-price { color: var(--promo); font-weight: 700; }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      border-radius: 12px;
      width: 95%;
      max-width: 380px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover { color: var(--danger); }

    .modal-body { padding: 0; }
    .modal-map { height: 150px; width: 100%; border-radius: 0; }

    .modal-details { padding: 12px 15px; }

    .modal-route-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .modal-route-point {
      display: flex;
      align-items: flex-start;
    }

    .modal-point-marker {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      flex-shrink: 0;
      font-size: 0.7rem;
      color: white;
      font-weight: bold;
    }

    .modal-point-address {
      flex: 1;
      word-break: break-word;
      font-size: 0.8rem;
      line-height: 1.3;
    }

    .modal-order-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .modal-detail-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .modal-detail-value {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.85rem;
    }

    .modal-detail-label {
      font-size: 0.7rem;
      color: #666;
      margin-top: 2px;
    }

    .modal-footer {
      padding: 12px 15px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
    }

    .ambil-btn {
      width: 100%;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .ambil-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .ambil-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: white;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 99;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 8px;
      margin: 0 5px;
    }

    .nav-item.active {
      background-color: rgba(30, 111, 92, 0.1);
    }

    .nav-item.active .nav-icon { color: var(--primary); }
    .nav-item.active .nav-label { color: var(--primary); font-weight: 600; }

    .nav-icon {
      font-size: 1.2rem;
      margin-bottom: 4px;
      color: #666;
      transition: all 0.2s;
    }

    .nav-label {
      font-size: 0.7rem;
      color: #666;
      transition: all 0.2s;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body { font-size: 0.8rem; }
      .order-item { padding: 10px; }
      .route-info { font-size: 0.75rem; }
      .order-details { font-size: 0.75rem; }
      .modal-content { width: 98%; max-height: 95vh; }
      .modal-map { height: 150px; }
      .location-toggle-btn, .autobid-btn, .refresh-btn {
        padding: 6px 12px;
        font-size: 0.75rem;
      }
      .bottom-nav { padding: 8px 0; }
      .nav-icon { font-size: 1.1rem; }
      .nav-label { font-size: 0.65rem; }
    }

    @media (max-width: 576px) {
      .container { padding: 10px; }
      .order-details { grid-template-columns: repeat(3, 1fr); }
      .modal-header, .modal-details, .modal-footer { padding: 12px 15px; }
      .modal-order-details { grid-template-columns: repeat(3, 1fr); gap: 10px; }
      .header { padding: 12px 15px; }
      .location-toggle-btn, .autobid-btn, .refresh-btn {
        padding: 5px 10px;
        font-size: 0.7rem;
      }
      .bottom-nav { padding: 6px 0; }
      .nav-item { padding: 6px 0; }
      .nav-icon { font-size: 1rem; }
      .nav-label { font-size: 0.6rem; }
      .modal-content { max-width: 340px; }
      .modal-map { height: 120px; }
      .modal-details { padding: 10px 12px; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo-container">
      <img id="driverPhoto" class="driver-photo" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Driver Photo">
      <div class="gps-status" id="gpsStatus">
        <span class="gps-dot gps-inactive" id="gpsDot"></span>
      </div>
    </div>
    <div class="header-controls">
      <button class="location-toggle-btn" id="locationToggleBtn">üìç OFF</button>
      <button class="autobid-btn" id="autobidBtn">Autobid: OFF</button>
      <button class="refresh-btn" id="refreshBtn" title="Refresh">‚Üª</button>
    </div>
  </div>

  <!-- Container -->
  <div class="container">
    <div class="orders-list" id="ordersList">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <!-- Modal Detail Order -->
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Detail Permintaan</h3>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-map" id="modalMap"></div>
        <div class="modal-details">
          <div class="modal-route-info">
            <div class="modal-route-point">
              <div class="modal-point-marker point-marker-a">A</div>
              <div class="modal-point-address modal-point-address-a" id="modalAddressA">-</div>
            </div>
            <div class="modal-route-point">
              <div class="modal-point-marker point-marker-b">B</div>
              <div class="modal-point-address" id="modalAddressB">-</div>
            </div>
          </div>
          
          <div id="modalDeliveryInfo"></div>
          
          <div class="modal-order-details">
            <div class="modal-detail-item">
              <span class="modal-detail-value" id="modalDuration">-</span>
              <span class="modal-detail-label">Durasi</span>
            </div>
            <div class="modal-detail-item">
              <span class="modal-detail-value" id="modalDistance">-</span>
              <span class="modal-detail-label">Jarak</span>
            </div>
            <div class="modal-detail-item">
              <span class="modal-detail-value" id="modalPrice">-</span>
              <span class="modal-detail-label">Harga</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ambil-btn" id="ambilBtn">Kirim Penawaran</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item active" data-screen="home">
      <div class="nav-icon">üè†</div>
      <div class="nav-label">Beranda</div>
    </div>
    <div class="nav-item" data-screen="history">
      <div class="nav-icon">üìã</div>
      <div class="nav-label">Riwayat</div>
    </div>
    <div class="nav-item" data-screen="active_order">
      <div class="nav-icon">üöó</div>
      <div class="nav-label">Berjalan</div>
    </div>
    <div class="nav-item" data-screen="account">
      <div class="nav-icon">üë§</div>
      <div class="nav-label">Akun</div>
    </div>
  </div>

  <!-- Audio Notifikasi -->
  <audio id="newOrderSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-tone-996.mp3" type="audio/mpeg">
  </audio>
  <audio id="autobidSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-classic-alarm-995.mp3" type="audio/mpeg">
  </audio>
  <audio id="orderAcceptedSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Kode JavaScript tetap sama seperti di file asli
    // (Kode JavaScript terlalu panjang untuk ditampilkan semua di sini)
    // Intinya: fungsi-fungsi Firebase, GPS, Autobid, dll.
    
    // ==================== CEK LOGIN DAN REDIRECT ====================
    function checkLoginStatus() {
      const driverData = localStorage.getItem('jego_driver_data');
      if (!driverData || driverData === '{}') {
        console.log('‚ùå Driver belum login, redirect ke halaman login');
        window.location.href = 'loginDriver.html';
        return false;
      }
      return true;
    }

    // ==================== KODE FIREBASE ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCYDUjYzdG3_xBxWdGV2wk1E-mBu21pzvg",
      authDomain: "ojeka-ba255.firebaseapp.com",
      databaseURL: "https://ojeka-ba255-default-rtdb.firebaseio.com",
      projectId: "ojeka-ba255",
      storageBucket: "ojeka-ba255.firebasestorage.app",
      messagingSenderId: "639980533353",
      appId: "1:639980533353:web:14a9cde94065b60c8cd4f8",
      measurementId: "G-PBP64Z8VQ8"
    };

    // Initialize Firebase
    let database;
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      database = firebase.database();
      console.log('‚úÖ Firebase berhasil diinisialisasi');
    } catch (error) {
      console.error('‚ùå Error inisialisasi Firebase:', error);
    }

    // Variabel global
    let ordersRef = null;
    let ordersListener = null;
    let modalMap = null;
    let directionsService = null;
    let directionsRenderer = null;
    let currentSelectedOrder = null;
    let countdownInterval = null;
    let offerListenerRef = null;
    let offerListener = null;
    let currentDriverId = null;
    let currentDriverData = null;
    let autobidEnabled = false;
    let autobidInterval = null;
    let isAutobidProcessing = false;
    let driverLocation = { latitude: null, longitude: null };
    let locationWatchId = null;
    let processedOrders = new Set();
    let locationTrackingEnabled = false;
    let locationTrackingInterval = null;

    // ==================== FUNGSI UTAMA ====================
    function loadOrders() {
      console.log('üîÑ Memulai loadOrders...');
      
      const ordersList = document.getElementById('ordersList');
      if (!ordersList) return;

      ordersList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      if (!checkDriverData()) {
        console.log('‚ùå Driver tidak terdaftar, berhenti load orders');
        return;
      }

      if (!database) return;

      if (ordersListener && ordersRef) {
        ordersRef.off('value', ordersListener);
      }

      try {
        ordersRef = database.ref('orders');
        
        ordersListener = ordersRef.on('value', (snapshot) => {
          console.log('‚úÖ Data orders diterima dari Firebase');
          
          const orders = snapshot.val();
          ordersList.innerHTML = '';

          if (!orders || Object.keys(orders).length === 0) {
            ordersList.innerHTML = `
              <div class="empty-state">
                <div>üì≠</div>
                <p>Tidak ada permintaan order saat ini</p>
              </div>
            `;
            return;
          }

          // Proses dan tampilkan orders
          const sortedOrders = Object.entries(orders)
            .map(([id, order]) => ({ id, ...order }))
            .filter(order => order.status === 'searching')
            .sort((a, b) => {
              const timeA = new Date(a.created_at || 0).getTime();
              const timeB = new Date(b.created_at || 0).getTime();
              return timeB - timeA;
            });

          if (sortedOrders.length === 0) {
            ordersList.innerHTML = `
              <div class="empty-state">
                <div>üì≠</div>
                <p>Tidak ada permintaan order</p>
              </div>
            `;
            return;
          }

          renderOrdersList(sortedOrders, ordersList);
          
        }, (error) => {
          console.error('‚ùå Error loading orders:', error);
          ordersList.innerHTML = `
            <div class="empty-state">
              <div>‚ö†Ô∏è</div>
              <p>Gagal terhubung ke server</p>
            </div>
          `;
        });
        
      } catch (error) {
        console.error('‚ùå Error accessing Firebase:', error);
      }
    }

    function renderOrdersList(orders, ordersList) {
      orders.forEach(order => {
        const orderItem = document.createElement('div');
        orderItem.className = 'order-item';
        orderItem.dataset.orderId = order.id;
        
        const customerName = order.user_data?.nama || 'Tidak diketahui';
        const alamatA = order.alamat_a || '-';
        const alamatB = order.alamat_b || '-';
        const durasi = order.durasi || '-';
        const jarak = order.jarak || '-';
        const harga = order.harga_total || 0;
        const isKurir = order.vehicle && order.vehicle.includes('kurir');
        
        let promoBadge = '';
        if (order.diskon_persen || order.promo_data) {
          promoBadge = '<span class="promo-badge">üéÅ PROMO</span>';
        }

        orderItem.innerHTML = `
          <div class="order-header">
            <div class="customer-name">
              ${customerName}
              ${isKurir ? '<span class="kurir-badge">üì¶ KURIR</span>' : ''}
              ${promoBadge}
            </div>
            <span class="status-badge status-searching">Mencari Driver</span>
          </div>
          <div class="route-info">
            <div class="route-point">
              <div class="point-marker point-marker-a">A</div>
              <div class="point-address point-address-a">${alamatA}</div>
            </div>
            <div class="route-point">
              <div class="point-marker point-marker-b">B</div>
              <div class="point-address">${alamatB}</div>
            </div>
          </div>
          <div class="order-details">
            <div class="detail-item">
              <span class="detail-value">${durasi}</span>
              <span class="detail-label">Durasi</span>
            </div>
            <div class="detail-item">
              <span class="detail-value">${jarak}</span>
              <span class="detail-label">Jarak</span>
            </div>
            <div class="detail-item">
              <span class="detail-value price-highlight">Rp ${harga.toLocaleString('id-ID')}</span>
              <span class="detail-label">Harga</span>
            </div>
          </div>
        `;
        
        orderItem.addEventListener('click', () => {
          showOrderDetail(order);
        });
        
        ordersList.appendChild(orderItem);
      });
    }

    function showOrderDetail(order) {
      if (!checkDriverData()) return;

      const orderKey = order.order_id || order.id;
      const orderRef = database.ref('orders/' + orderKey);
      
      orderRef.once('value').then((snapshot) => {
        const currentOrder = snapshot.val();
        
        if (!currentOrder || currentOrder.status !== 'searching') {
          alert('Order ini sudah diambil oleh driver lain.');
          loadOrders();
          return;
        }
        
        currentSelectedOrder = currentOrder;
        currentDriverId = 'DRIVER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        document.getElementById('modalAddressA').textContent = currentOrder.alamat_a || '-';
        document.getElementById('modalAddressB').textContent = currentOrder.alamat_b || '-';
        document.getElementById('modalDuration').textContent = currentOrder.durasi || '-';
        document.getElementById('modalDistance').textContent = currentOrder.jarak || '-';
        document.getElementById('modalPrice').textContent = currentOrder.harga_total ? `Rp ${currentOrder.harga_total.toLocaleString('id-ID')}` : '-';
        
        document.getElementById('ambilBtn').disabled = false;
        document.getElementById('ambilBtn').textContent = 'Kirim Penawaran';
        
        document.getElementById('orderModal').style.display = 'flex';
        
        if (!modalMap) initModalMap();
        showRouteOnMap(currentOrder);
        
      }).catch((error) => {
        console.error('Error checking order status:', error);
        alert('Gagal memuat detail order. Silakan coba lagi.');
      });
    }

    function initModalMap() {
      const mapElement = document.getElementById('modalMap');
      modalMap = new google.maps.Map(mapElement, {
        zoom: 12,
        center: { lat: 0.5441, lng: 123.0595 },
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });
      
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: modalMap,
        suppressMarkers: false,
        polylineOptions: { strokeColor: '#289672', strokeWeight: 6 }
      });
    }

    function showRouteOnMap(order) {
      if (!order.from_lat || !order.from_lng || !order.to_lat || !order.to_lng) return;
      
      const from = new google.maps.LatLng(order.from_lat, order.from_lng);
      const to = new google.maps.LatLng(order.to_lat, order.to_lng);
      
      directionsService.route({
        origin: from,
        destination: to,
        travelMode: google.maps.TravelMode.DRIVING,
        region: "ID"
      }, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
          const bounds = new google.maps.LatLngBounds();
          bounds.extend(from);
          bounds.extend(to);
          modalMap.fitBounds(bounds);
        }
      });
    }

    function sendDriverOffer() {
      if (!currentSelectedOrder || !currentDriverId) return;
      
      if (!checkDriverData()) return;

      const orderId = currentSelectedOrder.order_id || currentSelectedOrder.id;
      const driverId = currentDriverId;
      const ambilBtn = document.getElementById('ambilBtn');
      
      ambilBtn.disabled = true;
      ambilBtn.textContent = 'Mengirim...';
      
      const orderRef = database.ref('orders/' + orderId);
      orderRef.once('value').then((snapshot) => {
        const currentOrder = snapshot.val();
        
        if (!currentOrder || currentOrder.status !== 'searching') {
          alert('Order ini sudah diambil oleh driver lain.');
          closeModal();
          return;
        }
        
        const driverData = {
          id: driverId,
          name: currentDriverData.fullName,
          plate_number: currentDriverData.plateNumber,
          vehicle_type: currentDriverData.vehicleType,
          offered_at: new Date().toISOString(),
        };
        
        orderRef.child('driver_offers').child(driverId).set(driverData)
          .then(() => {
            console.log('Penawaran driver berhasil dikirim');
            ambilBtn.textContent = 'Menunggu Konfirmasi';
            startCountdown(orderId, driverId);
          })
          .catch((error) => {
            console.error('Gagal mengirim penawaran:', error);
            alert('Gagal mengirim penawaran. Silakan coba lagi.');
            ambilBtn.disabled = false;
            ambilBtn.textContent = 'Kirim Penawaran';
          });
      }).catch((error) => {
        console.error('Error checking order status:', error);
        alert('Gagal memeriksa status order.');
        ambilBtn.disabled = false;
        ambilBtn.textContent = 'Kirim Penawaran';
      });
    }

    function startCountdown(orderId, driverId) {
      let timeLeft = 30;
      if (countdownInterval) clearInterval(countdownInterval);
      
      countdownInterval = setInterval(() => {
        timeLeft--;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          removeDriverOffer(orderId, driverId);
          closeModal();
        }
      }, 1000);
    }

    function removeDriverOffer(orderId, driverId) {
      const orderRef = database.ref('orders/' + orderId);
      orderRef.child('driver_offers').child(driverId).remove()
        .then(() => console.log('Data driver dihapus karena waktu habis'))
        .catch(error => console.error('Gagal menghapus data driver:', error));
    }

    function closeModal() {
      document.getElementById('orderModal').style.display = 'none';
      
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      
      currentSelectedOrder = null;
      currentDriverId = null;
      loadOrders();
    }

    // ==================== FUNGSI GPS ====================
    function startGPSMonitoring() {
      if (!navigator.geolocation) {
        console.error('‚ùå Browser tidak mendukung geolocation');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          updateDriverLocation(position);
        },
        (error) => {
          console.error('‚ùå Error mendapatkan lokasi:', error);
        }
      );

      locationWatchId = navigator.geolocation.watchPosition(
        (position) => {
          updateDriverLocation(position);
        },
        (error) => {
          console.error('‚ùå Error update lokasi:', error);
        }
      );
    }

    function updateDriverLocation(position) {
      driverLocation = {
        latitude: position.coords.latitude,
        longitude: position.coords.longitude
      };
      
      console.log(`üìç Lokasi driver: ${driverLocation.latitude}, ${driverLocation.longitude}`);
      document.getElementById('gpsDot').className = 'gps-dot gps-active';
    }

    // ==================== FUNGSI DRIVER ====================
    function checkDriverData() {
      try {
        const driverDataStr = localStorage.getItem('jego_driver_data');
        
        if (!driverDataStr || driverDataStr === '{}') {
          console.log('‚ùå Tidak ada data driver di localStorage');
          showDriverNotRegistered();
          return false;
        }
        
        const driverData = JSON.parse(driverDataStr);
        
        if (driverData.driverId && driverData.fullName) {
          currentDriverData = driverData;
          
          // Update foto driver
          const driverPhoto = document.getElementById('driverPhoto');
          if (currentDriverData.profilePhotoUrl) {
            driverPhoto.src = currentDriverData.profilePhotoUrl;
          }
          
          console.log('‚úÖ Driver data valid');
          return true;
        } else {
          showDriverNotRegistered();
          return false;
        }
      } catch (error) {
        console.error('‚ùå Error checking driver data:', error);
        showDriverNotRegistered();
        return false;
      }
    }

    function showDriverNotRegistered() {
      const ordersList = document.getElementById('ordersList');
      if (ordersList) {
        ordersList.innerHTML = `
          <div class="empty-state">
            <div>üö´</div>
            <p>Anda belum terdaftar sebagai driver</p>
          </div>
        `;
      }
    }

    // ==================== FUNGSI NAVIGASI ====================
    function navigateToScreen(screen) {
      console.log(`üîÑ Navigasi ke screen: ${screen}`);
      
      switch(screen) {
        case 'home':
          if (!window.location.href.includes('list.html')) {
            window.location.href = 'list.html';
          }
          break;
        case 'history':
          window.location.href = 'riwayat.html';
          break;
        case 'active_order':
          window.location.href = 'orderAccepted.html';
          break;
        case 'account':
          window.location.href = 'akun.html';
          break;
      }
      
      updateActiveNavItem(screen);
    }

    function updateActiveNavItem(screen) {
      const navItems = document.querySelectorAll('.nav-item');
      
      navItems.forEach(item => {
        if (item.dataset.screen === screen) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    // ==================== FUNGSI TOGGLE ====================
    function toggleLocationTracking() {
      locationTrackingEnabled = !locationTrackingEnabled;
      updateLocationToggleButton();
      
      if (locationTrackingEnabled) {
        if (!driverLocation.latitude || !driverLocation.longitude) {
          alert('GPS diperlukan. Pastikan lokasi Anda aktif.');
          locationTrackingEnabled = false;
          updateLocationToggleButton();
          return;
        }
        
        console.log('üìç Location tracking diaktifkan');
      } else {
        console.log('üõë Location tracking dimatikan');
      }
    }

    function updateLocationToggleButton() {
      const locationToggleBtn = document.getElementById('locationToggleBtn');
      if (locationTrackingEnabled) {
        locationToggleBtn.innerHTML = 'üìç ON';
        locationToggleBtn.classList.add('active');
      } else {
        locationToggleBtn.innerHTML = 'üìç OFF';
        locationToggleBtn.classList.remove('active');
      }
    }

    function toggleAutobid() {
      if (!locationTrackingEnabled) {
        alert('Aktifkan tracking terlebih dahulu');
        return;
      }

      autobidEnabled = !autobidEnabled;
      updateAutobidButton();
      
      if (autobidEnabled) {
        console.log('üöÄ Autobid diaktifkan');
      } else {
        console.log('üõë Autobid dinonaktifkan');
      }
    }

    function updateAutobidButton() {
      const autobidBtn = document.getElementById('autobidBtn');
      if (autobidEnabled) {
        autobidBtn.innerHTML = 'Autobid: ON';
        autobidBtn.classList.add('active');
      } else {
        autobidBtn.innerHTML = 'Autobid: OFF';
        autobidBtn.classList.remove('active');
      }
    }

    function refreshData() {
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.disabled = true;
      
      loadOrders();
      
      setTimeout(() => {
        refreshBtn.disabled = false;
      }, 1000);
    }

    // ==================== INISIALISASI ====================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Halaman JeGo Driver dimuat');
      
      // Cek login
      if (!checkLoginStatus()) return;
      
      // Mulai GPS
      setTimeout(() => {
        startGPSMonitoring();
      }, 1000);
      
      // Load orders
      setTimeout(() => {
        loadOrders();
      }, 500);
      
      // Event listeners
      document.getElementById('locationToggleBtn').addEventListener('click', toggleLocationTracking);
      document.getElementById('refreshBtn').addEventListener('click', refreshData);
      document.getElementById('closeModal').addEventListener('click', closeModal);
      document.getElementById('ambilBtn').addEventListener('click', sendDriverOffer);
      document.getElementById('autobidBtn').addEventListener('click', toggleAutobid);

      document.getElementById('orderModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('orderModal')) closeModal();
      });

      // Bottom navigation
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const screen = item.dataset.screen;
          navigateToScreen(screen);
        });
      });
    });

    window.addEventListener('beforeunload', () => {
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
      }
    });
  </script>
</body>
</html>
