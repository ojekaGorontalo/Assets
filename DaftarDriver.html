<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Daftar Driver - JeGo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    :root {
      --primary: #FF9800;    /* Orange */
      --secondary: #FF5722;   /* Red-Orange */
      --accent: #FFC107;     /* Amber/Yellow */
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #4CAF50;    /* Green */
      --danger: #f44336;     /* Red */
      --warning: #FFC107;    /* Yellow */
      --info: #2196F3;       /* Blue */
      --gray: #9E9E9E;       /* Gray */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.4;
      font-size: 0.85rem;
    }

    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo {
      width: 40px;
      height: 40px;
      background-color: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary);
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Container Styles */
    .container {
      max-width: 100%;
      padding: 15px;
    }

    .form-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 0 auto;
    }

    .form-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    /* Auth Steps */
    .auth-step {
      display: none;
    }

    .auth-step.active {
      display: block;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      gap: 10px;
    }

    .step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #e9ecef;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      position: relative;
    }

    .step.active {
      background-color: var(--primary);
      color: white;
    }

    .step.completed {
      background-color: var(--success);
      color: white;
    }

    .step-line {
      flex: 1;
      height: 2px;
      background-color: #e9ecef;
      align-self: center;
      max-width: 50px;
    }

    .step-line.active {
      background-color: var(--primary);
    }

    .step-label {
      position: absolute;
      top: 35px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 0.8rem;
      color: #6c757d;
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    /* OTP Styles */
    .otp-section {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .otp-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
    }

    .otp-info {
      margin-bottom: 20px;
      font-size: 0.9rem;
      text-align: center;
      color: #666;
    }

    .otp-input-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .otp-input {
      width: 50px;
      height: 50px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
      border: 2px solid #ddd;
      border-radius: 6px;
      transition: all 0.3s;
    }

    .otp-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
      outline: none;
    }

    .otp-input.filled {
      border-color: var(--primary);
    }

    .resend-otp {
      text-align: center;
      margin-top: 15px;
      font-size: 0.85rem;
    }

    .resend-link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
    }

    .resend-link:hover {
      color: var(--secondary);
    }

    .resend-link.disabled {
      color: #999;
      cursor: not-allowed;
      text-decoration: none;
    }

    /* Recaptcha Container */
    #recaptcha-container {
      margin: 15px 0;
      min-height: 78px;
      display: flex;
      justify-content: center;
    }

    #recaptcha-container > div {
      margin: 0 auto;
    }

    .phone-format {
      font-size: 0.85rem;
      color: #666;
      margin-top: 5px;
    }

    .phone-format .example {
      font-weight: bold;
      color: var(--primary);
    }

    /* Phone Status */
    .phone-status {
      padding: 10px;
      border-radius: 8px;
      margin-top: 8px;
      font-size: 0.9rem;
      display: none;
    }

    .phone-status.available {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success);
      border-left: 3px solid var(--success);
      display: block;
    }

    .phone-status.registered {
      background-color: rgba(255, 193, 7, 0.1);
      color: var(--warning);
      border-left: 3px solid var(--warning);
      display: block;
    }

    .phone-status.error {
      background-color: rgba(244, 67, 54, 0.1);
      color: var(--danger);
      border-left: 3px solid var(--danger);
      display: block;
    }

    .phone-status-message {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .phone-status-icon {
      font-size: 1.1rem;
    }

    .phone-status-actions {
      margin-top: 8px;
      display: flex;
      gap: 10px;
    }

    .phone-status-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
    }

    .phone-status-btn.primary {
      background-color: var(--primary);
      color: white;
    }

    .phone-status-btn.secondary {
      background-color: #6c757d;
      color: white;
    }

    /* Vehicle Options */
    .vehicle-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .vehicle-option {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .vehicle-option:hover {
      border-color: var(--secondary);
    }

    .vehicle-option.selected {
      border-color: var(--primary);
      background-color: rgba(255, 152, 0, 0.05);
    }

    .vehicle-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .vehicle-name {
      font-weight: 600;
      font-size: 0.85rem;
    }

    .vehicle-capacity {
      font-size: 0.75rem;
      color: #666;
      margin-top: 3px;
    }

    .terms-container {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
    }

    .terms-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--primary);
    }

    .terms-content {
      font-size: 0.8rem;
      line-height: 1.5;
    }

    .terms-content p {
      margin-bottom: 10px;
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .checkbox-group input {
      margin-right: 10px;
      margin-top: 3px;
    }

    .checkbox-group label {
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .submit-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      width: 100%;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .submit-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Status Messages */
    .status-message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }

    .status-success {
      background-color: rgba(76, 175, 80, 0.1);
      color: #2e7d32;
      border: 1px solid #4CAF50;
    }

    .status-error {
      background-color: rgba(244, 67, 54, 0.1);
      color: #c62828;
      border: 1px solid #f44336;
    }

    .status-info {
      background-color: rgba(33, 150, 243, 0.1);
      color: #1565c0;
      border: 1px solid #2196F3;
    }

    .status-warning {
      background-color: rgba(255, 193, 7, 0.1);
      color: #ff8f00;
      border: 1px solid #FFC107;
    }

    /* File Upload Styles */
    .file-upload-container {
      background-color: rgba(255, 152, 0, 0.05);
      border: 2px dashed var(--primary);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .file-upload-container:hover {
      background-color: rgba(255, 152, 0, 0.1);
      border-color: var(--secondary);
    }

    .file-upload-container.dragover {
      background-color: rgba(255, 152, 0, 0.2);
      border-color: var(--accent);
    }

    .upload-icon {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .file-input {
      display: none;
    }

    .file-preview {
      margin-top: 15px;
      max-width: 200px;
      margin: 15px auto;
      display: none;
    }

    .file-preview img {
      width: 100%;
      border-radius: 6px;
      border: 2px solid var(--gray);
    }

    .upload-progress {
      margin-top: 10px;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      display: none;
    }

    .upload-progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--accent));
      width: 0%;
      transition: width 0.3s;
    }

    /* Success Section */
    .success-section {
      background-color: rgba(76, 175, 80, 0.1);
      border: 1px solid var(--success);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
      text-align: center;
    }

    .success-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--success);
    }

    .success-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .success-message {
      margin-bottom: 20px;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .whatsapp-btn {
      background: linear-gradient(to right, #25D366, #128C7E);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin-bottom: 10px;
    }

    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .whatsapp-icon {
      font-size: 1.2rem;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background-color: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
      overflow: hidden;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e9ecef;
    }

    .modal-title {
      display: flex;
      align-items: center;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .modal-icon.success {
      background-color: var(--success);
    }

    .modal-icon.error {
      background-color: var(--danger);
    }

    .modal-icon.warning {
      background-color: var(--warning);
    }

    .modal-icon.info {
      background-color: var(--info);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .close-btn:hover {
      background-color: #f8f9fa;
      color: var(--dark);
    }

    .modal-body {
      padding: 20px;
      font-size: 16px;
      line-height: 1.5;
    }

    .modal-footer {
      padding: 15px 20px;
      display: flex;
      justify-content: flex-end;
      border-top: 1px solid #e9ecef;
      background-color: #f8f9fa;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 15px;
    }

    .modal-btn.confirm {
      background-color: var(--primary);
      color: white;
      margin-left: 10px;
    }

    .modal-btn.confirm:hover {
      background-color: var(--secondary);
    }

    .modal-btn.cancel {
      background-color: #6c757d;
      color: white;
    }

    .modal-btn.cancel:hover {
      background-color: #5a6268;
    }

    .modal.success .modal-header {
      background-color: rgba(76, 175, 80, 0.1);
    }

    .modal.error .modal-header {
      background-color: rgba(244, 67, 54, 0.1);
    }

    .modal.warning .modal-header {
      background-color: rgba(255, 193, 7, 0.1);
    }

    .modal.info .modal-header {
      background-color: rgba(33, 150, 243, 0.1);
    }

    /* Loading Modal */
    .loading-modal .modal-body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 152, 0, 0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .loading-text {
      font-size: 16px;
      color: var(--dark);
      text-align: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-title {
        font-size: 1rem;
      }
      
      body {
        font-size: 0.8rem;
      }
      
      .form-container {
        padding: 15px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .vehicle-options {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }

      .otp-input {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }

      .step-label {
        display: none;
      }

      .step-line {
        max-width: 30px;
      }
    }

    @media (max-width: 576px) {
      .container {
        padding: 10px;
      }
      
      .form-title {
        font-size: 1.3rem;
      }
      
      .vehicle-options {
        grid-template-columns: 1fr 1fr;
      }

      .modal {
        width: 95%;
        max-width: 95%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo-container">
      <div class="logo">JG</div>
      <div class="header-title">JeGo - Daftar Driver</div>
    </div>
    <a href="list.html" class="back-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Kembali
    </a>
  </div>

  <!-- Container -->
  <div class="container">
    <div class="form-container">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1">
          1
          <span class="step-label">Data Diri</span>
        </div>
        <div class="step-line" id="line1"></div>
        <div class="step" id="step2">
          2
          <span class="step-label">Verifikasi OTP</span>
        </div>
        <div class="step-line" id="line2"></div>
        <div class="step" id="step3">
          3
          <span class="step-label">Dokumen</span>
        </div>
      </div>

      <h1 class="form-title">Form Pendaftaran Driver</h1>
      
      <div class="status-message" id="statusMessage"></div>
      
      <!-- Step 1: Data Diri -->
      <div class="auth-step active" id="step1-content">
        <form id="driverFormStep1">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="fullName">Nama Lengkap *</label>
              <input type="text" class="form-input" id="fullName" placeholder="Masukkan nama lengkap" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="phoneNumber">Nomor Telepon *</label>
              <input type="tel" class="form-input" id="phoneNumber" placeholder="Contoh: +628123456789" required>
              <div class="phone-format">
                Format: <span class="example">+628123456789</span> (gunakan kode negara +62)
              </div>
              
              <!-- Phone Status Message -->
              <div id="phoneStatus" class="phone-status">
                <div class="phone-status-message">
                  <span id="phoneStatusIcon" class="phone-status-icon">‚ÑπÔ∏è</span>
                  <span id="phoneStatusText"></span>
                </div>
                <div id="phoneStatusActions" class="phone-status-actions"></div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="email">Email</label>
            <input type="email" class="form-input" id="email" placeholder="Contoh: nama@email.com">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="address">Alamat *</label>
            <input type="text" class="form-input" id="address" placeholder="Masukkan alamat lengkap" required>
          </div>
          
          <!-- Recaptcha Container -->
          <div id="recaptcha-container"></div>
          
          <button type="button" class="submit-btn" id="sendOtpBtn">Kirim Kode OTP</button>
        </form>
      </div>

      <!-- Step 2: Verifikasi OTP -->
      <div class="auth-step" id="step2-content">
        <h2 class="otp-title">Verifikasi Nomor Telepon</h2>
        
        <div class="otp-info">
          <p>Kami telah mengirimkan kode OTP 6 digit via SMS ke nomor Anda.</p>
          <p>Masukkan kode OTP untuk melanjutkan pendaftaran driver.</p>
        </div>
        
        <div class="form-group">
          <label>Nomor Telepon</label>
          <input type="text" id="verifiedPhone" class="form-input" readonly style="background-color: #f8f9fa;">
        </div>
        
        <div class="otp-input-container">
          <input type="text" class="otp-input" id="otp1" maxlength="1" data-index="0">
          <input type="text" class="otp-input" id="otp2" maxlength="1" data-index="1">
          <input type="text" class="otp-input" id="otp3" maxlength="1" data-index="2">
          <input type="text" class="otp-input" id="otp4" maxlength="1" data-index="3">
          <input type="text" class="otp-input" id="otp5" maxlength="1" data-index="4">
          <input type="text" class="otp-input" id="otp6" maxlength="1" data-index="5">
        </div>
        
        <button type="button" class="submit-btn" id="verifyOtpBtn">Verifikasi OTP</button>
        
        <div class="resend-otp">
          <span id="resendText">Tidak menerima kode? </span>
          <span class="resend-link" id="resendOtpLink">Kirim ulang OTP</span>
          <span id="countdownText" style="display: none;"> (Tunggu <span id="countdown">60</span> detik)</span>
        </div>
        
        <button type="button" class="submit-btn" style="background: var(--gray); margin-top: 10px;" id="backToStep1Btn">Kembali ke Data Diri</button>
      </div>

      <!-- Step 3: Dokumen -->
      <div class="auth-step" id="step3-content">
        <h2 class="form-title">Upload Dokumen Driver</h2>
        
        <form id="driverFormStep3">
          <div class="form-group">
            <label class="form-label">Jenis Kendaraan *</label>
            <div class="vehicle-options">
              <div class="vehicle-option" data-type="motor">
                <div class="vehicle-icon">üèçÔ∏è</div>
                <div class="vehicle-name">Motor</div>
                <div class="vehicle-capacity">1 Penumpang</div>
              </div>
              <div class="vehicle-option" data-type="bentor">
                <div class="vehicle-icon">üõ∫</div>
                <div class="vehicle-name">Bentor</div>
                <div class="vehicle-capacity">3 Penumpang</div>
              </div>
              <div class="vehicle-option" data-type="mobil">
                <div class="vehicle-icon">üöó</div>
                <div class="vehicle-name">Mobil</div>
                <div class="vehicle-capacity">4 Penumpang</div>
              </div>
            </div>
            <input type="hidden" id="vehicleType" required>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="vehicleBrand">Merk Kendaraan *</label>
              <input type="text" class="form-input" id="vehicleBrand" placeholder="Contoh: Honda Beat" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="plateNumber">Plat Nomor *</label>
              <input type="text" class="form-input" id="plateNumber" placeholder="Contoh: B 1234 ABC" required>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="idCardNumber">Nomor KTP *</label>
            <input type="text" class="form-input" id="idCardNumber" placeholder="Masukkan nomor KTP" required>
          </div>
          
          <!-- Profile Photo Upload -->
          <div class="form-group">
            <label class="form-label">Foto Profil *</label>
            <p style="font-size: 0.8rem; color: var(--gray); margin-bottom: 10px;">
              Upload foto profil (wajah jelas, latar belakang netral). Maksimal 2MB.
            </p>
            
            <div class="file-upload-container" id="profileUploadContainer">
              <div class="upload-icon">üì∑</div>
              <p>Klik atau drag foto profil ke sini</p>
              <input type="file" class="file-input" id="profileFile" accept="image/*" required>
              <div class="upload-progress" id="profileProgress">
                <div class="upload-progress-bar" id="profileProgressBar"></div>
              </div>
            </div>
            <div class="file-preview" id="profilePreview"></div>
          </div>
          
          <!-- Document Upload Section -->
          <div class="form-group">
            <label class="form-label">Dokumen Pendukung *</label>
            <p style="font-size: 0.8rem; color: var(--gray); margin-bottom: 10px;">
              Upload foto KTP, SIM, dan STNK. Maksimal 2MB per file.
            </p>
            
            <!-- KTP Upload -->
            <div class="form-group">
              <label class="form-label">Foto KTP *</label>
              <div class="file-upload-container" id="ktpUploadContainer">
                <div class="upload-icon">üìÑ</div>
                <p>Klik atau drag file KTP ke sini</p>
                <input type="file" class="file-input" id="ktpFile" accept="image/*" required>
                <div class="upload-progress" id="ktpProgress">
                  <div class="upload-progress-bar" id="ktpProgressBar"></div>
                </div>
              </div>
              <div class="file-preview" id="ktpPreview"></div>
            </div>
            
            <!-- SIM Upload -->
            <div class="form-group">
              <label class="form-label">Foto SIM *</label>
              <div class="file-upload-container" id="simUploadContainer">
                <div class="upload-icon">üìÑ</div>
                <p>Klik atau drag file SIM ke sini</p>
                <input type="file" class="file-input" id="simFile" accept="image/*" required>
                <div class="upload-progress" id="simProgress">
                  <div class="upload-progress-bar" id="simProgressBar"></div>
                </div>
              </div>
              <div class="file-preview" id="simPreview"></div>
            </div>
            
            <!-- STNK Upload -->
            <div class="form-group">
              <label class="form-label">Foto STNK *</label>
              <div class="file-upload-container" id="stnkUploadContainer">
                <div class="upload-icon">üìÑ</div>
                <p>Klik atau drag file STNK ke sini</p>
                <input type="file" class="file-input" id="stnkFile" accept="image/*" required>
                <div class="upload-progress" id="stnkProgress">
                  <div class="upload-progress-bar" id="stnkProgressBar"></div>
                </div>
              </div>
              <div class="file-preview" id="stnkPreview"></div>
            </div>
          </div>
          
          <div class="terms-container">
            <div class="terms-title">Syarat dan Ketentuan JeGo Driver</div>
            <div class="terms-content">
              <p>1. Driver harus memiliki SIM yang masih berlaku sesuai dengan jenis kendaraan yang digunakan.</p>
              <p>2. Kendaraan harus dalam kondisi baik, layak jalan, dan memiliki STNK yang masih berlaku.</p>
              <p>3. Driver harus berperilaku sopan dan menjaga etika selama melayani customer.</p>
              <p>4. Driver dilarang menolak order tanpa alasan yang jelas.</p>
              <p>5. Driver harus mematuhi peraturan lalu lintas yang berlaku.</p>
              <p>6. Driver bertanggung jawab atas keamanan dan keselamatan customer selama perjalanan.</p>
              <p>7. JeGo berhak menonaktifkan akun driver yang melanggar syarat dan ketentuan.</p>
              <p>8. Driver akan dikenakan sanksi jika melakukan penipuan atau tindakan yang merugikan customer.</p>
              <p>9. Semua transaksi harus dilakukan melalui aplikasi JeGo.</p>
              <p>10. Driver setuju untuk memberikan data pribadi yang diperlukan untuk keperluan verifikasi.</p>
            </div>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="agreeTerms" required>
            <label for="agreeTerms">Saya telah membaca dan menyetujui Syarat dan Ketentuan JeGo Driver</label>
          </div>
          
          <button type="submit" class="submit-btn" id="submitBtn">Daftar sebagai Driver</button>
        </form>
      </div>
      
      <!-- Success Section -->
      <div class="success-section" id="successSection">
        <div class="success-icon">‚úÖ</div>
        <h2 class="success-title">Pendaftaran Berhasil!</h2>
        
        <div class="success-message">
          <p>Terima kasih telah mendaftar sebagai driver JeGo.</p>
          <p>Data Anda sedang diverifikasi oleh admin. Proses verifikasi membutuhkan waktu 1-2 hari kerja.</p>
          <p>Anda akan menerima notifikasi via WhatsApp setelah verifikasi selesai.</p>
        </div>
        
        <button class="whatsapp-btn" id="whatsappBtn">
          <span class="whatsapp-icon">üì±</span>
          Hubungi Admin JeGo
        </button>
        
        <p style="font-size: 0.8rem; color: #666; margin-top: 15px;">
          Nomor Admin: 083142889149<br>
          Jam Operasional: 08:00 - 17:00 WITA
        </p>
        
        <a href="list.html" class="submit-btn" style="background: var(--gray); margin-top: 10px;">
          Kembali ke Halaman Utama
        </a>
      </div>
    </div>
  </div>

  <!-- Modal Popup -->
  <div id="modalOverlay" class="modal-overlay">
    <div id="modal" class="modal">
      <div class="modal-header">
        <h3 class="modal-title">
          <span id="modalIcon" class="modal-icon">!</span>
          <span id="modalTitleText">Judul Modal</span>
        </h3>
        <button id="modalCloseBtn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <p id="modalMessage">Isi pesan modal akan ditampilkan di sini.</p>
      </div>
      <div class="modal-footer">
        <button id="modalCancelBtn" class="modal-btn cancel" style="display: none;">Batal</button>
        <button id="modalConfirmBtn" class="modal-btn confirm">OK</button>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="modal-overlay">
    <div class="modal loading-modal">
      <div class="modal-body">
        <div class="loading-spinner"></div>
        <p id="loadingText" class="loading-text">Sedang memproses...</p>
      </div>
    </div>
  </div>

  <script>
    // ================================================
    // KONFIGURASI
    // ================================================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
      authDomain: "game-balap-simpel.firebaseapp.com",
      databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
      projectId: "game-balap-simpel",
      storageBucket: "game-balap-simpel.firebasestorage.app",
      messagingSenderId: "864576853495",
      appId: "1:864576853495:web:6f16eb757fd3d8affb0af2",
      measurementId: "G-YWJPK7Y3J4"
    };

    // ================================================
    // INISIALISASI FIREBASE
    // ================================================
    firebase.initializeApp(FIREBASE_CONFIG);
    const database = firebase.database();
    const storage = firebase.storage();
    const auth = firebase.auth();

    // ================================================
    // VARIABEL GLOBAL
    // ================================================
    let recaptchaVerifier = null;
    let confirmationResult = null;
    let otpTimer = null;
    let otpCountdown = 60;
    let driverData = null;
    let firebaseUser = null;
    let currentStep = 1;

    // ================================================
    // ELEMEN DOM
    // ================================================
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const line1 = document.getElementById('line1');
    const line2 = document.getElementById('line2');
    
    const step1Content = document.getElementById('step1-content');
    const step2Content = document.getElementById('step2-content');
    const step3Content = document.getElementById('step3-content');
    
    const phoneStatus = document.getElementById('phoneStatus');
    const phoneStatusIcon = document.getElementById('phoneStatusIcon');
    const phoneStatusText = document.getElementById('phoneStatusText');
    const phoneStatusActions = document.getElementById('phoneStatusActions');
    
    const modalOverlay = document.getElementById('modalOverlay');
    const modal = document.getElementById('modal');
    const modalIcon = document.getElementById('modalIcon');
    const modalTitleText = document.getElementById('modalTitleText');
    const modalMessage = document.getElementById('modalMessage');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const loadingModal = document.getElementById('loadingModal');
    const loadingText = document.getElementById('loadingText');
    const recaptchaContainer = document.getElementById('recaptcha-container');
    const verifiedPhoneInput = document.getElementById('verifiedPhone');
    const resendOtpLink = document.getElementById('resendOtpLink');
    const countdownText = document.getElementById('countdownText');
    const countdownElement = document.getElementById('countdown');

    // ================================================
    // FUNGSI UTILITAS
    // ================================================
    
    function showPopup(title, message, type = 'info', options = {}) {
      modalTitleText.textContent = title;
      modalMessage.innerHTML = message;
      modal.className = 'modal ' + type;
      modalIcon.className = 'modal-icon ' + type;
      modalIcon.textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '!' : 'i';
      modalConfirmBtn.textContent = options.confirmText || 'OK';
      
      if (options.showCancel) {
        modalCancelBtn.style.display = 'inline-block';
        modalCancelBtn.textContent = options.cancelText || 'Batal';
      } else {
        modalCancelBtn.style.display = 'none';
      }
      
      modalConfirmBtn.onclick = function() {
        hidePopup();
        if (options.onConfirm) options.onConfirm();
      };
      
      modalCancelBtn.onclick = function() {
        hidePopup();
        if (options.onCancel) options.onCancel();
      };
      
      modalCloseBtn.onclick = function() {
        hidePopup();
        if (options.onCancel) options.onCancel();
      };
      
      modalOverlay.classList.add('active');
      
      if (options.autoHide) {
        setTimeout(() => {
          hidePopup();
          if (options.onAutoHide) options.onAutoHide();
        }, options.autoHideDelay || 3000);
      }
    }
    
    function hidePopup() {
      modalOverlay.classList.remove('active');
    }
    
    function showLoading(message = 'Sedang memproses...') {
      loadingText.textContent = message;
      loadingModal.classList.add('active');
    }
    
    function hideLoading() {
      loadingModal.classList.remove('active');
    }
    
    function showErrorMessage(message) {
      showPopup('Error', message, 'error');
    }
    
    function showSuccessMessage(message, autoHide = false) {
      showPopup('Sukses', message, 'success', { autoHide: autoHide, autoHideDelay: 2000 });
    }
    
    function showInfoMessage(message, autoHide = false) {
      showPopup('Informasi', message, 'info', { autoHide: autoHide, autoHideDelay: 3000 });
    }
    
    function formatPhoneNumber(phone) {
      let cleaned = phone.replace(/\D/g, '');
      if (cleaned.startsWith('0')) {
        cleaned = '+62' + cleaned.substring(1);
      } else if (cleaned.startsWith('62')) {
        cleaned = '+' + cleaned;
      } else if (!cleaned.startsWith('+')) {
        cleaned = '+62' + cleaned;
      }
      return cleaned;
    }
    
    function validatePhoneFormat(phone) {
      const phoneRegex = /^\+62[0-9]{9,12}$/;
      return phoneRegex.test(phone);
    }
    
    function showPhoneStatus(type, message, phoneInfo = null) {
      phoneStatus.className = 'phone-status';
      phoneStatusActions.innerHTML = '';
      
      if (type === 'available') {
        phoneStatus.classList.add('available');
        phoneStatusIcon.textContent = '‚úÖ';
        phoneStatusText.textContent = message;
      } 
      else if (type === 'registered') {
        phoneStatus.classList.add('registered');
        phoneStatusIcon.textContent = '‚ÑπÔ∏è';
        phoneStatusText.textContent = message;
        
        if (phoneInfo) {
          if (phoneInfo.type === 'user') {
            // User ditemukan - BOLEH daftar sebagai driver
            const continueBtn = document.createElement('button');
            continueBtn.className = 'phone-status-btn primary';
            continueBtn.textContent = 'Lanjutkan Daftar Driver';
            continueBtn.onclick = () => {
              phoneStatus.style.display = 'none';
            };
            phoneStatusActions.appendChild(continueBtn);
          } else if (phoneInfo.type === 'driver') {
            // Driver ditemukan - TIDAK BOLEH daftar ulang
            const status = phoneInfo.status || 'pending';
            
            if (status === 'approved' || status === 'active') {
              const loginBtn = document.createElement('button');
              loginBtn.className = 'phone-status-btn primary';
              loginBtn.textContent = 'Login Driver';
              loginBtn.onclick = () => {
                window.location.href = 'loginDriver.html?phone=' + encodeURIComponent(document.getElementById('phoneNumber').value);
              };
              phoneStatusActions.appendChild(loginBtn);
            }
            
            // Tombol ganti nomor untuk semua kasus
            const clearBtn = document.createElement('button');
            clearBtn.className = 'phone-status-btn secondary';
            clearBtn.textContent = 'Ganti Nomor';
            clearBtn.onclick = () => {
              document.getElementById('phoneNumber').value = '';
              document.getElementById('phoneNumber').focus();
              phoneStatus.style.display = 'none';
            };
            phoneStatusActions.appendChild(clearBtn);
          }
        }
      }
      else if (type === 'error') {
        phoneStatus.classList.add('error');
        phoneStatusIcon.textContent = '‚ùå';
        phoneStatusText.textContent = message;
      }
      
      phoneStatus.style.display = 'block';
    }
    
    function hidePhoneStatus() {
      phoneStatus.style.display = 'none';
    }
    
    function setupOTPInputs() {
      const otpInputs = document.querySelectorAll('.otp-input');
      otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value;
          if (!/^\d*$/.test(value)) {
            e.target.value = '';
            return;
          }
          if (value.length === 1) {
            e.target.classList.add('filled');
            if (index < otpInputs.length - 1) otpInputs[index + 1].focus();
          } else {
            e.target.classList.remove('filled');
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
          }
        });
        
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text').trim();
          if (/^\d{6}$/.test(pastedData)) {
            for (let i = 0; i < 6; i++) {
              otpInputs[i].value = pastedData[i];
              otpInputs[i].classList.add('filled');
            }
            otpInputs[5].focus();
          }
        });
      });
    }
    
    function getEnteredOTP() {
      let otp = '';
      for (let i = 1; i <= 6; i++) {
        otp += document.getElementById(`otp${i}`).value;
      }
      return otp;
    }
    
    function clearOTPInputs() {
      for (let i = 1; i <= 6; i++) {
        document.getElementById(`otp${i}`).value = '';
        document.getElementById(`otp${i}`).classList.remove('filled');
      }
    }
    
    function startResendCountdown(seconds) {
      resendOtpLink.classList.add('disabled');
      countdownText.style.display = 'inline';
      otpCountdown = seconds;
      countdownElement.textContent = otpCountdown;
      
      if (otpTimer) clearInterval(otpTimer);
      
      otpTimer = setInterval(() => {
        otpCountdown--;
        countdownElement.textContent = otpCountdown;
        
        if (otpCountdown <= 0) {
          clearInterval(otpTimer);
          resendOtpLink.classList.remove('disabled');
          countdownText.style.display = 'none';
        }
      }, 1000);
    }
    
    // ================================================
    // FUNGSI NAVIGASI STEP
    // ================================================
    
    function goToStep(step) {
      step1Content.classList.remove('active');
      step2Content.classList.remove('active');
      step3Content.classList.remove('active');
      
      step1.classList.remove('active', 'completed');
      step2.classList.remove('active', 'completed');
      step3.classList.remove('active', 'completed');
      line1.classList.remove('active');
      line2.classList.remove('active');
      
      currentStep = step;
      
      switch(step) {
        case 1:
          step1Content.classList.add('active');
          step1.classList.add('active');
          break;
          
        case 2:
          step2Content.classList.add('active');
          step1.classList.add('completed');
          step2.classList.add('active');
          line1.classList.add('active');
          break;
          
        case 3:
          step3Content.classList.add('active');
          step1.classList.add('completed');
          step2.classList.add('completed');
          step3.classList.add('active');
          line1.classList.add('active');
          line2.classList.add('active');
          break;
      }
    }
    
    // ================================================
    // FIREBASE FUNCTIONS (KONSISTEN DENGAN USER)
    // ================================================
    
    function setupRecaptcha() {
      try {
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          'size': 'normal',
          'callback': function(response) {
            console.log('‚úÖ reCAPTCHA verified');
          },
          'expired-callback': function() {
            console.log('‚ùå reCAPTCHA expired');
            showErrorMessage('reCAPTCHA telah kadaluarsa. Silakan coba lagi.');
          }
        });
        
        recaptchaVerifier.render();
        console.log('‚úÖ reCAPTCHA diatur');
      } catch (error) {
        console.error('‚ùå Error setting up reCAPTCHA:', error);
        showErrorMessage('Gagal mengatur reCAPTCHA. Silakan refresh halaman.');
      }
    }
    
    async function sendFirebaseOTP(phoneNumber) {
      try {
        showLoading('Mengirim kode OTP...');
        
        if (!recaptchaVerifier) {
          throw new Error('reCAPTCHA belum diatur');
        }
        
        confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifier);
        
        hideLoading();
        console.log('‚úÖ Kode OTP dikirim via Firebase');
        showInfoMessage('Kode OTP telah dikirim via SMS. Silakan periksa pesan SMS Anda.', true);
        return true;
      } catch (error) {
        hideLoading();
        console.error('‚ùå Error sending OTP:', error);
        
        let errorMessage = 'Gagal mengirim kode OTP. ';
        switch (error.code) {
          case 'auth/invalid-phone-number':
            errorMessage += 'Format nomor telepon tidak valid.';
            break;
          case 'auth/too-many-requests':
            errorMessage += 'Terlalu banyak permintaan. Silakan coba lagi nanti.';
            break;
          case 'auth/quota-exceeded':
            errorMessage += 'Kuota SMS telah habis. Silakan hubungi administrator.';
            break;
          default:
            errorMessage += error.message || 'Silakan coba lagi.';
        }
        
        showErrorMessage(errorMessage);
        return false;
      }
    }
    
    async function verifyFirebaseOTP(code) {
      try {
        showLoading('Memverifikasi OTP...');
        
        if (!confirmationResult) {
          throw new Error('Sesi OTP tidak valid. Silakan minta OTP baru.');
        }
        
        const userCredential = await confirmationResult.confirm(code);
        const user = userCredential.user;
        
        hideLoading();
        console.log('‚úÖ OTP verified, user:', user.uid);
        return user;
      } catch (error) {
        hideLoading();
        console.error('‚ùå Error verifying OTP:', error);
        
        let errorMessage = 'Gagal memverifikasi OTP. ';
        switch (error.code) {
          case 'auth/invalid-verification-code':
            errorMessage += 'Kode OTP tidak valid.';
            break;
          case 'auth/code-expired':
            errorMessage += 'Kode OTP telah kadaluarsa.';
            break;
          default:
            errorMessage += error.message || 'Silakan coba lagi.';
        }
        
        showErrorMessage(errorMessage);
        return null;
      }
    }
    
    // ================================================
    // FUNGSI DATABASE (KONSISTEN DENGAN USER)
    // ================================================
    
    async function checkPhoneNumberExists(phoneNumber) {
      try {
        console.log('üîç Checking phone in database:', phoneNumber);
        
        // 1. Cek di DRIVERS terlebih dahulu (untuk pendaftaran driver)
        const driversSnapshot = await database.ref('drivers')
          .orderByChild('phone')
          .equalTo(phoneNumber)
          .once('value');
        
        const driversData = driversSnapshot.val();
        
        if (driversData) {
          const driverId = Object.keys(driversData)[0];
          const driverData = driversData[driverId];
          const status = driverData.status || 'pending';
          
          return {
            exists: true,
            user: driverData,
            userId: driverId,
            type: 'driver',
            status: status,
            canRegisterAsDriver: false // TIDAK BOLEH DAFTAR LAGI
          };
        }
        
        // 2. Jika tidak ada di drivers, cek di users
        const usersSnapshot = await database.ref('users')
          .orderByChild('phone')
          .equalTo(phoneNumber)
          .once('value');
        
        const usersData = usersSnapshot.val();
        
        if (usersData) {
          const userId = Object.keys(usersData)[0];
          const userData = usersData[userId];
          
          // User ditemukan, tapi OTOMATIS BOLEH daftar sebagai driver
          // dengan nomor yang sama (satu nomor bisa untuk user dan driver)
          return {
            exists: true,
            user: userData,
            userId: userId,
            type: 'user',
            canRegisterAsDriver: true // Flag khusus
          };
        }
        
        // 3. Tidak ditemukan sama sekali
        return { 
          exists: false,
          canRegisterAsDriver: true // Boleh daftar
        };
        
      } catch (error) {
        console.error('‚ùå Error checking phone number:', error);
        return { 
          exists: false, 
          error: error.message,
          canRegisterAsDriver: true // Default boleh daftar
        };
      }
    }
    
    async function saveDriverToDatabase(uid, userData, additionalData) {
      try {
        console.log('üíæ Saving driver to database:', uid);
        
        // Cek apakah driver sudah ada di database
        const driverRef = database.ref('drivers/' + uid);
        const snapshot = await driverRef.once('value');
        
        if (snapshot.exists()) {
          console.log('‚ÑπÔ∏è Driver already exists in database, skipping save');
          return {
            success: true,
            message: 'Driver already exists',
            isNewDriver: false,
            driverData: snapshot.val()
          };
        }
        
        // Buat data driver baru dengan struktur konsisten
        const now = new Date();
        const driverProfile = {
          // Data dari auth (sama dengan user)
          firebase_key: uid,
          uid: uid,
          active: true,
          status: "pending", // Status awal pending untuk driver
          role: "driver",
          name: userData.fullName,
          phone: userData.phoneNumber,
          email: userData.email || "",
          address: userData.address || "",
          fotoProfilURL: "",
          fotoProfilStorage: "default",
          rating: 5,
          perjalanan: 0,
          createdAt: now.toISOString(),
          createdDate: now.toISOString().split('T')[0],
          updatedAt: now.toISOString(),
          
          // Data khusus driver
          vehicleType: additionalData.vehicleType || "",
          vehicleBrand: additionalData.vehicleBrand || "",
          plateNumber: additionalData.plateNumber || "",
          idCardNumber: additionalData.idCardNumber || "",
          driverStatus: "pending", // pending, approved, rejected, blocked
          Balance: 10000,
          Potongan: 10,
          totalOrders: 0,
          completedOrders: 0,
          totalEarnings: 0,
          avgRating: 5.0,
          ratingCount: 1,
          completionRate: '0%',
          isOnline: false,
          onTrip: false,
          
          // URL dokumen (akan diisi setelah upload)
          profilePhotoUrl: additionalData.profilePhotoUrl || "",
          ktpPhotoUrl: additionalData.ktpPhotoUrl || "",
          simPhotoUrl: additionalData.simPhotoUrl || "",
          stnkPhotoUrl: additionalData.stnkPhotoUrl || ""
        };
        
        // Simpan ke database
        await driverRef.set(driverProfile);
        
        console.log('‚úÖ Driver saved to database');
        return {
          success: true,
          message: 'Driver created successfully',
          isNewDriver: true,
          driverData: driverProfile
        };
      } catch (error) {
        console.error('‚ùå Error saving driver to database:', error);
        throw error;
      }
    }
    
    // ================================================
    // FUNGSI CEK STATUS DRIVER
    // ================================================
    
    async function checkDriverStatus() {
      try {
        const user = auth.currentUser;
        
        if (!user) {
          return;
        }
        
        const driversSnapshot = await database.ref('drivers')
          .orderByChild('uid')
          .equalTo(user.uid)
          .once('value');
        
        const driversData = driversSnapshot.val();
        
        if (!driversData) {
          return;
        }
        
        const driverId = Object.keys(driversData)[0];
        const driverData = driversData[driverId];
        const status = driverData.status || 'pending';
        
        switch(status) {
          case 'approved':
          case 'active':
            window.location.href = 'driverDashboard.html';
            break;
            
          case 'rejected':
            hideAllForms();
            showPopup('Pendaftaran Ditolak', 
              'Pendaftaran Anda telah ditolak oleh admin.<br><br>' +
              'Alasan: ' + (driverData.rejectionReason || 'Tidak memenuhi syarat') + '<br>' +
              'Silakan hubungi admin untuk informasi lebih lanjut.',
              'error');
            break;
            
          case 'blocked':
            hideAllForms();
            showPopup('Akun Diblokir',
              'Akun Anda telah diblokir oleh admin.<br><br>' +
              'Alasan: ' + (driverData.blockReason || 'Melanggar aturan') + '<br>' +
              'Hubungi admin untuk mengajukan pembukaan blokir.',
              'error');
            break;
            
          case 'pending':
            hideAllForms();
            document.getElementById('successSection').style.display = 'block';
            showInfoMessage('Status: Menunggu verifikasi admin.');
            break;
        }
      } catch (error) {
        console.error('‚ùå Error checking driver status:', error);
      }
    }
    
    function hideAllForms() {
      document.getElementById('step1-content').style.display = 'none';
      document.getElementById('step2-content').style.display = 'none';
      document.getElementById('step3-content').style.display = 'none';
      document.getElementById('successSection').style.display = 'none';
    }
    
    // ================================================
    // FILE UPLOAD FUNCTIONS
    // ================================================
    
    function setupFileUpload(uploadContainerId, fileInputId, previewId, progressId, progressBarId) {
      const uploadContainer = document.getElementById(uploadContainerId);
      const fileInput = document.getElementById(fileInputId);
      const preview = document.getElementById(previewId);
      const progress = document.getElementById(progressId);
      const progressBar = document.getElementById(progressBarId);
      
      uploadContainer.addEventListener('click', () => {
        fileInput.click();
      });
      
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 2 * 1024 * 1024) {
            showErrorMessage('File terlalu besar. Maksimal 2MB');
            fileInput.value = '';
            return;
          }
          
          if (!file.type.startsWith('image/')) {
            showErrorMessage('File harus berupa gambar');
            fileInput.value = '';
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (e) => {
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadContainer.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        uploadContainer.classList.add('dragover');
      }
      
      function unhighlight() {
        uploadContainer.classList.remove('dragover');
      }
      
      uploadContainer.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          const file = files[0];
          
          if (file.size > 2 * 1024 * 1024) {
            showErrorMessage('File terlalu besar. Maksimal 2MB');
            return;
          }
          
          if (!file.type.startsWith('image/')) {
            showErrorMessage('File harus berupa gambar');
            return;
          }
          
          fileInput.files = files;
          fileInput.dispatchEvent(new Event('change'));
        }
      }
      
      return {
        uploadContainer,
        fileInput,
        preview,
        progress,
        progressBar
      };
    }
    
    async function uploadFile(file, path, progressBar) {
      return new Promise((resolve, reject) => {
        const metadata = {
          contentType: file.type,
          customMetadata: {
            uploadedBy: 'driver_registration',
            timestamp: Date.now().toString()
          }
        };
        
        const storageRef = storage.ref(path);
        const uploadTask = storageRef.put(file, metadata);
        
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            console.log(`Upload is ${progress}% done`);
            
            if (progressBar) {
              progressBar.style.width = progress + '%';
            }
          },
          (error) => {
            console.error('Upload error:', error);
            reject(error);
          },
          async () => {
            try {
              const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
              resolve(downloadURL);
            } catch (error) {
              reject(error);
            }
          }
        );
      });
    }
    
    // ================================================
    // VALIDASI DATA
    // ================================================
    
    function validateDriverData(formData) {
      const requiredFields = [
        'fullName', 'phoneNumber', 'address', 'vehicleType', 
        'vehicleBrand', 'plateNumber', 'idCardNumber'
      ];
      
      for (const field of requiredFields) {
        if (!formData[field] || formData[field].trim() === '') {
          return `Field ${field} harus diisi`;
        }
      }
      
      const phoneRegex = /^[0-9]{10,}$/;
      if (!phoneRegex.test(formData.phoneNumber.replace(/\D/g, ''))) {
        return 'Nomor telepon tidak valid';
      }
      
      if (formData.email && formData.email.trim() !== '') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
          return 'Format email tidak valid';
        }
      }
      
      const idCardRegex = /^[0-9]{16,}$/;
      if (!idCardRegex.test(formData.idCardNumber.replace(/\D/g, ''))) {
        return 'Nomor KTP harus terdiri dari 16 digit angka';
      }
      
      return null;
    }
    
    // ================================================
    // EVENT HANDLERS
    // ================================================
    
    document.getElementById('phoneNumber').addEventListener('input', function() {
      hidePhoneStatus();
      
      const rawPhone = this.value.trim();
      if (!rawPhone) return;
      
      const formattedPhone = formatPhoneNumber(rawPhone);
      
      if (!validatePhoneFormat(formattedPhone)) {
        return;
      }
      
      // Debounce untuk mengurangi request berlebihan
      clearTimeout(this.checkTimeout);
      this.checkTimeout = setTimeout(async () => {
        try {
          const phoneInfo = await checkPhoneNumberExists(formattedPhone);
          
          if (phoneInfo.exists) {
            if (phoneInfo.type === 'driver') {
              const nama = phoneInfo.user?.name || phoneInfo.user?.fullName || 'Driver';
              const status = phoneInfo.status || 'pending';
              let message = `Nomor ${formattedPhone} sudah terdaftar sebagai driver atas nama ${nama}.`;
              
              if (status === 'pending') {
                message += ' Status: Menunggu verifikasi admin.';
              } else if (status === 'approved' || status === 'active') {
                message += ' Status: Sudah aktif. Silakan login.';
              } else if (status === 'rejected') {
                message += ' Status: Ditolak. Hubungi admin untuk informasi lebih lanjut.';
              } else if (status === 'blocked') {
                message += ' Status: Diblokir. Hubungi admin untuk mengajukan pembukaan blokir.';
              }
              
              // Tampilkan status dengan tombol login/ganti nomor
              showPhoneStatus('registered', message, phoneInfo);
            } else if (phoneInfo.type === 'user') {
              const nama = phoneInfo.user?.name || phoneInfo.user?.fullName || 'User';
              // User ditemukan - BOLEH daftar sebagai driver
              showPhoneStatus('registered', 
                `Nomor ${formattedPhone} sudah terdaftar sebagai user atas nama ${nama}. Anda dapat mendaftar sebagai driver dengan nomor ini.`, 
                phoneInfo
              );
            }
          } else {
            showPhoneStatus('available', `Nomor ${formattedPhone} tersedia untuk pendaftaran driver.`, null);
          }
        } catch (error) {
          console.error('Error checking phone:', error);
          showPhoneStatus('error', 'Gagal memeriksa nomor telepon. Silakan coba lagi.', null);
        }
      }, 800);
    });
    
    document.getElementById('sendOtpBtn').addEventListener('click', async function() {
      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      let phoneNumber = document.getElementById('phoneNumber').value.trim();
      const address = document.getElementById('address').value.trim();
      
      if (!fullName || !phoneNumber || !address) {
        showErrorMessage('Harap isi semua field yang wajib diisi (Nama, Telepon, Alamat).');
        return;
      }
      
      phoneNumber = formatPhoneNumber(phoneNumber);
      
      if (!validatePhoneFormat(phoneNumber)) {
        showErrorMessage('Format nomor telepon tidak valid. Gunakan format: +628123456789');
        return;
      }
      
      // CEK STATUS NOMOR TELEPON - PERUBAHAN PENTING!
      try {
        showLoading('Memeriksa nomor telepon...');
        const phoneInfo = await checkPhoneNumberExists(phoneNumber);
        hideLoading();
        
        // JIKA SUDAH TERDAFTAR SEBAGAI DRIVER (APAPUN STATUSNYA) - TOLAK!
        if (phoneInfo.exists && phoneInfo.type === 'driver') {
          const status = phoneInfo.status || 'pending';
          let errorMsg = `Nomor ${phoneNumber} sudah terdaftar sebagai driver.`;
          
          if (status === 'approved' || status === 'active') {
            errorMsg += " Status: Aktif. Silakan login di halaman login driver.";
            showErrorMessage(errorMsg, {
              onConfirm: () => {
                window.location.href = 'loginDriver.html';
              }
            });
          } else if (status === 'pending') {
            errorMsg += " Status: Menunggu verifikasi admin.";
            showErrorMessage(errorMsg);
          } else if (status === 'rejected') {
            errorMsg += " Status: Ditolak. Hubungi admin untuk informasi lebih lanjut.";
            showErrorMessage(errorMsg);
          } else if (status === 'blocked') {
            errorMsg += " Status: Diblokir. Hubungi admin untuk mengajukan pembukaan blokir.";
            showErrorMessage(errorMsg);
          }
          return; // STOP PROSES - TIDAK BOLEH LANJUT
        }
        
        // Jika user ditemukan, TETAP BOLEH lanjut (satu nomor untuk user dan driver)
        // Tidak ada return di sini, biarkan lanjut
        
      } catch (error) {
        hideLoading();
        console.error('Error checking phone:', error);
        showErrorMessage('Gagal memeriksa nomor telepon. Silakan coba lagi.');
        return;
      }
      
      driverData = {
        fullName: fullName,
        email: email,
        phoneNumber: phoneNumber,
        address: address
      };
      
      const otpSent = await sendFirebaseOTP(phoneNumber);
      
      if (otpSent) {
        verifiedPhoneInput.value = phoneNumber;
        goToStep(2);
        document.getElementById('otp1').focus();
        startResendCountdown(60);
      }
    });
    
    document.getElementById('verifyOtpBtn').addEventListener('click', async function() {
      const enteredOtp = getEnteredOTP();
      
      if (enteredOtp.length !== 6) {
        showErrorMessage('Harap masukkan kode OTP 6 digit lengkap.');
        return;
      }
      
      if (!driverData) {
        showErrorMessage('Data tidak ditemukan. Silakan mulai ulang pendaftaran.');
        return;
      }
      
      document.getElementById('verifyOtpBtn').disabled = true;
      document.getElementById('verifyOtpBtn').textContent = 'Memverifikasi...';
      
      const user = await verifyFirebaseOTP(enteredOtp);
      
      if (!user) {
        document.getElementById('verifyOtpBtn').disabled = false;
        document.getElementById('verifyOtpBtn').textContent = 'Verifikasi OTP';
        return;
      }
      
      firebaseUser = user;
      goToStep(3);
      document.getElementById('verifyOtpBtn').disabled = false;
      document.getElementById('verifyOtpBtn').textContent = 'Verifikasi OTP';
      showSuccessMessage('Verifikasi berhasil! Silakan lengkapi data kendaraan dan dokumen.', true);
    });
    
    resendOtpLink.addEventListener('click', async function() {
      if (resendOtpLink.classList.contains('disabled')) return;
      
      if (!driverData) {
        showErrorMessage('Data tidak ditemukan.');
        return;
      }
      
      const otpSent = await sendFirebaseOTP(driverData.phoneNumber);
      
      if (otpSent) {
        clearOTPInputs();
        document.getElementById('otp1').focus();
        startResendCountdown(60);
      }
    });
    
    document.getElementById('backToStep1Btn').addEventListener('click', function() {
      goToStep(1);
    });
    
    document.querySelectorAll('.vehicle-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('.vehicle-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        this.classList.add('selected');
        document.getElementById('vehicleType').value = this.getAttribute('data-type');
      });
    });
    
    const profileUpload = setupFileUpload('profileUploadContainer', 'profileFile', 'profilePreview', 'profileProgress', 'profileProgressBar');
    const ktpUpload = setupFileUpload('ktpUploadContainer', 'ktpFile', 'ktpPreview', 'ktpProgress', 'ktpProgressBar');
    const simUpload = setupFileUpload('simUploadContainer', 'simFile', 'simPreview', 'simProgress', 'simProgressBar');
    const stnkUpload = setupFileUpload('stnkUploadContainer', 'stnkFile', 'stnkPreview', 'stnkProgress', 'stnkProgressBar');
    
    document.getElementById('driverFormStep3').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Mendaftarkan...';
      
      try {
        const requiredFiles = [
          { name: 'Foto Profil', file: profileUpload.fileInput.files[0], upload: profileUpload },
          { name: 'KTP', file: ktpUpload.fileInput.files[0], upload: ktpUpload },
          { name: 'SIM', file: simUpload.fileInput.files[0], upload: simUpload },
          { name: 'STNK', file: stnkUpload.fileInput.files[0], upload: stnkUpload }
        ];
        
        for (const reqFile of requiredFiles) {
          if (!reqFile.file) {
            showErrorMessage(`Harap upload ${reqFile.name}`);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Daftar sebagai Driver';
            return;
          }
        }
        
        const formData = {
          ...driverData,
          vehicleType: document.getElementById('vehicleType').value,
          vehicleBrand: document.getElementById('vehicleBrand').value.trim(),
          plateNumber: document.getElementById('plateNumber').value.trim(),
          idCardNumber: document.getElementById('idCardNumber').value.trim(),
          profilePhotoUrl: '',
          ktpPhotoUrl: '',
          simPhotoUrl: '',
          stnkPhotoUrl: ''
        };
        
        const validationError = validateDriverData(formData);
        if (validationError) {
          showErrorMessage(validationError);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Daftar sebagai Driver';
          return;
        }
        
        showLoading('Mengupload foto dan dokumen...');
        
        const uploadPromises = [];
        const uploadResults = {};
        
        profileUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            profileUpload.fileInput.files[0], 
            `drivers/${firebaseUser.uid}/profile_${Date.now()}.jpg`,
            profileUpload.progressBar
          ).then(url => { uploadResults.profilePhotoUrl = url; })
        );
        
        ktpUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            ktpUpload.fileInput.files[0], 
            `drivers/${firebaseUser.uid}/ktp_${Date.now()}.jpg`,
            ktpUpload.progressBar
          ).then(url => { uploadResults.ktpPhotoUrl = url; })
        );
        
        simUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            simUpload.fileInput.files[0], 
            `drivers/${firebaseUser.uid}/sim_${Date.now()}.jpg`,
            simUpload.progressBar
          ).then(url => { uploadResults.simPhotoUrl = url; })
        );
        
        stnkUpload.progress.style.display = 'block';
        uploadPromises.push(
          uploadFile(
            stnkUpload.fileInput.files[0], 
            `drivers/${firebaseUser.uid}/stnk_${Date.now()}.jpg`,
            stnkUpload.progressBar
          ).then(url => { uploadResults.stnkPhotoUrl = url; })
        );
        
        await Promise.all(uploadPromises);
        
        // Update formData dengan URL yang sudah diupload
        formData.profilePhotoUrl = uploadResults.profilePhotoUrl;
        formData.ktpPhotoUrl = uploadResults.ktpPhotoUrl;
        formData.simPhotoUrl = uploadResults.simPhotoUrl;
        formData.stnkPhotoUrl = uploadResults.stnkPhotoUrl;
        
        await saveDriverToDatabase(firebaseUser.uid, driverData, formData);
        
        // Buat session untuk driver
        const sessionDriver = {
          userId: firebaseUser.uid,
          uid: firebaseUser.uid,
          name: driverData.fullName,
          phone: driverData.phoneNumber,
          email: driverData.email || "",
          address: driverData.address || "",
          status: "pending",
          role: "driver",
          fotoProfilURL: formData.profilePhotoUrl,
          rating: 5,
          perjalanan: 0,
          createdAt: new Date().toISOString()
        };
        
        localStorage.setItem('jego_logged_in_driver', JSON.stringify(sessionDriver));
        
        document.getElementById('driverFormStep3').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';
        
        showSuccessMessage('Pendaftaran driver berhasil! Data Anda sedang diverifikasi admin.', true);
        
      } catch (error) {
        console.error('‚ùå Error in registration process:', error);
        
        let errorMessage = 'Terjadi kesalahan saat menyimpan data. ';
        if (error.code === 'storage/unauthorized') {
          errorMessage = '‚ö†Ô∏è ERROR: Akses storage ditolak. Silakan hubungi administrator.';
        } else if (error.code === 'PERMISSION_DENIED') {
          errorMessage = '‚ö†Ô∏è ERROR: Akses database ditolak. Silakan hubungi administrator.';
        } else {
          errorMessage += error.message || 'Silakan coba lagi.';
        }
        
        showErrorMessage(errorMessage);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Daftar sebagai Driver';
      }
    });
    
    document.getElementById('whatsappBtn').addEventListener('click', function() {
      const message = `Halo Admin JeGo, saya ingin menanyakan status verifikasi pendaftaran driver saya.`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/6283142889149?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
    });
    
    function sendToKodular(data) {
      console.log('Mengirim data ke Kodular:', data);
      
      if (typeof window.AppInventor !== 'undefined' && window.AppInventor.setWebViewString) {
        try {
          window.AppInventor.setWebViewString(JSON.stringify(data));
          console.log('‚úÖ Data berhasil dikirim ke Kodular');
        } catch (error) {
          console.error('Error mengirim data via AppInventor:', error);
        }
      }
      else if (typeof window.android !== 'undefined' && window.android.receiveData) {
        try {
          window.android.receiveData(JSON.stringify(data));
          console.log('‚úÖ Data berhasil dikirim ke Kodular');
        } catch (error) {
          console.error('Error mengirim data via window.android:', error);
        }
      }
      else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.observe) {
        try {
          window.webkit.messageHandlers.observe.postMessage(data);
          console.log('‚úÖ Data berhasil dikirim ke Kodular');
        } catch (error) {
          console.error('Error mengirim data via webkit.messageHandlers:', error);
        }
      }
      else {
        console.warn('‚ùå Tidak ada metode yang berhasil mengirim data ke Kodular');
      }
    }
    
    // ================================================
    // INITIALIZATION & AUTH STATE LISTENER
    // ================================================
    
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Aplikasi Pendaftaran Driver JeGo dimulai...');
      
      try {
        setupRecaptcha();
        setupOTPInputs();
        
        modalOverlay.addEventListener('click', function(e) {
          if (e.target === modalOverlay) hidePopup();
        });
        
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modalOverlay.classList.contains('active')) hidePopup();
        });
        
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && index === 5) {
              document.getElementById('verifyOtpBtn').click();
            }
          });
        });
        
        auth.onAuthStateChanged(async (user) => {
          if (user) {
            await checkDriverStatus();
          }
        });
        
        console.log('‚úÖ Aplikasi Pendaftaran Driver siap digunakan');
        
      } catch (error) {
        console.error('‚ùå Error inisialisasi:', error);
        showErrorMessage('Gagal menginisialisasi aplikasi. Silakan refresh halaman.');
      }
    });
  </script>
</body>
</html>
