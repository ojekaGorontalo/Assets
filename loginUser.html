<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Login - JeGo (Integrated)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- FireBase SDK (versi modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      RecaptchaVerifier, 
      signInWithPhoneNumber
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      get, 
      query, 
      orderByChild, 
      equalTo 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ==================== KONFIGURASI ====================
    const SERVER_URL = 'http://135.181.38.85:7781';
    
    // ==================== GLOBAL VARIABLES ====================
    let app;
    let auth;
    let database;
    let confirmationResult = null;
    let recaptchaVerifier = null;
    let firebaseConfig = null;
    let recaptchaWidgetId = null;

    // ==================== INITIALIZE FUNCTIONS ====================
    async function getFirebaseConfigFromServer() {
      try {
        console.log('ðŸ”§ Mengambil config Firebase dari server...');
        const response = await fetch(`${SERVER_URL}/config`);
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.config) {
          console.log('âœ… Config Firebase berhasil diambil dari server');
          return data.config;
        } else {
          throw new Error('Format response server tidak valid');
        }
      } catch (error) {
        console.error('âŒ Gagal mengambil config dari server:', error);
        
        // Fallback ke config default
        return {
          apiKey: "AIzaSyDpGc_CsbNi1igA29n6qDhcX0oDkHNVscc",
          authDomain: "game-balap-simpel.firebaseapp.com",
          databaseURL: "https://game-balap-simpel-default-rtdb.firebaseio.com",
          projectId: "game-balap-simpel",
          storageBucket: "game-balap-simpel.firebasestorage.app",
          messagingSenderId: "864576853495",
          appId: "1:864576853495:web:6f16eb757fd3d8affb0af2"
        };
      }
    }

    async function initializeFirebase() {
      try {
        // Ambil config dari server
        firebaseConfig = await getFirebaseConfigFromServer();
        
        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        database = getDatabase(app);
        
        console.log('ðŸš€ Firebase initialized dengan config dari server');
        return true;
      } catch (error) {
        console.error('âŒ Gagal initialize Firebase:', error);
        showNotification('Error', 'Gagal menghubungkan ke server Firebase', 'error');
        return false;
      }
    }

    // ==================== SERVER API FUNCTIONS ====================
    async function loginToServer(idToken, phoneNumber) {
      try {
        console.log('ðŸ”„ Login ke server backend...');
        
        const response = await fetch(`${SERVER_URL}/api/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            idToken: idToken,
            phoneNumber: phoneNumber
          })
        });

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Login ke server gagal');
        }
        
        console.log('âœ… Login ke server berhasil');
        return data;
      } catch (error) {
        console.error('âŒ Server login error:', error);
        throw error;
      }
    }

    async function checkPhoneOnServer(phoneNumber) {
      try {
        const response = await fetch(`${SERVER_URL}/api/user/check-phone`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phone: phoneNumber })
        });
        
        if (response.ok) {
          return await response.json();
        }
        return null;
      } catch (error) {
        console.error('Error checking phone on server:', error);
        return null;
      }
    }

    // ==================== UI HELPER FUNCTIONS ====================
    function showNotification(title, message, type = 'info') {
      const notification = document.getElementById('notificationPopup');
      const notificationTitle = document.getElementById('notificationTitle');
      const notificationMessage = document.getElementById('notificationMessage');
      
      notificationTitle.textContent = title;
      notificationMessage.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    function showStatus(message, type) {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = 'status-message';
      statusElement.classList.add(`status-${type}`);
      statusElement.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    function showSmsStatus(message, type = 'sending') {
      const smsStatus = document.getElementById('smsStatus');
      smsStatus.textContent = message;
      smsStatus.className = 'sms-status';
      smsStatus.classList.add(type);
      smsStatus.style.display = 'block';
    }

    function hideSmsStatus() {
      const smsStatus = document.getElementById('smsStatus');
      smsStatus.style.display = 'none';
    }

    function showProgress(percent) {
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      
      progressContainer.style.display = 'block';
      progressBar.style.width = percent + '%';
    }

    function hideProgress() {
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.style.display = 'none';
    }

    // ==================== PHONE NUMBER FUNCTIONS ====================
    function cleanPhoneNumber(phone) {
      if (!phone) return '';
      let cleaned = phone.replace(/[^0-9]/g, '');
      if (cleaned.startsWith('62')) {
        cleaned = '0' + cleaned.substring(2);
      }
      return cleaned;
    }

    function formatPhoneForFirebase(phone) {
      if (!phone) return '';
      let cleaned = phone.replace(/[^0-9]/g, '');
      if (cleaned.startsWith('0')) {
        cleaned = '+62' + cleaned.substring(1);
      } else if (cleaned.startsWith('62')) {
        cleaned = '+' + cleaned;
      } else if (!cleaned.startsWith('+')) {
        cleaned = '+62' + cleaned;
      }
      
      // Validasi panjang minimal
      if (cleaned.length < 10 || cleaned.length > 15) {
        throw new Error('Nomor telepon harus 10-15 digit');
      }
      
      return cleaned;
    }

    // ==================== OTP FUNCTIONS ====================
    function setupOTPInput() {
      const otpInput = document.getElementById('otpInput');
      
      otpInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        
        if (e.target.value.length > 6) {
          e.target.value = e.target.value.substring(0, 6);
        }
        
        if (e.target.value.length === 6) {
          e.target.classList.add('filled');
        } else {
          e.target.classList.remove('filled');
        }
      });
      
      otpInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const numbersOnly = pastedText.replace(/[^0-9]/g, '');
        
        if (numbersOnly.length >= 6) {
          e.target.value = numbersOnly.substring(0, 6);
          e.target.classList.add('filled');
        }
      });
    }

    function getEnteredOTP() {
      return document.getElementById('otpInput').value;
    }

    function clearOTPInput() {
      document.getElementById('otpInput').value = '';
      document.getElementById('otpInput').classList.remove('filled');
    }

    function startResendCountdown(seconds) {
      const resendLink = document.getElementById('resendOtpLink');
      const countdownText = document.getElementById('countdownText');
      const countdownElement = document.getElementById('countdown');
      
      resendLink.classList.add('disabled');
      countdownText.style.display = 'inline';
      
      let countdown = seconds;
      countdownElement.textContent = countdown;
      
      const countdownInterval = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;
        
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          resendLink.classList.remove('disabled');
          countdownText.style.display = 'none';
        }
      }, 1000);
    }

    // ==================== FIREBASE AUTH FUNCTIONS (DIPERBAIKI) ====================
    function initializeRecaptcha() {
      try {
        console.log('ðŸ”„ Initializing reCAPTCHA...');
        
        // Cek apakah reCAPTCHA sudah diinisialisasi
        if (recaptchaVerifier) {
          console.log('âœ… reCAPTCHA sudah diinisialisasi sebelumnya');
          return recaptchaVerifier;
        }
        
        const container = document.getElementById('recaptcha-container');
        
        // JANGAN hapus container! Cek apakah sudah ada widget
        if (container.children.length > 0) {
          console.log('âš ï¸ reCAPTCHA widget sudah ada, menggunakan yang existing');
          // Cari verifier yang sudah ada
          recaptchaVerifier = window.recaptchaVerifier;
          return recaptchaVerifier;
        }
        
        // Inisialisasi reCAPTCHA sesuai dokumentasi Firebase
        recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
          'size': 'normal',
          'callback': (response) => {
            console.log('âœ… reCAPTCHA berhasil diselesaikan, response:', response);
            showNotification('Success', 'Verifikasi keamanan berhasil', 'success');
          },
          'expired-callback': () => {
            console.log('âš ï¸ reCAPTCHA expired, perlu diselesaikan ulang');
            showNotification('Info', 'Verifikasi keamanan telah kadaluarsa', 'info');
            
            // Reset reCAPTCHA jika widget ID tersedia
            if (recaptchaWidgetId && typeof grecaptcha !== 'undefined') {
              grecaptcha.reset(recaptchaWidgetId);
            }
          }
        });
        
        // Render reCAPTCHA
        recaptchaVerifier.render().then((widgetId) => {
          console.log('âœ… reCAPTCHA widget rendered with ID:', widgetId);
          recaptchaWidgetId = widgetId;
          window.recaptchaWidgetId = widgetId;
          
          // Simpan verifier di window untuk akses global
          window.recaptchaVerifier = recaptchaVerifier;
        }).catch(error => {
          console.error('âŒ Error rendering reCAPTCHA:', error);
          showNotification('Error', 'Gagal memuat verifikasi keamanan', 'error');
        });
        
        return recaptchaVerifier;
      } catch (error) {
        console.error('âŒ Error initializing recaptcha:', error);
        
        // Error handling spesifik
        let errorMessage = 'Gagal menginisialisasi verifikasi keamanan. ';
        
        if (error.code === 'auth/argument-error') {
          errorMessage += 'Parameter tidak valid.';
        } else if (error.code === 'auth/recaptcha-not-enabled') {
          errorMessage += 'reCAPTCHA belum diaktifkan di Firebase Console.';
        } else {
          errorMessage += error.message || 'Silakan refresh halaman.';
        }
        
        showNotification('Error', errorMessage, 'error');
        return null;
      }
    }

    // Fungsi untuk reset reCAPTCHA jika diperlukan
    function resetRecaptcha() {
      if (recaptchaWidgetId && typeof grecaptcha !== 'undefined') {
        grecaptcha.reset(recaptchaWidgetId);
        console.log('ðŸ”„ reCAPTCHA direset');
      }
    }

    async function sendOtpWithFirebase(phoneNumber) {
      try {
        showSmsStatus('ðŸ“± Mengirim OTP...', 'sending');
        
        const formattedPhone = formatPhoneForFirebase(phoneNumber);
        console.log('ðŸ“ž Formatted phone for Firebase:', formattedPhone);
        
        // Pastikan reCAPTCHA sudah diinisialisasi
        if (!recaptchaVerifier) {
          console.log('ðŸ”„ reCAPTCHA belum siap, menginisialisasi...');
          recaptchaVerifier = initializeRecaptcha();
          
          if (!recaptchaVerifier) {
            throw new Error('reCAPTCHA tidak dapat diinisialisasi');
          }
          
          // Tunggu reCAPTCHA siap (minimal 1 detik untuk render)
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // Cek apakah reCAPTCHA sudah diselesaikan
        if (typeof grecaptcha !== 'undefined' && recaptchaWidgetId) {
          const recaptchaResponse = grecaptcha.getResponse(recaptchaWidgetId);
          if (!recaptchaResponse) {
            showSmsStatus('âš ï¸ Silakan selesaikan verifikasi keamanan terlebih dahulu', 'error');
            throw new Error('reCAPTCHA belum diselesaikan');
          }
        }
        
        console.log('ðŸš€ Memanggil signInWithPhoneNumber...');
        
        // Kirim OTP sesuai dokumentasi Firebase
        confirmationResult = await signInWithPhoneNumber(auth, formattedPhone, recaptchaVerifier);
        
        console.log('âœ… OTP berhasil dikirim, verificationId:', confirmationResult.verificationId);
        showSmsStatus('âœ… OTP berhasil dikirim via SMS', 'success');
        
        return { 
          success: true, 
          message: 'OTP berhasil dikirim',
          verificationId: confirmationResult.verificationId 
        };
      } catch (error) {
        console.error('âŒ Send OTP error:', error);
        
        let errorMessage = 'Gagal mengirim OTP. ';
        let userMessage = 'Gagal mengirim OTP. ';
        
        // Error handling lengkap sesuai dokumentasi Firebase
        switch (error.code) {
          case 'auth/invalid-phone-number':
            errorMessage += 'Format nomor telepon tidak valid.';
            userMessage = 'Format nomor telepon tidak valid. Contoh: 08123456789';
            break;
            
          case 'auth/missing-recaptcha-token':
            errorMessage += 'Token reCAPTCHA tidak ditemukan.';
            userMessage = 'Silakan selesaikan verifikasi keamanan terlebih dahulu.';
            // Reset reCAPTCHA
            resetRecaptcha();
            break;
            
          case 'auth/invalid-recaptcha-token':
            errorMessage += 'Token reCAPTCHA tidak valid.';
            userMessage = 'Verifikasi keamanan gagal. Silakan coba lagi.';
            resetRecaptcha();
            break;
            
          case 'auth/captcha-check-failed':
            errorMessage += 'Verifikasi reCAPTCHA gagal.';
            userMessage = 'Verifikasi keamanan gagal. Silakan refresh halaman.';
            break;
            
          case 'auth/too-many-requests':
            errorMessage += 'Terlalu banyak permintaan.';
            userMessage = 'Terlalu banyak percobaan. Silakan coba lagi nanti.';
            break;
            
          case 'auth/quota-exceeded':
            errorMessage += 'Kuota SMS telah habis.';
            userMessage = 'Kuota SMS telah habis. Silakan hubungi admin.';
            break;
            
          case 'auth/app-not-authorized':
            errorMessage += 'Aplikasi tidak diotorisasi untuk menggunakan Firebase Authentication.';
            userMessage = 'Konfigurasi aplikasi bermasalah. Hubungi admin.';
            break;
            
          case 'auth/network-request-failed':
            errorMessage += 'Gagal terhubung ke jaringan.';
            userMessage = 'Gagal terhubung ke jaringan. Periksa koneksi internet Anda.';
            break;
            
          default:
            errorMessage += error.message || 'Silakan coba lagi.';
            userMessage = 'Terjadi kesalahan. Silakan coba lagi.';
        }
        
        console.error('Error details:', errorMessage);
        showSmsStatus('âŒ ' + userMessage, 'error');
        
        throw new Error(errorMessage);
      }
    }

    async function verifyOtpWithFirebase(otpCode) {
      try {
        if (!confirmationResult) {
          throw new Error('Sesi OTP tidak valid. Silakan minta OTP baru.');
        }
        
        console.log('ðŸ” Memverifikasi OTP...');
        
        const result = await confirmationResult.confirm(otpCode);
        const user = result.user;
        
        console.log('âœ… OTP berhasil diverifikasi, user:', user.uid);
        return { success: true, user };
      } catch (error) {
        console.error('âŒ Verify OTP error:', error);
        
        let errorMessage = 'Gagal memverifikasi OTP. ';
        let userMessage = 'Gagal memverifikasi OTP. ';
        
        if (error.code === 'auth/invalid-verification-code') {
          errorMessage += 'Kode OTP tidak valid.';
          userMessage = 'Kode OTP salah. Silakan cek kembali.';
        } else if (error.code === 'auth/code-expired') {
          errorMessage += 'Kode OTP telah kedaluwarsa.';
          userMessage = 'Kode OTP telah kedaluwarsa. Minta OTP baru.';
        } else if (error.code === 'auth/credential-already-in-use') {
          errorMessage += 'Kredensial sudah digunakan.';
          userMessage = 'Akun sudah digunakan.';
        } else if (error.code === 'auth/user-disabled') {
          errorMessage += 'Akun dinonaktifkan.';
          userMessage = 'Akun dinonaktifkan. Hubungi admin.';
        } else {
          errorMessage += error.message || 'Silakan coba lagi.';
          userMessage = 'Terjadi kesalahan. Silakan coba lagi.';
        }
        
        throw new Error(errorMessage);
      }
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ðŸ“„ DOM fully loaded, initializing...');
      
      setupOTPInput();
      
      // Initialize Firebase
      const firebaseReady = await initializeFirebase();
      
      if (firebaseReady) {
        console.log('âœ… Firebase ready, initializing reCAPTCHA...');
        
        // Inisialisasi reCAPTCHA dengan delay untuk memastikan library siap
        setTimeout(() => {
          initializeRecaptcha();
        }, 1000);
      }
      
      // Event Listeners
      document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
      document.getElementById('verifyOtpBtn').addEventListener('click', handleVerifyOtp);
      document.getElementById('resendOtpLink').addEventListener('click', handleResendOtp);
      document.getElementById('registerBtn').addEventListener('click', () => {
        window.location.href = 'registrasi_jego.html';
      });
      
      // Enter key support
      document.getElementById('teleponInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('loginBtn').click();
        }
      });
      
      document.getElementById('otpInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('verifyOtpBtn').click();
        }
      });
      
      // Auto-focus
      document.getElementById('teleponInput').focus();
      
      // Check if already logged in
      checkExistingSession();
    });

    // ==================== EVENT HANDLERS ====================
    async function handleLoginSubmit(e) {
      e.preventDefault();
      
      const loginBtn = document.getElementById('loginBtn');
      const telepon = document.getElementById('teleponInput').value.trim();
      
      if (!telepon) {
        showStatus('Harap masukkan nomor telepon.', 'error');
        return;
      }
      
      const cleanTelepon = telepon.replace(/\D/g, '');
      if (cleanTelepon.length < 10 || cleanTelepon.length > 13) {
        showStatus('Nomor telepon harus antara 10-13 digit.', 'error');
        return;
      }
      
      // Disable button
      loginBtn.disabled = true;
      loginBtn.classList.add('btn-loading');
      loginBtn.textContent = 'Mengirim OTP...';
      showProgress(20);
      
      try {
        // 1. Konversi nomor telepon ke format kode negara untuk pengecekan di server
        const phoneForServer = formatPhoneForFirebase(telepon);
        
        // 2. Cek user di server dengan format nomor yang sudah dikonversi
        showProgress(40);
        const serverCheck = await checkPhoneOnServer(phoneForServer);
        
        if (serverCheck && serverCheck.exists) {
          const userData = serverCheck.latestUser || serverCheck.users[0];
          
          // Cek status akun
          const userStatus = userData.status || 'active';
          
          if (userStatus === 'blocked_permanent' || userStatus === 'banned') {
            showStatus('Akun diblokir permanen. Tidak dapat login.', 'error');
            return;
          }
          
          if (userStatus === 'inactive') {
            showStatus('Akun tidak aktif. Hubungi administrator.', 'error');
            return;
          }
          
          // 3. Simpan data user
          localStorage.setItem('jego_current_user', JSON.stringify({
            userKey: userData.uid,
            telepon: telepon, // Simpan format asli (08xxx) untuk UI
            phoneForServer: phoneForServer, // Simpan juga format +62 untuk referensi
            userData: userData
          }));
          
          // 4. Kirim OTP
          showProgress(60);
          const otpResult = await sendOtpWithFirebase(telepon);
          
          if (otpResult.success) {
            // 5. Tampilkan OTP section
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('otpSection').style.display = 'block';
            document.getElementById('otpInput').focus();
            
            startResendCountdown(60);
            showProgress(100);
            showNotification('OTP Dikirim', 'Kode OTP telah dikirim via SMS.', 'info');
          }
          
        } else {
          showStatus('Nomor telepon tidak terdaftar.', 'error');
        }
        
      } catch (error) {
        console.error('Login error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        resetRecaptcha(); // Reset reCAPTCHA jika terjadi error
      } finally {
        setTimeout(() => {
          loginBtn.disabled = false;
          loginBtn.classList.remove('btn-loading');
          loginBtn.textContent = 'Kirim Kode OTP';
          hideProgress();
        }, 1000);
      }
    }

    async function handleVerifyOtp() {
      const verifyBtn = document.getElementById('verifyOtpBtn');
      const enteredOtp = getEnteredOTP();
      
      if (enteredOtp.length !== 6) {
        showStatus('Harap masukkan kode OTP 6 digit lengkap.', 'error');
        return;
      }
      
      verifyBtn.disabled = true;
      verifyBtn.classList.add('btn-loading');
      verifyBtn.textContent = 'Memverifikasi...';
      
      const currentUser = JSON.parse(localStorage.getItem('jego_current_user') || '{}');
      
      if (!currentUser.userKey) {
        showStatus('Sesi tidak valid.', 'error');
        resetVerifyButton();
        return;
      }
      
      try {
        // 1. Verify OTP dengan Firebase
        const verificationResult = await verifyOtpWithFirebase(enteredOtp);
        
        if (verificationResult.success && verificationResult.user) {
          // 2. Dapatkan ID Token
          const idToken = await verificationResult.user.getIdToken();
          const phoneNumber = verificationResult.user.phoneNumber;
          
          console.log('âœ… Firebase auth success, UID:', verificationResult.user.uid);
          console.log('ðŸ”‘ ID Token obtained');
          
          // 3. Login ke server
          const serverLogin = await loginToServer(idToken, phoneNumber);
          
          if (serverLogin.success) {
            // 4. Simpan data user
            const userData = {
              ...currentUser.userData,
              ...serverLogin.user,
              auth_uid: verificationResult.user.uid,
              last_login: new Date().toISOString()
            };
            
            localStorage.setItem('jego_logged_in_user', JSON.stringify(userData));
            localStorage.setItem('jego_user_data', JSON.stringify(userData));
            localStorage.setItem('jego_auth_uid', verificationResult.user.uid);
            
            if (serverLogin.token) {
              localStorage.setItem('jego_server_token', serverLogin.token);
            }
            
            // 5. Tampilkan success
            showStatus('Login berhasil! Mengalihkan...', 'success');
            showNotification('Login Berhasil', 'Login berhasil!', 'success');
            
            // 6. Reset reCAPTCHA untuk sesi berikutnya
            resetRecaptcha();
            
            // 7. Redirect
            setTimeout(() => {
              window.location.href = 'jenis_kenderaan.html';
            }, 1500);
            
          } else {
            throw new Error('Login ke server gagal');
          }
        }
      } catch (error) {
        console.error('Verify error:', error);
        showStatus(`Gagal: ${error.message}`, 'error');
        clearOTPInput();
        document.getElementById('otpInput').focus();
        resetVerifyButton();
      }
    }

    function resetVerifyButton() {
      const verifyBtn = document.getElementById('verifyOtpBtn');
      verifyBtn.disabled = false;
      verifyBtn.classList.remove('btn-loading');
      verifyBtn.textContent = 'Verifikasi OTP';
    }

    async function handleResendOtp() {
      const resendLink = document.getElementById('resendOtpLink');
      
      if (resendLink.classList.contains('disabled')) {
        return;
      }
      
      const currentUser = JSON.parse(localStorage.getItem('jego_current_user') || '{}');
      const telepon = currentUser.telepon;
      
      if (!telepon) {
        showStatus('Sesi tidak valid.', 'error');
        return;
      }
      
      resendLink.classList.add('disabled');
      showSmsStatus('ðŸ”„ Mengirim ulang OTP...', 'sending');
      
      try {
        await sendOtpWithFirebase(telepon);
        
        showStatus('OTP baru telah dikirim.', 'info');
        clearOTPInput();
        document.getElementById('otpInput').focus();
        startResendCountdown(60);
        
      } catch (error) {
        console.error('Resend error:', error);
        showStatus(`Gagal: ${error.message}`, 'error');
        resendLink.classList.remove('disabled');
      }
    }

    async function checkExistingSession() {
      const token = localStorage.getItem('jego_server_token');
      
      if (token) {
        try {
          const response = await fetch(`${SERVER_URL}/api/auth/me`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            
            if (data.success && data.user) {
              showStatus(`Selamat datang kembali, ${data.user.name}`, 'success');
              
              setTimeout(() => {
                window.location.href = 'jenis_kenderaan.html';
              }, 1000);
              
              return true;
            }
          }
        } catch (error) {
          console.log('Session check failed:', error);
        }
      }
      
      // Cek localStorage
      const localUser = localStorage.getItem('jego_logged_in_user');
      if (localUser) {
        try {
          const user = JSON.parse(localUser);
          showStatus(`Selamat datang kembali, ${user.name}`, 'info');
          
          setTimeout(() => {
            window.location.href = 'jenis_kenderaan.html';
          }, 1500);
        } catch (error) {
          console.error('Error parsing user:', error);
        }
      }
      
      return false;
    }
  </script>

  <style>
    /* STYLE CSS YANG SAMA DENGAN SEBELUMNYA */
    :root {
      --primary: #1e6f5c;
      --secondary: #289672;
      --accent: #e6dd3b;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.4;
      font-size: 0.85rem;
    }

    /* Header Styles */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo {
      width: 40px;
      height: 40px;
      background-color: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
      font-size: 16px;
      color: var(--primary);
    }

    .header-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* Container Styles */
    .container {
      max-width: 100%;
      padding: 15px;
    }

    .form-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 500px;
      margin: 0 auto;
    }

    .form-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 111, 92, 0.1);
    }

    .submit-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      width: 100%;
    }

    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
    }

    .submit-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .secondary-btn {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 12px 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 10px;
    }

    .secondary-btn:hover {
      background: rgba(30, 111, 92, 0.05);
    }

    /* Status Messages */
    .status-message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }

    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* OTP Section */
    .otp-section {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .otp-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
    }

    .otp-info {
      margin-bottom: 20px;
      font-size: 0.9rem;
      text-align: center;
      color: #666;
    }

    /* SINGLE OTP INPUT */
    .otp-single-input {
      width: 100%;
      padding: 15px;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      letter-spacing: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s;
      font-family: 'Courier New', monospace;
    }

    .otp-single-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 111, 92, 0.2);
      outline: none;
    }

    .otp-single-input.filled {
      border-color: var(--primary);
      background-color: #f8fff9;
    }

    .resend-otp {
      text-align: center;
      margin-top: 15px;
      font-size: 0.85rem;
    }

    .resend-link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
    }

    .resend-link:hover {
      color: var(--secondary);
    }

    .resend-link.disabled {
      color: #999;
      cursor: not-allowed;
      text-decoration: none;
    }

    /* Badge Lokal */
    .local-badge {
      display: inline-block;
      background-color: var(--accent);
      color: var(--dark);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-top: 10px;
      font-size: 0.8rem;
      text-align: center;
      width: 100%;
    }

    .app-info {
      text-align: center;
      margin: 15px 0;
      font-size: 0.85rem;
      color: var(--dark);
      opacity: 0.8;
    }

    /* Loading State */
    .btn-loading {
      position: relative;
      color: transparent !important;
    }

    .btn-loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin-top: -10px;
      margin-left: -10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progress Bar */
    .progress-container {
      height: 4px;
      background-color: #e0e0e0;
      border-radius: 2px;
      margin: 10px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Notification Popup */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-left: 4px solid var(--primary);
      z-index: 1000;
      display: none;
      max-width: 300px;
    }

    .notification.success {
      border-left-color: var(--success);
    }

    .notification.error {
      border-left-color: var(--danger);
    }

    .notification.info {
      border-left-color: var(--primary);
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .notification-message {
      font-size: 0.85rem;
      color: #666;
    }

    /* SMS Status Indicator */
    .sms-status {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 0.9rem;
      display: none;
    }

    .sms-status.success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .sms-status.error {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }

    .sms-status.sending {
      background-color: #e3f2fd;
      color: #1565c0;
      border: 1px solid #bbdefb;
    }

    /* Recaptcha Container */
    #recaptcha-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      min-height: 80px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-title {
        font-size: 1rem;
      }
      
      body {
        font-size: 0.8rem;
      }
      
      .form-container {
        padding: 15px;
      }
      
      .otp-single-input {
        font-size: 1.5rem;
        letter-spacing: 8px;
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo-container">
      <div class="logo">JG</div>
      <div class="header-title">JeGo - Login (Integrated)</div>
    </div>
  </div>

  <!-- Container -->
  <div class="container">
    <div class="form-container">
      <h1 class="form-title">Login User</h1>
      <div class="local-badge">TERINTEGRASI DENGAN SERVER BACKEND</div>
      <div class="app-info">
        JeGo - Jasa Ekspedisi Gorontalo
      </div>
      
      <!-- SMS Status Indicator -->
      <div class="sms-status" id="smsStatus"></div>
      
      <!-- Status Message -->
      <div class="status-message" id="statusMessage"></div>
      
      <!-- Recaptcha Container -->
      <div id="recaptcha-container"></div>
      
      <!-- Progress Bar -->
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <!-- Form Login -->
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="teleponInput">Nomor Telepon *</label>
          <input type="tel" class="form-input" id="teleponInput" placeholder="Contoh: 08123456789" required inputmode="numeric" pattern="[0-9]*">
          <small style="color: #666; font-size: 0.8rem; margin-top: 5px; display: block;">
            Pastikan nomor aktif dan dapat menerima SMS
          </small>
        </div>
        
        <button type="submit" class="submit-btn" id="loginBtn">Kirim Kode OTP</button>
        
        <button type="button" class="secondary-btn" id="registerBtn">Belum punya akun? Daftar Sekarang</button>
      </form>
      
      <!-- OTP Verification Section -->
      <div class="otp-section" id="otpSection">
        <h2 class="otp-title">Verifikasi OTP</h2>
        
        <div class="otp-info">
          <p>Kode OTP telah dikirim via SMS ke nomor Anda.</p>
          <p>Masukkan kode OTP 6 digit untuk melanjutkan.</p>
        </div>
        
        <!-- SINGLE OTP INPUT -->
        <input type="text" 
               class="otp-single-input" 
               id="otpInput" 
               maxlength="6" 
               inputmode="numeric" 
               pattern="[0-9]*" 
               placeholder="000000"
               autocomplete="one-time-code">
        
        <button type="button" class="submit-btn" id="verifyOtpBtn">Verifikasi OTP</button>
        
        <div class="resend-otp">
          <span id="resendText">Tidak menerima kode? </span>
          <span class="resend-link" id="resendOtpLink">Kirim ulang OTP</span>
          <span id="countdownText" style="display: none;"> (Tunggu <span id="countdown">60</span> detik)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Popup -->
  <div class="notification" id="notificationPopup">
    <div class="notification-title" id="notificationTitle">Informasi</div>
    <div class="notification-message" id="notificationMessage"></div>
  </div>
</body>
</html>
